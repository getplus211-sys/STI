<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Nandigram - Chats</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --pc: #0088cc; 
            --sc: #24a1de;
            --bg: #ffffff;
            --text: #222222;
            --gray: #8e8e93;
            --border: #dcdcdc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, sans-serif;
            background: #f1f1f1;
            padding-bottom: 90px; /* Space for larger footer */
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg);
            min-height: 100vh;
        }

        /* CUSTOM HEADER: 100px Height, Content at Bottom */
        .header {
            position: sticky;
            top: 0;
            height: 100px;
            background: linear-gradient(135deg, var(--pc), var(--sc));
            color: white;
            padding: 0 20px 15px 20px;
            z-index: 1000;
            display: flex;
            align-items: flex-end; /* Content at bottom */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 24px; font-weight: 700; letter-spacing: 0.5px; }
        .header-actions { display: flex; gap: 18px; }
        .action-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s; }
        .action-btn:active { background: rgba(255,255,255,0.2); }

        /* Search Bar */
        .search-container { padding: 10px 15px; background: var(--pc); display: none; }
        .search-container.active { display: block; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 14px; }

        /* Chat List */
        .chat-item {
            display: flex;
            padding: 12px 15px;
            align-items: center;
            border-bottom: 0.5px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
        }

        .chat-item:active {
            background: #f5f5f5;
        }

        .avatar {
            width: 52px; 
            height: 52px; 
            border-radius: 50%;
            background: #e0e0e0; 
            display: flex; 
            align-items: center;
            justify-content: center; 
            font-weight: bold; 
            color: white;
            margin-right: 15px; 
            flex-shrink: 0; 
            font-size: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .chat-info { 
            flex: 1; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 10px;
        }

        .chat-name { 
            font-size: 15px; 
            font-weight: 600; 
            color: #000; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time { 
            font-size: 12px; 
            color: var(--gray); 
            white-space: nowrap;
            flex-shrink: 0;
        }

        .chat-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .chat-msg { 
            font-size: 13px; 
            color: #666; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            flex: 1;
        }

        .unread-badge {
            background: #25d366; 
            color: white; 
            border-radius: 50%; 
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(37,211,102,0.3);
        }

        /* CUSTOM FOOTER: Increased Height, Content at Top */
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            height: 85px; /* Increased height */
            background: #fff;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: flex-start; /* Content at top */
            padding-top: 10px; /* Padding for top alignment */
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            color: var(--gray);
            flex: 1;
            cursor: pointer;
            padding: 8px 0;
            transition: color 0.2s;
        }

        .nav-item:active {
            opacity: 0.7;
        }

        .nav-item.active { 
            color: var(--pc); 
        }

        .nav-icon { 
            font-size: 24px; 
            display: block;
        }

        .nav-label { 
            font-size: 11px; 
            margin-top: 2px; 
            font-weight: 500; 
        }

        .fab {
            position: fixed;
            bottom: 105px; /* Adjusted for larger footer */
            right: 20px;
            width: 56px; 
            height: 56px;
            background: var(--pc); 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            color: white; 
            font-size: 24px; 
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,132,204,0.3);
            transition: all 0.2s;
        }

        .fab:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,132,204,0.3);
        }

        .loading { 
            text-align: center; 
            padding: 50px; 
            color: #888; 
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 15px;
            color: #666;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="header-content">
            <h1>Nandigram</h1>
            <div class="header-actions">
                <button class="action-btn" onclick="toggleSearch()" title="Search">ğŸ”</button>
                <button class="action-btn" onclick="showMenu()" title="Menu">â‹®</button>
            </div>
        </div>
    </div>

    <div class="search-container" id="searchBox">
        <input type="text" class="search-input" id="searchInput" placeholder="àª¶à«‹àª§à«‹..." oninput="filterChats()">
    </div>

    <div id="chatList">
        <div class="loading">àªšà«‡àªŸ àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«€ àª›à«‡...</div>
    </div>

    <button class="fab" onclick="location.href='ngm-new-chat.html'" title="New Chat">âœ</button>

    <div class="footer">
        <div class="nav-item active" onclick="location.href='ngm-chats.html'">
            <span class="nav-icon">ğŸ’¬</span>
            <div class="nav-label">àªšà«‡àªŸà«àª¸</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-channel-view.html'">
            <span class="nav-icon">ğŸ“¢</span>
            <div class="nav-label">àªšà«‡àª¨àª²</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-group-chat.html'">
            <span class="nav-icon">ğŸ‘¥</span>
            <div class="nav-label">àª—à«àª°à«àªª</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-kapila.html'">
            <span class="nav-icon">ğŸ¤–</span>
            <div class="nav-label">KAPiLa</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-profile.html'">
            <span class="nav-icon">ğŸ‘¤</span>
            <div class="nav-label">àªªà«àª°à«‹àª«àª¾àª‡àª²</div>
        </div>
    </div>
</div>

<script>
    const U = 'https://bhmycvrbucmbbrpzeane.supabase.co';
    const K = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
    const sb = supabase.createClient(U, K);

    let cu = null;
    let allChats = [];

    function getSmartTime(dateString) {
        const msgDate = new Date(dateString);
        const now = new Date();
        const diffMs = now - msgDate;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'now';
        if (diffMins < 60) return `${diffMins}m`;
        if (diffHours < 24) return `${diffHours}h`;
        
        // Check if yesterday
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        const msgDateOnly = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate());
        const yesterdayOnly = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
        
        if (msgDateOnly.getTime() === yesterdayOnly.getTime()) {
            return 'Yesterday';
        }
        
        // Otherwise show date
        return msgDate.toLocaleDateString('gu-IN', { month: 'short', day: 'numeric' });
    }

    async function init() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) { location.href = 'login.html'; return; }
        cu = user;
        fetchChats();
        
        // Real-time updates on messages
        sb.channel('messages').on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'ngm_messages' },
            () => fetchChats()
        ).subscribe();

        // Real-time updates on chat participants (unread count)
        sb.channel('chat_participants').on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'ngm_chat_participants' },
            (payload) => {
                if (payload.new?.user_id === cu.id) {
                    fetchChats();
                }
            }
        ).subscribe();
    }

    async function fetchChats() {
        const list = document.getElementById('chatList');
        try {
            // Get all chats for current user, sorted by last message time (newest first)
            let { data: parts, error } = await sb
                .from('ngm_chat_participants')
                .select('*,chat:ngm_chats(*)')
                .eq('user_id', cu.id);

            if (error) throw error;

            if (!parts || parts.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <div class="empty-state-text">àª•à«‹àªˆ àªšà«‡àªŸ àª¨àª¥à«€<br>àª¨àªµà«€ àªšà«‡àªŸ àª¶àª°à«‚ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ âœ àª•à«àª²àª¿àª• àª•àª°à«‹</div>
                    </div>
                `;
                return;
            }

            // Sort chats by last message time (newest first)
            parts.sort((a, b) => {
                const timeA = a.chat?.last_message_at ? new Date(a.chat.last_message_at).getTime() : 0;
                const timeB = b.chat?.last_message_at ? new Date(b.chat.last_message_at).getTime() : 0;
                return timeB - timeA;
            });

            let html = '';
            allChats = [];

            for (let p of parts) {
                const c = p.chat;
                if (!c) continue;

                // Get other user name for personal chats
                let name = "Chat";
                let avatarBg = getRandomColor();
                
                if (c.chat_type === 'personal') {
                    const otherId = (c.user1_id === cu.id) ? c.user2_id : c.user1_id;
                    const { data: u } = await sb
                        .from('ngm_users')
                        .select('full_name,profile_picture_url')
                        .eq('user_id', otherId)
                        .single();
                    name = u?.full_name || "User";
                } else {
                    name = c.group_name || "Group/Channel";
                }

                // Get last message
                const { data: lastMsg } = await sb
                    .from('ngm_messages')
                    .select('content,created_at,sender_id')
                    .eq('chat_id', c.chat_id)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                const lastMsgText = lastMsg 
                    ? lastMsg.content.substring(0, 40) 
                    : 'àª•à«‹àªˆ àª®à«‡àª¸à«‡àªœ àª¨àª¥à«€';

                const lastMsgTime = lastMsg 
                    ? getSmartTime(lastMsg.created_at)
                    : '';

                const unreadBadgeHTML = p.unread_count > 0 
                    ? `<div style="font-size:12px; color:#25d366; font-weight:600; margin-top:4px;">${p.unread_count} unread</div>`
                    : '';

                const chatObj = {
                    id: c.chat_id,
                    name: name,
                    lastMsg: lastMsgText,
                    time: lastMsgTime,
                    unread: p.unread_count,
                    avatarBg: avatarBg,
                    avatar: name.charAt(0)
                };
                allChats.push(chatObj);

                // Debug log
                console.log(`Chat: ${name}, Unread: ${p.unread_count}, Time: ${lastMsgTime}`);

                html += `
                    <div class="chat-item" onclick="openChat('${c.chat_id}')">
                        <div class="avatar" style="background:${avatarBg}">${name.charAt(0)}</div>
                        <div class="chat-info">
                            <div class="chat-top">
                                <span class="chat-name">${name}</span>
                                <div style="display:flex;flex-direction:column;align-items:flex-end;">
                                    <span class="chat-time">${lastMsgTime}</span>
                                    ${unreadBadgeHTML}
                                </div>
                            </div>
                            <div class="chat-bottom">
                                <span class="chat-msg">${lastMsgText}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        } catch (e) {
            list.innerHTML = '<div class="loading">Error: ' + e.message + '</div>';
            console.error(e);
        }
    }

    function openChat(chatId) {
        // Reset unread count for this chat
        resetUnreadCount(chatId);
        location.href = `ngm-chat-window.html?chat=${chatId}`;
    }

    async function resetUnreadCount(chatId) {
        try {
            const { error } = await sb.rpc('reset_unread_count', {
                p_chat_id: chatId,
                p_user_id: cu.id
            });
            if (error) console.error('Reset unread error:', error);
        } catch (e) {
            console.error('Error resetting unread:', e);
        }
    }

    function toggleSearch() {
        const s = document.getElementById('searchBox');
        s.classList.toggle('active');
        if (s.classList.contains('active')) {
            document.getElementById('searchInput').focus();
        }
    }

    function filterChats() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allChats.filter(chat => 
            chat.name.toLowerCase().includes(query)
        );

        const list = document.getElementById('chatList');
        if (filtered.length === 0) {
            list.innerHTML = '<div class="loading">àª•à«‹àªˆ àªšà«‡àªŸ àª®àª³à«€ àª¨àª¥à«€</div>';
            return;
        }

        let html = '';
        for (let chat of filtered) {
            const unreadBadgeHTML = chat.unread > 0 
                ? `<div style="font-size:12px; color:#25d366; font-weight:600; margin-top:4px;">${chat.unread} unread</div>`
                : '';

            html += `
                <div class="chat-item" onclick="openChat('${chat.id}')">
                    <div class="avatar" style="background:${chat.avatarBg}">${chat.avatar}</div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <span class="chat-name">${chat.name}</span>
                            <div style="display:flex;flex-direction:column;align-items:flex-end;">
                                <span class="chat-time">${chat.time}</span>
                                ${unreadBadgeHTML}
                            </div>
                        </div>
                        <div class="chat-bottom">
                            <span class="chat-msg">${chat.lastMsg}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        list.innerHTML = html;
    }

    function showMenu() {
        alert('Menu - Coming Soon');
    }

    function getRandomColor() {
        const colors = ['#ff6b6b', '#4facfe', '#43e97b', '#fa709a', '#667eea', '#ffa502'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    init();
</script>
</body>
</html>
