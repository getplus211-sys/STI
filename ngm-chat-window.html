<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{font-family:-apple-system,sans-serif;background:#e5ddd5;padding-bottom:95px}.c{max-width:480px;margin:0 auto;min-height:100vh}.h{position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;height:70px;background:linear-gradient(135deg,var(--pc),var(--sc));display:flex;align-items:center;padding:0 10px;z-index:100;box-shadow:0 2px 5px rgba(0,0,0,0.1)}.bb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.bb svg{width:24px;height:24px;fill:#fff}.hi{flex:1;display:flex;align-items:center;gap:10px;margin-left:5px;cursor:pointer}.ha{width:40px;height:40px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;overflow:hidden}.ha img{width:100%;height:100%;object-fit:cover}.ht{flex:1}.hn{color:#fff;font-size:16px;font-weight:600}.hs{color:rgba(255,255,255,0.8);font-size:12px}.hm{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none;position:relative}.hm svg{width:24px;height:24px;fill:#fff}.mc{padding:80px 10px 10px;min-height:100vh}.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}.mb{max-width:75%;padding:8px 12px;border-radius:8px;position:relative;word-wrap:break-word}.mb.emoji-only{background:none!important;padding:0;font-size:64px;line-height:1}.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}.m.received .mb{background:#fff;border-bottom-left-radius:2px}.mt{font-size:14px;color:#333}.mti{font-size:11px;color:#666;margin-top:4px;text-align:right}.ic{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f5f5f5;padding:8px;z-index:100;border-top:1px solid #e0e0e0;min-height:95px;display:flex;flex-direction:column;gap:8px}.it{display:flex;gap:8px;align-items:flex-end}.ab{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;flex-shrink:0}.mitw{flex:1;position:relative;background:#fff;border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center}.mi{flex:1;padding:10px 15px;border:none;font-size:14px;resize:none;max-height:100px;overflow-y:auto;background:transparent;font-family:inherit}.mi:focus{outline:none}.sb{width:40px;height:40px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}.sb svg{width:20px;height:20px;fill:#fff}.umc{display:flex;align-items:center;gap:8px;padding:4px 0}.ua{width:30px;height:30px;border-radius:50%;background:var(--pc);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#fff}.uc{font-size:12px;color:#666}.da{width:30px;height:30px;border-radius:50%;background:var(--pc);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#fff;transform:rotate(180deg)}.ek{display:none;position:fixed;bottom:95px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;padding:15px;height:250px;overflow-y:auto;z-index:99}.ek.show{display:block}.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}.ee{font-size:32px;padding:8px;cursor:pointer;text-align:center;border-radius:8px;transition:background 0.2s}.ee:hover{background:#f0f0f0}.ctx{position:fixed;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:8px 0;z-index:1000;display:none;min-width:180px}.ctx.show{display:block}.cti{padding:12px 20px;font-size:14px;color:#333;cursor:pointer;border-bottom:1px solid #f0f0f0}.cti:last-child{border-bottom:none}.cti:hover{background:#f5f5f5}.mm{position:fixed;top:0;left:0;right:0;bottom:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:center;justify-content:center}.mm.show{display:flex}.mmc{background:#fff;border-radius:12px;padding:20px;width:90%;max-width:400px}.mmt{font-size:18px;font-weight:600;margin-bottom:15px}.mmi{padding:12px 20px;margin:5px 0;cursor:pointer;border-radius:8px;background:#f5f5f5}.mmi:hover{background:#e0e0e0}.empty{text-align:center;padding:40px 20px;color:#999}.loading{text-align:center;padding:20px;color:#999}
</style>
</head>
<body>
<div class="c">
<div class="h">
<button class="bb" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<div class="hi" onclick="openUserInfo()">
<div class="ha" id="chatAvatar">?</div>
<div class="ht"><div class="hn" id="chatTitle">Loading...</div><div class="hs" id="chatStatus"></div></div>
</div>
<button class="hm" onclick="showMenu()"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
</div>
<div class="mc" id="messagesContainer"><div class="loading">Loading messages...</div></div>
<div class="ek" id="emojiKeyboard">
<div class="eg" id="emojiGrid"></div>
</div>
<div class="ic">
<div class="umc" id="unreadMsgCounter" style="display:none">
<button class="ua" onclick="scrollToBottom()">‚Üë</button>
<span class="uc" id="unreadCount">0 new messages</span>
<button class="da" onclick="scrollToTop()">‚Üë</button>
</div>
<div class="it">
<button class="ab" onclick="showFilePicker()">üìé</button>
<div class="mitw">
<textarea class="mi" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
</div>
<button class="ab" onclick="toggleEmoji()" id="emojiBtn">üòä</button>
<button class="sb" id="sendBtn" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</div>
</div>
</div>
<div class="ctx" id="contextMenu"></div>
<div class="mm" id="menuModal">
<div class="mmc">
<div class="mmt">Chat Options</div>
<div class="mmi" onclick="muteNotifications()">üîî Mute Notifications</div>
<div class="mmi" onclick="deleteChat()">üóëÔ∏è Delete Chat</div>
<div class="mmi" onclick="changeTheme()">üé® Change Theme</div>
<div class="mmi" onclick="closeMenu()">‚úñÔ∏è Close</div>
</div>
</div>
<script>
const SUPABASE_URL='https://bhmycvrbucmbbrpzeane.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null,chatId=null,otherUser=null,chatType=null,selectedMsgId=null,unreadMsgCount=0,lastScrollHeight=0;
const emojis=['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','‚ò∫Ô∏è','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];
(function(){const themes={purple:{primary:'#667eea',secondary:'#764ba2'},blue:{primary:'#4facfe',secondary:'#00f2fe'},pink:{primary:'#f093fb',secondary:'#f5576c'},green:{primary:'#43e97b',secondary:'#38f9d7'},orange:{primary:'#fa709a',secondary:'#fee140'},red:{primary:'#ff6b6b',secondary:'#ee5a6f'},teal:{primary:'#2bcbba',secondary:'#45caff'},indigo:{primary:'#4776e6',secondary:'#8e54e9'}};const theme=localStorage.getItem('nandigram_theme')||'purple';if(themes[theme]){document.documentElement.style.setProperty('--pc',themes[theme].primary);document.documentElement.style.setProperty('--sc',themes[theme].secondary)}})();
async function init(){await checkAuth();if(!currentUser){window.location.href='login.html';return}const params=new URLSearchParams(window.location.search);chatId=params.get('chat');if(!chatId){window.location.href='ngm-chats.html';return}await loadChat();await loadMessages();subscribeToMessages();setInterval(()=>updatePresence(),10000);initEmojis();lastScrollHeight=document.getElementById('messagesContainer').scrollHeight}
async function checkAuth(){const{data:{user}}=await sb.auth.getUser();if(user){currentUser=user}else{currentUser=null;window.location.href='login.html'}}
async function loadChat(){try{const{data:chat}=await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();if(!chat)return;chatType=chat.chat_type;if(chatType==='personal'){const otherUserId=chat.user1_id===currentUser.id?chat.user2_id:chat.user1_id;const{data:user}=await sb.from('ngm_users').select('*').eq('user_id',otherUserId).single();otherUser=user;if(user){document.getElementById('chatTitle').textContent=user.full_name||user.mobile||'Unknown';const initial=user.full_name?user.full_name.charAt(0).toUpperCase():'?';document.getElementById('chatAvatar').innerHTML=user.profile_picture_url?`<img src="${user.profile_picture_url}">`:`<span>${initial}</span>`;updateUserStatus(user)}}else if(chatType==='group'){const{data:group}=await sb.from('ngm_groups').select('*').eq('chat_id',chatId).single();if(group){document.getElementById('chatTitle').textContent=group.group_name;document.getElementById('chatAvatar').innerHTML='üë•';const{data:members}=await sb.from('ngm_chat_participants').select('*',{count:'exact'}).eq('chat_id',chatId).eq('is_active',true);document.getElementById('chatStatus').textContent=`${members.length||0} members`}}else if(chatType==='channel'){const{data:channel}=await sb.from('ngm_channels').select('*').eq('chat_id',chatId).single();if(channel){document.getElementById('chatTitle').textContent=channel.channel_name;document.getElementById('chatAvatar').innerHTML='üì¢';document.getElementById('chatStatus').textContent=`${channel.subscriber_count||0} subscribers`}}}catch(e){console.error(e)}}
function updateUserStatus(user){if(user.is_online){document.getElementById('chatStatus').textContent='online'}else if(user.last_seen){const lastSeen=new Date(user.last_seen);const now=new Date();const diff=now-lastSeen;if(diff<60000){document.getElementById('chatStatus').textContent='last seen just now'}else if(diff<3600000){document.getElementById('chatStatus').textContent='last seen '+Math.floor(diff/60000)+' min ago'}else if(diff<86400000){document.getElementById('chatStatus').textContent='last seen '+Math.floor(diff/3600000)+' hr ago'}else{document.getElementById('chatStatus').textContent='last seen '+Math.floor(diff/86400000)+' days ago'}}else{document.getElementById('chatStatus').textContent='offline'}}
async function loadMessages(){try{const{data:messages}=await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});renderMessages(messages||[]);await markMessagesAsRead()}catch(e){console.error(e);document.getElementById('messagesContainer').innerHTML='<div class="empty">Error loading messages</div>'}}
function renderMessages(messages){const container=document.getElementById('messagesContainer');if(messages.length===0){container.innerHTML='<div class="empty">No messages yet. Start the conversation!</div>';return}container.innerHTML=messages.map(msg=>{const isSent=msg.sender_id===currentUser.id;const time=new Date(msg.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});const content=msg.is_deleted?'<i>Message deleted</i>':msg.content;const isEmojiOnly=/^[\p{Emoji}\s]+$/u.test(msg.content)&&msg.content.length<=10;const emojiClass=isEmojiOnly?' emoji-only':'';return`<div class="m ${isSent?'sent':'received'}" data-mid="${msg.message_id}" oncontextmenu="showContextMenu(event,'${msg.message_id}',${isSent})"><div class="mb${emojiClass}"><div class="mt">${content}</div>${!isEmojiOnly?`<div class="mti">${time}</div>`:''}</div></div>`}).join('');const oldScrollHeight=lastScrollHeight;container.scrollTop=container.scrollHeight;const newScrollHeight=container.scrollHeight;if(newScrollHeight>oldScrollHeight&&newScrollHeight-oldScrollHeight>100){showUnreadCounter()}lastScrollHeight=newScrollHeight}
function showUnreadCounter(){unreadMsgCount++;document.getElementById('unreadCount').textContent=unreadMsgCount+' new message'+(unreadMsgCount>1?'s':'');document.getElementById('unreadMsgCounter').style.display='flex'}
function scrollToBottom(){const container=document.getElementById('messagesContainer');container.scrollTop=container.scrollHeight;unreadMsgCount=0;document.getElementById('unreadMsgCounter').style.display='none'}
function scrollToTop(){const container=document.getElementById('messagesContainer');container.scrollTop=0}
async function sendMessage(){const input=document.getElementById('messageInput');const text=input.value.trim();if(!text)return;try{const{error}=await sb.from('ngm_messages').insert({chat_id:chatId,sender_id:currentUser.id,content:text,message_type:'text',created_at:new Date().toISOString()});if(!error){await sb.from('ngm_chats').update({last_message_at:new Date().toISOString()}).eq('chat_id',chatId);input.value='';input.style.height='auto';await loadMessages()}}catch(e){console.error(e)}}
async function markMessagesAsRead(){try{await sb.from('ngm_chat_participants').update({unread_count:0,last_read_message_id:null}).eq('chat_id',chatId).eq('user_id',currentUser.id)}catch(e){console.error(e)}}
async function updatePresence(){try{await sb.from('ngm_users').update({last_seen:new Date().toISOString(),is_online:true}).eq('user_id',currentUser.id)}catch(e){console.error(e)}}
function showContextMenu(e,msgId,isSent){e.preventDefault();selectedMsgId=msgId;const ctx=document.getElementById('contextMenu');ctx.innerHTML='<div class="cti" onclick="copyMessage()">Copy</div>'+(isSent?'<div class="cti" onclick="deleteMessage()">Delete</div>':'');ctx.style.left=e.pageX+'px';ctx.style.top=e.pageY+'px';ctx.classList.add('show')}
async function deleteMessage(){document.getElementById('contextMenu').classList.remove('show');if(selectedMsgId){await sb.from('ngm_messages').update({is_deleted:true,deleted_at:new Date().toISOString()}).eq('message_id',selectedMsgId);await loadMessages()}}
function copyMessage(){document.getElementById('contextMenu').classList.remove('show');const msgElement=document.querySelector(`[data-mid="${selectedMsgId}"] .mt`);if(msgElement)navigator.clipboard.writeText(msgElement.textContent)}
function toggleEmoji(){document.getElementById('emojiKeyboard').classList.toggle('show')}
function initEmojis(){const grid=document.getElementById('emojiGrid');grid.innerHTML=emojis.map(e=>`<div class="ee" onclick="addEmoji('${e}')">${e}</div>`).join('')}
function addEmoji(emoji){const input=document.getElementById('messageInput');input.value+=emoji;input.focus();document.getElementById('emojiKeyboard').classList.remove('show')}
function showFilePicker(){alert('File picker: Photo, Video, Document, Location')}
function showMenu(){document.getElementById('menuModal').classList.add('show')}
function closeMenu(){document.getElementById('menuModal').classList.remove('show')}
function muteNotifications(){alert('Notifications muted for this chat');closeMenu()}
async function deleteChat(){if(confirm('Delete this chat?')){try{await sb.from('ngm_messages').delete().eq('chat_id',chatId);await sb.from('ngm_chat_participants').delete().eq('chat_id',chatId);await sb.from('ngm_chats').delete().eq('chat_id',chatId);window.location.href='ngm-chats.html'}catch(e){console.error(e);alert('Error deleting chat')}}}
function changeTheme(){const themes=['purple','blue','pink','green','orange','red','teal','indigo'];const choice=prompt('Choose theme:\n'+themes.map((t,i)=>(i+1)+'. '+t).join('\n'));if(choice&&themes[parseInt(choice)-1]){localStorage.setItem('nandigram_theme',themes[parseInt(choice)-1]);location.reload()}}
function openUserInfo(){if(otherUser)window.location.href='ngm-user-info.html?user='+otherUser.user_id}
function subscribeToMessages(){sb.channel('messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${chatId}`},()=>loadMessages()).subscribe()}
function goBack(){window.location.href='ngm-chats.html'}
const messageInput=document.getElementById('messageInput');messageInput.addEventListener('input',function(){this.style.height='auto';this.style.height=this.scrollHeight+'px'});
messageInput.addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}});
document.addEventListener('click',()=>document.getElementById('contextMenu').classList.remove('show'));
document.addEventListener('copy',e=>e.preventDefault());
document.addEventListener('paste',e=>e.preventDefault());
init();
</script>
</body>
</html>
