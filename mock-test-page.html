<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8" />
  <title>STI Mock Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      padding: 0;
    }

    header {
      background: #1a237e;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    .student-name {
      font-size: 14px;
      margin-top: 4px;
      opacity: 0.9;
    }

    .home-btn {
      margin-top: 8px;
      display: inline-block;
      padding: 6px 12px;
      background: white;
      color: #1a237e;
      border-radius: 6px;
      font-size: 13px;
      text-decoration: none;
      font-weight: 600;
    }

    .container {
      padding: 16px;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .info {
      font-size: 14px;
      color: #444;
      margin-bottom: 4px;
    }

    .buy-btn, .start-btn {
      margin-top: 10px;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .buy-btn {
      background: #1a237e;
      color: white;
    }

    .start-btn {
      background: #00c853;
      color: white;
    }

    footer {
      text-align: center;
      padding: 20px;
      margin-top: 20px;
    }

    .wa-btn {
      background: #25d366;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
    }
  </style>
</head>

<body>

<header>
  STI Mock Test Prelims
  <div class="student-name" id="studentName">Student Name</div>
  <a href="index.html" class="home-btn">Go to Home</a>
</header>

<div class="container" id="cardsContainer"></div>

<footer>
  <a class="wa-btn" href="https://wa.me/919925858057">Whatsapp</a>
</footer>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ✅ CONFIG
  const supabaseUrl = "https://bhmycvrbucmbbrpzeane.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";

  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const CREATE_ORDER_URL = "https://bhmycvrbucmbbrpzeane.supabase.co/functions/v1/creat-order";
  const VERIFY_PAYMENT_URL = "https://bhmycvrbucmbbrpzeane.supabase.co/functions/v1/verify-payment"; // placeholder

  const RAZORPAY_KEY = "rzp_test_123456789"; // replace later

  const TEST_PAGES = [
    "mock-test-1.html",
    "mock-test-2.html",
    "mock-test-3.html",
    "mock-test-4.html",
    "mock-test-5.html"
  ];

  const TEST_NAMES = [
    "STI Mock Test 1",
    "STI Mock Test 2",
    "STI Mock Test 3",
    "STI Mock Test 4",
    "STI Mock Test 5"
  ];

  let CURRENT_USER = null;

  // ✅ Load user
  async function loadUser() {
    const { data } = await supabaseClient.auth.getUser();
    if (!data.user) {
      alert("User not logged in");
      return;
    }
    CURRENT_USER = data.user;

    document.getElementById("studentName").innerText = data.user.email;
    loadCards();
  }

  // ✅ Load cards with purchase status
  async function loadCards() {
    const container = document.getElementById("cardsContainer");
    container.innerHTML = "";

    for (let i = 0; i < 5; i++) {
      const plan = `sti_mock_test_${i+1}`;

      const { data: access } = await supabaseClient
        .from("user_access")
        .select("*")
        .eq("user_id", CURRENT_USER.id)
        .eq("plan_name", plan)
        .eq("is_active", true)
        .maybeSingle();

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="card-title">${TEST_NAMES[i]}</div>
        <div class="info">200 Marks</div>
        <div class="info">2 Hours</div>
        <div class="info">Negative Marking -0.33</div>
      `;

      if (access) {
        const btn = document.createElement("button");
        btn.className = "start-btn";
        btn.innerText = "Already Purchased – Start Test";
        btn.onclick = () => {
          window.location.href = TEST_PAGES[i];
        };
        card.appendChild(btn);
      } else {
        const btn = document.createElement("button");
        btn.className = "buy-btn";
        btn.innerText = "Buy & Start";
        btn.onclick = () => startPayment(i+1, plan);
        card.appendChild(btn);
      }

      container.appendChild(card);
    }
  }

  // ✅ Payment Flow
  async function startPayment(testNumber, planName) {
    const orderRes = await fetch(CREATE_ORDER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amount: 49900,
        currency: "INR",
        user_id: CURRENT_USER.id,
        plan_name: planName
      })
    });

    const order = await orderRes.json();

    const options = {
      key: RAZORPAY_KEY,
      amount: order.amount,
      currency: order.currency,
      name: "STI Mock Test",
      description: planName,
      order_id: order.order_id,

      handler: async function (response) {
        await fetch(VERIFY_PAYMENT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature,
            user_id: CURRENT_USER.id,
            plan_name: planName
          })
        });

        window.location.href = TEST_PAGES[testNumber - 1];
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  }

  loadUser();
</script>

</body>
</html>
