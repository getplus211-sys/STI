<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Beginners - Quiz System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@300;400;600;700&display=swap');
        body { font-family: 'Hind Vadodara', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(102,126,234,0.4); }
        .quiz-option { transition: all 0.3s; cursor: pointer; }
        .quiz-option:hover { transform: translateX(5px); }
        .quiz-option.selected { background: #667eea; color: white; }
        .quiz-option.correct { background: #10B981; color: white; }
        .quiz-option.wrong { background: #EF4444; color: white; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .timer-warning { animation: pulse 1s infinite; }
    </style>
</head>
<body>
    <nav class="glass text-gray-800 p-4 shadow-xl flex justify-between items-center px-8 sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <div class="btn-primary text-white p-2 rounded-lg font-bold text-lg">LRD</div>
            <h1 class="text-xl font-bold">Beginners Quiz System</h1>
        </div>
        <div class="flex gap-4 items-center">
            <span id="userName" class="text-sm font-semibold"></span>
            <button onclick="logout()" class="btn-primary text-white px-4 py-2 rounded-full text-sm">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>

    <!-- HOME PAGE: Subject/Chapter Selection -->
    <div id="homePage" class="max-w-6xl mx-auto p-8">
        <div class="glass rounded-2xl p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ક્વિઝ શરૂ કરો</h2>
            <p class="text-gray-600">વિષય અને ચેપ્ટર પસંદ કરો</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="glass rounded-xl p-6">
                <label class="block text-sm font-bold text-gray-700 mb-3">વિષય પસંદ કરો</label>
                <select id="subjectSelect" onchange="loadChapters()" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold">
                    <option value="">વિષય પસંદ કરો...</option>
                </select>
            </div>

            <div class="glass rounded-xl p-6">
                <label class="block text-sm font-bold text-gray-700 mb-3">ચેપ્ટર પસંદ કરો</label>
                <select id="chapterSelect" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold" disabled>
                    <option value="">પહેલા વિષય પસંદ કરો...</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="glass rounded-xl p-6">
                <label class="block text-sm font-bold text-gray-700 mb-3">પ્રશ્નોની સંખ્યા</label>
                <input type="number" id="questionCount" value="10" min="5" max="50" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold text-center">
            </div>

            <div class="glass rounded-xl p-6">
                <label class="block text-sm font-bold text-gray-700 mb-3">સમય (મિનિટ)</label>
                <input type="number" id="timeLimit" value="15" min="5" max="60" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold text-center">
            </div>

            <div class="glass rounded-xl p-6">
                <label class="block text-sm font-bold text-gray-700 mb-3">લેવલ</label>
                <select id="difficultyLevel" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold">
                    <option value="">બધા</option>
                    <option value="સરળ">સરળ</option>
                    <option value="મધ્યમ">મધ્યમ</option>
                    <option value="હાર્ડ">હાર્ડ</option>
                </select>
            </div>
        </div>

        <button onclick="startQuiz()" class="w-full btn-primary text-white p-4 rounded-xl text-xl font-bold">
            <i class="fas fa-play-circle mr-2"></i> ક્વિઝ શરૂ કરો
        </button>

        <!-- Recent Tests -->
        <div class="glass rounded-2xl p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-history mr-2"></i>તમારા તાજેતરના ટેસ્ટ</h3>
            <div id="recentTests" class="space-y-3"></div>
        </div>
    </div>

    <!-- QUIZ PAGE -->
    <div id="quizPage" style="display:none;" class="max-w-6xl mx-auto p-8">
        <!-- Timer and Progress -->
        <div class="glass rounded-xl p-4 mb-6 flex justify-between items-center">
            <div class="flex gap-6">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">સમય બાકી</p>
                    <p id="timerDisplay" class="text-2xl font-black text-blue-600">15:00</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">પ્રશ્ન</p>
                    <p class="text-2xl font-black text-gray-800"><span id="currentQ">1</span> / <span id="totalQ">10</span></p>
                </div>
            </div>
            <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition">
                <i class="fas fa-check-circle mr-2"></i> સબમિટ કરો
            </button>
        </div>

        <!-- Question Card -->
        <div class="glass rounded-2xl p-8 mb-6">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-2xl font-bold text-gray-800">પ્રશ્ન <span id="qNum">1</span></h3>
                <div class="flex gap-2">
                    <span id="difficultyBadge" class="px-3 py-1 rounded-full text-sm font-bold">સરળ</span>
                    <button onclick="bookmarkQuestion()" class="text-yellow-500 hover:text-yellow-600 text-2xl">
                        <i id="bookmarkIcon" class="far fa-bookmark"></i>
                    </button>
                </div>
            </div>
            
            <p id="questionText" class="text-xl text-gray-700 mb-8 leading-relaxed"></p>
            
            <div id="optionsContainer" class="space-y-3"></div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between items-center mb-6">
            <button onclick="prevQuestion()" id="prevBtn" class="glass px-6 py-3 rounded-lg font-bold text-gray-700 hover:bg-gray-100" disabled>
                <i class="fas fa-chevron-left mr-2"></i> પહેલાંનો
            </button>
            <div class="flex gap-2 flex-wrap justify-center" id="questionNav"></div>
            <button onclick="nextQuestion()" id="nextBtn" class="glass px-6 py-3 rounded-lg font-bold text-gray-700 hover:bg-gray-100">
                આગળ <i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- RESULT PAGE -->
    <div id="resultPage" style="display:none;" class="max-w-4xl mx-auto p-8">
        <div class="glass rounded-2xl p-8 text-center mb-8">
            <div class="text-6xl mb-4"><i class="fas fa-trophy text-yellow-500"></i></div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ક્વિઝ પૂર્ણ થઈ!</h2>
            <p id="scoreDisplay" class="text-6xl font-black text-blue-600 my-6">0/10</p>
            <p id="percentageDisplay" class="text-2xl font-bold text-gray-700">0%</p>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="glass rounded-xl p-6 text-center">
                <p class="text-sm text-gray-500 mb-2">સાચા જવાબ</p>
                <p id="correctCount" class="text-3xl font-black text-green-600">0</p>
            </div>
            <div class="glass rounded-xl p-6 text-center">
                <p class="text-sm text-gray-500 mb-2">ખોટા જવાબ</p>
                <p id="wrongCount" class="text-3xl font-black text-red-600">0</p>
            </div>
            <div class="glass rounded-xl p-6 text-center">
                <p class="text-sm text-gray-500 mb-2">બાકી</p>
                <p id="skippedCount" class="text-3xl font-black text-gray-400">0</p>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="viewDashboard()" class="flex-1 btn-primary text-white p-4 rounded-xl font-bold">
                <i class="fas fa-chart-line mr-2"></i> Dashboard જુઓ
            </button>
            <button onclick="location.reload()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-xl font-bold">
                <i class="fas fa-redo mr-2"></i> નવી ક્વિઝ
            </button>
        </div>
    </div>

    <script>
        const sb = window.supabase.createClient(
            'https://bhmycvrbucmbbrpzeane.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4'
        );

        let currentUser = null;
        let allSubjects = [];
        let allChapters = [];
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval = null;
        let timeRemaining = 0;
        let testStartTime = null;
        let currentTestId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadSubjects();
            await loadRecentTests();
        });

        async function checkAuth() {
            const { data: { user }, error } = await sb.auth.getUser();
            if (error || !user) {
                alert('તમે login નથી! કૃપા કરીને login કરો.');
                // Redirect to login
                return;
            }
            currentUser = user;
            
            // Load user name
            const { data: profile } = await sb.from('profiles').select('full_name').eq('id', user.id).single();
            if (profile) {
                document.getElementById('userName').textContent = profile.full_name || user.email;
            }
        }

        async function loadSubjects() {
            const { data, error } = await sb.from('lrd_subjects').select('*').order('name');
            if (error) {
                console.error('Error loading subjects:', error);
                return;
            }
            allSubjects = data;
            const select = document.getElementById('subjectSelect');
            data.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                select.appendChild(option);
            });
        }

        async function loadChapters() {
            const subjectId = document.getElementById('subjectSelect').value;
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.innerHTML = '<option value="">ચેપ્ટર પસંદ કરો...</option>';
            
            if (!subjectId) {
                chapterSelect.disabled = true;
                return;
            }
            
            const { data, error } = await sb.from('lrd_chapters').select('*').eq('subject_id', subjectId).order('name');
            if (error) {
                console.error('Error loading chapters:', error);
                return;
            }
            
            chapterSelect.disabled = false;
            data.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                chapterSelect.appendChild(option);
            });
        }

        async function loadRecentTests() {
            if (!currentUser) return;
            
            const { data, error } = await sb.from('lrd_results')
                .select('test_id, created_at, lrd_subjects(name)')
                .eq('student_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(5);
            
            if (error || !data || data.length === 0) return;
            
            // Group by test_id
            const tests = {};
            data.forEach(r => {
                if (!tests[r.test_id]) {
                    tests[r.test_id] = {
                        test_id: r.test_id,
                        date: new Date(r.created_at).toLocaleDateString('gu-IN'),
                        subject: r.lrd_subjects?.name || 'Unknown'
                    };
                }
            });
            
            const container = document.getElementById('recentTests');
            Object.values(tests).slice(0, 5).forEach(t => {
                container.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold text-gray-800">${t.subject}</p>
                            <p class="text-sm text-gray-500">${t.date}</p>
                        </div>
                        <a href="lrd_dashboard_fixed.html" class="text-blue-600 hover:text-blue-700 font-semibold">જુઓ →</a>
                    </div>
                `;
            });
        }

        async function startQuiz() {
            const subjectId = document.getElementById('subjectSelect').value;
            const chapterId = document.getElementById('chapterSelect').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const timeLimitMinutes = parseInt(document.getElementById('timeLimit').value);
            const difficulty = document.getElementById('difficultyLevel').value;

            if (!subjectId) {
                alert('કૃપા કરીને વિષય પસંદ કરો!');
                return;
            }

            // Load questions
            let query = sb.from('lrd_questions').select('*').eq('subject_id', subjectId);
            
            if (chapterId) {
                query = query.eq('chapter_id', chapterId);
            }
            
            if (difficulty) {
                query = query.eq('difficulty_level', difficulty);
            }
            
            const { data, error } = await query.limit(questionCount);
            
            if (error || !data || data.length === 0) {
                alert('પ્રશ્નો મળ્યા નથી! કૃપા કરીને બીજું selection કરો.');
                return;
            }

            quizQuestions = data;
            userAnswers = new Array(data.length).fill(null).map((_, i) => ({
                questionIndex: i,
                selectedAnswer: null,
                isBookmarked: false,
                timeSpent: 0,
                startTime: Date.now()
            }));

            // Create test record
            const { data: testData, error: testError } = await sb.from('lrd_tests').insert({
                title: `${document.getElementById('subjectSelect').selectedOptions[0].text} Quiz`,
                total_marks: data.length,
                target_score: Math.ceil(data.length * 0.7),
                duration_minutes: timeLimitMinutes
            }).select().single();

            if (!testError && testData) {
                currentTestId = testData.id;
            }

            // Start quiz
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('quizPage').style.display = 'block';
            document.getElementById('totalQ').textContent = data.length;
            
            timeRemaining = timeLimitMinutes * 60;
            testStartTime = Date.now();
            startTimer();
            renderQuestion();
            renderQuestionNav();
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                }
                updateTimerDisplay();
                
                // Warning at 2 minutes
                if (timeRemaining === 120) {
                    document.getElementById('timerDisplay').classList.add('timer-warning', 'text-red-600');
                    alert('⚠️ માત્ર 2 મિનિટ બાકી!');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            const answer = userAnswers[currentQuestionIndex];
            
            // Update time spent on previous question
            if (currentQuestionIndex > 0) {
                const prevAnswer = userAnswers[currentQuestionIndex - 1];
                prevAnswer.timeSpent += Math.floor((Date.now() - prevAnswer.startTime) / 1000);
            }
            
            // Start timing current question
            answer.startTime = Date.now();
            
            document.getElementById('qNum').textContent = currentQuestionIndex + 1;
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('questionText').textContent = q.question_text;
            
            // Difficulty badge
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = q.difficulty_level;
            badge.className = 'px-3 py-1 rounded-full text-sm font-bold ' + 
                (q.difficulty_level === 'સરળ' ? 'bg-green-100 text-green-700' :
                 q.difficulty_level === 'મધ્યમ' ? 'bg-yellow-100 text-yellow-700' :
                 'bg-red-100 text-red-700');
            
            // Bookmark icon
            document.getElementById('bookmarkIcon').className = 
                answer.isBookmarked ? 'fas fa-bookmark' : 'far fa-bookmark';
            
            // Render options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            const options = ['A', 'B', 'C', 'D', 'E'].filter(opt => q[`option_${opt.toLowerCase()}`]);
            
            options.forEach(opt => {
                const isSelected = answer.selectedAnswer === opt;
                const div = document.createElement('div');
                div.className = `quiz-option glass p-4 rounded-lg font-semibold text-lg ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `<span class="font-bold mr-3">${opt}.</span> ${q[`option_${opt.toLowerCase()}`]}`;
                div.onclick = () => selectOption(opt);
                optionsContainer.appendChild(div);
            });
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === quizQuestions.length - 1;
        }

        function selectOption(option) {
            userAnswers[currentQuestionIndex].selectedAnswer = option;
            renderQuestion();
            renderQuestionNav();
        }

        function bookmarkQuestion() {
            userAnswers[currentQuestionIndex].isBookmarked = !userAnswers[currentQuestionIndex].isBookmarked;
            renderQuestion();
            renderQuestionNav();
        }

        function renderQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            quizQuestions.forEach((_, i) => {
                const answer = userAnswers[i];
                const btn = document.createElement('button');
                btn.className = 'w-10 h-10 rounded-lg font-bold ' + 
                    (answer.selectedAnswer ? 'bg-blue-600 text-white' : 
                     answer.isBookmarked ? 'bg-yellow-100 border-2 border-yellow-500 text-yellow-700' :
                     'bg-gray-200 text-gray-700');
                btn.textContent = i + 1;
                btn.onclick = () => goToQuestion(i);
                nav.appendChild(btn);
            });
        }

        function goToQuestion(index) {
            currentQuestionIndex = index;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        }

        async function submitQuiz() {
            if (!confirm('શું તમે ક્વિઝ સબમિટ કરવા માંગો છો?')) {
                return;
            }
            
            clearInterval(timerInterval);
            
            // Calculate final time for last question
            const lastAnswer = userAnswers[currentQuestionIndex];
            lastAnswer.timeSpent += Math.floor((Date.now() - lastAnswer.startTime) / 1000);
            
            // Calculate results
            let correct = 0, wrong = 0, skipped = 0;
            
            // Save results to database
            const resultsToInsert = [];
            
            for (let i = 0; i < quizQuestions.length; i++) {
                const q = quizQuestions[i];
                const answer = userAnswers[i];
                const isCorrect = answer.selectedAnswer === q.correct_option;
                const isAttempted = answer.selectedAnswer !== null;
                
                if (isAttempted) {
                    if (isCorrect) correct++;
                    else wrong++;
                } else {
                    skipped++;
                }
                
                resultsToInsert.push({
                    student_id: currentUser.id,
                    test_id: currentTestId,
                    question_id: q.id,
                    subject_id: q.subject_id,
                    chapter_id: q.chapter_id,
                    question_text: q.question_text,
                    option_a: q.option_a,
                    option_b: q.option_b,
                    option_c: q.option_c,
                    option_d: q.option_d,
                    option_e: q.option_e,
                    correct_option: q.correct_option,
                    student_answer: answer.selectedAnswer,
                    is_correct: isCorrect,
                    is_attempted: isAttempted,
                    difficulty_level: q.difficulty_level,
                    ideal_time_seconds: q.ideal_time_seconds || 30,
                    time_taken_seconds: answer.timeSpent,
                    time_efficiency_percentage: ((answer.timeSpent / (q.ideal_time_seconds || 30)) * 100).toFixed(2),
                    marks_obtained: isCorrect ? 1 : 0,
                    marks_allocated: 1,
                    question_number: i + 1,
                    total_questions: quizQuestions.length,
                    is_bookmarked: answer.isBookmarked
                });
            }
            
            // Insert results
            const { error } = await sb.from('lrd_results').insert(resultsToInsert);
            if (error) {
                console.error('Error saving results:', error);
                alert('Error saving results: ' + error.message);
            }
            
            // Show result page
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('resultPage').style.display = 'block';
            
            document.getElementById('scoreDisplay').textContent = `${correct}/${quizQuestions.length}`;
            document.getElementById('percentageDisplay').textContent = ((correct / quizQuestions.length) * 100).toFixed(1) + '%';
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('skippedCount').textContent = skipped;
        }

        function viewDashboard() {
            window.location.href = 'lrd_dashboard_fixed.html';
        }

        async function logout() {
            const { error } = await sb.auth.signOut();
            if (error) alert('Logout error: ' + error.message);
            else window.location.reload();
        }
    </script>
</body>
</html>
