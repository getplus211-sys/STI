<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NGM Chats - Pure Logic</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --ios-header: 90px;
            --ios-footer: 40px;
            --tg-blue: #0088cc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
            background-color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        /* Layout Architecture */
        .app-header {
            height: var(--ios-header);
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 448px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            z-index: 1000;
            border-bottom: 0.5px solid #d1d1d1;
            display: flex;
            align-items: flex-end;
            padding: 0 16px 12px;
        }

        .app-footer {
            height: var(--ios-footer);
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 448px;
            background: #f9f9f9;
            z-index: 1000;
            border-top: 0.5px solid #d1d1d1;
            display: flex;
            align-items: flex-start;
            padding-top: 6px;
        }

        .scroll-container {
            margin-top: var(--ios-header);
            margin-bottom: var(--ios-footer);
            min-height: calc(100vh - var(--ios-header) - var(--ios-footer));
            overflow-y: auto;
        }

        /* Chat Row Styles */
        .chat-row {
            display: flex;
            padding: 10px 16px;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 0.5px solid #f2f2f2;
        }

        .chat-row:active {
            background-color: #e5e5ea;
        }

        .avatar-circle {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #5AC8FA 0%, #007AFF 100%);
        }

        .search-box {
            background-color: #7676801F;
            border-radius: 10px;
            padding: 8px 12px 8px 35px;
            font-size: 16px;
            width: 100%;
            outline: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex justify-center bg-gray-50">

    <div class="w-full max-w-md bg-white min-h-screen shadow-2xl relative flex flex-col">
        
        <header class="app-header">
            <div class="flex justify-between items-center w-full">
                <button class="text-[#007AFF] text-[17px]">Edit</button>
                <h1 class="font-bold text-[17px]">Chats</h1>
                <button class="text-[#007AFF]">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
            </div>
        </header>

        <div class="scroll-container no-scrollbar">
            <div class="p-3">
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
                    <input type="text" id="searchInput" placeholder="Search" class="search-box">
                </div>
            </div>

            <div id="loader" class="flex flex-col items-center py-20 text-gray-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-2"></div>
                <p class="text-xs">Original àª¡à«‡àªŸàª¾ àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«‹ àª›à«‡...</p>
            </div>

            <div id="chatList"></div>

            <div id="emptyState" class="hidden py-20 text-center px-10">
                <p class="text-gray-400 text-sm">àª¤àª®àª¾àª°àª¾ 'ngm_chats' àªŸà«‡àª¬àª²àª®àª¾àª‚ àª•à«‹àªˆ àª¡à«‡àªŸàª¾ àª¨àª¥à«€.</p>
            </div>
        </div>

        <footer class="app-footer">
            <div class="flex justify-around items-center w-full text-[10px] font-bold text-[#8E8E93]">
                <div class="flex flex-col items-center"><span>CONTACTS</span></div>
                <div class="flex flex-col items-center"><span>CALLS</span></div>
                <div class="flex flex-col items-center text-[#007AFF]"><span>CHATS</span></div>
                <div class="flex flex-col items-center"><span>SETTINGS</span></div>
            </div>
        </footer>
    </div>

    <script>
        const API_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        
        const _supabase = supabase.createClient(API_URL, API_KEY);

        // 1. Initial Load
        async function fetchChats() {
            const { data, error } = await _supabase
                .from('ngm_chats')
                .select('*')
                .order('updated_at', { ascending: false });

            document.getElementById('loader').classList.add('hidden');

            if (error) {
                console.error("Fetch Error:", error);
                return;
            }

            if (!data || data.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            renderChats(data);
        }

        // 2. Dynamic UI Rendering
        function renderChats(chats) {
            const listContainer = document.getElementById('chatList');
            listContainer.innerHTML = chats.map(chat => {
                const initial = (chat.chat_type || 'U').charAt(0).toUpperCase();
                const timeStr = chat.updated_at ? new Date(chat.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                const title = chat.chat_type === 'group' ? 'NGM Project Group' : 'User: ' + chat.chat_id.substring(0, 6);

                return `
                <div class="chat-row" onclick="location.href='ngm-chat-window.html?chat_id=${chat.chat_id}'">
                    <div class="avatar-circle">${initial}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <h2 class="font-bold text-[16px] text-black truncate">${title}</h2>
                            <span class="text-[14px] text-gray-400">${timeStr}</span>
                        </div>
                        <p class="text-[14px] text-gray-500 truncate mt-0.5">
                            ${chat.chat_type} àªšà«‡àªŸ àªœà«‹àªµàª¾ àª®àª¾àªŸà«‡ àªŸà«‡àªª àª•àª°à«‹...
                        </p>
                    </div>
                </div>
                `;
            }).join('');
        }

        // 3. Search Functionality
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const term = e.target.value.toLowerCase();
            const { data } = await _supabase.from('ngm_chats').select('*');
            const filtered = data.filter(c => c.chat_id.toLowerCase().includes(term));
            renderChats(filtered);
        });

        // 4. Real-time Subscription
        function setupRealtime() {
            _supabase
                .channel('chat-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'ngm_chats' }, (payload) => {
                    fetchChats(); // Refresh on any change
                })
                .subscribe();
        }

        // Start
        window.onload = () => {
            fetchChats();
            setupRealtime();
        };
    </script>
</body>
</html>
