<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>LRD Quiz - Mock Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3{margin:8px 0}
button{border:none;border-radius:14px;padding:14px 20px;font-size:16px;width:100%;cursor:pointer;font-weight:600;transition:all .3s}
.primary{background:#22c55e;color:#fff}.primary:hover{background:#16a34a}
.gray{background:#e5e7eb;color:#334155}.gray:hover{background:#d1d5db}
.danger{background:#dc2626;color:#fff}.danger:hover{background:#b91c1c}
.option{border:2px solid #e5e7eb;border-radius:12px;padding:14px;margin:10px 0;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .3s}
.option:hover{border-color:#22c55e;background:#f0fdf4}
.option.selected{border-color:#22c55e;background:#f0fdf4}
.hidden{display:none}
#timer{font-weight:bold;color:#dc2626;font-size:1.3rem}
.nav-btns{display:flex;gap:12px;margin-top:20px}
.q-nav{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:20px}
.q-num{padding:12px;text-align:center;background:#f1f5f9;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:all .3s}
.q-num:hover{background:#e2e8f0}
.q-num.active{background:#22c55e;color:#fff}
.q-num.answered{background:#8b5cf6;color:#fff}
.chart-container{width:100%;max-width:300px;margin:20px auto}
.badge{padding:5px 10px;border-radius:8px;font-size:13px;font-weight:bold;text-transform:uppercase}
.badge-easy{background:#dcfce7;color:#166534}
.badge-medium{background:#fef9c3;color:#854d0e}
.badge-hard{background:#fee2e2;color:#991b1b}
.badge-àª¸àª°àª³{background:#dcfce7;color:#166534}
.badge-àª®àª§à«àª¯àª®{background:#fef9c3;color:#854d0e}
.badge-àª¹àª¾àª°à«àª¡{background:#fee2e2;color:#991b1b}
#modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
#modal-content{background:#fff;padding:28px;border-radius:20px;max-width:360px;width:90%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
.nav-bar{background:#1e40af;color:#fff;padding:16px 24px;box-shadow:0 4px 20px rgba(0,0,0,.15);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.nav-logo{background:#fff;color:#1e40af;padding:6px 12px;border-radius:8px;font-weight:bold;margin-right:12px}
.nav-btn{background:#2563eb;color:#fff;border:none;padding:10px 20px;border-radius:25px;font-size:14px;cursor:pointer;transition:all .3s}
.nav-btn:hover{background:#1d4ed8}
</style>
</head>
<body>
<div class="nav-bar">
  <div style="display:flex;align-items:center">
    <span class="nav-logo">LRD</span>
    <span style="font-size:18px;font-weight:bold">Mock Test</span>
  </div>
  <button class="nav-btn" onclick="goHome()">ğŸ  àª¹à«‹àª®</button>
</div>

<div id="modal-overlay">
  <div id="modal-content">
    <div id="modal-icon" style="font-size:56px;margin-bottom:16px"></div>
    <h3 id="modal-title" style="margin-bottom:12px;font-size:20px"></h3>
    <p id="modal-text" style="color:#64748b;margin-bottom:24px;line-height:1.6;font-size:15px"></p>
    <button id="modal-btn" class="primary" onclick="closeModal()">OK</button>
  </div>
</div>

<div id="setup-screen" class="container">
  <div class="card">
    <h2 id="setup-title">ğŸ“ Mock Test</h2>
    <p id="setup-desc" style="color:#64748b;font-size:15px">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</p>
    <div id="test-info" class="hidden">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:24px 0">
        <div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:2px solid #e2e8f0">
          <small style="color:#64748b;font-weight:600">àªªà«àª°àª¶à«àª¨à«‹</small>
          <div id="info-qcount" style="font-size:24px;font-weight:bold;color:#1e293b;margin-top:4px">-</div>
        </div>
        <div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:2px solid #e2e8f0">
          <small style="color:#64748b;font-weight:600">àª¸àª®àª¯</small>
          <div id="info-time" style="font-size:24px;font-weight:bold;color:#1e293b;margin-top:4px">-</div>
        </div>
        <div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:2px solid #e2e8f0">
          <small style="color:#64748b;font-weight:600">àª—à«àª£</small>
          <div id="info-marks" style="font-size:24px;font-weight:bold;color:#1e293b;margin-top:4px">-</div>
        </div>
      </div>
    </div>
    <button id="start-btn" class="primary hidden" onclick="startTest()">âœ¨ Start Test Now</button>
  </div>
</div>

<div id="quiz-screen" class="container hidden">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <span id="q-progress" style="font-weight:bold;font-size:18px">Question 1/10</span>
      <span id="timer" style="font-weight:bold;color:#dc2626;font-size:1.3rem">15:00</span>
    </div>
    <h3 id="question-text"></h3>
    <div id="options-container"></div>
    <div class="nav-btns">
      <button class="gray" onclick="prevQuestion()">â† àªªàª¾àª›àª³</button>
      <button id="next-btn" class="primary" onclick="nextQuestion()">àª†àª—àª³ â†’</button>
    </div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:16px">ğŸ“ Question Navigation</h3>
    <div class="q-nav" id="q-nav-grid"></div>
  </div>
</div>

<div id="result-screen" class="container hidden">
  <div class="card" style="text-align:center">
    <div style="font-size:80px;margin-bottom:16px">ğŸ‰</div>
    <h2 style="font-size:28px;margin-bottom:12px">àªŸà«‡àª¸à«àªŸ àªªà«‚àª°à«àª£ àª¥àªˆ!</h2>
    <div style="background:#f8fafc;border-radius:16px;padding:24px;margin:24px 0">
      <div style="font-size:48px;font-weight:900;color:#22c55e;margin-bottom:8px">
        <span id="result-score">0</span>/<span id="result-total">10</span>
      </div>
      <div style="font-size:24px;font-weight:bold;color:#64748b" id="result-percent">0%</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:24px 0">
      <div style="background:#dcfce7;padding:16px;border-radius:12px">
        <div style="font-size:32px;font-weight:bold;color:#166534" id="result-correct">0</div>
        <small style="color:#166534;font-weight:600">àª¸àª¾àªšàª¾</small>
      </div>
      <div style="background:#fee2e2;padding:16px;border-radius:12px">
        <div style="font-size:32px;font-weight:bold;color:#991b1b" id="result-wrong">0</div>
        <small style="color:#991b1b;font-weight:600">àª–à«‹àªŸàª¾</small>
      </div>
      <div style="background:#f1f5f9;padding:16px;border-radius:12px">
        <div style="font-size:32px;font-weight:bold;color:#64748b" id="result-skipped">0</div>
        <small style="color:#64748b;font-weight:600">àª¬àª¾àª•à«€</small>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="resultChart"></canvas>
    </div>
    <button class="primary" onclick="viewPerformance()">ğŸ“Š Performance Dashboard àªœà«àª“</button>
    <button class="gray" onclick="goHome()" style="margin-top:12px">ğŸ  àª¹à«‹àª®</button>
  </div>
</div>

<script>
const sb=window.supabase.createClient('https://bhmycvrbucmbbrpzeane.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4');

let user,testInfo,questions=[],currentIndex=0,userAnswers=[],questionTimes=[],timeLeft,startTime,questionStartTime,timerInterval,isSubmitting=false;

(async()=>{
  const params=new URLSearchParams(window.location.search);
  const testId=params.get('test_id');
  if(!testId){alertModal('âŒ','Error','Test ID àª¨àª¥à«€ àª®àª³à«€');return}
  
  const{data:{user:u}}=await sb.auth.getUser();
  if(!u){alertModal('âŒ','Login àªœàª°à«‚àª°à«€','àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ login àª•àª°à«‹');return}
  user=u;
  
  try{
    // Load test
    const{data:test}=await sb.from('lrd_tests').select('*').eq('id',testId).single();
    if(!test){alertModal('âŒ','Error','Test àª¨àª¥à«€ àª®àª³à«€');return}
    testInfo=test;
    
    // Load questions
    const{data:qs}=await sb.from('lrd_questions').select('*,lrd_subjects(name),lrd_chapters(name)').eq('subject_id',test.subject_id).limit(test.total_questions||10);
    if(!qs||qs.length===0){alertModal('âŒ','Error','àªªà«àª°àª¶à«àª¨à«‹ àª¨àª¥à«€ àª®àª³à«àª¯àª¾');return}
    questions=qs;
    userAnswers=new Array(qs.length).fill(null);
    questionTimes=new Array(qs.length).fill(0);
    
    // Check existing result
    const{data:existing}=await sb.from('lrd_results').select('test_id').eq('student_id',user.id).eq('test_id',testId).limit(1);
    if(existing&&existing.length>0){
      alertModal('â„¹ï¸','àªªàª¹à«‡àª²à«‡àª¥à«€ àª†àªªà«‡àª²','àª¤àª®à«‡ àª† test àªªàª¹à«‡àª²à«‡àª¥à«€ àª†àªªà«€ àªšà«‚àª•à«àª¯àª¾ àª›à«‹.',false);
      document.getElementById('start-btn').textContent='àª«àª°à«€àª¥à«€ àª†àªªà«‹';
    }
    
    document.getElementById('setup-title').innerText=test.title||'Mock Test';
    document.getElementById('setup-desc').innerText='àª¶à«àª‚ àª¤àª®à«‡ àª¤à«ˆàª¯àª¾àª° àª›à«‹?';
    document.getElementById('info-qcount').innerText=qs.length;
    document.getElementById('info-time').innerText=(test.duration_minutes||15)+' àª®àª¿àª¨àª¿àªŸ';
    document.getElementById('info-marks').innerText=test.total_marks||10;
    document.getElementById('test-info').classList.remove('hidden');
    document.getElementById('start-btn').classList.remove('hidden');
  }catch(err){
    console.error(err);
    alertModal('âŒ','Error','àª®àª¾àª¹àª¿àª¤à«€ àª²à«‹àª¡ àª•àª°àªµàª¾àª®àª¾àª‚ àª¸àª®àª¸à«àª¯àª¾: '+err.message);
  }
})();

function startTest(){
  document.getElementById('setup-screen').classList.add('hidden');
  document.getElementById('quiz-screen').classList.remove('hidden');
  const dur=testInfo.duration_minutes||15;
  timeLeft=dur*60;
  startTime=Date.now();
  questionStartTime=Date.now();
  renderQuestion();
  renderNav();
  timerInterval=setInterval(updateTimer,1000);
}

function updateTimer(){
  if(timeLeft<=0){
    alertModal('â°','àª¸àª®àª¯ àªªà«‚àª°à«‹','àª¤àª®àª¾àª°à«‹ àª¸àª®àª¯ àªªà«‚àª°à«‹ àª¥àª¯à«‹. àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª¥àªˆ àª°àª¹à«€ àª›à«‡...');
    setTimeout(submitTest,1500);
    return;
  }
  timeLeft--;
  const m=Math.floor(timeLeft/60),s=timeLeft%60;
  document.getElementById('timer').innerText=`${m}:${s<10?'0':''}${s}`;
}

function renderQuestion(){
  const q=questions[currentIndex];
  document.getElementById('q-progress').innerText=`Question ${currentIndex+1}/${questions.length}`;
  const diff=q.difficulty_level?`<span class="badge badge-${q.difficulty_level.toLowerCase()}">${q.difficulty_level}</span> `:'';
  document.getElementById('question-text').innerHTML=`${diff}${q.question_text}`;
  const cont=document.getElementById('options-container');
  cont.innerHTML='';
  const opts=[
    {key:'A',text:q.option_a},{key:'B',text:q.option_b},
    {key:'C',text:q.option_c},{key:'D',text:q.option_d}
  ];
  if(q.option_e)opts.push({key:'E',text:q.option_e});
  opts.forEach(o=>{
    if(!o.text)return;
    const div=document.createElement('div');
    div.className=`option ${userAnswers[currentIndex]===o.key?'selected':''}`;
    div.innerHTML=`<strong style="font-size:17px">${o.key}.</strong> <span style="font-size:15px">${o.text}</span>`;
    div.onclick=()=>{
      if(questionStartTime){
        questionTimes[currentIndex]+= Math.floor((Date.now()-questionStartTime)/1000);
      }
      userAnswers[currentIndex]=o.key;
      renderQuestion();
      renderNav();
      questionStartTime=Date.now();
    };
    cont.appendChild(div);
  });
  document.getElementById('next-btn').innerText=currentIndex===questions.length-1?'àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹':'àª†àª—àª³ â†’';
}

function renderNav(){
  const grid=document.getElementById('q-nav-grid');
  grid.innerHTML='';
  questions.forEach((_,i)=>{
    const d=document.createElement('div');
    d.className=`q-num ${i===currentIndex?'active':''} ${userAnswers[i]?'answered':''}`;
    d.innerText=i+1;
    d.onclick=()=>{
      if(questionStartTime){
        questionTimes[currentIndex]+=Math.floor((Date.now()-questionStartTime)/1000);
      }
      currentIndex=i;
      renderQuestion();
      renderNav();
      questionStartTime=Date.now();
    };
    grid.appendChild(d);
  });
}

function prevQuestion(){
  if(currentIndex>0){
    if(questionStartTime){
      questionTimes[currentIndex]+=Math.floor((Date.now()-questionStartTime)/1000);
    }
    currentIndex--;
    renderQuestion();
    renderNav();
    questionStartTime=Date.now();
  }
}

function nextQuestion(){
  if(currentIndex<questions.length-1){
    if(questionStartTime){
      questionTimes[currentIndex]+=Math.floor((Date.now()-questionStartTime)/1000);
    }
    currentIndex++;
    renderQuestion();
    renderNav();
    questionStartTime=Date.now();
  }else confirmSubmit();
}

function confirmSubmit(){
  alertModal('â“','àª¸àª¬àª®àª¿àªŸ àª•àª°à«€àª?','àª¶à«àª‚ àª¤àª®à«‡ àª–àª°à«‡àª–àª° àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?',true);
}

async function submitTest(){
  if(isSubmitting)return;
  isSubmitting=true;
  clearInterval(timerInterval);
  if(questionStartTime){
    questionTimes[currentIndex]+=Math.floor((Date.now()-questionStartTime)/1000);
  }
  
  let correct=0,wrong=0,skipped=0;
  const results=[];
  
  questions.forEach((q,i)=>{
    const ans=userAnswers[i];
    const isCorrect=ans===q.correct_option;
    const isAttempted=ans!==null&&ans!==undefined;
    
    if(isAttempted){isCorrect?correct++:wrong++}else{skipped++}
    
    results.push({
      student_id:user.id,
      test_id:testInfo.id,
      question_id:q.id,
      subject_id:q.subject_id,
      chapter_id:q.chapter_id,
      question_text:q.question_text,
      option_a:q.option_a,
      option_b:q.option_b,
      option_c:q.option_c,
      option_d:q.option_d,
      option_e:q.option_e,
      correct_option:q.correct_option,
      student_answer:ans,
      is_correct:isCorrect,
      is_attempted:isAttempted,
      difficulty_level:q.difficulty_level,
      ideal_time_seconds:q.ideal_time_seconds||30,
      time_taken_seconds:questionTimes[i]||0,
      marks_obtained:isCorrect?1:0,
      marks_allocated:1,
      question_number:i+1,
      total_questions:questions.length,
      is_bookmarked:false
    });
  });
  
  try{
    await sb.from('lrd_results').insert(results);
    showResults({correct,wrong,skipped,total:questions.length});
  }catch(err){
    console.error(err);
    alertModal('âŒ','Error','Results save àª•àª°àªµàª¾àª®àª¾àª‚ àª¸àª®àª¸à«àª¯àª¾: '+err.message);
    isSubmitting=false;
  }
}

function showResults(data){
  document.getElementById('quiz-screen').classList.add('hidden');
  document.getElementById('result-screen').classList.remove('hidden');
  document.getElementById('result-score').textContent=data.correct;
  document.getElementById('result-total').textContent=data.total;
  document.getElementById('result-percent').textContent=((data.correct/data.total)*100).toFixed(1)+'%';
  document.getElementById('result-correct').textContent=data.correct;
  document.getElementById('result-wrong').textContent=data.wrong;
  document.getElementById('result-skipped').textContent=data.skipped;
  
  new Chart(document.getElementById('resultChart'),{
    type:'doughnut',
    data:{
      labels:['àª¸àª¾àªšàª¾','àª–à«‹àªŸàª¾','àª¬àª¾àª•à«€'],
      datasets:[{
        data:[data.correct,data.wrong,data.skipped],
        backgroundColor:['#22c55e','#ef4444','#cbd5e1']
      }]
    },
    options:{plugins:{legend:{position:'bottom'}}}
  });
}

function alertModal(icon,title,text,isConfirm=false){
  document.getElementById('modal-icon').innerText=icon;
  document.getElementById('modal-title').innerText=title;
  document.getElementById('modal-text').innerText=text;
  if(isConfirm){
    document.getElementById('modal-btn').innerText='àª¹àª¾, àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹';
    document.getElementById('modal-btn').onclick=()=>{closeModal();submitTest()};
  }else{
    document.getElementById('modal-btn').innerText='OK';
    document.getElementById('modal-btn').onclick=closeModal;
  }
  document.getElementById('modal-overlay').style.display='flex';
}

function closeModal(){
  document.getElementById('modal-overlay').style.display='none';
}

function goHome(){
  window.location.href='lrd_test_selection.html';
}

function viewPerformance(){
  window.location.href='lrd_dashboard_fixed.html';
}
</script>
</body>
</html>
