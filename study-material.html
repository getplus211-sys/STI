<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --h: 90px; --f: 40px; }
        body { background: #fff; margin: 0; font-family: -apple-system, system-ui, sans-serif; }
        .header { height: var(--h); border-bottom: 0.5px solid #ccc; display: flex; align-items: flex-end; padding: 12px 16px; position: sticky; top: 0; background: #fff; z-index: 10; }
        .footer { height: var(--f); border-top: 0.5px solid #ccc; position: fixed; bottom: 0; width: 100%; max-width: 448px; background: #f8f8f8; display: flex; align-items: center; justify-content: space-around; font-size: 10px; font-weight: bold; color: #8e8e93; }
        .chat-list { margin-bottom: var(--f); }
        .chat-item { display: flex; align-items: center; padding: 10px 16px; gap: 12px; border-bottom: 0.5px solid #f2f2f2; cursor: pointer; }
        .chat-item:active { background: #f2f2f2; }
        .avatar { width: 54px; height: 54px; border-radius: 50%; background: #007aff; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 20px; overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="flex justify-center">
    <div class="w-full max-w-md bg-white min-h-screen relative">
        <header class="header">
            <div class="flex justify-between items-center w-full">
                <span class="text-blue-500">Edit</span>
                <h1 class="font-bold text-lg">Chats</h1>
                <span class="text-blue-500">✎</span>
            </div>
        </header>

        <div id="loader" class="p-10 text-center text-gray-400">Loading Chats...</div>
        <div id="chat-list" class="chat-list"></div>

        <footer class="footer">
            <span>CONTACTS</span>
            <span>CALLS</span>
            <span class="text-blue-500">CHATS</span>
            <span>SETTINGS</span>
        </footer>
    </div>

    <script>
        const S_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        async function loadChats() {
            // સીધો 'chat_list_view' માંથી ડેટા લેવો
            const { data, error } = await _supabase.from('chat_list_view').select('*').order('updated_at', { ascending: false });

            document.getElementById('loader').style.display = 'none';
            if (error) { console.error(error); return; }

            const container = document.getElementById('chat-list');
            container.innerHTML = data.map(chat => `
                <div class="chat-item" onclick="location.href='ngm-chat-window.html?chat_id=${chat.chat_id}'">
                    <div class="avatar">
                        ${chat.display_picture ? `<img src="${chat.display_picture}">` : chat.display_name[0]}
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between">
                            <span class="font-bold truncate">${chat.display_name}</span>
                            <span class="text-xs text-gray-400">${new Date(chat.updated_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">${chat.chat_type}</p>
                    </div>
                </div>
            `).join('');
        }

        loadChats();
    </script>
</body>
</html>
