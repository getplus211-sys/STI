<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Nandigram - Chats</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --pc: #0088cc; 
            --sc: #24a1de;
            --bg: #ffffff;
            --text: #222222;
            --gray: #8e8e93;
            --border: #dcdcdc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, sans-serif;
            background: #f1f1f1;
            padding-bottom: 90px; /* Space for larger footer */
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg);
            min-height: 100vh;
        }

        /* CUSTOM HEADER: 100px Height, Content at Bottom */
        .header {
            position: sticky;
            top: 0;
            height: 100px;
            background: linear-gradient(135deg, var(--pc), var(--sc));
            color: white;
            padding: 0 20px 15px 20px;
            z-index: 1000;
            display: flex;
            align-items: flex-end; /* Content at bottom */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 24px; font-weight: 700; letter-spacing: 0.5px; }
        .header-actions { display: flex; gap: 18px; }
        .action-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* Search Bar */
        .search-container { padding: 10px 15px; background: var(--pc); display: none; }
        .search-container.active { display: block; }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: none; outline: none; }

        /* Chat List */
        .chat-item {
            display: flex;
            padding: 15px;
            align-items: center;
            border-bottom: 0.5px solid #f0f0f0;
            cursor: pointer;
        }

        .avatar {
            width: 52px; height: 52px; border-radius: 50%;
            background: #e0e0e0; display: flex; align-items: center;
            justify-content: center; font-weight: bold; color: white;
            margin-right: 15px; flex-shrink: 0; font-size: 20px;
        }

        .chat-info { flex: 1; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-size: 16px; font-weight: 600; color: #000; }
        .chat-time { font-size: 12px; color: var(--gray); }
        .chat-msg { font-size: 14px; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CUSTOM FOOTER: Increased Height, Content at Top */
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            height: 85px; /* Increased height */
            background: #fff;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: flex-start; /* Content at top */
            padding-top: 10px; /* Padding for top alignment */
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            color: var(--gray);
            flex: 1;
            cursor: pointer;
        }

        .nav-item.active { color: var(--pc); }
        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 11px; margin-top: 2px; font-weight: 500; }

        .fab {
            position: fixed;
            bottom: 105px; /* Adjusted for larger footer */
            right: 20px;
            width: 56px; height: 56px;
            background: var(--pc); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .loading { text-align: center; padding: 50px; color: #888; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="header-content">
            <h1>Nandigram</h1>
            <div class="header-actions">
                <button class="action-btn" onclick="toggleSearch()">ğŸ”</button>
                <button class="action-btn" onclick="alert('Menu')">â‹®</button>
            </div>
        </div>
    </div>

    <div class="search-container" id="searchBox">
        <input type="text" class="search-input" id="searchInput" placeholder="àª¶à«‹àª§à«‹..." oninput="filter()">
    </div>

    <div id="chatList">
        <div class="loading">àªšà«‡àªŸ àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«€ àª›à«‡...</div>
    </div>

    <button class="fab" onclick="location.href='ngm-new-chat.html'">âœ</button>

    <div class="footer">
        <div class="nav-item active" onclick="location.href='ngm-chats.html'">
            <div class="nav-icon">ğŸ’¬</div>
            <div class="nav-label">àªšà«‡àªŸà«àª¸</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-channel-view.html'">
            <div class="nav-icon">ğŸ“¢</div>
            <div class="nav-label">àªšà«‡àª¨àª²</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-group-chat.html'">
            <div class="nav-icon">ğŸ‘¥</div>
            <div class="nav-label">àª—à«àª°à«àªª</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-kapila.html'">
            <div class="nav-icon">ğŸ¤–</div>
            <div class="nav-label">KAPiLa</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-profile.html'">
            <div class="nav-icon">ğŸ‘¤</div>
            <div class="nav-label">àªªà«àª°à«‹àª«àª¾àª‡àª²</div>
        </div>
    </div>
</div>

<script>
    const U = 'https://bhmycvrbucmbbrpzeane.supabase.co';
    const K = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
    const sb = supabase.createClient(U, K);

    let cu = null;

    async function init() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) { location.href = 'login.html'; return; }
        cu = user;
        fetchChats();
        
        // Real-time update
        sb.channel('updates').on('postgres_changes', { event: '*', schema: 'public', table: 'ngm_messages' }, fetchChats).subscribe();
    }

    async function fetchChats() {
        const list = document.getElementById('chatList');
        try {
            // àª¸àª¾àª¦à«€ àª•à«àªµà«‡àª°à«€ àªœà«‡àª¥à«€ àª¡à«‡àªŸàª¾ àª²à«‹àª¡ àª¨ àª¥àªµàª¾àª¨à«€ àª¸àª®àª¸à«àª¯àª¾ àª¦à«‚àª° àª¥àª¾àª¯
            let { data: parts, error } = await sb
                .from('ngm_chat_participants')
                .select(`
                    *,
                    chat:ngm_chats(*)
                `)
                .eq('user_id', cu.id);

            if (error) throw error;

            if (!parts || parts.length === 0) {
                list.innerHTML = '<div class="loading">àª•à«‹àªˆ àªšà«‡àªŸ àª®àª³à«€ àª¨àª¥à«€.</div>';
                return;
            }

            let html = '';
            for (let p of parts) {
                const c = p.chat;
                if(!c) continue;

                // àª¬à«€àªœàª¾ àª¯à«àªàª°àª¨à«àª‚ àª¨àª¾àª® àª®à«‡àª³àªµàªµàª¾ (Personal Chat àª®àª¾àªŸà«‡)
                let name = "Chat";
                if(c.chat_type === 'personal') {
                    const otherId = (c.user1_id === cu.id) ? c.user2_id : c.user1_id;
                    const { data: u } = await sb.from('ngm_users').select('full_name').eq('user_id', otherId).single();
                    name = u?.full_name || "User";
                } else {
                    name = "Group/Channel";
                }

                html += `
                    <div class="chat-item" onclick="location.href='ngm-chat-window.html?chat=${c.chat_id}'">
                        <div class="avatar" style="background:${getRandomColor()}">${name.charAt(0)}</div>
                        <div class="chat-info">
                            <div class="chat-top">
                                <span class="chat-name">${name}</span>
                                <span class="chat-time">àª¹àª®àª£àª¾àª‚</span>
                            </div>
                            <div class="chat-bottom">
                                <span class="chat-msg">${c.last_message_text || 'àª•à«‹àªˆ àª®à«‡àª¸à«‡àªœ àª¨àª¥à«€'}</span>
                                ${p.unread_count > 0 ? `<span style="background:#31cc54; color:white; border-radius:10px; padding:2px 8px; font-size:12px;">${p.unread_count}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        } catch (e) {
            list.innerHTML = '<div class="loading">Error: ' + e.message + '</div>';
        }
    }

    function toggleSearch() {
        const s = document.getElementById('searchBox');
        s.classList.toggle('active');
    }

    function getRandomColor() {
        const colors = ['#ff6b6b', '#4facfe', '#43e97b', '#fa709a', '#667eea'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    init();
</script>
</body>
</html>
