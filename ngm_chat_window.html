<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            font-family: Arial, sans-serif;
        }
        
        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        #header {
            height: 90px;
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            display: flex;
            align-items: flex-end;
            padding: 12px 16px;
            flex-shrink: 0;
        }
        
        #header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }
        
        #chat-info {
            flex: 1;
            cursor: pointer;
        }
        
        #chat-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        #chat-status {
            font-size: 12px;
            opacity: 0.9;
        }
        
        #messages {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: #e5ddd5;
            padding: 16px;
        }
        
        .msg {
            margin-bottom: 8px;
            display: flex;
        }
        
        .msg.sent {
            justify-content: flex-end;
        }
        
        .msg-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
        }
        
        .msg.sent .msg-bubble {
            background: #dcf8c6;
            border-bottom-right-radius: 2px;
        }
        
        .msg.received .msg-bubble {
            background: white;
            border-bottom-left-radius: 2px;
        }
        
        .msg-time {
            font-size: 11px;
            color: #667781;
            margin-top: 2px;
            text-align: right;
        }
        
        #input-area {
            height: 64px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 8px;
            flex-shrink: 0;
        }
        
        #input {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            padding: 10px 16px;
            font-size: 15px;
            outline: none;
        }
        
        #send-btn {
            width: 44px;
            height: 44px;
            background: #16a34a;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="header">
            <div id="header-content">
                <div class="avatar" id="avatar" onclick="openProfile()">?</div>
                <div id="chat-info" onclick="openProfile()">
                    <div id="chat-name">Loading...</div>
                    <div id="chat-status">...</div>
                </div>
            </div>
        </div>
        
        <div id="messages">
            <div id="loading">Loading...</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="input" placeholder="Type a message..." />
            <button id="send-btn" onclick="sendMsg()">âž¤</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chat_id');
        
        let currentUser = null;
        let messages = [];
        let otherUserId = null;
        
        async function init() {
            console.log('ðŸš€ Init START');
            const start = performance.now();
            
            // Get user
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
            console.log('âœ… User:', user.id);
            
            // Load chat info
            const { data: chat } = await supabase
                .from('ngm_chats')
                .select('*')
                .eq('chat_id', chatId)
                .single();
            
            if (chat) {
                otherUserId = chat.user1_id === user.id ? chat.user2_id : chat.user1_id;
                
                const { data: userData } = await supabase
                    .from('ngm_users')
                    .select('full_name, username')
                    .eq('user_id', otherUserId)
                    .single();
                
                if (userData) {
                    const name = userData.full_name || userData.username || 'User';
                    document.getElementById('chat-name').textContent = name;
                    document.getElementById('avatar').textContent = name[0].toUpperCase();
                    document.getElementById('chat-status').textContent = 'online';
                }
            }
            
            console.log('âœ… Chat loaded:', performance.now() - start, 'ms');
            
            // Load messages - ONLY 20
            const { data: msgs } = await supabase
                .from('ngm_messages')
                .select('message_id, sender_id, content, created_at')
                .eq('chat_id', chatId)
                .eq('is_deleted', false)
                .order('created_at', { ascending: false })
                .limit(20);
            
            messages = (msgs || []).reverse();
            console.log('âœ… Messages loaded:', messages.length, 'in', performance.now() - start, 'ms');
            
            // RENDER
            render();
            console.log('âœ… VISIBLE in', performance.now() - start, 'ms');
            
            // Scroll
            setTimeout(() => {
                const el = document.getElementById('messages');
                el.scrollTop = el.scrollHeight;
                console.log('âœ… Scrolled. Height:', el.scrollHeight);
            }, 50);
            
            // Realtime
            supabase
                .channel('msgs:' + chatId)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'ngm_messages',
                    filter: 'chat_id=eq.' + chatId
                }, payload => {
                    messages.push(payload.new);
                    render();
                    setTimeout(() => {
                        document.getElementById('messages').scrollTop = 99999;
                    }, 10);
                })
                .subscribe();
        }
        
        function render() {
            const container = document.getElementById('messages');
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
            
            // Clear
            container.innerHTML = '';
            
            // Add messages - FAST direct DOM
            messages.forEach(msg => {
                const isSent = msg.sender_id === currentUser.id;
                const time = new Date(msg.created_at).toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                const div = document.createElement('div');
                div.className = 'msg ' + (isSent ? 'sent' : 'received');
                div.innerHTML = `
                    <div class="msg-bubble">
                        <div>${msg.content || ''}</div>
                        <div class="msg-time">${time}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        async function sendMsg() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            
            await supabase
                .from('ngm_messages')
                .insert({
                    chat_id: chatId,
                    sender_id: currentUser.id,
                    message_type: 'text',
                    content: text
                });
        }
        
        function openProfile() {
            if (otherUserId) {
                window.location.href = 'ngm_profile.html?user_id=' + otherUserId;
            }
        }
        
        // Start
        init();
    </script>
</body>
</html>
