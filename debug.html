<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Mock Test 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
.container{max-width:900px;margin:auto;padding:10px}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:10px}
button{padding:12px 16px;border:none;border-radius:8px;font-size:16px}
.primary{background:#2563eb;color:#fff}
.gray{background:#e5e7eb}
.option{border:1px solid #ddd;border-radius:8px;padding:10px;margin:8px 0;cursor:pointer}
.option.active{background:#2563eb;color:#fff}
.topbar{display:flex;justify-content:space-between;align-items:center}
.timer{font-weight:700}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:6px}
.grid button{padding:6px;font-size:14px}
.correct{color:green}
.wrong{color:red}
</style>
</head>

<body>
<div class="container" id="app">Loading...</div>

<script>
const SUPABASE_URL="https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

const TEST_ID="mock_test_1";
const TOTAL_TIME=120*60;

let user,questions=[],answers={},current=0,timeLeft=TOTAL_TIME,attemptId;

(async()=>{
  const {data:{user:u}}=await supabase.auth.getUser();
  if(!u){document.getElementById("app").innerHTML="Login required";return;}
  user=u;

  // Access check
  const {data:access}=await supabase.from("user_access")
    .select("*").eq("user_id",user.id).eq("is_active",true).single();
  if(!access){app.innerHTML="No access";return;}

  // Attempt check
  const {data:attempt}=await supabase.from("test_attempts")
    .select("*").eq("user_id",user.id).eq("test_id",TEST_ID).single();

  if(attempt && attempt.is_submitted){
    loadResult();
    return;
  }

  if(!attempt){
    const {data:newAttempt}=await supabase.from("test_attempts").insert({
      user_id:user.id,test_id:TEST_ID,is_submitted:false
    }).select().single();
    attemptId=newAttempt.id;
  } else attemptId=attempt.id;

  loadQuestions();
})();

async function loadQuestions(){
  const {data}=await supabase.from("questions")
    .select("*").eq("test_id",TEST_ID).order("id");
  questions=data;
  renderTest();
  startTimer();
}

function renderTest(){
  showQuestion();
}

function showQuestion(){
  const q=questions[current];
  app.innerHTML=`
  <div class="topbar">
    <div>Q ${current+1}/200</div>
    <div class="timer" id="timer"></div>
  </div>
  <div class="card">
    <div>${q.question_text}</div>
    ${["a","b","c","d","e"].map((o,i)=>`
      <div class="option ${answers[q.id]==i+1?"active":""}" 
      onclick="selectOpt(${i+1})">${q["option_"+o]}</div>`).join("")}
  </div>
  <button class="gray" onclick="prev()">Prev</button>
  <button class="primary" onclick="next()">Save & Next</button>
  `;
}

function selectOpt(v){
  answers[questions[current].id]=v;
  showQuestion();
}

function next(){
  if(current<questions.length-1)current++;
  showQuestion();
}

function prev(){
  if(current>0)current--;
  showQuestion();
}

function startTimer(){
  setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").innerText=
      Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,"0");
    if(timeLeft<=0)submitTest();
  },1000);
}

async function submitTest(){
  let correct=0,wrong=0,skip=0,e=0,score=0;
  questions.forEach(q=>{
    const a=answers[q.id];
    if(!a){skip++;score-=0.33}
    else if(a===5){e++}
    else if(a===q.correct_option){correct++;score+=1}
    else{wrong++;score-=0.33}
  });

  await supabase.from("test_results").insert({
    user_id:user.id,test_id:TEST_ID,total_score:score,
    correct_count:correct,wrong_count:wrong,skipped_count:skip,
    e_count:e,time_taken_seconds:(TOTAL_TIME-timeLeft),
    answers:answers
  });

  await supabase.from("test_attempts").update({
    is_submitted:true,submitted_at:new Date()
  }).eq("id",attemptId);

  loadResult();
}

async function loadResult(){
  const {data:r}=await supabase.from("test_results")
    .select("*").eq("user_id",user.id).eq("test_id",TEST_ID).single();

  app.innerHTML=`
  <div class="card">
    <h2>Your Score: ${r.total_score}</h2>
    <canvas id="chart"></canvas>
    <button class="primary" onclick="showSolutions()">View Solutions</button>
  </div>
  `;

  new Chart(document.getElementById("chart"),{
    type:"pie",
    data:{
      labels:["Correct","Wrong","Skipped","E"],
      datasets:[{data:[
        r.correct_count,r.wrong_count,r.skipped_count,r.e_count
      ]}]
    }
  });
}

function showSolutions(){
  app.innerHTML=questions.map((q,i)=>`
    <div class="card">
      <b>Q${i+1}</b> ${q.question_text}<br>
      Your: ${answers[q.id]} | Correct: ${q.correct_option}<br>
      <small>${q.explanation}</small>
    </div>
  `).join("");
}
</script>
</body>
</html>
