<!doctype html>
<html lang="gu">
<head>
  <meta charset="utf-8" />
  <title>Premium Mock Test System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #4f46e5; --bg: #f3f4f6; --card: #ffffff; }
    body { font-family: system-ui, sans-serif; margin:0; background: var(--bg); color: #1f2937; }
    .container { max-width: 800px; margin: 0 auto; padding: 16px; }
    .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 16px; }
    .hidden { display: none !important; }
    .header { position: sticky; top:0; background: #fff; padding: 10px 16px; display:flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; z-index:100; }
    
    button { cursor: pointer; border: none; border-radius: 8px; padding: 12px; font-weight: 600; transition: 0.2s; font-size: 15px; }
    .btn-main { background: var(--primary); color: white; width: 100%; }
    .btn-main:disabled { background: #9ca3af; }
    .btn-outline { background: #fff; border: 1px solid #d1d5db; color: #374151; width: 100%; }
    
    .option-box { display: block; padding: 14px; border: 2px solid #f3f4f6; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
    .option-box:has(input:checked) { border-color: var(--primary); background: #f5f3ff; }
    
    .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
  </style>
</head>
<body>

<div id="testUI" class="hidden">
  <div class="header">
    <div id="qCount">Q: 1/200</div>
    <div id="timer" style="color:red; font-weight:bold;">120:00</div>
  </div>
</div>

<div class="container">
  <section id="statusSection" class="card">
    <h2>તમારું એક્સેસ ચેક થઈ રહ્યું છે...</h2>
  </section>

  <section id="preRules" class="card hidden">
    <h3>પરીક્ષાના નિયમો</h3>
    <p>• આ પરીક્ષા તમે માત્ર <b>એક જ વાર</b> આપી શકશો.</p>
    <label><input type="checkbox" id="ruleAgree"> હું તૈયાર છું.</label>
    <button id="startBtn" class="btn-main" style="margin-top:15px" disabled>Start Exam</button>
  </section>

  <section id="testSection" class="hidden">
    <div class="card">
      <p id="qText" style="font-size: 18px; font-weight: 600;"></p>
      <div id="optContainer"></div>
    </div>
    <div class="nav-grid">
      <button class="btn-outline" onclick="prevQ()">પાછળ</button>
      <button class="btn-main" onclick="saveNext()">Save & Next</button>
      <button class="btn-danger" style="grid-column: span 2; background:#ef4444; color:white; margin-top:10px" onclick="finalSubmit()">Final Submit</button>
    </div>
  </section>

  <section id="resultSection" class="hidden">
    <div class="card" style="text-align: center;">
      <h2 id="resTitle">રિઝલ્ટ</h2>
      <div id="scoreDisplay" style="font-size: 32px; font-weight: bold; color: var(--primary);"></div>
      <canvas id="resChart" style="max-width: 300px; margin: 20px auto;"></canvas>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-main" onclick="showSolutions()">Solutions</button>
        <button class="btn-outline" onclick="loadLeaderboard()">Leaderboard</button>
      </div>
    </div>
    
    <div id="lbArea" class="card hidden"><h3>Leaderboard</h3><table><thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead><tbody id="lbBody"></tbody></table></div>
    <div id="solArea" class="hidden"><h3>Solutions</h3><div id="solList"></div></div>
  </section>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient("https://bhmycvrbucmbbrpzeane.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4");

const TEST_ID = "mock_test_1";
let user = null, questions = [], answers = [], currentIdx = 0, timerSec = 120 * 60, interval;

// 1. Initial Access & Attempt Check
async function checkStatus() {
  const { data: { user: authUser } } = await supabase.auth.getUser();
  if (!authUser) { alert("Login Required!"); return; }
  user = authUser;

  // Check Access
  const { data: access } = await supabase.from('user_access').select('*').eq('user_id', user.id).eq('is_active', true).maybeSingle();
  if (!access) { document.getElementById('statusSection').innerHTML = "<h2>તમારી પાસે એક્ટિવ પ્લાન નથી.</h2>"; return; }

  // Check Previous Attempt
  const { data: attempt } = await supabase.from('test_results').select('*').eq('user_id', user.id).eq('test_id', TEST_ID).maybeSingle();

  if (attempt) {
    showExistingResult(attempt);
  } else {
    document.getElementById('statusSection').classList.add('hidden');
    document.getElementById('preRules').classList.remove('hidden');
  }
}
checkStatus();

// 2. Start Test & Attempt Logging
document.getElementById('ruleAgree').onchange = (e) => document.getElementById('startBtn').disabled = !e.target.checked;

document.getElementById('startBtn').onclick = async () => {
  // Create Attempt Entry
  await supabase.from('test_attempts').insert([{ user_id: user.id, test_id: TEST_ID, is_submitted: false, started_at: new Date() }]);
  
  const { data } = await supabase.from('questions').select('*').eq('test_id', TEST_ID);
  questions = data;
  answers = questions.map(q => ({ qid: q.id, sel: 0 }));
  
  document.getElementById('preRules').classList.add('hidden');
  document.getElementById('testUI').classList.remove('hidden');
  document.getElementById('testSection').classList.remove('hidden');
  renderQ();
  startTimer();
};

function renderQ() {
  const q = questions[currentIdx];
  document.getElementById('qCount').textContent = `Q: ${currentIdx + 1}/${questions.length}`;
  document.getElementById('qText').textContent = q.question_text;
  document.getElementById('optContainer').innerHTML = [
    {id:1, t:q.option_a}, {id:2, t:q.option_b}, {id:3, t:q.option_c}, {id:4, t:q.option_d}, {id:5, t:q.option_e || "E-Skip"}
  ].map(o => `<label class="option-box"><input type="radio" name="opt" value="${o.id}" ${answers[currentIdx].sel==o.id?'checked':''}> ${o.t}</label>`).join('');
}

window.saveNext = () => {
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel) { answers[currentIdx].sel = parseInt(sel.value); if(currentIdx < questions.length-1){ currentIdx++; renderQ(); } }
  else alert("Select Option!");
};
window.prevQ = () => { if(currentIdx > 0){ currentIdx--; renderQ(); } };

function startTimer() { interval = setInterval(() => { timerSec--; let m=Math.floor(timerSec/60), s=timerSec%60; document.getElementById('timer').textContent=`${m}:${s<10?'0'+s:s}`; if(timerSec<=0) finalSubmit(); }, 1000); }

// 3. Final Submit & Result Saving
window.finalSubmit = async () => {
  if(!confirm("Submit Test?")) return;
  clearInterval(interval);
  
  let c=0, w=0, e=0;
  answers.forEach((ans, i) => {
    if(ans.sel==0 || ans.sel==5) e++;
    else if(ans.sel == questions[i].correct_option) c++;
    else w++;
  });
  const score = (c * 1) - (w * 0.33);

  // Save to test_results
  await supabase.from('test_results').insert([{
    user_id: user.id, test_id: TEST_ID, total_score: score.toFixed(2),
    correct_count: c, wrong_count: w, e_count: e, answers: answers, time_taken_seconds: (120*60)-timerSec
  }]);

  // Update test_attempts
  await supabase.from('test_attempts').update({ is_submitted: true, submitted_at: new Date(), e_count: e }).eq('user_id', user.id).eq('test_id', TEST_ID);

  location.reload(); // Reload to show locked result screen
};

// 4. Show Result Logic (For Repeat Visits)
async function showExistingResult(data) {
  document.getElementById('statusSection').classList.add('hidden');
  document.getElementById('resultSection').classList.remove('hidden');
  document.getElementById('resTitle').textContent = "તમે આ ટેસ્ટ આપી દીધેલ છે";
  document.getElementById('scoreDisplay').textContent = `સ્કોર: ${data.total_score}`;
  
  // Load questions for solutions
  const { data: qData } = await supabase.from('questions').select('*').eq('test_id', TEST_ID);
  questions = qData;
  answers = data.answers;

  new Chart(document.getElementById('resChart'), {
    type: 'pie',
    data: { labels: ['Correct', 'Wrong', 'E/Skip'], datasets: [{ data: [data.correct_count, data.wrong_count, data.e_count], backgroundColor: ['#22c55e', '#ef4444', '#9ca3af'] }] }
  });
}

window.loadLeaderboard = async () => {
  const { data } = await supabase.from('test_results').select('total_score, profiles(full_name)').eq('test_id', TEST_ID).order('total_score', {ascending:false}).limit(10);
  document.getElementById('lbArea').classList.remove('hidden');
  document.getElementById('lbBody').innerHTML = data.map((r, i) => `<tr><td>${i+1}</td><td>${r.profiles?.full_name || 'User'}</td><td>${r.total_score}</td></tr>`).join('');
};

window.showSolutions = () => {
  document.getElementById('solArea').classList.remove('hidden');
  document.getElementById('solList').innerHTML = questions.map((q, i) => `
    <div class="card" style="border-left: 5px solid ${answers[i].sel==q.correct_option?'#22c55e':'#ef4444'}">
      <p><b>Q-${i+1}:</b> ${q.question_text}</p>
      <p>Your: ${answers[i].sel} | Correct: ${q.correct_option}</p>
      <small>${q.explanation || ''}</small>
    </div>`).join('');
};
</script>
</body>
</html>
