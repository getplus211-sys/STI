<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Nandigram - Chats</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --pc: #0088cc; /* Telegram Blue */
            --sc: #24a1de;
            --bg: #ffffff;
            --text: #222222;
            --gray: #8e8e93;
            --border: #dcdcdc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f1f1f1;
            color: var(--text);
            overflow-x: hidden;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            background: var(--pc);
            color: white;
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header h1 { font-size: 20px; font-weight: 600; }
        
        .header-actions { display: flex; gap: 15px; }
        .action-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* Search Bar */
        .search-container {
            padding: 10px 15px;
            background: var(--pc);
            display: none;
        }
        .search-container.active { display: block; }
        .search-input {
            width: 100%;
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            outline: none;
            font-size: 14px;
        }

        /* Chat List */
        .chat-list { flex: 1; }
        
        .chat-item {
            display: flex;
            padding: 12px 15px;
            align-items: center;
            border-bottom: 0.5px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:active { background: #f0f0f0; }

        .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .chat-info { flex: 1; overflow: hidden; }
        
        .chat-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        
        .chat-name { font-size: 16px; font-weight: 600; color: #000; }
        
        .chat-time { font-size: 12px; color: var(--gray); }
        
        .chat-bottom { display: flex; justify-content: space-between; align-items: center; }
        
        .chat-msg {
            font-size: 14px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }

        .unread-badge {
            background: #31cc54;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 3px 7px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .pinned-icon { color: var(--gray); font-size: 14px; transform: rotate(45deg); }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            height: 60px;
            background: #fff;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            color: var(--gray);
            font-size: 11px;
            flex: 1;
            padding: 8px 0;
        }

        .nav-item.active { color: var(--pc); }
        .nav-icon { font-size: 22px; margin-bottom: 2px; }

        /* Floating Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--pc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }

        .status-msg { text-align: center; padding: 40px; color: var(--gray); font-size: 14px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>àª¨àª‚àª¦à«€àª—à«àª°àª¾àª®</h1>
        <div class="header-actions">
            <button class="action-btn" onclick="toggleSearch()">ğŸ”</button>
            <button class="action-btn" onclick="showMenu()">â‹®</button>
        </div>
    </div>

    <div class="search-container" id="searchBox">
        <input type="text" class="search-input" placeholder="àªšà«‡àªŸ àª¶à«‹àª§à«‹..." id="searchInput" oninput="filterChats()">
    </div>

    <div id="pinnedSection" style="display:none; border-bottom: 8px solid #f1f1f1;">
        <div id="pinnedList"></div>
    </div>

    <div class="chat-list" id="chatList">
        <div class="status-msg">àªšà«‡àªŸ àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«€ àª›à«‡...</div>
    </div>

    <button class="fab" onclick="location.href='ngm-new-chat.html'">âœ</button>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="location.href='ngm-chats.html'">
            <div class="nav-icon">ğŸ’¬</div>
            <div>àªšà«‡àªŸà«àª¸</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-channel-view.html'">
            <div class="nav-icon">ğŸ“¢</div>
            <div>àªšà«‡àª¨àª²</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-group-chat.html'">
            <div class="nav-icon">ğŸ‘¥</div>
            <div>àª—à«àª°à«àªª</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-kapila.html'">
            <div class="nav-icon">ğŸ¤–</div>
            <div>àª•àªªàª¿àª²àª¾</div>
        </div>
        <div class="nav-item" onclick="location.href='ngm-profile.html'">
            <div class="nav-icon">ğŸ‘¤</div>
            <div>àªªà«àª°à«‹àª«àª¾àª‡àª²</div>
        </div>
    </div>
</div>

<script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Your Key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let allChatsData = [];

    async function init() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        currentUser = user;
        loadChats();
        setupRealtime();
    }

    async function loadChats() {
        try {
            // optimized query to get chats with last message and other user info
            const { data, error } = await supabase
                .from('ngm_chat_participants')
                .select(`
                    *,
                    chat:ngm_chats(*),
                    other_user:ngm_users!ngm_chat_participants_user_id_fkey(*)
                `)
                .eq('user_id', currentUser.id)
                .eq('is_active', true)
                .order('last_read_at', { ascending: false });

            if (error) throw error;

            if (!data || data.length === 0) {
                document.getElementById('chatList').innerHTML = '<div class="status-msg">àª¹àªœà« àª¸à«àª§à«€ àª•à«‹àªˆ àªšà«‡àªŸ àª¨àª¥à«€.</div>';
                return;
            }

            allChatsData = data;
            renderChats();
        } catch (err) {
            console.error(err);
            document.getElementById('chatList').innerHTML = '<div class="status-msg">àªšà«‡àªŸ àª²à«‹àª¡ àª•àª°àªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€.</div>';
        }
    }

    function renderChats() {
        const chatListEl = document.getElementById('chatList');
        const pinnedListEl = document.getElementById('pinnedList');
        const pinnedSection = document.getElementById('pinnedSection');

        let chatHtml = '';
        let pinnedHtml = '';
        let hasPinned = false;

        allChatsData.forEach(item => {
            const chat = item.chat;
            const name = item.other_user?.full_name || "Unknown User";
            const initial = name.charAt(0).toUpperCase();
            const time = formatTime(chat.last_message_at);
            const lastMsg = chat.last_message_text || "àª•à«‹àªˆ àª®à«‡àª¸à«‡àªœ àª¨àª¥à«€";
            
            const html = `
                <div class="chat-item" onclick="openChat('${chat.chat_id}')">
                    <div class="avatar">${initial}</div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <span class="chat-name">${name}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                        <div class="chat-bottom">
                            <span class="chat-msg">${lastMsg}</span>
                            ${item.unread_count > 0 ? `<span class="unread-badge">${item.unread_count}</span>` : ''}
                            ${item.is_pinned ? `<span class="pinned-icon">ğŸ“Œ</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            if (item.is_pinned) {
                pinnedHtml += html;
                hasPinned = true;
            } else {
                chatHtml += html;
            }
        });

        pinnedSection.style.display = hasPinned ? 'block' : 'none';
        pinnedListEl.innerHTML = pinnedHtml;
        chatListEl.innerHTML = chatHtml;
    }

    function formatTime(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diff = (now - date) / 1000;

        if (diff < 86400) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (diff < 172800) {
            return 'àª—àªˆàª•àª¾àª²à«‡';
        } else {
            return date.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
        }
    }

    function toggleSearch() {
        const sb = document.getElementById('searchBox');
        sb.classList.toggle('active');
        if (sb.classList.contains('active')) document.getElementById('searchInput').focus();
    }

    function filterChats() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.chat-item');
        items.forEach(item => {
            const name = item.querySelector('.chat-name').innerText.toLowerCase();
            item.style.display = name.includes(q) ? 'flex' : 'none';
        });
    }

    function openChat(id) {
        window.location.href = `ngm-chat-window.html?chat=${id}`;
    }

    function setupRealtime() {
        supabase.channel('public:ngm_chats')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'ngm_chats' }, payload => {
                loadChats();
            })
            .subscribe();
    }

    function showMenu() {
        alert("àª¸à«‡àªŸàª¿àª‚àª—à«àª¸\nàª¨àªµà«àª‚ àª—à«àª°à«àªª\nàª¨àªµà«€ àªšà«‡àª¨àª²\nàª¡àª¾àª°à«àª• àª®à«‹àª¡");
    }

    // Security: Disable copy/paste if required as per original code
    document.addEventListener('copy', e => e.preventDefault());
    
    init();
</script>

</body>
</html>
