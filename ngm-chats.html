<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nandigram - Chats</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 70px;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        .header {
            position: sticky;
            top: 0;
            height: 90px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            align-items: flex-end;
            padding: 0 20px 15px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            font-size: 24px;
            font-weight: 600;
        }
        .header-icons {
            display: flex;
            gap: 15px;
        }
        .icon-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
        .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        .search-bar {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: none;
        }
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
        }
        .section-header {
            padding: 10px 20px;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 5px;
            background: #f9f9f9;
        }
        .chat-list {
            background: white;
        }
        .chat-item {
            display: flex;
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .chat-item:active {
            background: #f5f5f5;
        }
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
            flex-shrink: 0;
            overflow: hidden;
        }
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-info {
            flex: 1;
            margin-left: 12px;
            overflow: hidden;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .chat-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .chat-time {
            font-size: 12px;
            color: #999;
        }
        .chat-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-message {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .unread-badge {
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            fill: #ccc;
            margin-bottom: 20px;
        }
        .empty-title {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        .empty-subtitle {
            font-size: 14px;
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 480px;
            margin: 0 auto;
            height: 70px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }
        .footer-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px 5px;
            color: #999;
            background: none;
            border: none;
        }
        .footer-item.active {
            color: var(--primary-color);
        }
        .footer-item svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .footer-label {
            font-size: 11px;
        }
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 99;
            border: none;
        }
        .fab svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Nandigram</h1>
                <div class="header-icons">
                    <button class="icon-btn" onclick="toggleSearch()">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    </button>
                    <button class="icon-btn" onclick="showSettings()">
                        <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="search-bar" id="searchBar">
            <input type="text" class="search-input" placeholder="Search chats..." id="searchInput" oninput="searchChats()">
        </div>

        <div id="pinnedSection" style="display:none;">
            <div class="section-header">
                <svg style="width:16px;height:16px;fill:#666" viewBox="0 0 24 24"><path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/></svg>
                Pinned Chats
            </div>
            <div class="chat-list" id="pinnedList"></div>
        </div>

        <div class="section-header">All Chats</div>
        <div class="loading" id="loading">Loading chats...</div>
        <div class="chat-list" id="chatList"></div>
        
        <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            <div class="empty-title">No chats yet</div>
            <div class="empty-subtitle">Start a conversation by tapping the + button</div>
        </div>
    </div>

    <button class="fab" onclick="navigate('ngm-new-chat.html')">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
    </button>

    <div class="footer">
        <button class="footer-item active">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            <div class="footer-label">Chats</div>
        </button>
        <button class="footer-item" onclick="navigate('ngm-channel-view.html')">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <div class="footer-label">Channels</div>
        </button>
        <button class="footer-item" onclick="navigate('ngm-group-chat.html')">
            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <div class="footer-label">Groups</div>
        </button>
        <button class="footer-item" onclick="navigate('ngm-profile.html')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <div class="footer-label">Profile</div>
        </button>
        <button class="footer-item" onclick="navigate('ngm-kapila.html')">
            <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6V7h12v12zm-9-6c-.83 0-1.5-.67-1.5-1.5S8.17 10 9 10s1.5.67 1.5 1.5S9.83 13 9 13zm7.5-1.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5zM8 15h8v2H8v-2z"/></svg>
            <div class="footer-label">KAPiLa</div>
        </button>
    </div>

    <script>
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;

        // Load theme
        (function() {
            const themes = {
                purple: {primary: '#667eea', secondary: '#764ba2'},
                blue: {primary: '#4facfe', secondary: '#00f2fe'},
                pink: {primary: '#f093fb', secondary: '#f5576c'},
                green: {primary: '#43e97b', secondary: '#38f9d7'},
                orange: {primary: '#fa709a', secondary: '#fee140'},
                red: {primary: '#ff6b6b', secondary: '#ee5a6f'},
                teal: {primary: '#2bcbba', secondary: '#45caff'},
                indigo: {primary: '#4776e6', secondary: '#8e54e9'}
            };
            const theme = localStorage.getItem('nandigram_theme') || 'purple';
            if (themes[theme]) {
                document.documentElement.style.setProperty('--primary-color', themes[theme].primary);
                document.documentElement.style.setProperty('--secondary-color', themes[theme].secondary);
            }
        })();

        async function init() {
            await checkAuth();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            await checkProfileComplete();
            await loadChats();
        }

        async function checkAuth() {
            const { data: { user } } = await sb.auth.getUser();
            if (user) {
                currentUser = user;
            }
        }

        async function checkProfileComplete() {
            try {
                const { data: profile } = await sb
                    .from('ngm_users')
                    .select('full_name, username')
                    .eq('user_id', currentUser.id)
                    .single();

                if (!profile || !profile.full_name || !profile.username) {
                    window.location.href = 'ngm-setup-profile.html';
                    return;
                }
            } catch (error) {
                console.error('Profile check error:', error);
            }
        }

        async function loadChats() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';

                const { data: participants, error: partError } = await sb
                    .from('ngm_chat_participants')
                    .select('chat_id, is_pinned, unread_count')
                    .eq('user_id', currentUser.id)
                    .eq('is_active', true);

                if (partError) throw partError;

                if (!participants || participants.length === 0) {
                    showEmptyState();
                    return;
                }

                const chatIds = participants.map(p => p.chat_id);

                const { data: chats, error: chatError } = await sb
                    .from('ngm_chats')
                    .select(`
                        *,
                        ngm_messages(content, created_at, sender_id)
                    `)
                    .in('chat_id', chatIds)
                    .order('last_message_at', { ascending: false });

                if (chatError) throw chatError;

                const chatsWithInfo = await Promise.all(chats.map(async (chat) => {
                    if (chat.chat_type === 'direct') {
                        const otherUserId = chat.user1_id === currentUser.id ? chat.user2_id : chat.user1_id;
                        const { data: otherUser } = await sb
                            .from('ngm_users')
                            .select('full_name, username, profile_picture_url')
                            .eq('user_id', otherUserId)
                            .single();

                        const participant = participants.find(p => p.chat_id === chat.chat_id);
                        
                        return {
                            ...chat,
                            displayName: otherUser?.full_name || 'Unknown User',
                            displayPicture: otherUser?.profile_picture_url,
                            isPinned: participant?.is_pinned || false,
                            unreadCount: participant?.unread_count || 0
                        };
                    }
                    return null;
                }));

                const validChats = chatsWithInfo.filter(c => c !== null);
                
                if (validChats.length === 0) {
                    showEmptyState();
                    return;
                }

                renderChats(validChats);
                
            } catch (error) {
                console.error('Error loading chats:', error);
                showEmptyState();
            }
        }

        function renderChats(chats) {
            document.getElementById('loading').style.display = 'none';
            
            const pinnedChats = chats.filter(c => c.isPinned);
            const regularChats = chats.filter(c => !c.isPinned);

            if (pinnedChats.length > 0) {
                document.getElementById('pinnedSection').style.display = 'block';
                renderChatList(pinnedChats, 'pinnedList', true);
            }

            renderChatList(regularChats, 'chatList', false);
        }

        function renderChatList(chats, containerId, isPinned) {
            const container = document.getElementById(containerId);
            
            if (chats.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = chats.map(chat => {
                const lastMessage = chat.ngm_messages && chat.ngm_messages.length > 0 
                    ? chat.ngm_messages[0] 
                    : null;
                
                const messageText = lastMessage ? lastMessage.content : 'No messages yet';
                const messageTime = lastMessage ? formatTime(lastMessage.created_at) : '';
                const initial = chat.displayName ? chat.displayName.charAt(0).toUpperCase() : '?';

                return `
                    <div class="chat-item" onclick="openChat('${chat.chat_id}')">
                        <div class="chat-avatar">
                            ${chat.displayPicture ? 
                                `<img src="${chat.displayPicture}" alt="${chat.displayName}">` : 
                                initial
                            }
                        </div>
                        <div class="chat-info">
                            <div class="chat-header">
                                <span class="chat-name">
                                    ${isPinned ? 'ðŸ“Œ ' : ''}${chat.displayName}
                                </span>
                                <span class="chat-time">${messageTime}</span>
                            </div>
                            <div class="chat-preview">
                                <span class="chat-message">${messageText}</span>
                                ${chat.unreadCount > 0 ? 
                                    `<span class="unread-badge">${chat.unreadCount}</span>` : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 604800000) {
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function showEmptyState() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
            if (searchBar.style.display === 'block') {
                document.getElementById('searchInput').focus();
            }
        }

        function searchChats() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const name = item.querySelector('.chat-name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }

        function openChat(chatId) {
            window.location.href = `ngm-chat-window.html?chat=${chatId}`;
        }

        function navigate(page) {
            window.location.href = page;
        }

        function showSettings() {
            window.location.href = 'ngm-settings.html';
        }

        document.addEventListener('copy', e => e.preventDefault());
        document.addEventListener('paste', e => e.preventDefault());

        init();
    </script>
</body>
</html>
