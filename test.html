<!doctype html>
<html lang="gu">
<head>
  <meta charset="utf-8" />
  <title>Premium Mock Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
    body { font-family: system-ui, -apple-system, sans-serif; margin:0; background: var(--bg); color: var(--text); }
    .container { max-width: 800px; margin: 0 auto; padding: 16px; }
    .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #e2e8f0; }
    .hidden { display: none !important; }
    
    /* Timer Header */
    .header { position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; z-index: 10; }
    #timer { font-weight: bold; color: #ef4444; font-size: 1.1rem; }

    /* Buttons */
    button { cursor: pointer; border: none; border-radius: 8px; padding: 12px 16px; font-weight: 600; font-size: 15px; transition: 0.2s; }
    .btn-main { background: var(--primary); color: white; width: 100%; }
    .btn-main:disabled { background: #cbd5e1; cursor: not-allowed; }
    .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
    .btn-danger { background: #ef4444; color: white; }

    /* Question Options */
    .option-box { display: block; padding: 14px; border: 2px solid #f1f5f9; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
    .option-box:has(input:checked) { border-color: var(--primary); background: #f5f3ff; }
    input[type="radio"] { margin-right: 10px; transform: scale(1.2); }

    .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
    .pal-btn { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #ddd; background: #fff; }
    .pal-done { background: #22c55e !important; color: white; border: none; }
  </style>
</head>
<body>

<div id="testUI" class="hidden">
  <div class="header">
    <div id="qCount">Q: 1/200</div>
    <div id="timer">120:00</div>
    <button class="btn-outline" style="padding: 5px 10px;" onclick="togglePalette(true)">Grid</button>
  </div>
</div>

<div class="container">
  <section id="accessSection" class="card">
    <h2 style="margin-top:0">Mock Test System</h2>
    <p>પરીક્ષા આપવા માટે તમારું એક્સેસ ચેક કરો.</p>
    <button id="checkAccessBtn" class="btn-main">Check My Access</button>
  </section>

  <section id="preRules" class="card hidden">
    <h3>પરીક્ષાના નિયમો</h3>
    <p>• દરેક પ્રશ્નનો ૧ માર્ક છે.<br>• ખોટા જવાબના ૦.૩૩ માર્ક કપાશે.<br>• E ઓપ્શનમાં નેગેટિવ માર્કિંગ નથી.</p>
    <label style="display:block; margin: 20px 0;">
      <input type="checkbox" id="ruleAgree"> હું નિયમો સમજું છું.
    </label>
    <button id="startBtn" class="btn-main" disabled>Start Exam</button>
  </section>

  <section id="testSection" class="hidden">
    <div class="card">
      <p id="qText" style="font-size: 17px; font-weight: 600; line-height: 1.5;"></p>
      <div id="optContainer"></div>
    </div>
    <div class="nav-grid">
      <button class="btn-outline" onclick="prevQ()">પાછળ</button>
      <button class="btn-main" onclick="saveNext()">Save & Next</button>
      <button class="btn-outline" style="grid-column: span 2;" onclick="skipQ()">Skip (E)</button>
      <button class="btn-danger" style="grid-column: span 2; margin-top: 10px;" onclick="finalSubmit()">Final Submit</button>
    </div>
  </section>

  <section id="resultSection" class="hidden">
    <div class="card" style="text-align: center;">
      <h2>Result</h2>
      <div id="scoreDisplay" style="font-size: 24px; font-weight: bold; margin: 15px 0;"></div>
      <canvas id="resChart"></canvas>
      <button class="btn-main" style="margin-top:20px;" onclick="location.reload()">બીજી ટેસ્ટ આપો</button>
    </div>
  </section>
</div>

<div id="palModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:100; display:flex; align-items:center; justify-content:center; padding:15px;">
  <div class="card" style="width:100%; max-height:80%; overflow-y:auto;">
    <h3>Questions Palette</h3>
    <div id="palGrid" class="palette-grid"></div>
    <button class="btn-main" style="margin-top:15px;" onclick="togglePalette(false)">Close</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://bhmycvrbucmbbrpzeane.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4"
);

const TEST_ID = "mock_test_1";
let questions = [], answers = [], currentIdx = 0, timerSec = 120 * 60, interval;
let userObj = null;

// --- Access Check ---
document.getElementById('checkAccessBtn').onclick = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { alert("મહેરબાની કરી લોગિન કરો."); return; }
  userObj = user;

  const { data: access } = await supabase.from('user_access').select('*').eq('user_id', user.id).eq('is_active', true).maybeSingle();

  if (access) {
    document.getElementById('accessSection').classList.add('hidden');
    document.getElementById('preRules').classList.remove('hidden');
  } else {
    alert("તમારી પાસે એક્ટિવ પ્લાન નથી.");
  }
};

// --- Start Test ---
document.getElementById('ruleAgree').onchange = (e) => { document.getElementById('startBtn').disabled = !e.target.checked; };

document.getElementById('startBtn').onclick = async () => {
  document.getElementById('startBtn').textContent = "Loading...";
  const { data, error } = await supabase.from('questions').select('*').eq('test_id', TEST_ID);
  
  if (data && data.length > 0) {
    questions = data;
    answers = questions.map(q => ({ qid: q.id, sel: 0 }));
    document.getElementById('preRules').classList.add('hidden');
    document.getElementById('testUI').classList.remove('hidden');
    document.getElementById('testSection').classList.remove('hidden');
    renderQ();
    startTimer();
  } else {
    alert("પ્રશ્નો મળ્યા નથી!");
    document.getElementById('startBtn').textContent = "Start Exam";
  }
};

function renderQ() {
  const q = questions[currentIdx];
  document.getElementById('qCount').textContent = `Q: ${currentIdx + 1}/${questions.length}`;
  document.getElementById('qText').textContent = q.question_text;
  
  const opts = [
    { id: 1, txt: q.option_a }, { id: 2, txt: q.option_b },
    { id: 3, txt: q.option_c }, { id: 4, txt: q.option_d },
    { id: 5, txt: q.option_e || "E - Not Attempted" }
  ];

  document.getElementById('optContainer').innerHTML = opts.map(o => `
    <label class="option-box">
      <input type="radio" name="opt" value="${o.id}" ${answers[currentIdx].sel == o.id ? 'checked' : ''}>
      ${o.txt}
    </label>
  `).join('');
}

window.saveNext = () => {
  const sel = document.querySelector('input[name="opt"]:checked');
  if (sel) {
    answers[currentIdx].sel = parseInt(sel.value);
    if (currentIdx < questions.length - 1) { currentIdx++; renderQ(); }
  } else { alert("એક ઓપ્શન પસંદ કરો."); }
};

window.skipQ = () => { answers[currentIdx].sel = 5; if (currentIdx < questions.length - 1) { currentIdx++; renderQ(); } };
window.prevQ = () => { if (currentIdx > 0) { currentIdx--; renderQ(); } };

function startTimer() {
  interval = setInterval(() => {
    timerSec--;
    let m = Math.floor(timerSec/60), s = timerSec%60;
    document.getElementById('timer').textContent = `${m}:${s<10?'0'+s:s}`;
    if(timerSec <= 0) finalSubmit();
  }, 1000);
}

window.togglePalette = (show) => {
  document.getElementById('palModal').classList.toggle('hidden', !show);
  if(show) {
    document.getElementById('palGrid').innerHTML = answers.map((a, i) => `
      <button class="pal-btn ${a.sel!=0?'pal-done':''}" onclick="goT(${i})">${i+1}</button>
    `).join('');
  }
};
window.goT = (i) => { currentIdx = i; renderQ(); togglePalette(false); };

window.finalSubmit = async () => {
  if(!confirm("સબમિટ કરવું છે?")) return;
  clearInterval(interval);
  
  let c=0, w=0, e=0;
  answers.forEach((ans, i) => {
    if (ans.sel == 0 || ans.sel == 5) e++;
    else if (ans.sel == questions[i].correct_option) c++;
    else w++;
  });

  const score = (c * 1) - (w * 0.33);
  
  // Save to DB
  await supabase.from('test_results').insert([{
    user_id: userObj.id,
    test_id: TEST_ID,
    total_score: score.toFixed(2),
    correct_count: c,
    wrong_count: w,
    e_count: e,
    answers: answers,
    time_taken_seconds: (120 * 60) - timerSec
  }]);

  document.getElementById('testSection').classList.add('hidden');
  document.getElementById('testUI').classList.add('hidden');
  document.getElementById('resultSection').classList.remove('hidden');
  document.getElementById('scoreDisplay').textContent = `Score: ${score.toFixed(2)}`;
  
  new Chart(document.getElementById('resChart'), {
    type: 'doughnut',
    data: { labels: ['સાચા', 'ખોટા', 'E/Skip'], datasets: [{ data: [c, w, e], backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1'] }] }
  });
};
</script>
</body>
</html>
