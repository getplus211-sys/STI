<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance - LRD Beginners</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans Gujarati', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        .header { background: #2563eb; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 12px; margin-bottom: 20px; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: bold; }
        .logo-badge { background: white; color: #2563eb; padding: 8px 12px; border-radius: 8px; }
        .home-btn { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; border: 2px solid white; color: white; text-decoration: none; }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Student Card */
        .student-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .student-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: #2563eb; }
        .student-info h2 { font-size: 20px; margin-bottom: 5px; }
        .student-meta { display: flex; gap: 15px; font-size: 14px; color: #6b7280; }
        
        /* Pie Chart Section */
        .chart-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .chart-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .chart-container { max-width: 350px; margin: 0 auto; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .stat-label { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1f2937; }
        .stat-sub { font-size: 14px; color: #10b981; margin-top: 5px; }
        
        /* Subject Analysis */
        .analysis-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; border-left: 4px solid #3b82f6; padding-left: 12px; }
        .subject-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px; }
        .subject-name { font-size: 16px; font-weight: 600; }
        .subject-score { font-size: 20px; font-weight: bold; }
        .score-excellent { color: #10b981; }
        .score-good { color: #3b82f6; }
        .score-average { color: #f59e0b; }
        .score-poor { color: #ef4444; }
        
        /* Chapter Details */
        .chapter-list { margin-top: 10px; padding-left: 20px; }
        .chapter-item { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; color: #6b7280; }
        
        /* Trend Chart */
        .trend-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Recommendation Card */
        .recommendation-card { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .rec-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .rec-section { margin-bottom: 20px; }
        .rec-section h3 { font-size: 16px; margin-bottom: 10px; opacity: 0.9; }
        .rec-list { list-style: none; }
        .rec-list li { padding: 8px 0 8px 25px; position: relative; }
        .rec-list li:before { content: "тЬУ"; position: absolute; left: 0; color: #10b981; font-weight: bold; }
        
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .student-header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo"><span class="logo-badge">LRD</span><span>Beginners</span></div>
        <a href="select-test.html" class="home-btn">ЁЯПа рк╣рлЛрко</a>
    </div>

    <div class="container">
        <!-- Student Card -->
        <div class="student-card">
            <div class="student-header">
                <div class="avatar">RS</div>
                <div class="student-info">
                    <h2>рк╡рк┐ркжрлНркпрк╛рк░рлНркерлАркирлБркВ ркирк╛рко</h2>
                    <div class="student-meta">
                        <span>рк▓рлЗрк╡рк▓: <strong>ркЧрк╛ркВркбрлНрк╕</strong></span>
                        <span>рк░рлЗркВркХ: <strong>#14</strong></span>
                        <span>ркдрк╛рк░рлАркЦ: <strong id="testDate">25-12-2025</strong></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="chart-card">
            <div class="chart-title">ркЯрлЗрк╕рлНркЯркирлБркВ рккрк░рк┐ркгрк╛рко (Pie Chart)</div>
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ркХрлБрк▓/ркорлЗрк│рк╡рлЗрк▓ ркЧрлБркг</div>
                <div class="stat-value" id="scoreDisplay">100 / 98</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ркЪрлЛркХрк╕рк╛ркИ (Accuracy)</div>
                <div class="stat-value" style="color: #10b981;" id="accuracyDisplay">82.5%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">рк╕ркоркп/рккрлНрк░рк╢рлНрки</div>
                <div class="stat-value" id="timePerQuestion">42s</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ</div>
                <div class="stat-value" style="color: #f59e0b;" id="concentrationRating">8/10</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">рк╕рк░рк│ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
                <div class="stat-value" id="easyStats">45/50</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ркЕркзрк╛рк░рлЛ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
                <div class="stat-value" id="hardStats">12/25</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ркЯрк╛рк░рлНркЧрлЗркЯ рк╕рлНркХрлЛрк░</div>
                <div class="stat-value" id="targetScore">60</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">рк╕рлБркзрк╛рк░рлЛ ркЬрк░рлВрк░ (%)</div>
                <div class="stat-value" style="color: #f59e0b;" id="improvementNeeded">12%</div>
            </div>
            <div class="stat-card" style="grid-column: span 2;">
                <div class="stat-label">ркмрк╛ркХрлА рккрлНрк░рк╢рлНркирлЛ</div>
                <div class="stat-value" id="remainingQuestions">05</div>
            </div>
        </div>

        <!-- Subject Analysis -->
        <div class="analysis-card">
            <div class="section-title">рк╡рк┐рк╖ркп ркЕркирлЗ ркЪрлЗрккрлНркЯрк░ рк╡рк╛рк░ ркПркирк╛рк▓рк┐рк╕рк┐рк╕</div>
            <div id="subjectAnalysis">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="trend-card">
            <div class="chart-title">ркдркорк╛рк░рлА рккрлНрк░ркЧркдрк┐ (Trend)</div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="recommendation-card">
            <div class="rec-title">ЁЯОп ркдркорк╛рк░рк╛ ркорк╛ркЯрлЗ ркПркХрлНрк╢рки рккрлНрк▓рк╛рки</div>
            <div id="recommendations">
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let testResult = null;
        let questionAttempts = [];

        async function init() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    alert('ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк▓рлЛркЧрк┐рки ркХрк░рлЛ');
                    return;
                }
                currentUser = user;

                const urlParams = new URLSearchParams(window.location.search);
                const resultId = urlParams.get('result_id');
                
                if (!resultId) {
                    alert('Result ID not found');
                    return;
                }

                await loadData(resultId);
                displayData();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadData(resultId) {
            // Load test result
            const { data: result } = await supabaseClient
                .from('lrd_test_results')
                .select('*')
                .eq('id', resultId)
                .single();
            testResult = result;

            // Load question attempts with details
            const { data: attempts } = await supabaseClient
                .from('lrd_question_attempts')
                .select('*, lrd_questions(*, lrd_subjects(name), lrd_chapters(name))')
                .eq('test_result_id', resultId);
            questionAttempts = attempts || [];
        }

        function displayData() {
            if (!testResult) return;

            // Update date
            const date = new Date(testResult.completed_at);
            document.getElementById('testDate').textContent = date.toLocaleDateString('en-GB').replace(/\//g, '-');

            // Update score
            const totalMarks = testResult.total_questions;
            document.getElementById('scoreDisplay').textContent = `${totalMarks} / ${testResult.score}`;
            document.getElementById('accuracyDisplay').textContent = testResult.percentage + '%';

            // Time per question
            const timePerQ = Math.floor(testResult.total_time_seconds / testResult.total_questions);
            document.getElementById('timePerQuestion').textContent = timePerQ + 's';

            // Calculate difficulty stats
            const difficultyStats = calculateDifficultyStats();
            document.getElementById('easyStats').textContent = `${difficultyStats.easy.correct}/${difficultyStats.easy.total}`;
            document.getElementById('hardStats').textContent = `${difficultyStats.hard.correct}/${difficultyStats.hard.total}`;

            // Remaining questions
            document.getElementById('remainingQuestions').textContent = String(testResult.skipped_questions).padStart(2, '0');

            // Improvement needed
            const improvementNeeded = (100 - parseFloat(testResult.percentage)).toFixed(0);
            document.getElementById('improvementNeeded').textContent = improvementNeeded + '%';

            // Draw charts
            drawPieChart();
            drawTrendChart();

            // Display subject analysis
            displaySubjectAnalysis();

            // Display recommendations
            displayRecommendations();
        }

        function calculateDifficultyStats() {
            const stats = {
                easy: { correct: 0, total: 0 },
                medium: { correct: 0, total: 0 },
                hard: { correct: 0, total: 0 }
            };

            questionAttempts.forEach(attempt => {
                const difficulty = attempt.lrd_questions.difficulty_level;
                if (difficulty === 'рк╕рк░рк│') {
                    stats.easy.total++;
                    if (attempt.is_correct) stats.easy.correct++;
                } else if (difficulty === 'ркоркзрлНркпрко') {
                    stats.medium.total++;
                    if (attempt.is_correct) stats.medium.correct++;
                } else if (difficulty === 'ркорлБрк╢рлНркХрлЗрк▓') {
                    stats.hard.total++;
                    if (attempt.is_correct) stats.hard.correct++;
                }
            });

            return stats;
        }

        function drawPieChart() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['рк╕рк╛ркЪрк╛', 'ркЦрлЛркЯрк╛', 'ркмрк╛ркХрлА'],
                    datasets: [{
                        data: [testResult.correct_answers, testResult.wrong_answers, testResult.skipped_questions],
                        backgroundColor: ['#10b981', '#ef4444', '#e5e7eb']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function drawTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5'],
                    datasets: [{
                        label: 'рк╕рлНркХрлЛрк░',
                        data: [55, 62, 59, 70, parseFloat(testResult.percentage)],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function displaySubjectAnalysis() {
            const subjectMap = {};
            
            questionAttempts.forEach(attempt => {
                const subjectName = attempt.lrd_questions.lrd_subjects.name;
                const chapterName = attempt.lrd_questions.lrd_chapters.name;
                
                if (!subjectMap[subjectName]) {
                    subjectMap[subjectName] = {
                        total: 0,
                        correct: 0,
                        chapters: {}
                    };
                }
                
                subjectMap[subjectName].total++;
                if (attempt.is_correct) subjectMap[subjectName].correct++;
                
                if (!subjectMap[subjectName].chapters[chapterName]) {
                    subjectMap[subjectName].chapters[chapterName] = { total: 0, correct: 0 };
                }
                subjectMap[subjectName].chapters[chapterName].total++;
                if (attempt.is_correct) subjectMap[subjectName].chapters[chapterName].correct++;
            });

            let html = '';
            Object.entries(subjectMap).forEach(([subject, data]) => {
                const percentage = ((data.correct / data.total) * 100).toFixed(0);
                const scoreClass = percentage >= 80 ? 'score-excellent' : percentage >= 60 ? 'score-good' : percentage >= 40 ? 'score-average' : 'score-poor';
                
                html += `
                    <div class="subject-item">
                        <div>
                            <div class="subject-name">${subject}</div>
                            <div class="chapter-list">
                                ${Object.entries(data.chapters).map(([chapter, chData]) => {
                                    const chPer = ((chData.correct / chData.total) * 100).toFixed(0);
                                    return `<div class="chapter-item"><span>${chapter}</span><span>${chPer}%</span></div>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="subject-score ${scoreClass}">${percentage}%</div>
                    </div>
                `;
            });

            document.getElementById('subjectAnalysis').innerHTML = html;
        }

        function displayRecommendations() {
            const percentage = parseFloat(testResult.percentage);
            let html = '';

            if (percentage < 60) {
                html += `
                    <div class="rec-section">
                        <h3>рк╡ркзрк╛рк░рлЗ рк╕ркоркп ркЖрккрлЛ:</h3>
                        <ul class="rec-list">
                            <li>рк░рлЛркЬ 2-3 ркХрк▓рк╛ркХ ркирк┐ркпркорк┐ркд ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ</li>
                            <li>ркиркмрк│рк╛ рк╡рк┐рк╖ркпрлЛ рккрк░ рк╡рк┐рк╢рлЗрк╖ ркзрлНркпрк╛рки ркЖрккрлЛ</li>
                            <li>ркмрлЗрк╕рк┐ркХ ркХрлЛркирлНрк╕рлЗрккрлНркЯрлНрк╕ рклрк░рлАркерлА рк╕ркоркЬрлЛ</li>
                        </ul>
                    </div>
                `;
            }

            if (percentage >= 60 && percentage < 80) {
                html += `
                    <div class="rec-section">
                        <h3>рк╡рк╛ркВркЪрки рк╕рлБркзрк╛рк░рлЛ:</h3>
                        <ul class="rec-list">
                            <li>ркоркзрлНркпрко ркЕркирлЗ ркорлБрк╢рлНркХрлЗрк▓ рккрлНрк░рк╢рлНркирлЛ рккрк░ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ рк╡ркзрк╛рк░рлЛ</li>
                            <li>рк╕рлНрккрлАркб ркЕркирлЗ ркПркХрлНркпрлБрк░рк╕рлА ркмркВркирлЗ рк╕рлБркзрк╛рк░рлЛ</li>
                            <li>рк░рк┐рк╡рк┐ркЭрки ркирк┐ркпркорк┐ркд ркХрк░рлЛ</li>
                        </ul>
                    </div>
                `;
            }

            if (percentage >= 80) {
                html += `
                    <div class="rec-section">
                        <h3>ркдркорк╛рк░рлА ркоркЬркмрлВркдрк╛ркИ:</h3>
                        <ul class="rec-list">
                            <li>ркЙркдрлНркдрко рккрлНрк░ркжрк░рлНрк╢рки! ркЖ рк╕рлНркдрк░ ркЬрк╛рк│рк╡рлЛ</li>
                            <li>ркирк┐ркпркорк┐ркд рк░рк┐рк╡рк┐ркЭрки ркЪрк╛рк▓рлБ рк░рк╛ркЦрлЛ</li>
                            <li>ркорлБрк╢рлНркХрлЗрк▓ рккрлНрк░рк╢рлНркирлЛ рккрк░ рк╡ркзрлБ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркХрк░рлЛ</li>
                        </ul>
                    </div>
                `;
            }

            document.getElementById('recommendations').innerHTML = html;
        }

        window.onload = init;
    </script>
</body>
</html>
