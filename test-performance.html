<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <title>LRD Performance</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-item { border: 1px solid #ddd; padding: 10px; text-align: center; border-radius: 5px; }
        .rule-box { background: #1e293b; color: #fbbf24; padding: 15px; border-radius: 8px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        .btn { background: #2563eb; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; }
    </style>
</head>
<body>
    <div id="main-content">
        <div class="card" style="text-align: center;"><h3>ડેટા લોડ થઈ રહ્યો છે...</h3></div>
    </div>

    <script>
        const sb = supabase.createClient("https://bhmycvrbucmbbrpzeane.supabase.co", "YOUR_ANON_KEY");

        async function loadData() {
            const resId = new URLSearchParams(window.location.search).get('result_id');
            if (!resId) { document.getElementById('main-content').innerHTML = "ID missing"; return; }

            // Fetch Results & Profile
            const { data: result } = await sb.from('lrd_test_results').select('*, profiles(*)').eq('id', resId).single();
            
            // Fetch Responses with nested join [cite: 1]
            const { data: responses } = await sb.from('lrd_question_responses')
                .select('*, lrd_questions(chapter_code, lrd_chapters(name, lrd_subjects(name)))')
                .eq('result_id', resId);

            // Fetch Rules based on performance
            const { data: rules } = await sb.from('lrd_rule_engine')
                .select('*')
                .eq('speed_category', result.avg_time_per_question < 45 ? 'fast' : 'slow')
                .limit(2);

            render(result, responses, rules);
        }

        function render(res, resp, rules) {
            let respRows = resp.map(r => `
                <tr>
                    <td>${r.lrd_questions.lrd_chapters.lrd_subjects.name}</td>
                    <td>${r.lrd_questions.lrd_chapters.name}</td>
                    <td>${r.is_correct ? '✅' : '❌'}</td>
                </tr>`).join('');

            document.getElementById('main-content').innerHTML = `
                <div class="card">
                    <h2>વિદ્યાર્થી: ${res.profiles.full_name}</h2>
                    <div class="stat-grid">
                        <div class="stat-item"><b>ગુણ</b><br>${res.obtained_marks}</div>
                        <div class="stat-item"><b>Accuracy</b><br>${res.accuracy_percentage}%</div>
                        <div class="stat-item"><b>સમય</b><br>${res.avg_time_per_question}s</div>
                    </div>
                </div>
                <div class="rule-box">
                    <h3>એક્શન પ્લાન (Rule Engine):</h3>
                    <ul>${rules.map(r => `<li>${r.suggestion_text}</li>`).join('')}</ul>
                </div>
                <div class="card">
                    <h3>પ્રશ્નવાર વિગત</h3>
                    <table><thead><tr><th>વિષય</th><th>ચેપ્ટર</th><th>પરિણામ</th></tr></thead><tbody>${respRows}</tbody></table>
                </div>`;
        }
        loadData();
    </script>
</body>
</html>
