<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--tg-blue:#5288c1;--bg:#e5ddd5;--msg-in:#fff;--msg-out:#dcf8c6}
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
body{font-family:'Roboto',-apple-system,sans-serif;background:var(--bg);margin:0;padding:0;overflow:hidden}
.container{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column;background:var(--bg)}
.header{height:100px;background:linear-gradient(135deg,var(--tg-blue),#3d6fa3);display:flex;flex-direction:column;justify-content:flex-end;padding:0 10px 10px;position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;z-index:100;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
.header-content{display:flex;align-items:center;gap:10px}
.back-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none;flex-shrink:0}
.back-btn svg{width:24px;height:24px;fill:#fff}
.avatar{width:42px;height:42px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:var(--tg-blue);overflow:hidden;flex-shrink:0}
.avatar img{width:100%;height:100%;object-fit:cover}
.header-info{flex:1;cursor:pointer;overflow:hidden}
.name{color:#fff;font-size:17px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.status{color:rgba(255,255,255,0.9);font-size:13px;margin-top:1px}
.menu-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none;flex-shrink:0}
.menu-btn svg{width:22px;height:22px;fill:#fff}
.messages-area{flex:1;overflow-y:auto;padding:110px 10px 60px;background:var(--bg)}
.message{margin-bottom:8px;display:flex;animation:fadeIn 0.2s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.message.out{justify-content:flex-end}
.message.in{justify-content:flex-start}
.msg-bubble{max-width:75%;padding:6px 10px;border-radius:8px;position:relative;box-shadow:0 1px 1px rgba(0,0,0,0.1)}
.msg-bubble.emoji-only{background:none!important;box-shadow:none;padding:2px;font-size:60px;line-height:1;animation:emojiPop 0.3s}
.msg-bubble.emoji-two{background:none!important;box-shadow:none;padding:2px;font-size:30px;line-height:1}
.msg-bubble.emoji-three{background:none!important;box-shadow:none;padding:2px;font-size:17px;line-height:1.2}
@keyframes emojiPop{0%{transform:scale(0)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
.message.out .msg-bubble{background:var(--msg-out);border-bottom-right-radius:2px}
.message.in .msg-bubble{background:var(--msg-in);border-bottom-left-radius:2px}
.msg-text{font-size:15px;color:#000;word-wrap:break-word;white-space:pre-wrap}
.msg-time{font-size:11px;color:#666;margin-top:3px;text-align:right}
.typing{padding:8px 15px;font-size:13px;color:#666;font-style:italic;position:fixed;bottom:60px;left:0;right:0;max-width:480px;margin:0 auto;background:var(--bg);z-index:90;display:none}
.typing.raised{bottom:360px}
.emoji-keyboard,.file-picker{position:fixed;bottom:60px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;display:none;z-index:150;border-top:1px solid #e0e0e0;box-shadow:0 -2px 5px rgba(0,0,0,0.1)}
.emoji-keyboard.show,.file-picker.show{display:flex}
.emoji-keyboard{flex-direction:column;height:300px}
.emoji-tabs{display:flex;border-bottom:1px solid #e0e0e0;background:#f7f7f7;overflow-x:auto}
.emoji-tab{padding:10px 20px;font-size:13px;color:#666;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent}
.emoji-tab.active{color:var(--tg-blue);border-bottom-color:var(--tg-blue)}
.emoji-grid{flex:1;overflow-y:auto;padding:8px;display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.emoji-item{font-size:28px;padding:4px;text-align:center;cursor:pointer;border-radius:6px;line-height:1}
.emoji-item:active{background:#e8e8e8}
.file-picker{padding:15px;flex-direction:column;height:auto}
.file-item{padding:15px;margin:5px 0;background:#f5f5f5;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:15px;font-weight:600;position:relative}
.file-item input{position:absolute;opacity:0;width:100%;height:100%;left:0;top:0}
.file-item:active{background:#e0e0e0}
.input-bar{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f5f5f5;display:flex;align-items:center;gap:6px;padding:5px 8px;border-top:1px solid #d0d0d0;box-shadow:0 -2px 5px rgba(0,0,0,0.05);z-index:200;height:60px}
.emoji-btn,.attach-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none;flex-shrink:0}
.emoji-btn{font-size:22px}
.attach-btn svg{width:20px;height:20px;fill:#999}
.input-wrapper{flex:1;background:#fff;border-radius:20px;display:flex;align-items:center;min-height:40px;max-height:80px;padding:0 12px;border:1px solid #d0d0d0}
.msg-input{flex:1;border:none;outline:none;font-size:15px;resize:none;max-height:70px;overflow-y:auto;background:transparent;padding:8px 0;font-family:inherit}
.send-btn{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;background:var(--tg-blue);flex-shrink:0}
.send-btn svg{width:20px;height:20px;fill:#fff}
.menu-modal{position:fixed;top:0;left:0;right:0;bottom:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,0.5);z-index:300;display:none;align-items:flex-start;justify-content:flex-end;padding:110px 10px 10px}
.menu-modal.show{display:flex}
.menu-content{background:#fff;border-radius:8px;min-width:200px;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
.menu-item{padding:14px 20px;font-size:15px;color:#222;cursor:pointer;border-bottom:1px solid #f0f0f0}
.menu-item:last-child{border-bottom:none}
.menu-item:active{background:#f5f5f5}
.theme-modal,.delete-modal{position:fixed;top:0;left:0;right:0;bottom:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
.theme-modal{z-index:350}
.delete-modal{z-index:400}
.theme-modal.show,.delete-modal.show{display:flex}
.theme-content,.delete-content{background:#fff;border-radius:12px;padding:20px;width:90%;max-width:350px}
.theme-title,.delete-title{font-size:18px;font-weight:600;margin-bottom:15px}
.delete-content{max-width:320px;text-align:center}
.delete-msg{font-size:14px;color:#666;margin-bottom:20px}
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.theme-box{padding:15px 10px;background:#f5f5f5;border-radius:8px;cursor:pointer;text-align:center;border:2px solid transparent}
.theme-box.active{border-color:var(--tg-blue)}
.theme-color{width:100%;height:40px;border-radius:6px;margin-bottom:5px}
.theme-name{font-size:11px;color:#666}
.delete-btns{display:flex;gap:10px}
.del-btn,.close-btn{padding:12px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer}
.del-btn{flex:1}
.del-btn.cancel,.close-btn{background:#f0f0f0;color:#333}
.del-btn.delete{background:#e74c3c;color:#fff}
.close-btn{width:100%;margin-top:15px}
.context-menu{position:fixed;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);padding:8px 0;z-index:500;display:none;min-width:150px}
.context-menu.show{display:block}
.context-item{padding:12px 20px;font-size:14px;color:#333;cursor:pointer;border-bottom:1px solid #f0f0f0}
.context-item:last-child{border-bottom:none}
.context-item:active{background:#f5f5f5}
.empty{text-align:center;padding:40px 20px;color:#999;font-size:15px}
.unread-badge{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:var(--tg-blue);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;display:none;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);z-index:90;cursor:pointer}
.unread-badge.show{display:flex}
.badge-btn{width:20px;height:20px;border-radius:50%;background:#fff;color:var(--tg-blue);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
</style>
</head>
<body>
<div class="container">
<div class="header">
<div class="header-content">
<button class="back-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<div class="avatar" id="chatAvatar">H</div>
<div class="header-info" onclick="openProfile()">
<div class="name" id="chatName">Loading...</div>
<div class="status" id="chatStatus"></div>
</div>
<button class="menu-btn" onclick="showMenu()"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
</div>
</div>
<div class="messages-area" id="messagesArea"><div class="empty">No messages yet</div></div>
<div class="typing" id="typingIndicator">typing...</div>
<div class="unread-badge" id="unreadBadge" onclick="scrollToBottom()">
<button class="badge-btn">‚Üì</button>
<span id="unreadCount">0 new</span>
</div>
<div class="emoji-keyboard" id="emojiKeyboard">
<div class="emoji-tabs">
<div class="emoji-tab" onclick="switchTab('smileys')">üòÄ All</div>
<div class="emoji-tab active" onclick="switchTab('recent')">üòä Recent</div>
<div class="emoji-tab" onclick="switchTab('people')">üëã People</div>
<div class="emoji-tab" onclick="switchTab('animals')">üê± Animals</div>
<div class="emoji-tab" onclick="switchTab('food')">üçï Food</div>
</div>
<div class="emoji-grid" id="emojiGrid"></div>
</div>
<div class="file-picker" id="filePicker">
<div class="file-item">üì∑ Photo<input type="file" accept="image/*" onchange="uploadFile(this,'photo')"></div>
<div class="file-item">üé• Video<input type="file" accept="video/*" onchange="uploadFile(this,'video')"></div>
<div class="file-item">üìÑ Document<input type="file" accept=".pdf,.doc,.docx,.txt" onchange="uploadFile(this,'document')"></div>
</div>
<div class="input-bar" id="inputBar">
<button class="emoji-btn" onclick="toggleEmoji()">üòä</button>
<div class="input-wrapper">
<textarea class="msg-input" id="msgInput" placeholder="Message" rows="1" oninput="autoResize(this);handleTyping()"></textarea>
</div>
<button class="attach-btn" onclick="toggleFiles()"><svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg></button>
<button class="send-btn" onclick="sendMsg()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</div>
</div>
<div class="context-menu" id="contextMenu"></div>
<div class="menu-modal" id="menuModal">
<div class="menu-content">
<div class="menu-item" onclick="toggleMute()"><span id="muteText">üîï Mute</span></div>
<div class="menu-item" onclick="showThemeModal()">üé® Change Theme</div>
<div class="menu-item" onclick="deleteChat()">üóëÔ∏è Delete Chat</div>
</div>
</div>
<div class="theme-modal" id="themeModal">
<div class="theme-content">
<div class="theme-title">Choose Theme</div>
<div class="theme-grid">
<div class="theme-box active" onclick="setTheme('blue')" data-theme="blue"><div class="theme-color" style="background:linear-gradient(135deg,#5288c1,#3d6fa3)"></div><div class="theme-name">Blue</div></div>
<div class="theme-box" onclick="setTheme('purple')" data-theme="purple"><div class="theme-color" style="background:linear-gradient(135deg,#667eea,#764ba2)"></div><div class="theme-name">Purple</div></div>
<div class="theme-box" onclick="setTheme('pink')" data-theme="pink"><div class="theme-color" style="background:linear-gradient(135deg,#f093fb,#f5576c)"></div><div class="theme-name">Pink</div></div>
<div class="theme-box" onclick="setTheme('green')" data-theme="green"><div class="theme-color" style="background:linear-gradient(135deg,#43e97b,#38f9d7)"></div><div class="theme-name">Green</div></div>
</div>
<button class="close-btn" onclick="closeThemeModal()">Close</button>
</div>
</div>
<div class="delete-modal" id="deleteModal">
<div class="delete-content">
<div class="delete-title">Delete Message?</div>
<div class="delete-msg">Choose delete option:</div>
<div class="delete-btns">
<button class="del-btn cancel" onclick="closeDeleteModal()">Cancel</button>
<button class="del-btn delete" onclick="deleteForMe()">For Me</button>
<button class="del-btn delete" onclick="deleteForAll()">For All</button>
</div>
</div>
</div>
<script>
const sb=window.supabase.createClient('https://bhmycvrbucmbbrpzeane.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4');
let user,chatId,otherUser,selectedMsg,unreadCount=0,lastScrollH=0,isTyping=false,typingCh,typingTO;
const emojis={recent:[],smileys:['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','‚ò∫Ô∏è','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚ú®','üí´','‚≠ê','üåü','‚ö°','üî•','üí•','üí¢','üíØ','‚úÖ','‚ùå','‚≠ï','üö´','üéâ','üéä','üéÅ','üèÜ','ü•á','ü•à','ü•â','üëç','üëé','üëè','üôå','ü§ù','üôè','üí™','ü¶æ','ü§≤','üëê','ü§û','‚úåÔ∏è','ü§ü','ü§ò','üëå','ü§å','ü§è','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','‚úã','ü§ö','üñê','üññ','üëã','ü§ô','üíÖ','ü§≥'],people:['üëã','ü§ö','üñê','‚úã','üññ','üëå','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü¶∑','ü¶¥','üëÄ','üëÅ','üëÖ','üëÑ','üíã','üë∂','üëß','üßí','üë¶','üë©','üßë','üë®'],animals:['üê±','üê∂','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ó','üï∑','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üå∏','üå∫','üåº','üåª','üå∑','üåπ','ü•Ä','üèµ','üíê','üåæ','üå≤','üå≥','üå¥','üå±','üåø','‚òòÔ∏è','üçÄ','üçÅ','üçÇ','üçÉ'],food:['üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂','üåΩ','ü•ï','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü•™','ü•ô','üßÜ','üåÆ','üåØ','ü•ó','ü•ò','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','‚òï','üçµ','ü•§','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ','üßÉ','üßâ','üßä']};
emojis.recent=JSON.parse(localStorage.getItem('recent_emoji')||'[]').slice(0,50);
let currentTab='recent';
async function init(){const{data:{user:u}}=await sb.auth.getUser();if(!u){location.href='login.html';return}user=u;const p=new URLSearchParams(location.search);chatId=p.get('chat');if(!chatId){location.href='ngm-chats.html';return}await loadChat();await loadMsgs();subscribe();setInterval(()=>updatePresence(),5000);setInterval(()=>checkStatus(),2000);renderEmojis();lastScrollH=document.getElementById('messagesArea').scrollHeight}
async function loadChat(){try{const{data:c}=await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();if(!c)return;if(c.chat_type==='personal'){const oid=c.user1_id===user.id?c.user2_id:c.user1_id;const{data:u}=await sb.from('ngm_users').select('*').eq('user_id',oid).single();otherUser=u;if(u){document.getElementById('chatName').textContent=u.full_name||u.mobile||'Unknown';const i=u.full_name?u.full_name[0].toUpperCase():'?';document.getElementById('chatAvatar').innerHTML=u.profile_picture_url?`<img src="${u.profile_picture_url}">`:`<span>${i}</span>`;updateStatus(u)}}}catch(e){console.error(e)}}
function updateStatus(u){const now=Date.now(),ls=u.last_seen?new Date(u.last_seen).getTime():0,d=now-ls;document.getElementById('chatStatus').textContent=d<10000?'online':d<60000?'last seen recently':d<3600000?`last seen ${Math.floor(d/60000)} min ago`:d<86400000?`last seen ${Math.floor(d/3600000)} hr ago`:`last seen ${Math.floor(d/86400000)} days ago`}
async function checkStatus(){if(otherUser){const{data:u}=await sb.from('ngm_users').select('is_online,last_seen').eq('user_id',otherUser.user_id).single();if(u){otherUser.is_online=u.is_online;otherUser.last_seen=u.last_seen;updateStatus(otherUser)}}}
async function loadMsgs(){try{const{data:ms}=await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});renderMsgs(ms||[]);await markRead()}catch(e){console.error(e)}}
function renderMsgs(ms){const c=document.getElementById('messagesArea');if(!ms.length){c.innerHTML='<div class="empty">No messages yet<br>Send a message to start chatting!</div>';return}const wasBot=c.scrollHeight-c.scrollTop<=c.clientHeight+100;c.innerHTML=ms.map(m=>{const isOut=m.sender_id===user.id,t=new Date(m.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),txt=m.is_deleted?'<i>Message deleted</i>':m.content,ec=m.content.match(/[\p{Emoji}]/gu)?.length||0,tc=m.content.replace(/[\p{Emoji}\s]/gu,'').length;let cls='';if(tc===0&&ec===1)cls=' emoji-only';else if(tc===0&&ec===2)cls=' emoji-two';else if(tc===0&&ec>=3)cls=' emoji-three';return`<div class="message ${isOut?'out':'in'}" data-id="${m.message_id}" oncontextmenu="showCtx(event,'${m.message_id}',${isOut})"><div class="msg-bubble${cls}"><div class="msg-text">${txt}</div>${cls===''?`<div class="msg-time">${t}</div>`:''}</div></div>`}).join('');const newH=c.scrollHeight;if(wasBot){
