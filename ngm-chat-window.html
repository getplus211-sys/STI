<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{font-family:-apple-system,sans-serif;background:#e5ddd5;padding-bottom:95px}.c{max-width:480px;margin:0 auto;min-height:100vh}.h{position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;height:70px;background:linear-gradient(135deg,var(--pc),var(--sc));display:flex;align-items:center;padding:0 10px;z-index:100;box-shadow:0 2px 5px rgba(0,0,0,0.1)}.bb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.bb svg{width:24px;height:24px;fill:#fff}.hi{flex:1;display:flex;align-items:center;gap:10px;margin-left:5px;cursor:pointer}.ha{width:40px;height:40px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;overflow:hidden}.ha img{width:100%;height:100%;object-fit:cover}.ht{flex:1}.hn{color:#fff;font-size:16px;font-weight:600}.hs{color:rgba(255,255,255,0.8);font-size:12px}.hm{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none;position:relative}.hm svg{width:24px;height:24px;fill:#fff}.mc{padding:80px 10px 10px;min-height:100vh}.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}.mb{max-width:75%;padding:8px 12px;border-radius:8px;position:relative;word-wrap:break-word}.mb.emoji-only{background:none!important;padding:0;font-size:64px;line-height:1}.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}.m.received .mb{background:#fff;border-bottom-left-radius:2px}.mt{font-size:14px;color:#333}.mti{font-size:11px;color:#666;margin-top:4px;text-align:right}.ic{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f5f5f5;padding:8px;z-index:100;border-top:1px solid #e0e0e0;min-height:95px;display:flex;flex-direction:column;gap:8px}.it{display:flex;gap:8px;align-items:flex-end}.ab{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;flex-shrink:0}.mitw{flex:1;position:relative;background:#fff;border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center}.mi{flex:1;padding:10px 15px;border:none;font-size:14px;resize:none;max-height:100px;overflow-y:auto;background:transparent;font-family:inherit}.mi:focus{outline:none}.sb{width:40px;height:40px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}.sb svg{width:20px;height:20px;fill:#fff}.umc{display:flex;align-items:center;gap:8px;padding:4px 0}.ua{width:30px;height:30px;border-radius:50%;background:var(--pc);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#fff}.uc{font-size:12px;color:#666}.da{width:30px;height:30px;border-radius:50%;background:var(--pc);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#fff;transform:rotate(180deg)}.ek{display:none;position:fixed;bottom:95px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;padding:15px;height:250px;overflow-y:auto;z-index:99}.ek.show{display:block}.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}.ee{font-size:32px;padding:8px;cursor:pointer;text-align:center;border-radius:8px;transition:background 0.2s}.ee:hover{background:#f0f0f0}.ctx{position:fixed;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:8px 0;z-index:1000;display:none;min-width:180px}.ctx.show{display:block}.cti{padding:12px 20px;font-size:14px;color:#333;cursor:pointer;border-bottom:1px solid #f0f0f0}.cti:last-child{border-bottom:none}.cti:hover{background:#f5f5f5}.mm{position:fixed;top:0;left:0;right:0;bottom:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:center;justify-content:center}.mm.show{display:flex}.mmc{background:#fff;border-radius:12px;padding:20px;width:90%;max-width:400px}.mmt{font-size:18px;font-weight:600;margin-bottom:15px}.mmi{padding:12px 20px;margin:5px 0;cursor:pointer;border-radius:8px;background:#f5f5f5}.mmi:hover{background:#e0e0e0}.empty{text-align:center;padding:40px 20px;color:#999}.loading{text-align:center;padding:20px;color:#999}
</style>
</head>
<body>
<div class="c">
<div class="h">
<button class="bb" onclick="gb()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<div class="hi" onclick="oui()">
<div class="ha" id="ha">?</div>
<div class="ht"><div class="hn" id="hn">Loading...</div><div class="hs" id="hs"></div></div>
</div>
<button class="hm" onclick="sm()"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
</div>
<div class="mc" id="mc"><div class="loading">Loading messages...</div></div>
<div class="ek" id="ek">
<div class="eg" id="eg"></div>
</div>
<div class="ic">
<div class="umc" id="umc" style="display:none">
<button class="ua" onclick="su()">‚Üë</button>
<span class="uc" id="uc">0 new messages</span>
<button class="da" onclick="sd()">‚Üë</button>
</div>
<div class="it">
<button class="ab" onclick="tf()">üìé</button>
<div class="mitw">
<textarea class="mi" id="mi" placeholder="Type a message..." rows="1"></textarea>
</div>
<button class="ab" onclick="te()" id="eb">üòä</button>
<button class="sb" id="sbn" onclick="smd()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</div>
</div>
</div>
<div class="ctx" id="ctx"></div>
<div class="mm" id="mm">
<div class="mmc">
<div class="mmt">Chat Options</div>
<div class="mmi" onclick="tn()">üîî Mute Notifications</div>
<div class="mmi" onclick="dc()">üóëÔ∏è Delete Chat</div>
<div class="mmi" onclick="ct()">üé® Change Theme</div>
<div class="mmi" onclick="cm()">‚úñÔ∏è Close</div>
</div>
</div>
<script>
const U='https://bhmycvrbucmbbrpzeane.supabase.co',K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4',sb=window.supabase.createClient(U,K);
let cu,cid,ou,ct,rm=null,sm_id=null,um=0,lsh=0;
const es=['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','‚ò∫Ô∏è','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];
(()=>{const t={purple:{primary:'#667eea',secondary:'#764ba2'},blue:{primary:'#4facfe',secondary:'#00f2fe'},pink:{primary:'#f093fb',secondary:'#f5576c'},green:{primary:'#43e97b',secondary:'#38f9d7'},orange:{primary:'#fa709a',secondary:'#fee140'},red:{primary:'#ff6b6b',secondary:'#ee5a6f'},teal:{primary:'#2bcbba',secondary:'#45caff'},indigo:{primary:'#4776e6',secondary:'#8e54e9'}},th=localStorage.getItem('nandigram_theme')||'purple';if(t[th]){document.documentElement.style.setProperty('--pc',t[th].primary);document.documentElement.style.setProperty('--sc',t[th].secondary)}})();
async function init(){await ca();if(!cu){window.location.href='login.html';return}const p=new URLSearchParams(window.location.search);cid=p.get('chat');if(!cid){window.location.href='ngm-chats.html';return}await lc();await lm();subs();setInterval(()=>ups(),10000);ie();lsh=document.getElementById('mc').scrollHeight}
async function ca(){const{data:{user}}=await sb.auth.getUser();if(user){cu=user}else{cu=null;window.location.href='login.html'}}
async function lc(){try{const{data:c}=await sb.from('ngm_chats').select('*').eq('chat_id',cid).single();if(!c)return;ct=c.chat_type;if(ct==='personal'){const oid=c.user1_id===cu.id?c.user2_id:c.user1_id;const{data:u}=await sb.from('ngm_users').select('*').eq('user_id',oid).single();ou=u;if(u){document.getElementById('hn').textContent=u.full_name||u.mobile||'Unknown';const in1=u.full_name?u.full_name.charAt(0).toUpperCase():'?';document.getElementById('ha').innerHTML=u.profile_picture_url?`<img src="${u.profile_picture_url}">`:`<span>${in1}</span>`;uss(u)}}else if(ct==='group'){const{data:g}=await sb.from('ngm_groups').select('*').eq('chat_id',cid).single();if(g){document.getElementById('hn').textContent=g.group_name;document.getElementById('ha').innerHTML='üë•';const{data:mc}=await sb.from('ngm_chat_participants').select('*',{count:'exact'}).eq('chat_id',cid).eq('is_active',true);document.getElementById('hs').textContent=`${mc.length||0} members`}}else if(ct==='channel'){const{data:ch}=await sb.from('ngm_channels').select('*').eq('chat_id',cid).single();if(ch){document.getElementById('hn').textContent=ch.channel_name;document.getElementById('ha').innerHTML='üì¢';document.getElementById('hs').textContent=`${ch.subscriber_count||0} subscribers`}}}catch(e){console.error(e)}}
function uss(u){if(u.is_online){document.getElementById('hs').textContent='online'}else if(u.last_seen){const ls=new Date(u.last_seen),n=new Date(),df=n-ls;if(df<60000)document.getElementById('hs').textContent='last seen just now';else if(df<3600000)document.getElementById('hs').textContent=`last seen ${Math.floor(df/60000)}m ago';else if(df<86400000)document.getElementById('hs').textContent=`last seen ${Math.floor(df/3600000)}h ago`;else document.getElementById('hs').textContent=`last seen ${Math.floor(df/86400000)}d ago`}else{document.getElementById('hs').textContent='offline'}}
async function lm(){try{const{data:ms}=await sb.from('ngm_messages').select('*').eq('chat_id',cid).order('created_at',{ascending:true});rms(ms||[]);await umr()}catch(e){console.error(e);document.getElementById('mc').innerHTML='<div class="empty">Error loading messages</div>'}}
function rms(ms){const con=document.getElementById('mc');if(ms.length===0){con.innerHTML='<div class="empty">No messages yet. Start the conversation!</div>';return}con.innerHTML=ms.map(m=>{const is=m.sender_id===cu.id,tm=new Date(m.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),del=m.is_deleted?'<i>Message deleted</i>':m.content,ieo=/^[\p{Emoji}\s]+$/u.test(m.content)&&m.content.length<=10,eoc=ieo?' emoji-only':'';return`<div class="m ${is?'sent':'received'}" data-mid="${m.message_id}" oncontextmenu="scm(event,'${m.message_id}',${is})"><div class="mb${eoc}"><div class="mt">${del}</div>${!ieo?`<div class="mti">${tm}${is&&m.is_read?' ‚úì‚úì':''}</div>`:''}</div></div>`}).join('');const osh=lsh;con.scrollTop=con.scrollHeight;const nsh=con.scrollHeight;if(nsh>osh&&nsh-osh>100)unm();lsh=nsh}
function unm(){um++;document.getElementById('uc').textContent=`${um} new message${um>1?'s':''}`;document.getElementById('umc').style.display='flex'}
function su(){const con=document.getElementById('mc');con.scrollTop=con.scrollHeight;um=0;document.getElementById('umc').style.display='none'}
function sd(){const con=document.getElementById('mc');con.scrollTop=0}
async function smd(){const inp=document.getElementById('mi'),txt=inp.value.trim();if(!txt)return;try{const{error}=await sb.from('ngm_messages').insert({chat_id:cid,sender_id:cu.id,content:txt,message_type:'text',created_at:new Date().toISOString()});if(!error){await sb.from('ngm_chats').update({last_message_at:new Date().toISOString()}).eq('chat_id',cid);inp.value='';inp.style.height='auto';await lm()}}catch(e){console.error(e)}}
async function umr(){try{const{data:ms}=await sb.from('ngm_messages').select('message_id').eq('chat_id',cid).eq('is_read',false).neq('sender_id',cu.id);if(ms&&ms.length>0){const mids=ms.map(m=>m.message_id);await sb.from('ngm_messages').update({is_read:true,read_at:new Date().toISOString()}).in('message_id',mids);await sb.from('ngm_chat_participants').update({unread_count:0}).eq('chat_id',cid).eq('user_id',cu.id)}}catch(e){console.error(e)}}
async function ups(){try{await sb.from('ngm_users').update({last_seen:new Date().toISOString(),is_online:true}).eq('user_id',cu.id)}catch(e){console.error(e)}}
function scm(e,mid,is){e.preventDefault();sm_id=mid;const ctx=document.getElementById('ctx');ctx.innerHTML=`<div class="cti" onclick="ctxa('copy')">Copy</div>${is?'<div class="cti" onclick="ctxa(\'delete\')">Delete</div>':''}`;ctx.style.left=e.pageX+'px';ctx.style.top=e.pageY+'px';ctx.classList.add('show')}
async function ctxa(a){document.getElementById('ctx').classList.remove('show');if(a==='delete'&&sm_id){await sb.from('ngm_messages').update({is_deleted:true,deleted_at:new Date().toISOString()}).eq('message_id',sm_id);await lm()}else if(a==='copy'){const m=document.querySelector(`[data-mid="${sm_id}"] .mt`);if(m)navigator.clipboard.writeText(m.textContent)}}
function te(){document.getElementById('ek').classList.toggle('show')}
function ie(){const eg=document.getElementById('eg');eg.innerHTML=es.map(e=>`<div class="ee" onclick="ae('${e}')">${e}</div>`).join('')}
function ae(e){const inp=document.getElementById('mi');inp.value+=e;inp.focus();document.getElementById('ek').classList.remove('show')}
function tf(){alert('File: Photo, Video, Document, Location')}
function sm(){document.getElementById('mm').classList.add('show')}
function cm(){document.getElementById('mm').classList.remove('show')}
function tn(){alert('Notifications muted');cm()}
async function dc(){if(confirm('Delete this chat?')){try{await sb.from('ngm_messages').delete().eq('chat_id',cid);await sb.from('ngm_chat_participants').delete().eq('chat_id',cid);await sb.from('ngm_chats').delete().eq('chat_id',cid);window.location.href='ngm-chats.html'}catch(e){console.error(e)}}}
function ct(){const ts=['purple','blue','pink','green','orange','red','teal','indigo'];const c=prompt('Theme:\n'+ts.map((t,i)=>`${i+1}. ${t}`).join('\n'));if(c&&ts[parseInt(c)-1]){localStorage.setItem('nandigram_theme',ts[parseInt(c)-1]);location.reload()}}
function oui(){if(ou)window.location.href=`ngm-user-info.html?user=${ou.user_id}`}
function subs(){sb.channel('messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${cid}`},()=>lm()).subscribe()}
function gb(){window.location.href='ngm-chats.html'}
const mii=document.getElementById('mi');mii.addEventListener('input',function(){this.style.height='auto';this.style.height=this.scrollHeight+'px'});
mii.addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();smd()}});
document.addEventListener('click',()=>document.getElementById('ctx').classList.remove('show'));
document.addEventListener('copy',e=>e.preventDefault());document.addEventListener('paste',e=>e.preventDefault());
init();
</script>
</body>
</html>
