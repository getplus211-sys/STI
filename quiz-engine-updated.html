<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mock Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;
box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3{margin:6px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer}
.primary{background:#22c55e;color:#fff}
.gray{background:#e5e7eb}
.danger{background:#dc2626;color:#fff}
.option{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0;cursor:pointer;display:flex;align-items:center;gap:10px}
.option.selected{border-color:#22c55e;background:#f0fdf4}
.hidden{display:none}
#timer{font-weight:bold;color:#dc2626;font-size:1.2rem}
.nav-btns{display:flex;gap:10px;margin-top:20px}
.q-nav{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:15px}
.q-num{padding:10px;text-align:center;background:#eee;border-radius:8px;cursor:pointer;font-size:14px}
.q-num.active{background:#22c55e;color:#fff}
.q-num.answered{background:#9333ea;color:#fff}
.chart-container{width:100%;max-width:300px;margin:20px auto}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:bold;text-transform:uppercase}
.badge-easy{background:#dcfce7;color:#166534}
.badge-medium{background:#fef9c3;color:#854d0e}
.badge-hard{background:#fee2e2;color:#991b1b}

/* Modal Styles */
#modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;
}
#modal-content {
  background: #fff; padding: 24px; border-radius: 20px; max-width: 320px; width: 90%;
  text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
}
</style>
</head>
<body>

<div id="modal-overlay">
  <div id="modal-content">
    <div id="modal-icon" style="font-size: 48px; margin-bottom: 12px;"></div>
    <h3 id="modal-title" style="margin-bottom: 8px;"></h3>
    <p id="modal-text" style="color: #64748b; margin-bottom: 20px; line-height: 1.5;"></p>
    <button id="modal-btn" class="primary" onclick="closeModal()">OK</button>
  </div>
</div>

<div id="setup-screen" class="container">
  <div class="card">
    <h2 id="setup-title">Mock Test</h2>
    <p id="setup-desc" style="color: #64748b;">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</p>
    
    <div id="test-info" class="hidden">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
        <div class="card" style="margin: 0; background: #f8fafc; text-align: center;">
          <small style="color: #64748b;">àªªà«àª°àª¶à«àª¨à«‹</small>
          <div id="info-qcount" style="font-size: 20px; font-weight: bold;">-</div>
        </div>
        <div class="card" style="margin: 0; background: #f8fafc; text-align: center;">
          <small style="color: #64748b;">àª¸àª®àª¯</small>
          <div id="info-time" style="font-size: 20px; font-weight: bold;">-</div>
        </div>
      </div>
    </div>

    <button id="start-btn" class="primary hidden" onclick="startTest()">Start Test Now</button>
  </div>
</div>

<div id="quiz-screen" class="container hidden">
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px">
    <span id="q-progress" style="font-weight:600;color:#64748b">Question 1/0</span>
    <span id="timer">00:00</span>
  </div>

  <div class="card">
    <div id="question-text" style="font-size:18px;margin-bottom:20px;font-weight:600;line-height:1.5"></div>
    <div id="options-container"></div>
  </div>

  <div class="nav-btns">
    <button class="gray" onclick="prevQuestion()" style="flex:1">Previous</button>
    <button class="primary" id="next-btn" onclick="nextQuestion()" style="flex:2">Next</button>
  </div>

  <div class="q-nav" id="q-nav-grid"></div>

  <div class="card" style="margin-top:15px">
    <button class="danger" onclick="confirmSubmit()">Submit Test</button>
  </div>
</div>

<div id="result-screen" class="container hidden">
  <div class="card" style="text-align:center">
    <h2>ğŸ‰ àªŸà«‡àª¸à«àªŸ àªªà«‚àª°à«àª£!</h2>
    <div id="score-details" style="margin:20px 0"></div>
    <div class="chart-container"><canvas id="resultChart"></canvas></div>
    <button class="primary" onclick="location.href='dashboard.html'">Dashboard àªªàª° àªœàª¾àª“</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://halzulnewvmyutfqrycy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhbHp1bG5ld3ZteXV0ZnFyeWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MjYzMDIsImV4cCI6MjA4MjEwMjMwMn0.oXIheubGUVzQAF8oZmE_U4W94R-nD068cXzTuw_sEro";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const urlParams = new URLSearchParams(window.location.search);
const QUIZ_ID = urlParams.get("quiz_id");
const TIMEOUT_MS = 10000;

let questions = [];
let currentIndex = 0;
let userAnswers = [];
let user = null;
let timeLeft = 0;
let timerInterval = null;
let startTime = null;
let isSubmitting = false;

const timeout = (ms) => new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), ms));

/* ========== INITIALIZATION ========== */
async function init() {
  const { data: { user }, error: authError } = await sb.auth.getUser();
  if (authError || !user) {
    alertModal('ğŸ”’', 'àª²à«‹àª—àª¿àª¨ àªœàª°à«‚àª°à«€', 'àªŸà«‡àª¸à«àªŸ àª†àªªàªµàª¾ àª®àª¾àªŸà«‡ àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª²à«‹àª—àª¿àª¨ àª•àª°à«‹.');
    setTimeout(() => window.location.href = 'index.html', 2000);
    return;
  }

  try {
    // 1. Fetch Mapping First
    const { data: mapping } = await sb.from("quiz_test_mapping").select("lrd_test_id").eq("quiz_id", QUIZ_ID).maybeSingle();
    const finalTestId = mapping ? mapping.lrd_test_id : QUIZ_ID;

    // 2. Fetch Questions WITH PROPER SUBJECT AND CHAPTER DETAILS
    const { data, error } = await Promise.race([
      sb.from("lrd_questions").select(`
        *,
        lrd_chapters (
          id,
          name,
          chapter_code,
          subject_id,
          lrd_subjects (
            id,
            name,
            subject_code
          )
        )
      `).eq("quiz_id", QUIZ_ID).order('id', { ascending: true }),
      timeout(TIMEOUT_MS)
    ]);
    
    if (error) throw error;
    questions = data || [];

    // Process questions to add subject_id and chapter_id at top level
    questions = questions.map(q => ({
      ...q,
      subject_id: q.lrd_chapters?.subject_id || null,
      chapter_id: q.chapter_id || q.lrd_chapters?.id || null,
      subject_name: q.lrd_chapters?.lrd_subjects?.name || 'Unknown',
      chapter_name: q.lrd_chapters?.name || 'Unknown'
    }));

    console.log('Loaded questions with subject/chapter info:', questions.length);

    // 3. Check Existing Result in LRD table
    const { data: existingResult } = await Promise.race([
      sb.from("lrd_test_results")
        .select("*")
        .eq("user_id", user.id)
        .eq("test_id", finalTestId)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (existingResult) {
      showResults({
        total_score: existingResult.obtained_marks,
        correct_count: (existingResult.easy_correct + existingResult.hard_correct),
        wrong_count: (questions.length - (existingResult.easy_correct + existingResult.hard_correct) - existingResult.unanswered_count),
        skipped_count: existingResult.unanswered_count,
        time_taken_seconds: existingResult.total_time_taken_seconds
      });
    } else {
      document.getElementById("setup-desc").innerText = "àª¤à«ˆàª¯àª¾àª° àª›à«‹?";
      document.getElementById("info-qcount").innerText = questions.length;
      document.getElementById("info-time").innerText = questions.length + " min";
      document.getElementById("test-info").classList.remove("hidden");
      document.getElementById("start-btn").classList.remove("hidden");
    }
  } catch (err) {
    console.error('Init error:', err);
    alertModal('âŒ', 'Error', 'àª®àª¾àª¹àª¿àª¤à«€ àª²à«‹àª¡ àª•àª°àªµàª¾àª®àª¾àª‚ àª¸àª®àª¸à«àª¯àª¾ àª†àªµà«€.');
  }
}

/* ========== TEST ENGINE ========== */
function startTest() {
  document.getElementById("setup-screen").classList.add("hidden");
  document.getElementById("quiz-screen").classList.remove("hidden");
  timeLeft = questions.length * 60;
  startTime = Date.now();
  renderQuestion();
  renderNav();
  timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
  if (timeLeft <= 0) { submitTest(); return; }
  timeLeft--;
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;
  document.getElementById("timer").innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
}

function renderQuestion() {
  const q = questions[currentIndex];
  document.getElementById("q-progress").innerText = `Question ${currentIndex + 1}/${questions.length}`;
  
  const diffBadge = q.difficulty_level ? `<span class="badge badge-${q.difficulty_level.toLowerCase()}">${q.difficulty_level}</span> ` : '';
  document.getElementById("question-text").innerHTML = `${diffBadge}${q.question_text}`;

  const container = document.getElementById("options-container");
  container.innerHTML = "";

  const opts = [
    {key:'1', text: q.option_a, label: 'A'},
    {key:'2', text: q.option_b, label: 'B'},
    {key:'3', text: q.option_c, label: 'C'},
    {key:'4', text: q.option_d, label: 'D'},
    {key:'5', text: 'àª¬àª¾àª•à«€ àª°àª¾àª–à«‡àª² (E)', label: 'E'}
  ];

  opts.forEach(o => {
    const div = document.createElement("div");
    div.className = `option ${userAnswers[currentIndex] === o.key ? 'selected' : ''}`;
    div.innerHTML = `<strong>${o.label}.</strong> <span>${o.text}</span>`;
    div.onclick = () => { userAnswers[currentIndex] = o.key; renderQuestion(); renderNav(); };
    container.appendChild(div);
  });

  document.getElementById("next-btn").innerText = (currentIndex === questions.length - 1) ? "Finish" : "Next";
}

function renderNav() {
  const grid = document.getElementById("q-nav-grid");
  grid.innerHTML = "";
  questions.forEach((_, i) => {
    const d = document.createElement("div");
    d.className = `q-num ${i === currentIndex ? 'active' : ''} ${userAnswers[i] ? 'answered' : ''}`;
    d.innerText = i + 1;
    d.onclick = () => { currentIndex = i; renderQuestion(); renderNav(); };
    grid.appendChild(d);
  });
}

function prevQuestion() { if(currentIndex > 0) { currentIndex--; renderQuestion(); renderNav(); } }
function nextQuestion() {
  if(currentIndex < questions.length - 1) { currentIndex++; renderQuestion(); renderNav(); }
  else confirmSubmit();
}

function confirmSubmit() { alertModal('â“', 'àª¸àª¬àª®àª¿àªŸ?', 'àª¶à«àª‚ àª¤àª®à«‡ àªŸà«‡àª¸à«àªŸ àªªà«‚àª°à«€ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?', true); }

/* ========== IMPROVED TEST SUBMISSION WITH PROPER subject_id AND chapter_id ========== */
async function submitTest() {
  if (isSubmitting) return;
  isSubmitting = true;
  clearInterval(timerInterval);

  const finalTime = Math.floor((Date.now() - startTime) / 1000);
  let correct = 0, wrong = 0, skipped = 0;
  let easy_c = 0, easy_t = 0, hard_c = 0, hard_t = 0;

  questions.forEach((q, i) => {
    const a = userAnswers[i];
    const isEasy = q.difficulty_level?.toLowerCase() === 'easy';
    if(isEasy) easy_t++; else hard_t++;

    if(!a || a === '5') {
        skipped++;
    } else if(Number(a) === Number(q.correct_option)) {
        correct++;
        if(isEasy) easy_c++; else hard_c++;
    } else {
        wrong++;
    }
  });

  const score = correct - (wrong * 0.25);
  const accuracy = (correct / (correct + wrong)) * 100 || 0;

  try {
    // Get test mapping
    const { data: mapping } = await sb.from("quiz_test_mapping").select("lrd_test_id").eq("quiz_id", QUIZ_ID).maybeSingle();
    const finalTestId = mapping ? mapping.lrd_test_id : QUIZ_ID;

    // Determine subject_id from first question (àª¸à«Œàª¥à«€ àª¸àª¾àª®àª¾àª¨à«àª¯ subject)
    const subjectCounts = {};
    questions.forEach(q => {
      if (q.subject_id) {
        subjectCounts[q.subject_id] = (subjectCounts[q.subject_id] || 0) + 1;
      }
    });
    
    // Get most common subject_id
    let mainSubjectId = null;
    let maxCount = 0;
    for (const [sid, count] of Object.entries(subjectCounts)) {
      if (count > maxCount) {
        maxCount = count;
        mainSubjectId = sid;
      }
    }

    // Create test result
    const { data: resData, error: resErr } = await sb.from("lrd_test_results").insert({
      user_id: user.id,
      test_id: finalTestId,
      obtained_marks: score,
      accuracy_percentage: accuracy,
      total_time_taken_seconds: finalTime,
      easy_correct: easy_c,
      easy_total: easy_t,
      hard_correct: hard_c,
      hard_total: hard_t,
      unanswered_count: skipped,
      avg_time_per_question: (finalTime / questions.length).toFixed(2),
      subject_id: mainSubjectId, // Main subject for this test
      concentration_rating: calculateConcentration(accuracy, finalTime / questions.length),
      improvement_percentage: 0
    }).select().single();

    if(resErr) throw resErr;

    console.log('Test result created:', resData.id);

    // IMPROVED: Create question responses WITH PROPER subject_id and chapter_id
    const responses = [];
    
    for (let i = 0; i < questions.length; i++) {
      const q = questions[i];
      const userAnswer = userAnswers[i];
      
      // Determine subject_id and chapter_id for this question
      let questionSubjectId = q.subject_id;
      let questionChapterId = q.chapter_id;

      // If still null, try to fetch from database
      if (!questionSubjectId || !questionChapterId) {
        try {
          const { data: qDetails, error: qError } = await sb
            .from('lrd_questions')
            .select(`
              chapter_id,
              lrd_chapters (
                id,
                subject_id
              )
            `)
            .eq('id', q.id)
            .single();

          if (!qError && qDetails) {
            questionChapterId = questionChapterId || qDetails.chapter_id || qDetails.lrd_chapters?.id;
            questionSubjectId = questionSubjectId || qDetails.lrd_chapters?.subject_id;
          }
        } catch (err) {
          console.warn('Could not fetch chapter details for question', q.id);
        }
      }

      responses.push({
        result_id: resData.id,
        question_id: q.id,
        subject_id: questionSubjectId,  // àª¯à«‹àª—à«àª¯ subject_id
        chapter_id: questionChapterId,  // àª¯à«‹àª—à«àª¯ chapter_id
        user_selected_option: userAnswer ? String.fromCharCode(96 + parseInt(userAnswer)) : null,
        is_correct: Number(userAnswer) === Number(q.correct_option),
        time_spent_seconds: Math.floor(finalTime / questions.length),
        created_at: new Date().toISOString()
      });
    }

    // Batch insert responses
    const { error: respErr } = await sb.from("lrd_question_responses").insert(responses);
    
    if (respErr) {
      console.error('Response insert error:', respErr);
      throw respErr;
    }

    console.log(`Successfully saved ${responses.length} question responses`);

    // Show results
    showResults({ 
      total_score: score, 
      correct_count: correct, 
      wrong_count: wrong, 
      skipped_count: skipped, 
      time_taken_seconds: finalTime 
    });

  } catch (err) {
    console.error('Submit error:', err);
    alertModal('âŒ', 'Error', 'àª¸à«‡àªµ àª•àª°àªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.');
    isSubmitting = false;
  }
}

// Helper function to calculate concentration rating
function calculateConcentration(accuracy, avgTimePerQuestion) {
  let rating = 5; // Default medium
  
  if (accuracy >= 90 && avgTimePerQuestion < 45) {
    rating = 10;
  } else if (accuracy >= 80 && avgTimePerQuestion < 60) {
    rating = 9;
  } else if (accuracy >= 70) {
    rating = 8;
  } else if (accuracy >= 60) {
    rating = 7;
  } else if (accuracy >= 50) {
    rating = 6;
  } else if (accuracy < 40) {
    rating = 4;
  }
  
  return rating;
}

/* ========== RESULTS & UI HELPERS ========== */
function showResults(data) {
  document.getElementById("setup-screen").classList.add("hidden");
  document.getElementById("quiz-screen").classList.add("hidden");
  document.getElementById("result-screen").classList.remove("hidden");

  const m = Math.floor(data.time_taken_seconds / 60), s = data.time_taken_seconds % 60;

  document.getElementById("score-details").innerHTML = `
    <div style="font-size:32px;font-weight:bold;color:#22c55e">${data.total_score.toFixed(2)}</div>
    <div style="color:#64748b;margin-bottom:15px">àª¤àª®àª¾àª°à«‹ àª¸à«àª•à«‹àª°</div>
    <div style="display:flex;justify-content:space-around;font-weight:600">
      <div style="color:#22c55e">âœ”ï¸ ${data.correct_count}</div>
      <div style="color:#dc2626">âŒ ${data.wrong_count}</div>
      <div style="color:#94a3b8">â­ï¸ ${data.skipped_count}</div>
    </div>
    <div style="margin-top:10px;color:#64748b;font-size:14px">àª¸àª®àª¯: ${m}:${s < 10 ? '0' : ''}${s}</div>
  `;

  const ctx = document.getElementById("resultChart");
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['àª¸àª¾àªšàª¾', 'àª–à«‹àªŸàª¾', 'àª¬àª¾àª•à«€'],
      datasets: [{
        data: [data.correct_count, data.wrong_count, data.skipped_count],
        backgroundColor: ['#22c55e', '#dc2626', '#94a3b8'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '70%',
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

function alertModal(icon, title, text, isConfirm = false) {
  document.getElementById("modal-icon").innerText = icon;
  document.getElementById("modal-title").innerText = title;
  document.getElementById("modal-text").innerText = text;
  
  const btn = document.getElementById("modal-btn");
  if (isConfirm) {
    btn.innerText = "àª¹àª¾, àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹";
    btn.onclick = () => { closeModal(); submitTest(); };
  } else {
    btn.innerText = "OK";
    btn.onclick = closeModal;
  }
  
  document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal-overlay").style.display = "none";
}

// Initialize on load
init();
</script>
</body>
</html>
