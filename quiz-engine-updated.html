<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mock Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;
box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3{margin:6px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer}
.primary{background:#22c55e;color:#fff}
.gray{background:#e5e7eb}
.danger{background:#dc2626;color:#fff}
.option{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0;cursor:pointer}
.option.active{background:#22c55e;color:#fff}
.top{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px}
.hidden{display:none}
.rank{display:flex;gap:10px;align-items:center}
.rank.me{border:2px solid #22c55e}
.loader{text-align:center;padding:40px}
.loader-icon{font-size:40px;animation:spin 2s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.qgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(45px,1fr));gap:8px;margin:15px 0}
.qbtn{padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-weight:600;font-size:14px}
.qbtn.answered{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.current{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.correct{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.wrong{background:#ef4444;color:#fff;border-color:#ef4444}
.qbtn.skipped{background:#cbd5e1;color:#333;border-color:#cbd5e1}
.badge{background:#22c55e;color:#fff;padding:5px 12px;border-radius:20px;font-size:14px;display:inline-block;margin-bottom:10px}
.badge.free{background:#3b82f6}
.badge.paid{background:#f59e0b}
.nav-buttons{display:flex;gap:10px;margin-top:10px;margin-bottom:20px}
.nav-buttons button{flex:1}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;
backdrop-filter:blur(4px)}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:20px;max-width:420px;width:90%;
padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease}
@keyframes modalPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.modal-icon{font-size:50px;text-align:center;margin-bottom:15px}
.modal-title{font-size:22px;font-weight:700;text-align:center;margin-bottom:10px;color:#1e293b}
.modal-text{font-size:15px;color:#64748b;text-align:center;line-height:1.6;margin-bottom:20px}
.modal-brand{font-size:13px;color:#94a3b8;text-align:center;margin-top:15px;font-weight:600}
.modal-brand span{color:#22c55e;font-weight:700}
.modal-buttons{display:flex;gap:10px}
.modal-buttons button{flex:1;border-radius:12px;padding:12px;font-size:15px;font-weight:600;cursor:pointer;border:none}
.modal-btn-confirm{background:#22c55e;color:#fff}
.modal-btn-cancel{background:#e2e8f0;color:#334155}
.modal-btn-ok{background:#3b82f6;color:#fff}
.time-elapsed{background:#3b82f6;color:#fff;padding:10px 16px;border-radius:12px;font-size:16px;font-weight:600;text-align:center}
</style>
</head>

<body>
<div class="container" id="app">
  <div class="card loader">
    <div class="loader-icon">тП│</div>
    <h3>Loading...</h3>
    <p>Please wait</p>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" id="modalIcon">тД╣я╕П</div>
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-text" id="modalText">Message</div>
    <div class="modal-buttons" id="modalButtons"></div>
    <div class="modal-brand"><span>KAPiLa Institute</span><br>Created by devendra_dd</div>
  </div>
</div>

<script>

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const TIMEOUT_MS = 15000;

// Get quiz_id from URL
const urlParams = new URLSearchParams(window.location.search);
const QUIZ_ID = urlParams.get('quiz');

if (!QUIZ_ID) {
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h3>тЪая╕П Invalid URL</h3>
      <p>Quiz ID not found in URL</p>
      <button class="primary" onclick="window.history.back()">Go Back</button>
    </div>
  `;
  throw new Error('No quiz ID provided');
}

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const app = document.getElementById("app");
let user, questions=[], answers={}, current=0;
let timeElapsed=0, timer, submitted=false, startTime;
let CURRENT_QUIZ = null; // Will be loaded from database

/* ========== MODAL HELPERS ========== */
function showModal(icon, title, text, buttons) {
  const modal = document.getElementById('modal');
  const modalIcon = document.getElementById('modalIcon');
  const modalTitle = document.getElementById('modalTitle');
  const modalText = document.getElementById('modalText');
  const modalButtons = document.getElementById('modalButtons');

  modalIcon.textContent = icon;
  modalTitle.textContent = title;
  modalText.textContent = text;
  modalButtons.innerHTML = buttons;
  modal.classList.add('show');
}

function hideModal() {
  document.getElementById('modal').classList.remove('show');
}

function confirmModal(title, text, onConfirm) {
  showModal(
    'тЭУ',
    title,
    text,
    `<button class="modal-btn-cancel" onclick="hideModal()">рк░ркж ркХрк░рлЛ</button>
     <button class="modal-btn-confirm" onclick="hideModal();(${onConfirm})()">рк╣рк╛, ркЦрк╛ркдрк░рлА ркЫрлЗ</button>`
  );
}

function alertModal(icon, title, text) {
  showModal(
    icon,
    title,
    text,
    `<button class="modal-btn-ok" onclick="hideModal();location.reload()">рк╕ркоркЬрк╛ркпрлБркВ</button>`
  );
}

/* ========== TIMEOUT HELPER ========== */
const timeout = (ms) => new Promise((_, reject) => 
  setTimeout(() => reject(new Error('Request timeout')), ms)
);

/* ========== ERROR DISPLAY ========== */
function showError(message, showRetry = true) {
  app.innerHTML = `
    <div class="card">
      <h3>тЪая╕П Error</h3>
      <p>${message}</p>
      ${showRetry ? '<button class="primary" onclick="location.reload()">Retry</button>' : ''}
    </div>
  `;
}

/* ========== INIT ========== */
(async()=>{
  try {
    if (!navigator.onLine) {
      showError('No internet connection. Please check and try again.');
      return;
    }

    // 1. Load quiz information from quiz_test_mapping table
    const { data: quizInfo, error: quizError } = await Promise.race([
      sb
        .from("quiz_test_mapping")
        .select("*")
        .eq("quiz_id", QUIZ_ID)
        .single(),
      timeout(TIMEOUT_MS)
    ]);

    if (quizError || !quizInfo) {
      showError('Quiz not found. Please check the URL.');
      return;
    }

    CURRENT_QUIZ = quizInfo;

    // 2. Get authenticated user
    const {data:{user:u}} = await Promise.race([
      sb.auth.getUser(),
      timeout(TIMEOUT_MS)
    ]);

    if(!u){
      showError('Please login first', false);
      return;
    }
    user=u;

    // 3. Check access for paid quizzes
    if (!CURRENT_QUIZ.is_free) {
      const { data: access } = await Promise.race([
        sb
          .from("user_test_access")
          .select("has_access")
          .eq("user_id", user.id)
          .eq("test_id", QUIZ_ID)
          .maybeSingle(),
        timeout(TIMEOUT_MS)
      ]);

      if (!access || !access.has_access) {
        alertModal('ЁЯФТ', 'ркПркХрлНрк╕рлЗрк╕ ркиркерлА', 'ркдркорк╛рк░рлА рккрк╛рк╕рлЗ ркЖ ркЯрлЗрк╕рлНркЯркирлЛ ркПркХрлНрк╕рлЗрк╕ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ payment ркХрк░рлЛ.');
        showError('ркдркорк╛рк░рлА рккрк╛рк╕рлЗ ркЖ ркЯрлЗрк╕рлНркЯркирлЛ ркПркХрлНрк╕рлЗрк╕ ркиркерлА.', false);
        return;
      }
    }

    // 4. Check if user already took this test
    const { data: existingResult } = await Promise.race([
      sb
        .from("test_results")
        .select("total_score, correct_count, wrong_count, skipped_count, e_count, time_taken_seconds, answers")
        .eq("user_id", user.id)
        .eq("test_id", QUIZ_ID)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (existingResult) {
      answers = existingResult.answers || {};

      const { data: qData } = await Promise.race([
        sb
          .from("lrd_questions")
          .select("*")
          .eq("test_id", QUIZ_ID)
          .order("id"),
        timeout(TIMEOUT_MS)
      ]);

      if (!qData || qData.length === 0) {
        showError("Test рккрлНрк░рк╢рлНркирлЛ ркиркерлА ркорк│рлНркпрк╛");
        return;
      }

      questions = qData;

      loadResult(
        existingResult.total_score,
        existingResult.correct_count,
        existingResult.wrong_count,
        existingResult.skipped_count,
        existingResult.e_count,
        existingResult.time_taken_seconds
      );
      return;
    }

    // 5. Load questions
    const { data: qData } = await Promise.race([
      sb
        .from("lrd_questions")
        .select("*")
        .eq("test_id", QUIZ_ID)
        .order("id"),
      timeout(TIMEOUT_MS)
    ]);

    if(!qData || qData.length === 0){
      showError("Test рккрлНрк░рк╢рлНркирлЛ ркиркерлА ркорк│рлНркпрк╛");
      return;
    }

    questions=qData;
    loadIntro();
  } catch(err) {
    console.error('Init error:', err);
    showError('Failed to load: ' + err.message);
  }
})();

/* ========== LOAD INTRO (ENTRY CARD) ========== */
function loadIntro() {
  app.innerHTML = `
    <div class="card">
      <span class="badge ${CURRENT_QUIZ.badge_class}">${CURRENT_QUIZ.badge_text}</span>
      <h2>${CURRENT_QUIZ.quiz_name}</h2>
      <p style="margin: 10px 0; color: #64748b;">${CURRENT_QUIZ.description || ''}</p>
      <p><b>Instructions:</b></p>
      <ul style="margin: 15px 0; padding-left: 25px; line-height: 1.8;">
        <li>Total Questions: <b>${questions.length}</b></li>
        <li>No Time Limit - Take your time!</li>
        <li><b>No Negative Marking</b> - Only correct answers add points.</li>
        <li>E option: Available if needed.</li>
        <li>Your time will be tracked for leaderboard ranking.</li>
        ${CURRENT_QUIZ.is_free ? '<li><b>тЬЕ No payment required - 100% Free!</b></li>' : '<li><b>ЁЯТО Paid Test - Access Required</b></li>'}
      </ul>
      <label style="display: flex; align-items: center; gap: 8px; margin: 20px 0;">
        <input type="checkbox" id="agree" style="width: auto; cursor: pointer;"> 
        <span>I agree to the terms and conditions.</span>
      </label>
      <button class="primary" onclick="startTest()">Start Test Now</button>
    </div>
  `;
}

/* ========== START TEST ========== */
async function startTest(){
  const agreeCheckbox = document.getElementById('agree');
  if(!agreeCheckbox.checked){
    alertModal('тЪая╕П', 'рк╢рк░ркдрлЛ рк╕рлНрк╡рлАркХрк╛рк░рлЛ', 'ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ instructions рк╕рлНрк╡рлАркХрк╛рк░рлЛ.');
    return;
  }

  try {
    const { data: existingResult } = await Promise.race([
      sb
        .from("test_results")
        .select("id")
        .eq("user_id", user.id)
        .eq("test_id", QUIZ_ID)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (existingResult) {
      alertModal('ЁЯЪл', 'ркЯрлЗрк╕рлНркЯ рккрлВрк░рлНркг ркеркИ ркЧркИ', 'ркдркорлЗ ркЖ ркЯрлЗрк╕рлНркЯ рккрк╣рлЗрк▓рлЗркерлА ркЖрккрлА ркжрлАркзрлА ркЫрлЗ. ркдркорлЗ ркдрлЗркирлЗ рклрк░рлАркерлА ркЖрккрлА рк╢ркХркдрк╛ ркиркерлА.');
      setTimeout(() => location.reload(), 2000);
      return;
    }

    startTime = Date.now();
    startTimer();
    renderQuestion();
  } catch(err) {
    console.error('Start test error:', err);
    showError('Failed to start test. Please try again.');
  }
}

/* ========== QUESTION DISPLAY ========== */
function renderQuestion(){
  if(!questions[current]) return;
  
  const q=questions[current];
  const opts=["a","b","c","d","e"];
  const qGridHTML = questions.map((_, idx) => {
    const isAnswered = answers[questions[idx].id] !== undefined;
    const isCurrent = idx === current;
    let btnClass = 'qbtn';
    if (isCurrent) btnClass += ' current';
    else if (isAnswered) btnClass += ' answered';
    return `<button class="${btnClass}" onclick="jumpTo(${idx})">${idx+1}</button>`;
  }).join("");

  app.innerHTML=`
  <div class="card">
    <span class="badge ${CURRENT_QUIZ.badge_class}">${CURRENT_QUIZ.badge_text}</span>
    <div class="top">
      <span>Q ${current+1}/${questions.length}</span>
      <span class="time-elapsed" id="timer">тП▒я╕П 0:00</span>
    </div>
    <p style="font-size:17px;line-height:1.5">${q.question_text}</p>
    
    ${opts.map((o,i)=>`
      <div class="option ${answers[q.id]===i+1?'active':''}" onclick="selectOpt(${i+1})">
        ${q["option_"+o]}
      </div>
    `).join("")}
    
    <div class="nav-buttons">
      <button onclick="prev()" ${current===0?'disabled':''}>тмЕ рккрк╛ркЫрк│</button>
      ${current<questions.length-1
        ?`<button class="primary" onclick="next()">ркЖркЧрк│ тЮб</button>`
        :`<button class="primary" onclick="confirmSubmit()">тЬЕ рк╕ркмркорк┐ркЯ</button>`
      }
    </div>
  </div>
  
  <div class="card">
    <h4>Question Navigator</h4>
    <div class="qgrid">${qGridHTML}</div>
    <button class="danger" onclick="confirmSubmit()">Submit Test</button>
  </div>
  `;
}

function selectOpt(o){
  answers[questions[current].id]=o;
  renderQuestion();
}

function jumpTo(idx){
  current=idx;
  renderQuestion();
}

function next(){ 
  if(current<questions.length-1){
    current++;
    renderQuestion();
  }
}

function prev(){ 
  if(current>0){
    current--;
    renderQuestion();
  }
}

/* ========== TIMER (COUNT UP) ========== */
function startTimer(){
  timer=setInterval(()=>{
    timeElapsed = Math.floor((Date.now() - startTime) / 1000);
    const t=document.getElementById("timer");
    if(t) {
      const minutes = Math.floor(timeElapsed / 60);
      const seconds = timeElapsed % 60;
      t.innerText = `тП▒я╕П ${minutes}:${String(seconds).padStart(2,"0")}`;
    }
  },1000);
}

/* ========== SUBMIT CONFIRMATION ========== */
function confirmSubmit() {
  showModal(
    'тЭУ',
    'ркЯрлЗрк╕рлНркЯ рк╕ркмркорк┐ркЯ ркХрк░рлЛ?',
    'рк╢рлБркВ ркдркорлЗ ркЦрк░рлЗркЦрк░ ркЖ ркЯрлЗрк╕рлНркЯ рк╕ркмркорк┐ркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ? ркдркорлЗ рккркЫрлА ркХрлЛркИ ркЬрк╡рк╛ркм ркмркжрк▓рлА рк╢ркХрк╢рлЛ ркирк╣рлАркВ.',
    `<button class="modal-btn-cancel" onclick="hideModal()">рк░ркж ркХрк░рлЛ</button>
     <button class="modal-btn-confirm" onclick="hideModal();submitTest()">рк╣рк╛, рк╕ркмркорк┐ркЯ ркХрк░рлЛ</button>`
  );
}

/* ========== SUBMIT (NO NEGATIVE MARKING) ========== */
async function submitTest(auto=false){
  if(submitted) return;
  submitted=true;
  clearInterval(timer);
  hideModal();

  try {
    let correct=0, wrong=0, skip=0, e=0, score=0;

    questions.forEach(q=>{
      const a=answers[q.id];
      if(!a){
        skip++;
      }
      else if(a===5){
        e++;
      }
      else if(a===q.correct_option){
        correct++;
        score++;
      }
      else{
        wrong++;
      }
    });

    score = Number(score.toFixed(2));
    const finalTimeElapsed = Math.floor((Date.now() - startTime) / 1000);
    const safeAnswers = JSON.parse(JSON.stringify(answers));

    const {error} = await Promise.race([
      sb.from("test_results").insert({
        user_id:user.id,
        test_id:QUIZ_ID,
        total_score:score,
        correct_count:correct,
        wrong_count:wrong,
        skipped_count:skip,
        e_count:e,
        time_taken_seconds:finalTimeElapsed,
        answers:safeAnswers
      }),
      timeout(TIMEOUT_MS)
    ]);

    if(error){
      alertModal('тЭМ', 'рк╕рлЗрк╡ ркиркерлА ркеркпрлБркВ', 'Result save failed: '+error.message);
      submitted = false;
      return;
    }

    loadResult(score,correct,wrong,skip,e,finalTimeElapsed);
  } catch(err) {
    console.error('Submit error:', err);
    alertModal('тЭМ', 'рк╕ркмркорк┐ркЯ ркирк┐рк╖рлНрклрк│', 'Failed to submit. Please try again.');
    submitted = false;
  }
}

/* ========== RESULT ========== */
function loadResult(score, c, w, s, e, timeFromDB = null) {
  const timeTaken = timeFromDB !== null ? timeFromDB : timeElapsed;
  const minutes = Math.floor(timeTaken / 60);
  const seconds = timeTaken % 60;

  app.innerHTML = `
  <div class="card">
    <span class="badge ${CURRENT_QUIZ.badge_class}">${CURRENT_QUIZ.badge_text}</span>
    <h2>Your Score: ${score}</h2>
    <div style="margin: 15px 0; line-height: 1.6;">
      <p><b>Correct:</b> ${c} | <b>Wrong:</b> ${w}</p>
      <p><b>Skipped:</b> ${s} | <b>E Options:</b> ${e}</p>
      <p><b>Time Taken:</b> ${minutes}m ${seconds}s</p>
    </div>
    <canvas id="chart"></canvas><br>
    
    <button class="primary" onclick="viewPerformance()">ЁЯУК Performance ркЬрлБркУ</button>
    <br><br>
    <button class="gray" onclick="viewSolutions()">ркЬрк╡рк╛ркмрлЛ ркЕркирлЗ рк╕рлЛрк▓рлНркпрлБрк╢рки ркЬрлБркУ</button>
    <br><br>
    <button class="gray" onclick="loadLeaderboard()">ЁЯПЖ Leaderboard ркЬрлБркУ</button>
  </div>`;

  const chart = document.getElementById("chart");
  new Chart(chart, {
    type: "pie",
    data: {
      labels: ["Correct", "Wrong", "Skipped", "E"],
      datasets: [{ 
        data: [c, w, s, e], 
        backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1', '#eab308'] 
      }]
    }
  });
}

/* ========== SOLUTIONS VIEW ========== */
function viewSolutions() {
  let gridHTML = '<div class="card"><h4>Question Navigator</h4><div class="qgrid">';
  questions.forEach((q, idx) => {
    const userAns = answers[q.id];
    const isCorrect = userAns === q.correct_option;
    let btnClass = 'qbtn';
    if(!userAns) btnClass += ' skipped';
    else if(isCorrect) btnClass += ' correct';
    else btnClass += ' wrong';
    gridHTML += `<button class="${btnClass}" onclick="scrollToSolution(${idx})">${idx+1}</button>`;
  });
  gridHTML += '</div></div>';

  let solutionHTML = `<span class="badge ${CURRENT_QUIZ.badge_class}">${CURRENT_QUIZ.badge_text}</span>
                      <h3>Answer Key & Solutions</h3>
                      <button class="gray" style="margin-bottom:15px" onclick="location.reload()">Back to Result</button>
                      ${gridHTML}`;

  questions.forEach((q, index) => {
    const userAns = answers[q.id];
    const isCorrect = userAns === q.correct_option;
    const options = ["a", "b", "c", "d", "e"];
    
    solutionHTML += `
    <div class="card" id="sol${index}" style="border-left: 5px solid ${isCorrect ? '#22c55e' : '#ef4444'}">
      <p><b>Q${index + 1}:</b> ${q.question_text}</p>
      <p><b>Your Answer:</b> ${userAns ? q["option_" + options[userAns - 1]] : "Skipped"}</p>
      <p style="color: #22c55e"><b>Correct Answer:</b> ${q["option_" + options[q.correct_option - 1]]}</p>
      ${q.solution ? `<div style="background:#f8fafc; padding:10px; margin-top:10px; font-size:14px;"><b>Solution:</b> ${q.solution}</div>` : ""}
    </div>`;
  });

  solutionHTML += `<button class="primary" onclick="location.reload()">Finish</button>`;
  app.innerHTML = solutionHTML;
  window.scrollTo(0, 0);
}

function scrollToSolution(idx){
  const el = document.getElementById('sol'+idx);
  if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

/* ========== LEADERBOARD ========== */
async function loadLeaderboard(){
  try {
    const { data: results, error } = await Promise.race([
      sb
        .from("test_results")
        .select("user_id,total_score,time_taken_seconds")
        .eq("test_id", QUIZ_ID)
        .order("total_score", { ascending: false })
        .order("time_taken_seconds", { ascending: true }),
      timeout(TIMEOUT_MS)
    ]);

    if(error){
      alertModal('тЭМ', 'рк▓рлЛркб ркирк┐рк╖рлНрклрк│', "Failed to load leaderboard: " + error.message);
      return;
    }

    const userIds = results.map(r => r.user_id);

    const { data: profiles } = await Promise.race([
      sb
        .from("profiles")
        .select("id, full_name")
        .in("id", userIds),
      timeout(TIMEOUT_MS)
    ]);

    const nameMap = {};
    if(profiles) {
      profiles.forEach(p => nameMap[p.id] = p.full_name);
    }

    const myIndex = results.findIndex(r => r.user_id === user.id);
    if (myIndex === -1) {
      alertModal('тЪая╕П', 'рк░рк┐ркЭрк▓рлНркЯ ркиркерлА ркорк│рлНркпрлБркВ', "Your result not found in leaderboard");
      return;
    }

    const myRank = myIndex + 1;
    const myData = results[myIndex];

    const listHTML = results
      .filter(r => r.user_id !== user.id)
      .map((u, i) => {
        const minutes = Math.floor(u.time_taken_seconds / 60);
        const seconds = u.time_taken_seconds % 60;
        return `
        <div class="card rank">
          <b>Rank #${results.indexOf(u) + 1}</b><br>
          Name: ${nameMap[u.user_id] || "User"}<br>
          Score: ${u.total_score}<br>
          Time: ${minutes}m ${seconds}s
        </div>
      `;
      }).join("");

    const myMinutes = Math.floor(myData.time_taken_seconds / 60);
    const mySeconds = myData.time_taken_seconds % 60;

    app.innerHTML = `
      <span class="badge ${CURRENT_QUIZ.badge_class}">${CURRENT_QUIZ.badge_text}</span>
      <button class="gray" onclick="location.reload()">тмЕ Back to Result</button>
      <br><br>

      <div class="card rank me">
        <b>Your Rank: #${myRank}</b><br>
        Name: ${nameMap[user.id] || "You"}<br>
        Score: ${myData.total_score}<br>
        Time: ${myMinutes}m ${mySeconds}s
      </div>

      <h2>Leaderboard</h2>
      ${listHTML}
    `;
  } catch(err) {
    console.error('Leaderboard error:', err);
    alertModal('тЭМ', 'рк▓рлЛркб ркирк┐рк╖рлНрклрк│', "Failed to load leaderboard. Please try again.");
  }
}

/* ========== VIEW PERFORMANCE ========== */
async function viewPerformance() {
  try {
    // Check if we have LRD test mapping
    const { data: mapping } = await Promise.race([
      sb
        .from("quiz_test_mapping")
        .select("lrd_test_id")
        .eq("quiz_id", QUIZ_ID)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (!mapping) {
      alertModal('тЪая╕П', 'ркорлЗрккрк┐ркВркЧ ркиркерлА ркорк│рлА', 'ркЖ ркЯрлЗрк╕рлНркЯ ркорк╛ркЯрлЗ performance data ркЙрккрк▓ркмрлНркз ркиркерлА.');
      return;
    }

    // Get LRD test result
    const { data: lrdResult } = await Promise.race([
      sb
        .from("lrd_test_results")
        .select("id")
        .eq("user_id", user.id)
        .eq("test_id", mapping.lrd_test_id)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (lrdResult) {
      window.location.href = `test-performance.html?result_id=${lrdResult.id}`;
    } else {
      alertModal('тЪая╕П', 'Performance Data ркиркерлА', 'Performance data рк╣ркЬрлБ ркЙрккрк▓ркмрлНркз ркиркерлА. ркерлЛркбрк╛ рк╕ркоркп рккркЫрлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.');
    }
  } catch (err) {
    console.error('View performance error:', err);
    alertModal('тЭМ', 'Error', 'Performance рк▓рлЛркб ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.');
  }
}

</script>
</body>
</html>
