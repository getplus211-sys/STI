<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hind Vadodara', sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .nav { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 16px 24px; border-radius: 12px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-white { background: white; color: #1e40af; }
        @media (max-width: 768px) {
            body { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <h1 style="font-size: 20px;">ЁЯУК Performance Dashboard</h1>
            <button class="btn btn-white" onclick="window.location.href='index.html'">тЖР Home</button>
        </div>
        <div id="dashboardContent">рк▓рлЛркб ркХрк░рлА рк░рк╣рлНркпрк╛ ркЫрлАркП...</div>
    </div>

    <script>
        const SUPABASE_URL = "YOUR_SUPABASE_URL";
        const SUPABASE_KEY = "YOUR_SUPABASE_KEY";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ATTEMPT_ID = new URLSearchParams(window.location.search).get('attempt_id');

        async function init() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) {
                alert('рк▓рлЛркЧрк┐рки ркЬрк░рлВрк░рлА ркЫрлЗ!');
                window.location.href = 'index.html';
                return;
            }

            const { data: attempt } = await sb
                .from('lrd_test_attempts')
                .select('*')
                .eq('id', ATTEMPT_ID)
                .eq('user_id', user.id)
                .single();

            if (!attempt) {
                alert('Performance data ркиркерлА ркорк│рлНркпрлЛ!');
                return;
            }

            const { data: responses } = await sb
                .from('lrd_test_responses')
                .select('*')
                .eq('attempt_id', ATTEMPT_ID);

            const { data: profile } = await sb
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            const { data: quiz } = await sb
                .from('lrd_quizzes')
                .select('*')
                .eq('quiz_id', attempt.quiz_id)
                .single();

            // Get suggestions from rules
            const suggestions = await getRuleSuggestions(attempt, responses);

            renderDashboard({ attempt, responses, profile, quiz, suggestions });
        }

        async function getRuleSuggestions(attempt, responses) {
            const suggestions = [];
            
            // Group responses by chapter
            const chapterStats = {};
            responses.forEach(r => {
                const key = `${r.subject_name}|||${r.chapter_name}`;
                if (!chapterStats[key]) {
                    chapterStats[key] = {
                        subject: r.subject_name,
                        chapter: r.chapter_name,
                        total: 0,
                        correct: 0
                    };
                }
                chapterStats[key].total++;
                if (r.is_correct) chapterStats[key].correct++;
            });

            // For each chapter, get matching rules
            for (const key in chapterStats) {
                const stat = chapterStats[key];
                const accuracy = (stat.correct / stat.total) * 100;

                const { data: rules } = await sb
                    .from('lrd_rule_engine')
                    .select('*')
                    .ilike('subject_id', stat.subject)
                    .ilike('chapter_code', stat.chapter)
                    .lte('min_score', accuracy)
                    .gte('max_score', accuracy)
                    .eq('speed_category', attempt.speed_category)
                    .order('priority');

                if (rules && rules.length > 0) {
                    suggestions.push({
                        subject: stat.subject,
                        chapter: stat.chapter,
                        accuracy: accuracy.toFixed(1),
                        rule: rules[0]
                    });
                }
            }

            return suggestions;
        }

        function renderDashboard({ attempt, responses, profile, quiz, suggestions }) {
            const initials = profile?.full_name?.split(' ').map(n => n[0]).join('').toUpperCase() || 'U';
            const testDate = new Date(attempt.created_at).toLocaleDateString('gu-IN');

            // Group by subject and chapter
            const subjectGroups = {};
            responses.forEach(r => {
                if (!subjectGroups[r.subject_name]) {
                    subjectGroups[r.subject_name] = {};
                }
                if (!subjectGroups[r.subject_name][r.chapter_name]) {
                    subjectGroups[r.subject_name][r.chapter_name] = {
                        total: 0,
                        correct: 0,
                        easy: { total: 0, correct: 0 },
                        medium: { total: 0, correct: 0 },
                        hard: { total: 0, correct: 0 }
                    };
                }
                const ch = subjectGroups[r.subject_name][r.chapter_name];
                ch.total++;
                if (r.is_correct) ch.correct++;

                const diff = r.difficulty_level?.toLowerCase() || 'medium';
                if (ch[diff]) {
                    ch[diff].total++;
                    if (r.is_correct) ch[diff].correct++;
                }
            });

            const html = `
<div style="max-width: 1200px; margin: 0 auto;">
    
    <!-- Profile Card -->
    <div style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 24px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px;">
        <div style="display: flex; align-items: center; gap: 16px; flex: 1; min-width: 200px;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; flex-shrink: 0;">
                ${initials}
            </div>
            <div style="min-width: 0;">
                <p style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600; margin: 0 0 5px 0;">рк╡рк┐ркжрлНркпрк╛рк░рлНркерлА</p>
                <h2 style="font-size: 20px; font-weight: bold; color: #1e293b; margin: 0; overflow: hidden; text-overflow: ellipsis;">${profile?.full_name || 'рк╡рк┐ркжрлНркпрк╛рк░рлНркерлА'}</h2>
            </div>
        </div>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <p style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 8px;">рк▓рлЗрк╡рк▓</p>
                <span style="background: #fed7aa; color: #ea580c; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold; display: inline-block;">${profile?.current_level || 'ркЧрлЛрк▓рлНркб'}</span>
            </div>
            <div style="text-align: center;">
                <p style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 8px;">ркдрк╛рк░рлАркЦ</p>
                <p style="font-size: 15px; font-weight: bold; color: #475569; margin: 0;">${testDate}</p>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <h3 style="font-weight: bold; color: #475569; margin: 0 0 16px 0; font-size: 16px;">ЁЯУК рккрк░рк┐ркгрк╛рко</h3>
            <canvas id="pieChart"></canvas>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ркЧрлБркг</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${quiz?.total_marks || 100}/<span style="color: #2563eb;">${attempt.obtained_marks.toFixed(0)}</span></p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ркЪрлЛркХрк╕рк╛ркИ</p>
                <p style="font-size: 18px; font-weight: bold; color: #10b981; margin: 0;">${attempt.accuracy_percentage.toFixed(1)}%</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">рк╕ркоркп/рккрлНрк░рк╢рлНрки</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${Math.round(attempt.avg_time_per_question)}s</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ркПркХрк╛ркЧрлНрк░ркдрк╛</p>
                <p style="font-size: 18px; font-weight: bold; color: #8b5cf6; margin: 0;">${attempt.concentration_rating}/10</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">рк╕рк░рк│</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${attempt.easy_correct}/${attempt.easy_attempted}</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ркЕркШрк░рк╛</p>
                <p style="font-size: 18px; font-weight: bold; color: #ef4444; margin: 0;">${attempt.hard_correct}/${attempt.hard_attempted}</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">рк╕рлНрккрлАркб</p>
                <p style="font-size: 16px; font-weight: bold; margin: 0;">${attempt.speed_category}</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ркмрк╛ркХрлА</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${attempt.skipped_questions}</p>
            </div>
        </div>
    </div>

    <!-- Subject-wise Analysis -->
    <h3 style="font-size: 18px; font-weight: bold; color: #1e293b; margin: 0 0 16px 0;">ЁЯУЪ рк╡рк┐рк╖ркп ркЕркирлЗ ркЪрлЗрккрлНркЯрк░рк╡рк╛рк░ ркПркирк╛рк▓рк┐рк╕рк┐рк╕</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
        ${Object.keys(subjectGroups).map((subject, idx) => {
            const chapters = subjectGroups[subject];
            const totalQ = Object.values(chapters).reduce((s, c) => s + c.total, 0);
            const correctQ = Object.values(chapters).reduce((s, c) => s + c.correct, 0);
            const subjectAccuracy = ((correctQ / totalQ) * 100).toFixed(0);
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'];
            const bgColors = ['#eff6ff', '#f5f3ff', '#f0fdf4', '#fffbeb'];
            const color = colors[idx % colors.length];
            const bgColor = bgColors[idx % bgColors.length];

            return `
            <div style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
                <div style="background: ${bgColor}; padding: 16px; border-bottom: 1px solid #e2e8f0;">
                    <h4 style="font-weight: bold; color: ${color}; font-size: 16px; margin: 0 0 8px 0;">${subject}</h4>
                    <span style="background: ${color}; color: white; font-size: 12px; padding: 4px 12px; border-radius: 12px; font-weight: 600;">ркирк┐рккрлБркгркдрк╛: ${subjectAccuracy}%</span>
                </div>
                <div style="padding: 16px;">
                    ${Object.keys(chapters).map(chapter => {
                        const ch = chapters[chapter];
                        const chAcc = ((ch.correct / ch.total) * 100).toFixed(0);
                        return `
                        <div style="padding: 12px; margin: 8px 0; background: #f8fafc; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #1e293b; font-size: 14px;">${chapter}</strong>
                                <span style="background: ${chAcc >= 70 ? '#dcfce7' : chAcc >= 40 ? '#fef3c7' : '#fee2e2'}; color: ${chAcc >= 70 ? '#166534' : chAcc >= 40 ? '#92400e' : '#991b1b'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${chAcc}%</span>
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                ркХрлБрк▓: ${ch.total} | рк╕рк╛ркЪрк╛: ${ch.correct} | рк╕рк░рк│: ${ch.easy.correct}/${ch.easy.total} | ркЕркШрк░рк╛: ${ch.hard.correct}/${ch.hard.total}
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            `;
        }).join('')}
    </div>

    <!-- Action Plan -->
    <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); margin-bottom: 24px;">
        <h3 style="font-size: 18px; font-weight: bold; margin: 0 0 16px 0; color: #fbbf24; border-bottom: 2px solid rgba(251,191,36,0.3); padding-bottom: 10px;">
            ЁЯОп ркдркорк╛рк░рк╛ ркорк╛ркЯрлЗ ркПркХрлНрк╢рки рккрлНрк▓рк╛рки
        </h3>
        ${suggestions.length > 0 ? `
            <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                ${suggestions.slice(0, 5).map(s => `
                    <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; border-left: 4px solid #fbbf24;">
                        <div style="font-weight: bold; color: #fbbf24; margin-bottom: 8px;">${s.chapter} (${s.accuracy}%)</div>
                        <div style="color: #cbd5e1; font-size: 14px; margin-bottom: 8px;">${s.rule.suggestion_text || 'рк╡ркзрлБ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркХрк░рлЛ'}</div>
                        <div style="color: #94a3b8; font-size: 13px;">${s.rule.action_plan_text || 'ркжрк░рк░рлЛркЬ practice ркХрк░ркдрк╛ рк░рк╣рлЛ.'}</div>
                    </div>
                `).join('')}
            </div>
        ` : `
            <p style="color: #cbd5e1; font-size: 14px;">ЁЯОЙ ркдркорк╛рк░рлБркВ performance ркЙркдрлНркдрко ркЫрлЗ! ркЖ рк░рлАркдрлЗ ркЪрк╛рк▓рлБ рк░рк╛ркЦрлЛ!</p>
        `}
    </div>
</div>
            `;

            document.getElementById('dashboardContent').innerHTML = html;

            // Render pie chart
            setTimeout(() => {
                const ctx = document.getElementById('pieChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['рк╕рк╛ркЪрк╛', 'ркЦрлЛркЯрк╛', 'ркмрк╛ркХрлА'],
                            datasets: [{
                                data: [attempt.correct_answers, attempt.wrong_answers, attempt.skipped_questions],
                                backgroundColor: ['#22c55e', '#ef4444', '#f59e0b']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            cutout: '70%',
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }
            }, 100);
        }

        init();
    </script>
</body>
</html>
