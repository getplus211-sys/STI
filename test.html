<!doctype html>
<html lang="gu">
<head>
  <meta charset="utf-8" />
  <title>Mock Test System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f7f7fb; }
    .container { max-width:960px; margin:0 auto; padding:12px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin:10px 0; }
    .hidden { display:none; }
    .nav-actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .nav-actions button { flex:1; min-width:100px; padding:10px; border-radius:6px; border:1px solid #ccc; }
    .danger { background:#e6362e; color:#fff; border:none; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(40px,1fr)); gap:6px; }
    .grid button { padding:6px; border-radius:6px; border:1px solid #ccc; font-size:12px; }
    .grid button.correct { background:#e6ffed; }
    .grid button.wrong { background:#ffecec; }
    .grid button.skipped { background:#f0f0f0; }
    header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; }
    .meta { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:16px; border-radius:8px; width:95%; max-width:600px; }
    @media(max-width:600px){
      .nav-actions button { font-size:14px; padding:8px; }
      #questionText { font-size:15px; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <h1>Mock Test</h1>
    <div class="meta">
      <div id="timer">àª¬àª¾àª•à«€ àª¸àª®àª¯: 120:00</div>
      <button id="paletteBtn">Palette</button>
    </div>
  </header>

  <!-- Pre-Test Rules -->
  <section id="preRules" class="card">
    <h2>àªŸà«‡àª¸à«àªŸ àª¶àª°à«‚ àª•àª°àª¤àª¾ àªªàª¹à«‡àª²àª¾àª‚</h2>
    <label><input type="checkbox" id="rule1"/> àª‡àª¨à«àªŸàª°àª¨à«‡àªŸ àªšàª¾àª²à« àª°àª¾àª–àªµà«àª‚</label><br>
    <label><input type="checkbox" id="rule2"/> àªàª• àªœ àªµàª¾àª° àªŸà«‡àª¸à«àªŸ àª†àªªàª¶à«‹</label><br>
    <label><input type="checkbox" id="rule3"/> àªµàª¿àª¨à«àª¡à«‹ àª¬àª‚àª§ àª¨àª¹àª¿ àª•àª°àª¶à«‹</label><br>
    <button id="startBtn" disabled>Start Test</button>
  </section>

  <!-- Test Section -->
  <section id="testSection" class="hidden">
    <div id="qNumber"></div>
    <div id="questionBox" class="card">
      <div id="questionText"></div>
      <form id="optionsForm">
        <label><input type="radio" name="option" value="1"/> A</label><br>
        <label><input type="radio" name="option" value="2"/> B</label><br>
        <label><input type="radio" name="option" value="3"/> C</label><br>
        <label><input type="radio" name="option" value="4"/> D</label><br>
        <label><input type="radio" name="option" value="5"/> E - Not Attempted</label>
      </form>
    </div>
    <div class="nav-actions">
      <button id="prevBtn">àªªàª¾àª›àª³</button>
      <button id="saveNextBtn">Save & Next</button>
      <button id="skipBtn">Skip</button>
      <button id="submitBtn" class="danger">Final Submit</button>
    </div>
    <div id="paletteModal" class="modal hidden">
      <div class="modal-content">
        <h3>Question Palette</h3>
        <div id="paletteGrid" class="grid"></div>
        <button id="closePalette">Close</button>
      </div>
    </div>
  </section>

  <!-- Result Section -->
  <section id="resultSection" class="hidden">
    <h2>Result</h2>
    <div id="summary" class="card"></div>
    <canvas id="pieChart" width="300" height="300"></canvas>
    <div id="solutions"></div>
    <button onclick="showLeaderboard()">Leaderboard àªœà«àª“</button>
  </section>

  <!-- Leaderboard Section -->
  <section id="leaderboardSection" class="hidden">
    <h2>Leaderboard</h2>
    <div id="lbTable" class="card"></div>
    <button onclick="backToResult()">Back</button>
  </section>

</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://bhmycvrbucmbbrpzeane.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

const TEST_ID = "mocktest-01"; // ğŸ‘ˆ questions table àª®àª¾àª‚ test_id àª† value àª¹à«‹àªµà«€ àªœà«‹àªˆàª
const TOTAL_QUESTIONS = 200;
const DURATION_SECONDS = 120*60;

let questions=[], answers=[], currentIndex=0, timerInterval=null, submitted=false;

// Pre-rules
const checks=[rule1,rule2,rule3];
checks.forEach(ch=>ch.addEventListener("change",()=>{startBtn.disabled=!checks.every(c=>c.checked);}));
startBtn.addEventListener("click",()=>{preRules.classList.add("hidden");testSection.classList.remove("hidden");startTest();});

// Load questions
async function loadQuestions(){
  const {data,error}=await supabase.from("questions").select("*").eq("test_id",TEST_ID);
  if(error)console.error(error);
  questions=data||[];
  answers=questions.map(q=>({qid:q.id,selected:0}));
}

// Render question
function renderQuestion(){
  const q=questions[currentIndex];
  if(!q)return;
  qNumber.textContent=`Question ${currentIndex+1}/${TOTAL_QUESTIONS}`;
  questionText.textContent=q.question_text;
  [...optionsForm.elements].forEach(el=>el.checked=(Number(el.value)===answers[currentIndex].selected));
}

// Save answer
function saveAnswer(sel){answers[currentIndex].selected=sel;buildPalette();}

// Palette
function buildPalette(){
  paletteGrid.innerHTML="";
  answers.forEach((a,i)=>{
    const btn=document.createElement("button");
    btn.textContent=i+1;
    if(a.selected===0||a.selected===5)btn.classList.add("skipped");
    btn.onclick=()=>{currentIndex=i;renderQuestion();togglePalette(false);};
    paletteGrid.appendChild(btn);
  });
}
function togglePalette(show){paletteModal.classList.toggle("hidden",!show);}
paletteBtn.onclick=()=>togglePalette(true);
closePalette.onclick=()=>togglePalette(false);

// Navigation
prevBtn.onclick=()=>{if(currentIndex>0){currentIndex--;renderQuestion();}};
saveNextBtn.onclick=()=>{saveAnswer(getSelected());if(currentIndex<TOTAL_QUESTIONS-1){currentIndex++;renderQuestion();}};
skipBtn.onclick=()=>{saveAnswer(0);if(currentIndex<TOTAL_QUESTIONS-1){currentIndex++;renderQuestion();}};
function getSelected(){const checked=[...optionsForm.elements].find(el=>

// âœ… Navigation (already above)

// âœ… Timer
function startTimer(){
  let remaining=DURATION_SECONDS;
  timerInterval=setInterval(()=>{
    remaining--;
    timer.textContent=`àª¬àª¾àª•à«€ àª¸àª®àª¯: ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,"0")}`;
    if(remaining<=0){clearInterval(timerInterval);finalSubmit();}
  },1000);
}

// âœ… Submit
submitBtn.onclick=finalSubmit;
function finalSubmit(){
  if(submitted)return;submitted=true;clearInterval(timerInterval);
  let correct=0,wrong=0,skipped=0,eCount=0;
  answers.forEach((a,i)=>{
    const q=questions[i];
    if(a.selected===0){skipped++;}
    else if(a.selected===5){eCount++;}
    else if(a.selected===q.correct_option){correct++;}
    else{wrong++;}
  });
  const total=correct*1+(wrong*-0.33)+(skipped*-0.33);
  summary.textContent=`Score:${total} | Correct:${correct} | Wrong:${wrong} | Skipped:${skipped} | E:${eCount}`;
  testSection.classList.add("hidden");resultSection.classList.remove("hidden");
  drawPie(correct,wrong,skipped,eCount);
  renderSolutions();
}

// âœ… Pie chart
function drawPie(correct, wrong, skipped, eCount) {
  const ctx = pieChart.getContext("2d");
  const data = [
    { value: correct, color: "#22c55e", label: "Correct" },
    { value: wrong,   color: "#ef4444", label: "Wrong" },
    { value: skipped, color: "#6b7280", label: "Skipped" },
    { value: eCount,  color: "#f59e0b", label: "E-marked" }
  ];
  const total = data.reduce((sum, d) => sum + d.value, 0);
  let startAngle = 0;
  data.forEach(d => {
    if (d.value === 0) return;
    const sliceAngle = (d.value / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(pieChart.width/2, pieChart.height/2);
    ctx.arc(pieChart.width/2, pieChart.height/2,
      Math.min(pieChart.width, pieChart.height)/2 - 10,
      startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = d.color;
    ctx.fill();
    startAngle += sliceAngle;
  });
  // legend
  let y = 10;
  ctx.font = "14px sans-serif";
  data.forEach(d => {
    ctx.fillStyle = d.color;
    ctx.fillRect(10, y, 12, 12);
    ctx.fillStyle = "#333";
    ctx.fillText(`${d.label}: ${d.value}`, 30, y+10);
    y += 20;
  });
}

// âœ… Render solutions
function renderSolutions() {
  solutions.innerHTML = "";
  questions.forEach((q, idx) => {
    const sel = answers[idx].selected;
    const block = document.createElement("div");
    block.className = "card";
    block.innerHTML = `
      <h3>Q${idx+1}</h3>
      <p>${q.question_text}</p>
      <ul>
        <li>A: ${q.option_a}</li>
        <li>B: ${q.option_b}</li>
        <li>C: ${q.option_c}</li>
        <li>D: ${q.option_d}</li>
        <li>E: ${q.option_e}</li>
      </ul>
      <p><strong>Your:</strong> ${sel===0?"Skipped":sel===5?"E":"ABCD"[sel-1]}</p>
      <p><strong>Correct:</strong> ${"ABCD"[q.correct_option-1]}</p>
      <p><strong>Solution:</strong> ${q.explanation||"â€”"}</p>
    `;
    solutions.appendChild(block);
  });
}

// âœ… Leaderboard
async function showLeaderboard() {
  resultSection.classList.add("hidden");
  leaderboardSection.classList.remove("hidden");
  const { data, error } = await supabase
    .from("test_results")
    .select("user_id,total_score,time_taken_seconds")
    .eq("test_id", TEST_ID);
  if (error) { lbTable.textContent="Error loading leaderboard"; return; }
  const userIds=[...new Set(data.map(r=>r.user_id))];
  const { data: profiles } = await supabase
    .from("profiles")
    .select("id,full_name,email")
    .in("id", userIds);
  const nameMap=new Map((profiles||[]).map(p=>[p.id,p.full_name||p.email]));
  const sorted=data.sort((a,b)=>{
    if(b.total_score!==a.total_score) return b.total_score-a.total_score;
    return a.time_taken_seconds-b.time_taken_seconds;
  });
  const rows=sorted.map((r,idx)=>`
    <tr><td>${idx+1}</td>
    <td>${nameMap.get(r.user_id)||r.user_id}</td>
    <td>${r.total_score}</td>
    <td>${r.time_taken_seconds}</td></tr>`).join("");
  lbTable.innerHTML=`<table>
    <thead><tr><th>Rank</th><th>Name</th><th>Score</th><th>Time(s)</th></tr></thead>
    <tbody>${rows}</tbody></table>`;
}
function backToResult(){leaderboardSection.classList.add("hidden");resultSection.classList.remove("hidden");}

// âœ… Start Test
async function startTest(){
  await loadQuestions();
  currentIndex=0;
  renderQuestion();
  buildPalette();
  startTimer();
}
</script>
</body>
</html>
