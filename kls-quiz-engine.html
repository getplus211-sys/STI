<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>KLS Quiz System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;padding-top:60px}
.header{position:fixed;top:0;left:0;right:0;z-index:1000;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
.header.hidden{display:none}
.brand{flex:1}
.brand-name{font-size:16px;font-weight:bold;color:#667eea}
.back-btn{background:#f3f4f6;border:none;padding:8px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;width:36px;height:36px}
.back-btn:hover{background:#e5e7eb}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3,h4{margin:6px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer;margin-bottom:10px}
.primary{background:#22c55e;color:#fff}
.gray{background:#e5e7eb;color:#333}
.blue{background:#3b82f6;color:#fff}
.success{background:#8b5cf6;color:#fff}
.danger{background:#dc2626;color:#fff}
.warning{background:#f59e0b;color:#fff}
.option{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0;cursor:pointer;transition:all 0.2s}
.option:hover{border-color:#22c55e}
.option.active{background:#22c55e;color:#fff;border-color:#22c55e}
.top{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px}
.hidden{display:none}
.loader{text-align:center;padding:40px}
.qgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(45px,1fr));gap:8px;margin:15px 0}
.qbtn{padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-weight:600;font-size:14px}
.qbtn.answered{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.current{background:#3b82f6;color:#fff;border-color:#3b82f6}
.qbtn.correct{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.wrong{background:#ef4444;color:#fff;border-color:#ef4444}
.qbtn.skipped{background:#cbd5e1;color:#333;border-color:#cbd5e1}
.badge{background:#22c55e;color:#fff;padding:5px 12px;border-radius:20px;font-size:14px;display:inline-block;margin-bottom:10px}
.badge.free{background:#3b82f6}
.badge.kapila{background:#22c55e}
.badge.completed{background:#f59e0b}
.nav-buttons{display:flex;gap:10px;margin-top:10px;margin-bottom:20px}
.nav-buttons button{flex:1}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:20px;max-width:420px;width:90%;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease;text-align:center}
@keyframes modalPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.modal-icon{font-size:60px;margin-bottom:15px}
.modal-title{font-size:22px;font-weight:700;margin-bottom:10px;color:#1e293b}
.modal-text{font-size:15px;color:#64748b;line-height:1.6;margin-bottom:20px}
.modal-brand{font-size:13px;color:#94a3b8;margin-top:20px;font-weight:600}
.modal-brand span{color:#22c55e;font-weight:700}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-buttons button{flex:1;border-radius:12px;padding:12px;font-size:15px;font-weight:600;cursor:pointer;border:none}
.modal-btn-confirm{background:#22c55e;color:#fff}
.modal-btn-cancel{background:#e2e8f0;color:#334155}
.rank{display:flex;gap:10px;align-items:center}
.rank.me{border:2px solid #22c55e}
.rank-item{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:10px;margin-bottom:8px}
.rank-num{width:35px;height:35px;background:#3b82f6;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
.rank-num.top1{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.rank-num.top2{background:linear-gradient(135deg,#cbd5e1,#94a3b8)}
.rank-num.top3{background:linear-gradient(135deg,#fca5a5,#f87171)}
.rank-info{flex:1}
.rank-name{font-weight:600;font-size:14px}
.rank-score{color:#6b7280;font-size:13px}
.rank-points{font-weight:bold;color:#22c55e;font-size:18px}
.solution-item{border:1px solid #e5e7eb;border-radius:12px;padding:15px;margin-bottom:15px}
.solution-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.solution-qnum{font-weight:bold;font-size:16px}
.solution-status{padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600}
.solution-status.correct{background:#dcfce7;color:#16a34a}
.solution-status.wrong{background:#fee2e2;color:#dc2626}
.solution-status.skipped{background:#f1f5f9;color:#64748b}
.solution-question{font-size:14px;margin-bottom:10px;color:#334155}
.solution-options{margin:10px 0}
.solution-opt{padding:8px 12px;margin:5px 0;border-radius:8px;font-size:13px}
.solution-opt.selected{background:#dbeafe;border:2px solid #3b82f6}
.solution-opt.correct-ans{background:#dcfce7;border:2px solid #16a34a}
.solution-opt.wrong-ans{background:#fee2e2;border:2px solid #dc2626}
.alert-box{background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:15px;margin:15px 0}
.alert-box h3{color:#92400e;margin-bottom:8px}
.alert-box p{color:#78350f;margin:5px 0;line-height:1.6}
.checkbox-container{display:flex;align-items:center;gap:10px;padding:15px;background:#f1f5f9;border-radius:10px;margin:15px 0}
.checkbox-container input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
.checkbox-container label{cursor:pointer;font-size:14px;color:#334155}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Mobile Responsive */
@media (max-width: 600px) {
  body{padding-top:50px}
  .header{padding:8px 10px}
  .brand-name{font-size:14px}
  .back-btn{width:32px;height:32px;font-size:16px;padding:6px}
}
</style>
</head>
<body>
<header class="header">
  <div class="brand">
    <div class="brand-name">KAPiLa Learning</div>
  </div>
  <button class="back-btn" onclick="window.history.back()">тЖР</button>
</header>

<div class="container" id="app">
  <div class="card loader">
    <h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
    <p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ</p>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" id="modalIcon">тЭУ</div>
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-text" id="modalText">Message</div>
    <div class="modal-buttons" id="modalButtons"></div>
    <div class="modal-brand"><span>KAPiLa Learning</span><br>Created by devendra_dd</div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const urlParams = new URLSearchParams(window.location.search);
const QUIZ_ID = urlParams.get('quiz_id');

let app = document.getElementById("app");
let user, questions = [], current = 0, answers = {}, startTime, timer, submitted = false, quizAttemptId = null, currentTest = null;
let existingResult = null;
let testStarted = false;

if (!QUIZ_ID) {
  app.innerHTML = '<div class="card"><h3>тЪая╕П Invalid URL</h3><p>Test ID not found</p></div>';
} else {
  init();
}

// Browser close/refresh warning - only during test
window.addEventListener('beforeunload', function (e) {
  if (testStarted && !submitted) {
    e.preventDefault();
    e.returnValue = 'рк╢рлБркВ ркдркорлЗ ркЦрк░рлЗркЦрк░ ркЖ рккрлЗркЬ ркЫрлЛркбрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ? ркдркорк╛рк░рлЛ рккрлНрк░ркЧркдрк┐ рк╕рлЗрк╡ ркерк╢рлЗ ркирк╣рлАркВ!';
    return e.returnValue;
  }
});

async function init() {
  try {
    const { data: { user: u } } = await sb.auth.getUser();
    if (!u) {
      app.innerHTML = '<div class="card"><h3>ЁЯФТ Login Required</h3><p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЛркЧрк┐рки ркХрк░рлЛ</p></div>';
      return;
    }
    user = u;

    const { data: test } = await sb.from("kls_quizzes").select("*").eq("quiz_id", QUIZ_ID).single();
    if (!test) {
      app.innerHTML = '<div class="card"><h3>тЭМ Test Not Found</h3></div>';
      return;
    }
    currentTest = test;

    // Check if user has already attempted this test (ONE TEST PER STUDENT)
    const { data: previousAttempt, error: attemptError } = await sb
      .from("kls_quiz_attempts")
      .select("*")
      .eq("user_id", user.id)
      .eq("quiz_id", QUIZ_ID)
      .maybeSingle();

    // If user has already taken this test, show their previous result
    if (previousAttempt) {
      existingResult = previousAttempt;
      quizAttemptId = previousAttempt.id;
      showAlreadyAttempted(test, previousAttempt);
      return;
    }

    const { data: qs } = await sb.from("kls_questions").select("*").eq("quiz_id", QUIZ_ID);
    questions = qs || [];

    if (questions.length === 0) {
      app.innerHTML = '<div class="card"><h3>тЪая╕П No Questions</h3></div>';
      return;
    }

    showInstructions(test);
  } catch (err) {
    app.innerHTML = '<div class="card"><h3>тЭМ Error</h3><p>' + err.message + '</p></div>';
  }
}

function showAlreadyAttempted(test, result) {
  const date = new Date(result.completed_at).toLocaleDateString('gu-IN');
  const time = new Date(result.completed_at).toLocaleTimeString('gu-IN', {hour: '2-digit', minute: '2-digit'});
  
  app.innerHTML = `
  <div class="card">
    <span class="badge completed">тЬУ рккрлВрк░рлНркг ркеркпрлЗрк▓</span>
    <h2>${test.quiz_name}</h2>
    
    <div class="alert-box">
      <h3>тЪая╕П ркдркорлЗ ркЖ ркЯрлЗрк╕рлНркЯ рккрк╣рлЗрк▓рк╛ркерлА ркЬ ркЖрккрлА ркЪрлБркХрлНркпрк╛ ркЫрлЛ!</h3>
      <p><b>ркдрк╛рк░рлАркЦ:</b> ${date} ${time}</p>
      <p><b>ркдркорк╛рк░рлЛ рк╕рлНркХрлЛрк░:</b> ${result.score}/${result.total_questions}</p>
      <p><b>ркЪрлЛркХрк╕рк╛ркИ:</b> ${result.percentage}%</p>
      <p style="margin-top:10px">ркжрк░рлЗркХ ркЯрлЗрк╕рлНркЯ ркорк╛ркдрлНрк░ ркПркХ ркЬ рк╡рк╛рк░ ркЖрккрлА рк╢ркХрк╛ркп ркЫрлЗ. ркдркорлЗ ркдркорк╛рк░рк╛ рккрк░рк┐ркгрк╛ркорлЛ ркЕркирлЗ solutions ркЬрлЛркИ рк╢ркХрлЛ ркЫрлЛ.</p>
    </div>

    <button class="primary" onclick="window.location.href='kls-performance.html?attempt_id=${quizAttemptId}'">ЁЯУК Performance Report ркЬрлБркУ</button>
    <button class="blue" onclick="loadExistingResult()">ЁЯУК ркдркорк╛рк░рк╛ рккрк░рк┐ркгрк╛ркорлЛ ркЬрлБркУ</button>
    <button class="gray" onclick="loadExistingSolutions()">ЁЯУЭ Solutions ркЬрлБркУ</button>
    <br>
    <button class="success" onclick="retakeQuiz()">ЁЯФД рк╢рлБркВ ркдркорлЗ рклрк░рлА ркЯрлЗрк╕рлНркЯ ркЖрккрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?</button>
    <button class="warning" onclick="window.history.back()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>
  </div>`;
}

async function retakeQuiz() {
  showModal(
    'ЁЯФД',
    'рклрк░рлА ркЯрлЗрк╕рлНркЯ ркЖрккрлЛ',
    'рк╢рлБркВ ркдркорлЗ ркЦрк░рлЗркЦрк░ ркЖ ркЯрлЗрк╕рлНркЯ рклрк░рлАркерлА ркЖрккрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?<br><br><strong>ркирлЛркВркз:</strong> ркдркорк╛рк░рлЛ ркЬрлВркирлЛ рк╕рлНркХрлЛрк░ ркЕркирлЗ рккрлНрк░ркпрк╛рк╕ delete ркеркИ ркЬрк╢рлЗ.',
    `
      <button class="primary" onclick="confirmRetake()">рк╣рк╛, рклрк░рлА ркЯрлЗрк╕рлНркЯ ркЖрккрлБркВ</button>
      <button class="gray" onclick="hideModal()">ркирк╛, рк░ркж ркХрк░рлЛ</button>
    `
  );
}

async function confirmRetake() {
  hideModal();
  app.innerHTML = '<div class="loader">тЩ╗я╕П рк░рлАрк╕рлЗркЯ ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</div>';
  
  try {
    // Delete old attempt data
    await sb.from('kls_quiz_attempts').delete().eq('id', quizAttemptId);
    await sb.from('kls_question_attempts').delete().eq('quiz_attempt_id', quizAttemptId);
    
    // Reset and reload quiz
    existingResult = null;
    quizAttemptId = null;
    window.location.reload();
  } catch (err) {
    console.error('Retake error:', err);
    app.innerHTML = `<div class="card"><h3>тЭМ Error</h3><p>${err.message}</p></div>`;
  }
}

async function loadExistingResult() {
  const r = existingResult;
  const m = Math.floor(r.total_time_seconds / 60);
  const sec = r.total_time_seconds % 60;

  app.innerHTML = `
  <div class="card">
    <span class="badge completed">тЬУ рккрлВрк░рлНркг ркеркпрлЗрк▓</span>
    <h2>Your Score: ${r.score}</h2>
    <div style="margin:15px 0;line-height:1.8">
      <p><b>Correct:</b> ${r.correct_answers} | <b>Wrong:</b> ${r.wrong_answers}</p>
      <p><b>Skipped:</b> ${r.skipped_questions} | <b>E Options:</b> ${r.e_option_used}</p>
      <p><b>Time Taken:</b> ${m}m ${sec}s</p>
    </div>
    <canvas id="chart"></canvas><br><br>
    <button class="primary" onclick="loadLeaderboard()">ЁЯПЖ View Leaderboard</button>
    <button class="gray" onclick="loadExistingSolutions()">ЁЯУЭ View Solutions</button>
    <button class="blue" onclick="viewPerformance()">ЁЯУК Current Test Performance</button>
  </div>`;

  const chart = document.getElementById("chart");
  new Chart(chart, {
    type: "pie",
    data: {
      labels: ["Correct", "Wrong", "Skipped", "E"],
      datasets: [{
        data: [r.correct_answers, r.wrong_answers, r.skipped_questions, r.e_option_used],
        backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1', '#eab308']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

async function loadExistingSolutions() {
  app.innerHTML = '<div class="card loader"><div style="font-size:40px">тП│</div><h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3><p>Solutions рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ</p></div>';

  console.log('Loading solutions for attempt:', quizAttemptId);
  
  // First check if attempts exist
  const { data: attempts, error: attemptsError } = await sb
    .from("kls_question_attempts")
    .select("*")
    .eq("quiz_attempt_id", quizAttemptId);

  console.log('Question attempts:', attempts, 'Error:', attemptsError);

  if (!attempts || attempts.length === 0) {
    app.innerHTML = `<div class="card"><h3>тЪая╕П No Data</h3>
      <p>Solutions not found. Attempt ID: ${quizAttemptId}</p>
      <p style="font-size:12px">Check console for debug info</p>
      <button class="gray" onclick="loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button></div>`;
    return;
  }
  
  // Now load questions separately
  const questionIds = attempts.map(a => a.question_id);
  const { data: questions, error: questionsError } = await sb
    .from("kls_questions")
    .select("*")
    .in("id", questionIds);
  
  console.log('Questions:', questions, 'Error:', questionsError);
  
  if (!questions || questions.length === 0) {
    app.innerHTML = `<div class="card"><h3>тЪая╕П Questions Not Found</h3>
      <p>Question details not available</p>
      <button class="gray" onclick="loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button></div>`;
    return;
  }
  
  // Merge data manually
  const mergedData = attempts.map(att => {
    const q = questions.find(qu => qu.id === att.question_id);
    return { ...att, kls_questions: q };
  });

  // Question Navigator Grid
  let gridHTML = '<div class="card"><h4>Question Navigator</h4><div class="qgrid">';
  mergedData.forEach((a, idx) => {
    let btnClass = 'qbtn';
    if (a.selected_answer === 'SKIPPED') btnClass += ' skipped';
    else if (a.is_correct) btnClass += ' correct';
    else btnClass += ' wrong';
    gridHTML += `<button class="${btnClass}" onclick="scrollToSolution(${idx})">${idx + 1}</button>`;
  });
  gridHTML += '</div></div>';

  let solutionsHTML = `
  <span class="badge kapila">KAPiLa</span>
  <h3>Answer Key & Solutions</h3>
  <button class="gray" style="margin-bottom:15px" onclick="loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>
  ${gridHTML}`;

  mergedData.forEach((a, idx) => {
    const q = a.kls_questions;
    const userAns = a.selected_answer;
    const correctAns = q.correct_answer;
    const isCorrect = a.is_correct;

    solutionsHTML += `
    <div class="card" id="sol${idx}" style="border-left: 5px solid ${isCorrect ? '#22c55e' : (userAns === 'SKIPPED' ? '#cbd5e1' : '#ef4444')}">
      <p><b>Q${idx + 1}:</b> ${q.question}</p>
      <p><b>Your Answer:</b> ${userAns === 'SKIPPED' ? 'ркЫрлЛркбрлА ркжрлАркзрлЛ' : (userAns === 'A' ? q.option_a : userAns === 'B' ? q.option_b : userAns === 'C' ? q.option_c : userAns === 'D' ? q.option_d : q.option_e)}</p>
      <p style="color: #22c55e"><b>Correct Answer:</b> ${correctAns === 'A' ? q.option_a : correctAns === 'B' ? q.option_b : correctAns === 'C' ? q.option_c : correctAns === 'D' ? q.option_d : q.option_e}</p>
      ${q.explanation ? `<div style="background:#f8fafc; padding:10px; margin-top:10px; font-size:14px;"><b>Explanation:</b> ${q.explanation}</div>` : ""}
    </div>`;
  });

  solutionsHTML += '<button class="primary" onclick="loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>';
  app.innerHTML = solutionsHTML;
  window.scrollTo(0, 0);
}

function scrollToSolution(idx) {
  const el = document.getElementById('sol' + idx);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function showInstructions(test) {
  app.innerHTML = `
  <div class="card">
    <h2>ЁЯУЛ Instructions</h2>
    <h3>${test.quiz_name}</h3>
    <p style="margin:10px 0"><b>Total Questions:</b> ${questions.length}</p>
    <p style="margin:10px 0"><b>Duration:</b> ${test.duration_minutes} minutes</p>
    
    <div style="background:#f1f5f9;padding:15px;border-radius:10px;margin:15px 0">
      <h4>Guidelines:</h4>
      <ul style="line-height:1.8;padding-left:20px">
        <li>ркжрк░рлЗркХ рккрлНрк░рк╢рлНркиркорк╛ркВ ркПркХ ркЬ рк╕рк╛ркЪрлЛ ркЬрк╡рк╛ркм ркЫрлЗ</li>
        <li>ркдркорлЗ ркХрлЛркИрккркг рк╕ркоркпрлЗ рккрлНрк░рк╢рлНркирлЛ рк╡ркЪрлНркЪрлЗ ркЖркЧрк│-рккрк╛ркЫрк│ ркЬркИ рк╢ркХрлЛ ркЫрлЛ</li>
        <li>E рк╡рк┐ркХрк▓рлНркк ркирлЛ ркЙрккркпрлЛркЧ ркХрк░рлА рк╢ркХрлЛ ркЫрлЛ ркЬрлЛ ркЬрк░рлВрк░ рк╣рлЛркп</li>
        <li>рк╕ркмркорк┐ркЯ ркХрк░рлНркпрк╛ рккркЫрлА ркЬрк╡рк╛ркм ркмркжрк▓рлА рк╢ркХрк╛рк╢рлЗ ркирк╣рлАркВ</li>
        <li>ркЖ ркЯрлЗрк╕рлНркЯ ркорк╛ркдрлНрк░ ркПркХ ркЬ рк╡рк╛рк░ ркЖрккрлА рк╢ркХрк╛ркп ркЫрлЗ</li>
      </ul>
    </div>

    <div class="checkbox-container">
      <input type="checkbox" id="agreeCheckbox">
      <label for="agreeCheckbox">рк╣рлБркВ рк╢рк░ркдрлЛ ркЕркирлЗ ркирк┐ркпркорлЛркирлЗ рк╕рлНрк╡рлАркХрк╛рк░рлБркВ ркЫрлБркВ (I agree to the terms and conditions)</label>
    </div>

    <button class="primary" onclick="startTest()">тЦ╢я╕П ркЯрлЗрк╕рлНркЯ рк╢рк░рлВ ркХрк░рлЛ</button>
    <button class="warning" onclick="window.location.href='select-test.html'">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>
  </div>`;
}

function startTest() {
  const checkbox = document.getElementById('agreeCheckbox');
  if (!checkbox.checked) {
    showModal('тЪая╕П', 'рк╢рк░ркдрлЛ рк╕рлНрк╡рлАркХрк╛рк░рлЛ', 'ркЯрлЗрк╕рлНркЯ рк╢рк░рлВ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк╢рк░ркдрлЛ ркЕркирлЗ ркирк┐ркпркорлЛ рк╕рлНрк╡рлАркХрк╛рк░рлЛ.', 
      '<button class="modal-btn-confirm" onclick="hideModal()">рк╕ркоркЬрк╛ркпрлБркВ</button>');
    return;
  }

  testStarted = true;
  startTime = Date.now();
  
  // Hide header during quiz
  document.querySelector('.header').classList.add('hidden');
  document.body.style.paddingTop = '0';
  
  renderQuestion();
  startTimer();
}

function renderQuestion() {
  const q = questions[current];

  let gridHTML = '<div class="qgrid">';
  questions.forEach((_, idx) => {
    let cls = 'qbtn';
    if (answers[questions[idx].id]) cls += ' answered';
    if (idx === current) cls += ' current';
    gridHTML += `<button class="${cls}" onclick="jumpToQuestion(${idx})">${idx + 1}</button>`;
  });
  gridHTML += '</div>';

  let optionsHTML = '';
  ['A', 'B', 'C', 'D', 'E'].forEach((opt, i) => {
    const optionText = q[`option_${opt.toLowerCase()}`];
    if (optionText) {
      const isActive = answers[q.id] === (i + 1) ? 'active' : '';
      const eStyle = (opt === 'E') ? 'style="border:2px dashed #d1d5db;color:#6b7280"' : '';
      optionsHTML += `<div class="option ${isActive}" onclick="selectOption(${i + 1})" ${eStyle}>${opt}. ${optionText}</div>`;
    }
  });

  app.innerHTML = `
  <div class="card">
    <div class="top">
      <div id="timer">тП▒я╕П 0:00</div>
      <div>рккрлНрк░рк╢рлНрки ${current + 1}/${questions.length}</div>
    </div>
    <p style="font-weight:bold;margin:10px 0">${q.question}</p>
    ${optionsHTML}
    <div class="nav-buttons">
      <button class="gray" onclick="prevQuestion()" ${current === 0 ? 'disabled' : ''}>тмЕ рккрк╛ркЫрк│</button>
      ${current === questions.length - 1 ? 
        '<button class="danger" onclick="confirmSubmit()">тЬУ рк╕ркмркорк┐ркЯ ркХрк░рлЛ</button>' :
        '<button class="primary" onclick="nextQuestion()">ркЖркЧрк│ тЮб</button>'}
    </div>
  </div>
  <div class="card">
    <h4>Question Navigator</h4>
    ${gridHTML}
  </div>`;
}

function selectOption(opt) {
  const q = questions[current];
  answers[q.id] = opt;
  renderQuestion();
}

function jumpToQuestion(idx) {
  current = idx;
  renderQuestion();
}

function nextQuestion() {
  if (current < questions.length - 1) {
    current++;
    renderQuestion();
  }
}

function prevQuestion() {
  if (current > 0) {
    current--;
    renderQuestion();
  }
}

function startTimer() {
  timer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const t = document.getElementById("timer");
    if (t) {
      const m = Math.floor(elapsed / 60);
      const s = elapsed % 60;
      t.innerText = `тП▒я╕П ${m}:${String(s).padStart(2, "0")}`;
    }
  }, 1000);
}

function confirmSubmit() {
  const unanswered = questions.length - Object.keys(answers).length;
  showModal(
    'тЭУ',
    'ркЯрлЗрк╕рлНркЯ рк╕ркмркорк┐ркЯ ркХрк░рлЛ?',
    `рк╢рлБркВ ркдркорлЗ ркЦрк░рлЗркЦрк░ ркЖ ркЯрлЗрк╕рлНркЯ рк╕ркмркорк┐ркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ? ркдркорлЗ рккркЫрлА ркХрлЛркИ ркЬрк╡рк╛ркм ркмркжрк▓рлА рк╢ркХрк╢рлЛ ркирк╣рлАркВ.${unanswered > 0 ? `\n\n${unanswered} рккрлНрк░рк╢рлНркирлЛ ркмрк╛ркХрлА ркЫрлЗ!` : ''}`,
    `<button class="modal-btn-cancel" onclick="hideModal()">рк░ркж ркХрк░рлЛ</button>
     <button class="modal-btn-confirm" onclick="hideModal();submitTest()">рк╣рк╛, рк╕ркмркорк┐ркЯ ркХрк░рлЛ</button>`
  );
}

async function submitTest() {
  if (submitted) return;
  submitted = true;
  clearInterval(timer);

  // Show loading indicator
  app.innerHTML = `
  <div class="card loader" style="text-align:center">
    <div style="font-size:60px;animation:spin 2s linear infinite">тП│</div>
    <h3>рк╕ркмркорк┐ркЯ ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
    <p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ, ркдркорк╛рк░рк╛ ркЬрк╡рк╛ркмрлЛ рк╕рлЗрк╡ ркеркИ рк░рк╣рлНркпрк╛ ркЫрлЗ</p>
  </div>`;

  let correct = 0, wrong = 0, skip = 0, e = 0;

  questions.forEach(q => {
    const a = answers[q.id];
    const correctOpt = q.correct_answer === 'A' ? 1 : q.correct_answer === 'B' ? 2 : q.correct_answer === 'C' ? 3 : q.correct_answer === 'D' ? 4 : null;
    
    if (a === 5) {
      // E option selected (Not Attempted)
      e++;
    } else if (!a) {
      // No answer given (Skipped)
      skip++;
    } else if (a === correctOpt) {
      // Correct answer
      correct++;
    } else {
      // Wrong answer (A/B/C/D selected but wrong)
      wrong++;
    }
  });
  console.log('Total check:', correct + wrong + skip, '(should be', questions.length + ')');

  const score = correct;
  const timeTaken = Math.floor((Date.now() - startTime) / 1000);
  const percentage = ((correct / questions.length) * 100).toFixed(2);

  const { data: result, error } = await sb.from("kls_quiz_attempts").insert({
    user_id: user.id,
    quiz_id: QUIZ_ID,
    subject_id: currentTest.subject_id,
    chapter_code: currentTest.chapter_code,
    total_questions: questions.length,
    attempted_questions: correct + wrong, // Only actual attempts (not skip or E)
    correct_answers: correct,
    wrong_answers: wrong,
    skipped_questions: skip,
    e_option_used: e,
    score: score,
    percentage: percentage,
    total_time_seconds: timeTaken,
    started_at: new Date(startTime).toISOString(),
    completed_at: new Date().toISOString()
  }).select().single();

  if (error) {
    alert('Error: ' + error.message);
    submitted = false;
    return;
  }

  quizAttemptId = result.id;
  existingResult = result;

  // Save question attempts
  for (let i = 0; i < questions.length; i++) {
    const q = questions[i];
    const userAns = answers[q.id];
    const correctOpt = q.correct_answer === 'A' ? 1 : q.correct_answer === 'B' ? 2 : q.correct_answer === 'C' ? 3 : q.correct_answer === 'D' ? 4 : null;
    
    // Determine selected answer and correctness
    let selectedAnswer, isCorrect;
    
    if (userAns === 5) {
      selectedAnswer = 'E'; // E option
      isCorrect = false;
    } else if (!userAns) {
      selectedAnswer = 'SKIPPED'; // No answer
      isCorrect = false;
    } else {
      selectedAnswer = userAns === 1 ? 'A' : userAns === 2 ? 'B' : userAns === 3 ? 'C' : 'D';
      isCorrect = userAns === correctOpt;
    }
    
    await sb.from("kls_question_attempts").insert({
      quiz_attempt_id: quizAttemptId,
      question_id: q.id,
      user_id: user.id,
      quiz_id: QUIZ_ID,
      selected_answer: selectedAnswer,
      is_correct: isCorrect,
      time_taken_seconds: Math.floor(timeTaken / questions.length),
      question_order: i + 1
    });
  }

  // Directly show result page
  loadResult(score, correct, wrong, skip, e, timeTaken);
}

function loadResult(score, c, w, s, e, time) {
  // Show header again after quiz
  document.querySelector('.header').classList.remove('hidden');
  document.body.style.paddingTop = '60px';
  
  const m = Math.floor(time / 60);
  const sec = time % 60;

  app.innerHTML = `
  <div class="card">
    <span class="badge kapila">KAPiLa</span>
    <h2>Your Score: ${score}</h2>
    <div style="margin:15px 0;line-height:1.8">
      <p><b>Correct:</b> ${c} | <b>Wrong:</b> ${w}</p>
      <p><b>Skipped:</b> ${s} | <b>E Options:</b> ${e}</p>
      <p><b>Time Taken:</b> ${m}m ${sec}s</p>
    </div>
    <canvas id="chart"></canvas><br><br>
    <button class="primary" onclick="window.location.href='kls-performance.html?attempt_id=${quizAttemptId}'">ЁЯУК Performance Report ркЬрлБркУ</button>
    <button class="blue" onclick="loadLeaderboard()">ЁЯПЖ View Leaderboard</button>
    <button class="gray" onclick="loadExistingSolutions()">ЁЯУЭ View Answers / Solutions</button>
  </div>`;

  const chart = document.getElementById("chart");
  new Chart(chart, {
    type: "pie",
    data: {
      labels: ["Correct", "Wrong", "Skipped", "E"],
      datasets: [{
        data: [c, w, s, e],
        backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1', '#eab308']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

async function loadLeaderboard() {
  app.innerHTML = '<div class="card loader"><div style="font-size:40px;animation:spin 2s linear infinite">тП│</div><h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3><p>Leaderboard рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлЛ ркЫрлЗ</p></div>';
  
  try {
    // Get ALL results for this test
    const { data: allResults, error: allError } = await sb
      .from("kls_quiz_attempts")
      .select("user_id, score, total_time_seconds, correct_answers, total_questions, percentage")
      .eq("quiz_id", QUIZ_ID)
      .order("score", { ascending: false })
      .order("total_time_seconds", { ascending: true });

    if (allError) {
      console.error('Leaderboard error:', allError);
      showModal('тЭМ', 'рк▓рлЛркб ркирк┐рк╖рлНрклрк│', 'Failed to load leaderboard: ' + allError.message, 
        '<button class="modal-btn-confirm" onclick="hideModal();loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>');
      return;
    }

    if (!allResults || allResults.length === 0) {
      showModal('тЪая╕П', 'ркХрлЛркИ Results ркиркерлА', 'ркЖ ркЯрлЗрк╕рлНркЯ ркорк╛ркЯрлЗ рк╣ркЬрлБ ркХрлЛркИ results ркиркерлА', 
        '<button class="modal-btn-confirm" onclick="hideModal();loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>');
      return;
    }

    // Find current user's position in all results
    const myIndex = allResults.findIndex(r => r.user_id === user.id);
    if (myIndex === -1) {
      showModal('тЪая╕П', 'рк░рк┐ркЭрк▓рлНркЯ ркиркерлА ркорк│рлНркпрлБркВ', 'Your result not found in leaderboard', 
        '<button class="modal-btn-confirm" onclick="hideModal();loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>');
      return;
    }

    const myRank = myIndex + 1;
    const myData = allResults[myIndex];

    // Get top 50 results
    const top50 = allResults.slice(0, 50);

    // Fetch profiles separately (like quiz-engine 6)
    const allUserIds = allResults.map(r => r.user_id);
    const { data: profiles } = await sb
      .from("profiles")
      .select("id, full_name")
      .in("id", allUserIds);

    // Create name map
    const nameMap = {};
    if (profiles) {
      profiles.forEach(p => nameMap[p.id] = p.full_name);
    }

    const myMinutes = Math.floor(myData.total_time_seconds / 60);
    const mySeconds = myData.total_time_seconds % 60;

    let html = `
    <div class="card">
      <span class="badge kapila">KAPiLa</span>
      <button class="gray" onclick="loadExistingResult()">тмЕ Back to Result</button>
      <br><br>

      <div class="card rank" style="border:2px solid #22c55e;background:#f0fdf4;padding:15px">
        <b>Your Rank: #${myRank}</b><br>
        Name: ${nameMap[user.id] || "You"}<br>
        Score: ${myData.score}/${myData.total_questions}<br>
        Accuracy: ${myData.percentage}%<br>
        Time: ${myMinutes}m ${mySeconds}s
      </div>

      <h2>ЁЯПЖ Leaderboard (Top 50)</h2>
    </div>`;

    top50.forEach((r, idx) => {
      const minutes = Math.floor(r.total_time_seconds / 60);
      const seconds = r.total_time_seconds % 60;
      const isCurrentUser = r.user_id === user.id;
      
      html += `
      <div class="card rank" ${isCurrentUser ? 'style="border:2px solid #22c55e;background:#f0fdf4"' : ''}>
        <b>Rank #${idx + 1}</b><br>
        Name: ${nameMap[r.user_id] || "User"} ${isCurrentUser ? '(ркдркорлЗ)' : ''}<br>
        Score: ${r.score}/${r.total_questions}<br>
        Accuracy: ${r.percentage}%<br>
        Time: ${minutes}m ${seconds}s
      </div>`;
    });

    html += '<button class="gray" onclick="loadExistingResult()">тмЕ Back to Result</button>';
    app.innerHTML = html;
  } catch (err) {
    console.error('Leaderboard error:', err);
    showModal('тЭМ', 'рк▓рлЛркб ркирк┐рк╖рлНрклрк│', 'Failed to load leaderboard. Please try again.', 
      '<button class="modal-btn-confirm" onclick="hideModal();loadExistingResult()">тЖР рккрк╛ркЫрк╛ ркЬрк╛ркУ</button>');
  }
}

function viewPerformance() {
  window.location.href = `kls-performance.html?attempt_id=${quizAttemptId}`;
}

function showModal(icon, title, text, buttons) {
  document.getElementById('modalIcon').innerText = icon;
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalText').innerHTML = text;
  document.getElementById('modalButtons').innerHTML = buttons;
  document.getElementById('modal').classList.add('show');
}

function hideModal() {
  document.getElementById('modal').classList.remove('show');
}
</script>
</body>
</html>
