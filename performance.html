<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Beginners - Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans Gujarati', sans-serif; background: #f3f4f6; min-height: 100vh; }
        .header { background: #2563eb; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: bold; }
        .logo-badge { background: white; color: #2563eb; padding: 8px 12px; border-radius: 8px; font-weight: bold; }
        .header-btn { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; cursor: pointer; border: 2px solid white; color: white; text-decoration: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        .student-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .stat-label { color: #6b7280; font-size: 14px; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1f2937; }
        .chart-container { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .chart-title { font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 20px; }
        .recommendation-card { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .recommendation-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .recommendation-list { list-style: none; padding-left: 0; }
        .recommendation-list li { padding: 8px 0; padding-left: 25px; position: relative; }
        .recommendation-list li:before { content: "âœ“"; position: absolute; left: 0; color: #10b981; font-weight: bold; }
        .loading { text-align: center; padding: 80px 20px; font-size: 24px; color: #6b7280; }
        .subjects-grid { display: grid; gap: 20px; }
        .subject-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .subject-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .subject-name { font-size: 18px; font-weight: bold; color: #1f2937; }
        .subject-percentage { font-size: 24px; font-weight: bold; }
        .percentage-excellent { color: #10b981; }
        .percentage-good { color: #3b82f6; }
        .percentage-average { color: #f59e0b; }
        .percentage-poor { color: #ef4444; }
        .progress-bar { height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); transition: width 0.5s ease; }
        .tabs { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid #e5e7eb; }
        .tab { padding: 12px 24px; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo"><span class="logo-badge">LRD</span><span>Beginners</span></div>
        <a href="select-test.html" class="header-btn">ğŸ  àª¹à«‹àª®</a>
    </div>
    <div class="container" id="mainContainer"><div class="loading">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</div></div>

    <script>
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let currentTestResult = null;
        let allTestResults = [];
        let performanceData = [];
        let recommendations = [];

        async function init() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    document.getElementById('mainContainer').innerHTML = '<div class="loading">àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª¹à«‡àª²àª¾ àª²à«‹àª—àª¿àª¨ àª•àª°à«‹</div>';
                    return;
                }
                currentUser = user;
                
                const urlParams = new URLSearchParams(window.location.search);
                const resultId = urlParams.get('result_id');
                if (resultId) await loadCurrentTestResult(resultId);
                
                await loadAllTestResults();
                await loadPerformanceData();
                analyzePerformance();
                renderDashboard();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mainContainer').innerHTML = '<div class="loading">àª•àª‚àªˆàª• àª–à«‹àªŸà«àª‚ àª¥àª¯à«àª‚</div>';
            }
        }

        async function loadCurrentTestResult(resultId) {
            const { data, error } = await supabaseClient
                .from('lrd_test_results')
                .select('*, lrd_tests(test_name), lrd_question_attempts(*, lrd_questions(*, lrd_subjects(name), lrd_chapters(name)))')
                .eq('id', resultId)
                .single();
            if (!error) currentTestResult = data;
        }

        async function loadAllTestResults() {
            const { data } = await supabaseClient
                .from('lrd_test_results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('completed_at', { ascending: false });
            allTestResults = data || [];
        }

        async function loadPerformanceData() {
            const { data } = await supabaseClient
                .from('lrd_performance_analytics')
                .select('*, lrd_subjects(name, subject_code), lrd_chapters(name, chapter_id)')
                .eq('user_id', currentUser.id);
            performanceData = data || [];
        }

        function analyzePerformance() {
            recommendations = [];
            performanceData.forEach(perf => {
                const accuracy = (perf.correct_answers / perf.total_questions_attempted * 100) || 0;
                const subj = perf.lrd_subjects.name;
                const chap = perf.lrd_chapters.name;
                
                if (accuracy < 40) {
                    recommendations.push({type: 'urgent', subject: subj, chapter: chap, message: subj + ' - ' + chap + ': àª¤àª¾àª¤à«àª•àª¾àª²àª¿àª• àª§à«àª¯àª¾àª¨ àª†àªªà«‹! àª®àª¾àª¤à«àª° ' + accuracy.toFixed(1) + '% àª¸àªšà«‹àªŸàª¤àª¾.'});
                } else if (accuracy >= 40 && accuracy < 60) {
                    recommendations.push({type: 'warning', subject: subj, chapter: chap, message: subj + ' - ' + chap + ': àª¨àª¬àª³à«àª‚ (' + accuracy.toFixed(1) + '%). àªµàª§à« àª…àª­à«àª¯àª¾àª¸ àªœàª°à«‚àª°à«€.'});
                } else if (accuracy >= 60 && accuracy < 75) {
                    recommendations.push({type: 'moderate', subject: subj, chapter: chap, message: subj + ' - ' + chap + ': àª¸àª°à«‡àª°àª¾àª¶ (' + accuracy.toFixed(1) + '%). àª°àª¿àªµàª¿àªàª¨ àªµàª§àª¾àª°à«‹.'});
                } else if (accuracy >= 75 && accuracy < 85) {
                    recommendations.push({type: 'good', subject: subj, chapter: chap, message: subj + ' - ' + chap + ': àª¸àª¾àª°à«àª‚ (' + accuracy.toFixed(1) + '%)! àª°àª¿àªµàª¿àªàª¨ àªšàª¾àª²à« àª°àª¾àª–à«‹.'});
                } else {
                    recommendations.push({type: 'excellent', subject: subj, chapter: chap, message: subj + ' - ' + chap + ': àª‰àª¤à«àª•à«ƒàª·à«àªŸ! (' + accuracy.toFixed(1) + '%) àª† àª¸à«àª¤àª° àªœàª¾àª³àªµà«‹.'});
                }
            });
        }

        function renderDashboard() {
            const totalTests = allTestResults.length;
            const totalQuestions = allTestResults.reduce((sum, r) => sum + r.total_questions, 0);
            const totalCorrect = allTestResults.reduce((sum, r) => sum + r.correct_answers, 0);
            const overallAccuracy = totalQuestions > 0 ? ((totalCorrect / totalQuestions) * 100).toFixed(1) : 0;
            
            let html = '<div class="student-card"><h2>àªµàª¿àª¦à«àª¯àª¾àª°à«àª¥à«€ àªªàª°à«àª«à«‹àª°à«àª®àª¨à«àª¸ àª¡à«‡àª¶àª¬à«‹àª°à«àª¡</h2></div>';
            
            html += '<div class="tabs">';
            html += '<div class="tab active" onclick="switchTab(\'current\')">àªµàª°à«àª¤àª®àª¾àª¨ àªŸà«‡àª¸à«àªŸ</div>';
            html += '<div class="tab" onclick="switchTab(\'overall\')">àª“àªµàª°àª“àª² àªªàª°à«àª«à«‹àª°à«àª®àª¨à«àª¸</div>';
            html += '</div>';
            
            html += '<div id="currentTab" class="tab-content active">';
            if (currentTestResult) {
                html += '<div class="stats-grid">';
                html += '<div class="stat-card"><div class="stat-label">àª¸à«àª•à«‹àª°</div><div class="stat-value">' + currentTestResult.score + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">àªšà«‹àª•àª¸àª¾àªˆ</div><div class="stat-value" style="color: #10b981;">' + currentTestResult.percentage + '%</div></div>';
                html += '<div class="stat-card"><div class="stat-label">àª¸àª¾àªšàª¾ àªœàªµàª¾àª¬</div><div class="stat-value" style="color: #10b981;">' + currentTestResult.correct_answers + '</div></div>';
                html += '<div class="stat-card"><div class="stat-label">àª–à«‹àªŸàª¾ àªœàªµàª¾àª¬</div><div class="stat-value" style="color: #ef4444;">' + currentTestResult.wrong_answers + '</div></div>';
                html += '</div>';
                html += '<div class="chart-container"><div class="chart-title">àªŸà«‡àª¸à«àªŸ àªªàª°àª¿àª£àª¾àª®</div><canvas id="pieChart" width="400" height="200"></canvas></div>';
            } else {
                html += '<p>àªµàª°à«àª¤àª®àª¾àª¨ àªŸà«‡àª¸à«àªŸàª¨à«‹ àª¡à«‡àªŸàª¾ àª‰àªªàª²àª¬à«àª§ àª¨àª¥à«€</p>';
            }
            html += '</div>';
            
            html += '<div id="overallTab" class="tab-content">';
            html += '<div class="stats-grid">';
            html += '<div class="stat-card"><div class="stat-label">àª•à«àª² àªŸà«‡àª¸à«àªŸ</div><div class="stat-value">' + totalTests + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">àª“àªµàª°àª“àª² àªšà«‹àª•àª¸àª¾àªˆ</div><div class="stat-value" style="color: #10b981;">' + overallAccuracy + '%</div></div>';
            html += '<div class="stat-card"><div class="stat-label">àª•à«àª² àªªà«àª°àª¶à«àª¨à«‹</div><div class="stat-value">' + totalQuestions + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">àª•à«àª² àª¸àª¾àªšàª¾</div><div class="stat-value" style="color: #10b981;">' + totalCorrect + '</div></div>';
            html += '</div>';
            html += renderSubjectCards();
            html += '</div>';
            
            html += '<div class="recommendation-card">';
            html += '<div class="recommendation-title">ğŸ¯ àª¤àª®àª¾àª°àª¾ àª®àª¾àªŸà«‡ àª¸àª²àª¾àª¹</div>';
            html += renderRecommendations();
            html += '</div>';
            
            document.getElementById('mainContainer').innerHTML = html;
            
            setTimeout(() => {
                if (currentTestResult) drawPieChart();
            }, 500);
        }

        function renderSubjectCards() {
            const subjectMap = {};
            performanceData.forEach(perf => {
                const sid = perf.subject_id;
                if (!subjectMap[sid]) {
                    subjectMap[sid] = {name: perf.lrd_subjects.name, totalAttempted: 0, totalCorrect: 0, chapters: []};
                }
                subjectMap[sid].totalAttempted += perf.total_questions_attempted;
                subjectMap[sid].totalCorrect += perf.correct_answers;
                subjectMap[sid].chapters.push({
                    name: perf.lrd_chapters.name,
                    accuracy: (perf.correct_answers / perf.total_questions_attempted * 100) || 0
                });
            });
            
            let html = '<div class="subjects-grid">';
            Object.values(subjectMap).forEach(subject => {
                const accuracy = (subject.totalCorrect / subject.totalAttempted * 100) || 0;
                const pclass = accuracy >= 80 ? 'percentage-excellent' : accuracy >= 60 ? 'percentage-good' : accuracy >= 40 ? 'percentage-average' : 'percentage-poor';
                html += '<div class="subject-card">';
                html += '<div class="subject-header"><div class="subject-name">' + subject.name + '</div>';
                html += '<div class="subject-percentage ' + pclass + '">' + accuracy.toFixed(0) + '%</div></div>';
                html += '<div class="progress-bar"><div class="progress-fill" style="width: ' + accuracy + '%"></div></div>';
                html += '</div>';
            });
            html += '</div>';
            return html;
        }

        function renderRecommendations() {
            const urgent = recommendations.filter(r => r.type === 'urgent' || r.type === 'warning');
            const good = recommendations.filter(r => r.type === 'good' || r.type === 'excellent');
            let html = '';
            if (urgent.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h3 style="font-size: 16px; margin-bottom: 10px;">àªµàª§àª¾àª°à«‡ àª¸àª®àª¯ àª†àªªà«‹:</h3><ul class="recommendation-list">';
                urgent.slice(0, 5).forEach(r => html += '<li>' + r.message + '</li>');
                html += '</ul></div>';
            }
            if (good.length > 0) {
                html += '<div><h3 style="font-size: 16px; margin-bottom: 10px;">àª¤àª®àª¾àª°à«€ àª®àªœàª¬à«‚àª¤àª¾àªˆ:</h3><ul class="recommendation-list">';
                good.slice(0, 3).forEach(r => html += '<li>' + r.message + '</li>');
                html += '</ul></div>';
            }
            return html;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'current') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('currentTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('overallTab').classList.add('active');
            }
        }

        function drawPieChart() {
            const canvas = document.getElementById('pieChart');
            if (!canvas || !currentTestResult) return;
            new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['àª¸àª¾àªšàª¾', 'àª–à«‹àªŸàª¾', 'àª¸à«àª•àª¿àªªà«àª¡'],
                    datasets: [{
                        data: [currentTestResult.correct_answers, currentTestResult.wrong_answers, currentTestResult.skipped_questions],
                        backgroundColor: ['#10b981', '#ef4444', '#e5e7eb']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
