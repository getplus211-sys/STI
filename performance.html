<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>Performance - LRD Beginners</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3,h4{margin:6px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer;margin-bottom:10px}
.primary{background:#22c55e;color:#fff}
.blue{background:#3b82f6;color:#fff}
.badge{background:#22c55e;color:#fff;padding:5px 12px;border-radius:20px;font-size:14px;display:inline-block;margin-bottom:10px}
.badge.free{background:#3b82f6}
.student-header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
.avatar{width:80px;height:80px;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:bold;color:#2563eb}
.student-info h2{font-size:20px;margin-bottom:5px}
.student-meta{display:flex;gap:15px;font-size:14px;color:#6b7280}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0}
.stat-card{background:#f8fafc;border-radius:12px;padding:20px;text-align:center}
.stat-label{font-size:14px;color:#6b7280;margin-bottom:8px}
.stat-value{font-size:32px;font-weight:bold;color:#1f2937}
.section-title{font-size:18px;font-weight:bold;margin:20px 0 15px;border-left:4px solid #3b82f6;padding-left:12px}
.subject-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f8fafc;border-radius:8px;margin-bottom:10px}
.subject-name{font-size:16px;font-weight:600}
.subject-score{font-size:20px;font-weight:bold}
.score-excellent{color:#22c55e}
.score-good{color:#3b82f6}
.score-average{color:#f59e0b}
.score-poor{color:#ef4444}
.rec-card{background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);color:#fff;border-radius:16px;padding:25px}
.rec-title{font-size:20px;font-weight:bold;margin-bottom:15px}
.rec-list{list-style:none;padding:0}
.rec-list li{padding:8px 0 8px 25px;position:relative}
.rec-list li:before{content:"тЬУ";position:absolute;left:0;color:#22c55e;font-weight:bold}
@media (max-width:600px){
.stats-grid{grid-template-columns:1fr}
.student-header{flex-direction:column;text-align:center}
}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="card">
    <h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const urlParams = new URLSearchParams(window.location.search);
const RESULT_ID = urlParams.get('result_id');

let app = document.getElementById("app");
let user, testResult, questionAttempts = [];

if (!RESULT_ID) {
  app.innerHTML = '<div class="card"><h3>тЪая╕П Invalid URL</h3></div>';
} else {
  init();
}

async function init() {
  try {
    const { data: { user: u } } = await sb.auth.getUser();
    if (!u) {
      app.innerHTML = '<div class="card"><h3>ЁЯФТ Login Required</h3></div>';
      return;
    }
    user = u;

    const { data: result } = await sb.from("lrd_test_results").select("*").eq("id", RESULT_ID).single();
    testResult = result;

    const { data: attempts } = await sb.from("lrd_question_attempts")
      .select("*, lrd_questions(*, lrd_subjects(name), lrd_chapters(name))")
      .eq("test_result_id", RESULT_ID);
    questionAttempts = attempts || [];

    displayPerformance();
  } catch (err) {
    app.innerHTML = '<div class="card"><h3>тЭМ Error</h3><p>' + err.message + '</p></div>';
  }
}

function displayPerformance() {
  const date = new Date(testResult.completed_at).toLocaleDateString('en-GB').replace(/\//g, '-');
  const timePerQ = Math.floor(testResult.total_time_seconds / testResult.total_questions);

  let diffStats = { easy: { correct: 0, total: 0 }, medium: { correct: 0, total: 0 }, hard: { correct: 0, total: 0 } };
  
  questionAttempts.forEach(att => {
    const diff = att.lrd_questions.difficulty_level;
    if (diff === 'рк╕рк░рк│') {
      diffStats.easy.total++;
      if (att.is_correct) diffStats.easy.correct++;
    } else if (diff === 'ркоркзрлНркпрко') {
      diffStats.medium.total++;
      if (att.is_correct) diffStats.medium.correct++;
    } else {
      diffStats.hard.total++;
      if (att.is_correct) diffStats.hard.correct++;
    }
  });

  const subjectMap = {};
  questionAttempts.forEach(att => {
    const subj = att.lrd_questions.lrd_subjects.name;
    if (!subjectMap[subj]) {
      subjectMap[subj] = { total: 0, correct: 0 };
    }
    subjectMap[subj].total++;
    if (att.is_correct) subjectMap[subj].correct++;
  });

  let subjectHTML = '';
  Object.entries(subjectMap).forEach(([name, data]) => {
    const per = ((data.correct / data.total) * 100).toFixed(0);
    const cls = per >= 80 ? 'score-excellent' : per >= 60 ? 'score-good' : per >= 40 ? 'score-average' : 'score-poor';
    subjectHTML += `<div class="subject-item"><span class="subject-name">${name}</span><span class="subject-score ${cls}">${per}%</span></div>`;
  });

  const improvementNeeded = (100 - parseFloat(testResult.percentage)).toFixed(0);

  let recHTML = '';
  if (testResult.percentage < 60) {
    recHTML += '<h4>рк╡ркзрк╛рк░рлЗ рк╕ркоркп ркЖрккрлЛ:</h4><ul class="rec-list">';
    recHTML += '<li>рк░рлЛркЬ 2-3 ркХрк▓рк╛ркХ ркирк┐ркпркорк┐ркд ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ</li>';
    recHTML += '<li>ркиркмрк│рк╛ рк╡рк┐рк╖ркпрлЛ рккрк░ рк╡рк┐рк╢рлЗрк╖ ркзрлНркпрк╛рки ркЖрккрлЛ</li>';
    recHTML += '<li>ркмрлЗрк╕рк┐ркХ ркХрлЛркирлНрк╕рлЗрккрлНркЯрлНрк╕ рклрк░рлАркерлА рк╕ркоркЬрлЛ</li>';
    recHTML += '</ul>';
  } else if (testResult.percentage >= 60 && testResult.percentage < 80) {
    recHTML += '<h4>рк╡рк╛ркВркЪрки рк╕рлБркзрк╛рк░рлЛ:</h4><ul class="rec-list">';
    recHTML += '<li>ркоркзрлНркпрко ркЕркирлЗ ркорлБрк╢рлНркХрлЗрк▓ рккрлНрк░рк╢рлНркирлЛ рккрк░ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ рк╡ркзрк╛рк░рлЛ</li>';
    recHTML += '<li>рк╕рлНрккрлАркб ркЕркирлЗ ркПркХрлНркпрлБрк░рк╕рлА ркмркВркирлЗ рк╕рлБркзрк╛рк░рлЛ</li>';
    recHTML += '</ul>';
  } else {
    recHTML += '<h4>ркдркорк╛рк░рлА ркоркЬркмрлВркдрк╛ркИ:</h4><ul class="rec-list">';
    recHTML += '<li>ркЙркдрлНркдрко рккрлНрк░ркжрк░рлНрк╢рки! ркЖ рк╕рлНркдрк░ ркЬрк╛рк│рк╡рлЛ</li>';
    recHTML += '<li>ркирк┐ркпркорк┐ркд рк░рк┐рк╡рк┐ркЭрки ркЪрк╛рк▓рлБ рк░рк╛ркЦрлЛ</li>';
    recHTML += '</ul>';
  }

  app.innerHTML = `
  <div class="card">
    <div class="student-header">
      <div class="avatar">RS</div>
      <div class="student-info">
        <h2>рк╡рк┐ркжрлНркпрк╛рк░рлНркерлА Performance</h2>
        <div class="student-meta">
          <span>рк▓рлЗрк╡рк▓: <b>ркЧрк╛ркВркбрлНрк╕</b></span>
          <span>рк░рлЗркВркХ: <b>#14</b></span>
          <span>ркдрк╛рк░рлАркЦ: <b>${date}</b></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ркЯрлЗрк╕рлНркЯркирлБркВ рккрк░рк┐ркгрк╛рко</h3>
    <canvas id="pieChart"></canvas>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">ркХрлБрк▓/ркорлЗрк│рк╡рлЗрк▓ ркЧрлБркг</div>
      <div class="stat-value">${testResult.total_questions} / ${testResult.score}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЪрлЛркХрк╕рк╛ркИ</div>
      <div class="stat-value" style="color:#22c55e">${testResult.percentage}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕ркоркп/рккрлНрк░рк╢рлНрки</div>
      <div class="stat-value">${timePerQ}s</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ</div>
      <div class="stat-value" style="color:#f59e0b">8/10</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕рк░рк│ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
      <div class="stat-value">${diffStats.easy.correct}/${diffStats.easy.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркорлБрк╢рлНркХрлЗрк▓ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
      <div class="stat-value">${diffStats.hard.correct}/${diffStats.hard.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЯрк╛рк░рлНркЧрлЗркЯ рк╕рлНркХрлЛрк░</div>
      <div class="stat-value">60</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕рлБркзрк╛рк░рлЛ ркЬрк░рлВрк░</div>
      <div class="stat-value" style="color:#f59e0b">${improvementNeeded}%</div>
    </div>
    <div class="stat-card" style="grid-column:span 2">
      <div class="stat-label">ркмрк╛ркХрлА рккрлНрк░рк╢рлНркирлЛ</div>
      <div class="stat-value">${String(testResult.skipped_questions).padStart(2, '0')}</div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">рк╡рк┐рк╖ркп ркЕркирлЗ ркЪрлЗрккрлНркЯрк░ рк╡рк╛рк░ ркПркирк╛рк▓рк┐рк╕рк┐рк╕</div>
    ${subjectHTML}
  </div>

  <div class="rec-card">
    <div class="rec-title">ЁЯОп ркдркорк╛рк░рк╛ ркорк╛ркЯрлЗ ркПркХрлНрк╢рки рккрлНрк▓рк╛рки</div>
    ${recHTML}
  </div>

  <button class="blue" onclick="window.location.href='select-test.html'">ЁЯПа Back to Home</button>
  `;

  const ctx = document.getElementById('pieChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['рк╕рк╛ркЪрк╛', 'ркЦрлЛркЯрк╛', 'ркмрк╛ркХрлА'],
      datasets: [{
        data: [testResult.correct_answers, testResult.wrong_answers, testResult.skipped_questions],
        backgroundColor: ['#22c55e', '#ef4444', '#e5e7eb']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}
</script>
</body>
</html>
