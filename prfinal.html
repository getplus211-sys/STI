<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Beginners - ркХрлНрк╡рк┐ркЭ Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@300;400;600;700&display=swap');
        body { font-family: 'Hind Vadodara', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(102,126,234,0.4); }
        .quiz-option { transition: all 0.3s; cursor: pointer; border: 2px solid #e5e7eb; }
        .quiz-option:hover { transform: translateX(5px); border-color: #667eea; }
        .quiz-option.selected { background: #667eea; color: white; border-color: #667eea; }
        .quiz-option.correct { background: #10B981; color: white; border-color: #10B981; }
        .quiz-option.wrong { background: #EF4444; color: white; border-color: #EF4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .timer-warning { animation: pulse 1s infinite; color: #EF4444; }
        .q-nav-btn { transition: all 0.2s; }
        .q-nav-btn.answered { background: #667eea; color: white; }
        .q-nav-btn.bookmarked { background: #FCD34D; color: #92400E; border: 2px solid #F59E0B; }
        .q-nav-btn.current { border: 3px solid #10B981; }
    </style>
</head>
<body>
    <!-- QUIZ PAGE -->
    <div id="quizPage">
        <!-- Top Bar -->
        <div class="glass sticky top-0 z-50 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <div class="btn-primary text-white px-3 py-2 rounded-lg font-bold">LRD</div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">ркЯрлЗрк╕рлНркЯ</p>
                        <p id="testTitle" class="text-lg font-bold text-gray-800">рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</p>
                    </div>
                </div>
                <div class="flex gap-6 items-center">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-bold">рк╕ркоркп ркмрк╛ркХрлА</p>
                        <p id="timerDisplay" class="text-3xl font-black text-blue-600">00:00</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 uppercase font-bold">рккрлНрк░рк╢рлНрки</p>
                        <p class="text-2xl font-black text-gray-800"><span id="currentQ">0</span>/<span id="totalQ">0</span></p>
                    </div>
                    <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition">
                        <i class="fas fa-check-circle mr-2"></i>рк╕ркмркорк┐ркЯ
                    </button>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <!-- Question Panel -->
                <div class="lg:col-span-3">
                    <div class="glass rounded-2xl p-8 mb-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">рккрлНрк░рк╢рлНрки <span id="qNum">0</span></h3>
                                <div class="flex gap-2 items-center">
                                    <span id="difficultyBadge" class="px-3 py-1 rounded-full text-sm font-bold"></span>
                                    <span id="chapterBadge" class="px-3 py-1 rounded-full text-sm font-bold bg-gray-100 text-gray-700"></span>
                                </div>
                            </div>
                            <button onclick="bookmarkQuestion()" class="text-3xl hover:scale-110 transition">
                                <i id="bookmarkIcon" class="far fa-bookmark text-yellow-500"></i>
                            </button>
                        </div>
                        
                        <p id="questionText" class="text-xl text-gray-700 mb-8 leading-relaxed"></p>
                        
                        <div id="optionsContainer" class="space-y-4"></div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between gap-4">
                        <button onclick="prevQuestion()" id="prevBtn" class="glass px-8 py-4 rounded-xl font-bold text-gray-700 hover:bg-gray-100 transition" disabled>
                            <i class="fas fa-chevron-left mr-2"></i>рккрк╣рлЗрк▓рк╛ркВркирлЛ
                        </button>
                        <button onclick="clearAnswer()" class="glass px-8 py-4 rounded-xl font-bold text-red-600 hover:bg-red-50 transition">
                            <i class="fas fa-eraser mr-2"></i>Clear
                        </button>
                        <button onclick="nextQuestion()" id="nextBtn" class="glass px-8 py-4 rounded-xl font-bold text-gray-700 hover:bg-gray-100 transition">
                            ркЖркЧрк│<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Sidebar: Question Navigation -->
                <div class="lg:col-span-1">
                    <div class="glass rounded-2xl p-6 sticky top-24">
                        <h4 class="font-bold text-gray-800 mb-4 text-center">рккрлНрк░рк╢рлНрки ркирлЗрк╡рк┐ркЧрлЗрк╢рки</h4>
                        <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6"></div>
                        
                        <!-- Legend -->
                        <div class="border-t pt-4 space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded bg-gray-200"></div>
                                <span class="text-gray-600">ркмрк╛ркХрлА</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded bg-blue-600"></div>
                                <span class="text-gray-600">ркЬрк╡рк╛ркм ркЖрккрлНркпрлЛ</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded bg-yellow-300 border-2 border-yellow-600"></div>
                                <span class="text-gray-600">Bookmark</span>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="border-t mt-4 pt-4 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ркЬрк╡рк╛ркм ркЖрккрлНркпрк╛:</span>
                                <span id="answeredCount" class="font-bold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ркмрк╛ркХрлА:</span>
                                <span id="unansweredCount" class="font-bold text-red-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Bookmarked:</span>
                                <span id="bookmarkedCount" class="font-bold text-yellow-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULT PAGE -->
    <div id="resultPage" style="display:none;">
        <div class="max-w-4xl mx-auto p-8">
            <div class="glass rounded-2xl p-12 text-center mb-8">
                <div class="text-7xl mb-6"><i class="fas fa-trophy text-yellow-500"></i></div>
                <h2 class="text-4xl font-bold text-gray-800 mb-4">ркХрлНрк╡рк┐ркЭ рккрлВрк░рлНркг ркеркИ!</h2>
                <p id="scoreDisplay" class="text-7xl font-black text-blue-600 my-8">0/0</p>
                <p id="percentageDisplay" class="text-3xl font-bold text-gray-700 mb-2">0%</p>
                <p id="remarkDisplay" class="text-xl font-semibold text-gray-600"></p>
            </div>

            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="glass rounded-2xl p-8 text-center">
                    <i class="fas fa-check-circle text-5xl text-green-600 mb-4"></i>
                    <p class="text-sm text-gray-500 mb-2">рк╕рк╛ркЪрк╛ ркЬрк╡рк╛ркм</p>
                    <p id="correctCount" class="text-4xl font-black text-green-600">0</p>
                </div>
                <div class="glass rounded-2xl p-8 text-center">
                    <i class="fas fa-times-circle text-5xl text-red-600 mb-4"></i>
                    <p class="text-sm text-gray-500 mb-2">ркЦрлЛркЯрк╛ ркЬрк╡рк╛ркм</p>
                    <p id="wrongCount" class="text-4xl font-black text-red-600">0</p>
                </div>
                <div class="glass rounded-2xl p-8 text-center">
                    <i class="fas fa-minus-circle text-5xl text-gray-400 mb-4"></i>
                    <p class="text-sm text-gray-500 mb-2">ркмрк╛ркХрлА</p>
                    <p id="skippedCount" class="text-4xl font-black text-gray-400">0</p>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 mb-8">
                <h3 class="font-bold text-gray-800 mb-4 text-lg">рк╕ркоркп рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">ркХрлБрк▓ рк╕ркоркп рк╡рккрк░рк╛ркпрлЛ</p>
                        <p id="totalTimeUsed" class="text-2xl font-black text-blue-600">0:00</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">рк╕рк░рлЗрк░рк╛рк╢ рк╕ркоркп/рккрлНрк░рк╢рлНрки</p>
                        <p id="avgTimePerQ" class="text-2xl font-black text-purple-600">0s</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="viewDashboard()" class="flex-1 btn-primary text-white p-5 rounded-xl font-bold text-lg">
                    <i class="fas fa-chart-line mr-2"></i>Performance Dashboard ркЬрлБркУ
                </button>
                <button onclick="backToTests()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-5 rounded-xl font-bold text-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i>ркЯрлЗрк╕рлНркЯ рккрк╕ркВркжркЧрлА
                </button>
            </div>
        </div>
    </div>

    <script>
        const sb = window.supabase.createClient(
            'https://bhmycvrbucmbbrpzeane.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4'
        );

        let currentUser = null;
        let currentTest = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval = null;
        let timeRemaining = 0;
        let testStartTime = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const testId = urlParams.get('test_id');
            
            if (!testId) {
                alert('ркХрлЛркИ ркЯрлЗрк╕рлНркЯ рккрк╕ркВркж ркиркерлА ркХрк░рлЗрк▓рлА!');
                window.location.href = 'test_selection.html';
                return;
            }
            
            await checkAuth();
            await loadTest(testId);
            startQuiz();
        });

        async function checkAuth() {
            const { data: { user }, error } = await sb.auth.getUser();
            if (error || !user) {
                alert('ркдркорлЗ login ркиркерлА!');
                window.location.href = 'test_selection.html';
                return;
            }
            currentUser = user;
        }

        async function loadTest(testId) {
            // Load test details
            const { data: test, error: testError } = await sb
                .from('lrd_tests')
                .select('*')
                .eq('id', testId)
                .single();
            
            if (testError || !test) {
                alert('ркЯрлЗрк╕рлНркЯ ркорк│рлА ркиркерлА!');
                window.location.href = 'test_selection.html';
                return;
            }
            
            currentTest = test;
            document.getElementById('testTitle').textContent = test.title || 'Test';
            
            // Load questions for this test
            // Note: You'll need to have a way to associate questions with tests
            // For now, loading questions based on subject_id from test
            const { data: questions, error: questionsError } = await sb
                .from('lrd_questions')
                .select(`
                    *,
                    lrd_subjects(name, subject_code),
                    lrd_chapters(name)
                `)
                .eq('subject_id', test.subject_id)
                .limit(test.total_questions || 10);
            
            if (questionsError || !questions || questions.length === 0) {
                alert('ркЖ ркЯрлЗрк╕рлНркЯ ркорк╛ркЯрлЗ рккрлНрк░рк╢рлНркирлЛ ркорк│рлНркпрк╛ ркиркерлА!');
                window.location.href = 'test_selection.html';
                return;
            }
            
            quizQuestions = questions;
            document.getElementById('totalQ').textContent = questions.length;
        }

        function startQuiz() {
            userAnswers = quizQuestions.map((_, i) => ({
                questionIndex: i,
                selectedAnswer: null,
                isBookmarked: false,
                timeSpent: 0,
                startTime: Date.now()
            }));
            
            timeRemaining = (currentTest.duration_minutes || 15) * 60;
            testStartTime = Date.now();
            
            startTimer();
            renderQuestion();
            renderQuestionNav();
            updateStats();
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('тП░ рк╕ркоркп рккрлВрк░рлЛ ркеркпрлЛ!');
                    submitQuiz();
                    return;
                }
                updateTimerDisplay();
                
                if (timeRemaining === 120) {
                    document.getElementById('timerDisplay').classList.add('timer-warning');
                    alert('тЪая╕П ркорк╛ркдрлНрк░ 2 ркорк┐ркирк┐ркЯ ркмрк╛ркХрлА!');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            const answer = userAnswers[currentQuestionIndex];
            
            // Update time for previous question
            if (currentQuestionIndex > 0) {
                const prevAnswer = userAnswers[currentQuestionIndex - 1];
                prevAnswer.timeSpent += Math.floor((Date.now() - prevAnswer.startTime) / 1000);
            }
            answer.startTime = Date.now();
            
            document.getElementById('qNum').textContent = currentQuestionIndex + 1;
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('questionText').textContent = q.question_text;
            
            // Difficulty badge
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = q.difficulty_level || 'ркоркзрлНркпрко';
            badge.className = 'px-3 py-1 rounded-full text-sm font-bold ' + 
                (q.difficulty_level === 'рк╕рк░рк│' ? 'bg-green-100 text-green-700' :
                 q.difficulty_level === 'рк╣рк╛рк░рлНркб' ? 'bg-red-100 text-red-700' :
                 'bg-yellow-100 text-yellow-700');
            
            // Chapter badge
            document.getElementById('chapterBadge').textContent = q.lrd_chapters?.name || 'Chapter';
            
            // Bookmark
            document.getElementById('bookmarkIcon').className = 
                answer.isBookmarked ? 'fas fa-bookmark text-yellow-500' : 'far fa-bookmark text-yellow-500';
            
            // Options
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            const options = ['A', 'B', 'C', 'D', 'E'].filter(opt => q[`option_${opt.toLowerCase()}`]);
            
            options.forEach(opt => {
                const isSelected = answer.selectedAnswer === opt;
                const div = document.createElement('div');
                div.className = `quiz-option glass p-5 rounded-xl font-semibold text-lg ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `<span class="font-bold text-xl mr-4">${opt}.</span> ${q[`option_${opt.toLowerCase()}`]}`;
                div.onclick = () => selectOption(opt);
                container.appendChild(div);
            });
            
            // Navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === quizQuestions.length - 1;
            
            renderQuestionNav();
        }

        function selectOption(option) {
            userAnswers[currentQuestionIndex].selectedAnswer = option;
            renderQuestion();
            updateStats();
        }

        function clearAnswer() {
            userAnswers[currentQuestionIndex].selectedAnswer = null;
            renderQuestion();
            updateStats();
        }

        function bookmarkQuestion() {
            userAnswers[currentQuestionIndex].isBookmarked = !userAnswers[currentQuestionIndex].isBookmarked;
            renderQuestion();
            updateStats();
        }

        function renderQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            quizQuestions.forEach((_, i) => {
                const answer = userAnswers[i];
                const btn = document.createElement('button');
                let className = 'q-nav-btn w-10 h-10 rounded-lg font-bold ';
                
                if (i === currentQuestionIndex) {
                    className += 'current ';
                }
                
                if (answer.isBookmarked) {
                    className += 'bookmarked';
                } else if (answer.selectedAnswer) {
                    className += 'answered';
                } else {
                    className += 'bg-gray-200 text-gray-700';
                }
                
                btn.className = className;
                btn.textContent = i + 1;
                btn.onclick = () => goToQuestion(i);
                nav.appendChild(btn);
            });
        }

        function updateStats() {
            const answered = userAnswers.filter(a => a.selectedAnswer !== null).length;
            const bookmarked = userAnswers.filter(a => a.isBookmarked).length;
            
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('unansweredCount').textContent = quizQuestions.length - answered;
            document.getElementById('bookmarkedCount').textContent = bookmarked;
        }

        function goToQuestion(index) {
            currentQuestionIndex = index;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        }

        async function submitQuiz() {
            const answered = userAnswers.filter(a => a.selectedAnswer !== null).length;
            const unanswered = quizQuestions.length - answered;
            
            if (unanswered > 0) {
                const confirmMsg = `ркдркорлЗ ${unanswered} рккрлНрк░рк╢рлНркирлЛркирк╛ ркЬрк╡рк╛ркм ркЖрккрлНркпрк╛ ркиркерлА. рк╢рлБркВ ркдркорлЗ рк╕ркмркорк┐ркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?`;
                if (!confirm(confirmMsg)) return;
            }
            
            clearInterval(timerInterval);
            
            // Final time calculation
            const lastAnswer = userAnswers[currentQuestionIndex];
            lastAnswer.timeSpent += Math.floor((Date.now() - lastAnswer.startTime) / 1000);
            
            // Calculate results
            let correct = 0, wrong = 0, skipped = 0;
            const resultsToInsert = [];
            
            for (let i = 0; i < quizQuestions.length; i++) {
                const q = quizQuestions[i];
                const answer = userAnswers[i];
                const isCorrect = answer.selectedAnswer === q.correct_option;
                const isAttempted = answer.selectedAnswer !== null;
                
                if (isAttempted) {
                    isCorrect ? correct++ : wrong++;
                } else {
                    skipped++;
                }
                
                resultsToInsert.push({
                    student_id: currentUser.id,
                    test_id: currentTest.id,
                    question_id: q.id,
                    subject_id: q.subject_id,
                    chapter_id: q.chapter_id,
                    question_text: q.question_text,
                    option_a: q.option_a,
                    option_b: q.option_b,
                    option_c: q.option_c,
                    option_d: q.option_d,
                    option_e: q.option_e,
                    correct_option: q.correct_option,
                    student_answer: answer.selectedAnswer,
                    is_correct: isCorrect,
                    is_attempted: isAttempted,
                    difficulty_level: q.difficulty_level,
                    ideal_time_seconds: q.ideal_time_seconds || 30,
                    time_taken_seconds: answer.timeSpent,
                    marks_obtained: isCorrect ? 1 : 0,
                    marks_allocated: 1,
                    question_number: i + 1,
                    total_questions: quizQuestions.length,
                    is_bookmarked: answer.isBookmarked
                });
            }
            
            // Save to database
            const { error } = await sb.from('lrd_results').insert(resultsToInsert);
            if (error) {
                console.error('Error saving results:', error);
                alert('Error: ' + error.message);
            }
            
            // Show results
            showResults(correct, wrong, skipped);
        }

        function showResults(correct, wrong, skipped) {
            document.getElementById('quizPage').style.display = 'none';
            document.getElementById('resultPage').style.display = 'block';
            
            const total = quizQuestions.length;
            const percentage = ((correct / total) * 100).toFixed(1);
            
            document.getElementById('scoreDisplay').textContent = `${correct}/${total}`;
            document.getElementById('percentageDisplay').textContent = percentage + '%';
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('skippedCount').textContent = skipped;
            
            // Remark
            const remark = 
                percentage >= 90 ? 'ЁЯОЦя╕П Outstanding! ркдркорлЗ ркЕркжрлНркжркнрлБркд ркЫрлЛ!' :
                percentage >= 75 ? 'ЁЯПЖ Excellent! ркЦрлВркм рк╕рк░рк╕!' :
                percentage >= 60 ? 'ЁЯСН рк╕рк╛рк░рлБркВ! Continue ркХрк░рлЛ!' :
                percentage >= 40 ? 'ЁЯУИ рк╕рк░рлЗрк░рк╛рк╢ - рк╡ркзрлБ practice ркХрк░рлЛ!' :
                'ЁЯТк ркорк╣рлЗркиркд ркХрк░рлЛ, рк╕рклрк│ркдрк╛ ркорк│рк╢рлЗ!';
            document.getElementById('remarkDisplay').textContent = remark;
            
            // Time stats
            const totalTimeUsed = ((currentTest.duration_minutes * 60) - timeRemaining);
            const minutes = Math.floor(totalTimeUsed / 60);
            const seconds = totalTimeUsed % 60;
            document.getElementById('totalTimeUsed').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('avgTimePerQ').textContent = Math.round(totalTimeUsed / total) + 's';
        }

        function viewDashboard() {
            window.location.href = 'lrd_dashboard_fixed.html';
        }

        function backToTests() {
            window.location.href = 'test_selection.html';
        }
    </script>
</body>
</html>
