<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>Performance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;padding-top:60px}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
.sticky-header{position:fixed;top:0;left:0;right:0;z-index:1000;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#d946ef 100%);box-shadow:0 2px 10px rgba(0,0,0,.15);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.sticky-header-content{max-width:800px;color:#fff}
.page-title{margin:0;font-size:16px;font-weight:700;color:#fff}
.test-title{margin:0;font-size:13px;color:rgba(255,255,255,0.9);font-weight:500}
.home-btn{background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.4);border-radius:10px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;display:inline-flex;align-items:center;gap:5px}
.home-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px)}
.student-card{background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border:2px solid #bae6fd;position:relative;overflow:hidden}
.student-card::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(59,130,246,0.1) 0%,transparent 70%);animation:pulse 3s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
h2,h3,h4{margin:6px 0 12px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer;margin-bottom:10px}
.blue{background:#3b82f6;color:#fff}
.badge{background:#e0e7ff;color:#4338ca;padding:6px 14px;border-radius:20px;font-size:14px;display:inline-block;margin-bottom:0;float:right;font-weight:600}
.student-header{display:flex;align-items:center;gap:15px;margin-bottom:20px;position:relative;z-index:1}
.avatar{width:90px;height:90px;background:linear-gradient(135deg,#3b82f6 0%,#8b5cf6 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:bold;color:#fff;box-shadow:0 8px 20px rgba(59,130,246,0.4);border:4px solid #fff}
.student-meta{display:flex;gap:12px;font-size:14px;flex-wrap:wrap;margin-top:8px}
.student-name{color:#1e293b;font-size:26px;font-weight:700;margin:0 0 8px 0;text-shadow:0 2px 4px rgba(0,0,0,0.1)}
.meta-badge{background:#fff;padding:6px 12px;border-radius:20px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:inline-flex;align-items:center;gap:5px}
.level-badge{font-weight:700;padding:8px 16px;border-radius:25px;font-size:15px;box-shadow:0 4px 12px rgba(0,0,0,0.15);cursor:pointer;transition:all 0.2s}
.level-badge:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.2)}
.level-initial{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.level-starter{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff}
.level-good{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
.level-better{background:linear-gradient(135deg,#eab308,#ca8a04);color:#fff}
.level-nice{background:linear-gradient(135deg,#84cc16,#65a30d);color:#fff}
.level-verygood{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
.level-verynice{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.level-excellent{background:linear-gradient(135deg,#14b8a6,#0d9488);color:#fff}
.level-excellentplus{background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff}
.level-perfect{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;animation:glow 2s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 4px 12px rgba(139,92,246,0.4)}50%{box-shadow:0 4px 20px rgba(139,92,246,0.8)}}
.level-info-modal{max-width:500px}
.level-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:15px}
.level-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:#f8fafc}
.level-name{font-weight:600;font-size:14px}
.level-range{font-size:13px;color:#64748b}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0}
.stat-card{background:#f8fafc;border-radius:12px;padding:15px;text-align:center;position:relative}
.stat-card.clickable{cursor:pointer;transition:all 0.2s}
.stat-card.clickable:hover{background:#e0e7ff;transform:translateY(-2px)}
.stat-label{font-size:13px;color:#6b7280;margin-bottom:5px}
.stat-value{font-size:28px;font-weight:bold;color:#1f2937}
.section-title{font-size:18px;font-weight:bold;margin:20px 0 10px;color:#1f2937}
.subject-card{background:#f8fafc;border-radius:12px;padding:15px;margin-bottom:15px}
.subject-title{font-size:16px;font-weight:bold;color:#1f2937;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.analysis-table{width:100%;border-collapse:collapse;margin-top:10px}
.analysis-table th{background:#10b981;color:#fff;padding:10px;text-align:left;font-size:14px;font-weight:600}
.analysis-table td{padding:10px;font-size:14px;border-bottom:1px solid #e5e7eb}
.analysis-table td:first-child{font-weight:500;color:#374151}
.analysis-table td:nth-child(2),.analysis-table td:nth-child(3){text-align:center;color:#6b7280}
.analysis-table td:last-child{text-align:center;font-weight:bold;font-size:16px}
.per-excellent{color:#22c55e}
.per-verygood{color:#10b981}
.per-good{color:#3b82f6}
.per-average{color:#f59e0b}
.per-poor{color:#ef4444}
.rec-card{background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);color:#fff;border-radius:16px;padding:20px;margin-bottom:14px}
.rec-card.extra{background:linear-gradient(135deg,#059669 0%,#10b981 100%)}
.rec-title{font-size:18px;font-weight:bold;margin-bottom:15px}
.rec-section{margin-bottom:15px}
.rec-section h4{font-size:15px;margin-bottom:8px;opacity:0.95}
.rec-list{list-style:none;padding:0;margin:0}
.rec-list li{padding:5px 0 5px 22px;position:relative;font-size:14px;line-height:1.5}
.rec-list li:before{content:"тЬУ";position:absolute;left:0;color:#22c55e;font-weight:bold}
.loader{text-align:center;padding:40px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:20px;max-width:420px;width:90%;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease;text-align:center}
@keyframes modalPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.modal-icon{font-size:50px;margin-bottom:15px}
.modal-title{font-size:20px;font-weight:700;margin-bottom:10px;color:#1e293b}
.modal-text{font-size:14px;color:#64748b;line-height:1.6;margin-bottom:20px;white-space:pre-line}
.modal-btn{background:#3b82f6;color:#fff;border:none;border-radius:12px;padding:12px 24px;font-size:15px;font-weight:600;cursor:pointer;width:100%}
.back-btn{margin-top:20px}
@media (max-width:600px){
.stats-grid{grid-template-columns:1fr}
.student-header{flex-direction:column;text-align:center}
.analysis-table{font-size:12px}
.analysis-table th,.analysis-table td{padding:8px 5px}
body{padding-top:70px}
.page-title{font-size:14px}
.test-title{font-size:12px}
.home-btn{padding:6px 12px;font-size:12px}
.sticky-header{padding:8px 12px}
.avatar{width:70px;height:70px;font-size:32px}
.student-name{font-size:22px}
.student-meta{justify-content:center}
}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="card loader">
    <h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
    <p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ</p>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" id="modalIcon">тД╣я╕П</div>
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-text" id="modalText">Message</div>
    <button class="modal-btn" onclick="hideModal()">рк╕ркоркЬрк╛ркпрлБркВ</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const urlParams = new URLSearchParams(window.location.search);
const RESULT_ID = urlParams.get('result_id');

let app = document.getElementById("app");
let user, testResult, questionAttempts = [], previousTests = [];
let userName = '', userRank = 0, testName = '';

if (!RESULT_ID) {
  app.innerHTML = '<div class="card"><h3>тЪая╕П Invalid URL</h3><p>Result ID not found</p></div>';
} else {
  init();
}

function showModal(icon, title, text) {
  document.getElementById('modalIcon').innerText = icon;
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalText').innerText = text;
  document.getElementById('modal').classList.add('show');
}

function hideModal() {
  document.getElementById('modal').classList.remove('show');
}

async function init() {
  try {
    const { data: { user: u } } = await sb.auth.getUser();
    if (!u) {
      app.innerHTML = '<div class="card"><h3>ЁЯФТ Login Required</h3><p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЛркЧрк┐рки ркХрк░рлЛ</p></div>';
      return;
    }
    user = u;

    // Load user profile for name
    const { data: profile } = await sb
      .from("profiles")
      .select("full_name")
      .eq("id", user.id)
      .single();
    
    userName = profile?.full_name || "Student";

    // Load test result with test name
    const { data: result, error: resultError } = await sb
      .from("lrd_test_results")
      .select("*, lrd_tests(test_name)")
      .eq("id", RESULT_ID)
      .single();
    
    if (resultError || !result) {
      app.innerHTML = '<div class="card"><h3>тЭМ Result Not Found</h3><p>' + (resultError?.message || 'No data') + '</p></div>';
      return;
    }
    testResult = result;
    testName = result.lrd_tests?.test_name || "Test";
    
    // Set page title
    document.title = `${testName} - Performance Dashboard`;

    // Calculate rank
    const { data: allResults } = await sb
      .from("lrd_test_results")
      .select("user_id, score, total_time_seconds")
      .eq("test_id", result.test_id)
      .order("score", { ascending: false })
      .order("total_time_seconds", { ascending: true });
    
    if (allResults) {
      const myIndex = allResults.findIndex(r => r.user_id === user.id);
      userRank = myIndex + 1;
    }

    // Load previous 5 tests for trend graph
    const { data: prevTests } = await sb
      .from("lrd_test_results")
      .select("score, percentage, completed_at")
      .eq("user_id", user.id)
      .order("completed_at", { ascending: false })
      .limit(5);
    
    previousTests = prevTests || [];

    // Load question attempts with full details
    const { data: attempts, error: attemptsError } = await sb
      .from("lrd_question_attempts")
      .select(`
        *,
        lrd_questions (
          *,
          lrd_subjects (id, name, subject_code),
          lrd_chapters (id, name, chapter_id)
        )
      `)
      .eq("test_result_id", RESULT_ID);
    
    if (attemptsError) {
      console.error('Attempts error:', attemptsError);
    }
    
    questionAttempts = attempts || [];

    if (questionAttempts.length === 0) {
      app.innerHTML = '<div class="card"><h3>тЪая╕П No Data</h3><p>рккрлНрк░рк╢рлНркирлЛркирлЛ ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА</p></div>';
      return;
    }

    displayPerformance();
  } catch (err) {
    console.error('Init error:', err);
    app.innerHTML = '<div class="card"><h3>тЭМ Error</h3><p>' + err.message + '</p></div>';
  }
}

function getPerformanceLevel(percentage) {
  if (percentage <= 10) return "Initial";
  if (percentage <= 20) return "Starter";
  if (percentage <= 30) return "Good";
  if (percentage <= 40) return "Better";
  if (percentage <= 50) return "Nice";
  if (percentage <= 60) return "Very Good";
  if (percentage <= 70) return "Very Nice";
  if (percentage <= 80) return "Excellent";
  if (percentage <= 90) return "Excellent+";
  return "Perfect";
}

function calculateConcentrationRating(avgTimePerQ, accuracy) {
  // If accuracy is 0%, rating should be 1.0
  if (accuracy <= 0) return "1.0";
  
  let rating = 10;
  
  // Time factor - target is <=35s per question
  if (avgTimePerQ > 10) rating -= 0.5;
  if (avgTimePerQ > 15) rating -= 1;
  if (avgTimePerQ > 20) rating -= 1;
  if (avgTimePerQ > 25) rating -= 1.5;
  if (avgTimePerQ > 30) rating -= 2;
  if (avgTimePerQ > 35) rating -= 3;
  
  // Accuracy factor - heavy penalty for low accuracy
  if (accuracy < 90) rating -= 0.5;
  if (accuracy < 80) rating -= 1;
  if (accuracy < 70) rating -= 1.5;
  if (accuracy < 60) rating -= 2;
  if (accuracy < 50) rating -= 2;
  if (accuracy < 40) rating -= 2.5;
  if (accuracy < 30) rating -= 2.5;
  if (accuracy < 20) rating -= 3;
  if (accuracy < 10) rating -= 3;
  
  return Math.max(1, Math.min(10, rating)).toFixed(1);
}

function getPercentageColor(per) {
  if (per >= 85) return 'per-excellent';
  if (per >= 70) return 'per-verygood';
  if (per >= 55) return 'per-good';
  if (per >= 40) return 'per-average';
  return 'per-poor';
}

function displayPerformance() {
  const date = new Date(testResult.completed_at).toLocaleDateString('en-GB').replace(/\//g, '-');
  const timePerQ = Math.floor(testResult.total_time_seconds / testResult.total_questions);
  const percentage = parseFloat(testResult.percentage);
  const level = getPerformanceLevel(percentage);
  const concentrationRating = calculateConcentrationRating(timePerQ, percentage);
  
  const firstLetter = userName.charAt(0).toUpperCase();
  
  // Get level class for badge color
  const levelClass = level.toLowerCase().replace('+', 'plus').replace(' ', '');

  // Calculate difficulty stats
  let diffStats = {
    easy: { correct: 0, total: 0 },
    medium: { correct: 0, total: 0 },
    hard: { correct: 0, total: 0 }
  };
  
  questionAttempts.forEach(att => {
    if (!att.lrd_questions) return;
    const diff = att.lrd_questions.difficulty_level;
    if (diff === 'рк╕рк░рк│') {
      diffStats.easy.total++;
      if (att.is_correct) diffStats.easy.correct++;
    } else if (diff === 'ркоркзрлНркпрко') {
      diffStats.medium.total++;
      if (att.is_correct) diffStats.medium.correct++;
    } else if (diff === 'ркорлБрк╢рлНркХрлЗрк▓') {
      diffStats.hard.total++;
      if (att.is_correct) diffStats.hard.correct++;
    }
  });

  // Calculate subject and chapter wise stats
  const subjectMap = {};
  
  questionAttempts.forEach(att => {
    if (!att.lrd_questions || !att.lrd_questions.lrd_subjects || !att.lrd_questions.lrd_chapters) return;
    
    const subjId = att.lrd_questions.lrd_subjects.id;
    const subjName = att.lrd_questions.lrd_subjects.name;
    const chapterId = att.lrd_questions.lrd_chapters.id;
    const chapterName = att.lrd_questions.lrd_chapters.name;
    
    if (!subjectMap[subjId]) {
      subjectMap[subjId] = {
        name: subjName,
        total: 0,
        correct: 0,
        chapters: {}
      };
    }
    
    subjectMap[subjId].total++;
    if (att.is_correct) subjectMap[subjId].correct++;
    
    if (!subjectMap[subjId].chapters[chapterId]) {
      subjectMap[subjId].chapters[chapterId] = {
        name: chapterName,
        total: 0,
        correct: 0
      };
    }
    
    subjectMap[subjId].chapters[chapterId].total++;
    if (att.is_correct) subjectMap[subjId].chapters[chapterId].correct++;
  });

  // Generate subject-wise analysis tables
  let subjectHTML = '';
  Object.entries(subjectMap).forEach(([subjId, subjData]) => {
    const subjPer = ((subjData.correct / subjData.total) * 100).toFixed(0);
    const subjPerColor = getPercentageColor(parseFloat(subjPer));
    
    let tableRows = '';
    Object.entries(subjData.chapters).forEach(([chId, chData]) => {
      const chPer = ((chData.correct / chData.total) * 100).toFixed(0);
      const chPerColor = getPercentageColor(parseFloat(chPer));
      tableRows += `
        <tr>
          <td>${chData.name}</td>
          <td>${chData.total}</td>
          <td>${chData.correct}</td>
          <td class="${chPerColor}">${chPer}%</td>
        </tr>
      `;
    });
    
    subjectHTML += `
      <div class="subject-card">
        <div class="subject-title">
          <span>${subjData.name}</span>
          <span class="badge ${subjPerColor}">рк╕ркВрккрлВрк░рлНркг рк╡рк┐рк╖ркп: ${subjPer}%</span>
        </div>
        <table class="analysis-table">
          <thead>
            <tr>
              <th>ркЪрлЗрккрлНркЯрк░</th>
              <th>рккрлНрк░рк╢рлНркирлЛ</th>
              <th>рк╕рк╛ркЪрк╛</th>
              <th>рккрк░рк┐ркгрк╛рко</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
    `;
  });

  // Generate improved recommendations
  let recCards = '';
  
  // Card 1: Study time recommendation for <85%
  if (percentage < 85) {
    recCards += `
    <div class="rec-card">
      <div class="rec-title">ЁЯУЪ ркЕркнрлНркпрк╛рк╕ рк╕ркоркп ркнрк▓рк╛ркоркг</div>
      <ul class="rec-list">
        <li>ркжрк░рк░рлЛркЬ ркУркЫрк╛ркорк╛ркВ ркУркЫрк╛ 10-12 ркХрк▓рк╛ркХ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ</li>
        <li>рк╕рк╡рк╛рк░рлЗ 3-4 ркХрк▓рк╛ркХ, ркмрккрлЛрк░рлЗ 3-4 ркХрк▓рк╛ркХ ркЕркирлЗ рк░рк╛ркдрлНрк░рлЗ 3-4 ркХрк▓рк╛ркХ рк╡рк╣рлЗркВркЪрлЛ</li>
        <li>ркирк┐ркпркорк┐ркдркдрк╛ ркЕркирлЗ discipline ркЬрк╛рк│рк╡рлЛ ркЕркирлЗ focused study ркХрк░рлЛ</li>
        <li>рк╢рк╛ркВркд рк╡рк╛ркдрк╛рк╡рк░ркгркорк╛ркВ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ ркЕркирлЗ mobile notifications ркмркВркз рк░рк╛ркЦрлЛ</li>
      </ul>
    </div>`;
  }

  // Card 2: Subject-wise recommendations (15%+ questions and <50% accuracy)
  let hasWeakSubject = false;
  Object.entries(subjectMap).forEach(([subjId, subjData]) => {
    const subjPer = ((subjData.correct / subjData.total) * 100);
    const subjShare = (subjData.total / testResult.total_questions) * 100;
    
    if (subjShare >= 15 && subjPer < 50) {
      if (!hasWeakSubject) hasWeakSubject = true;
      recCards += `
      <div class="rec-card">
        <div class="rec-title">ЁЯФ┤ ${subjData.name} - ркдрк╛ркдрлНркХрк╛рк▓рк┐ркХ ркзрлНркпрк╛рки</div>
        <ul class="rec-list">
          <li>ркЖ рк╡рк┐рк╖ркп ркжрк░рк░рлЛркЬ ркУркЫрк╛ркорк╛ркВ ркУркЫрк╛ 3-4 ркХрк▓рк╛ркХ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ</li>
          <li>ркмрлЗрк╕рк┐ркХ ркХрлЛркирлНрк╕рлЗрккрлНркЯрлНрк╕ ркоркЬркмрлВркд ркХрк░рлЛ ркЕркирлЗ fundamentals рк╕ркоркЬрлЛ</li>
          <li>ркирк┐ркпркорк┐ркд рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркХрк░рлЛ ркЕркирлЗ previous years ркирк╛ рккрлНрк░рк╢рлНркирлЛ ркЙркХрлЗрк▓рлЛ</li>
          <li>рк╢ркВркХрк╛ рк╣рлЛркп ркдрлЛ ркдрк░ркд рк╢рк┐ркХрлНрк╖ркХ ркЕркерк╡рк╛ ркорк┐ркдрлНрк░рлЛркирлЗ рккрлВркЫрлЛ</li>
          <li>ркжрк░ ркЕркарк╡рк╛ркбрк┐ркпрлЗ ркЖ рк╡рк┐рк╖ркпркирлА ркЯрлЗрк╕рлНркЯ рк▓рлЛ ркЕркирлЗ рккрлНрк░ркЧркдрк┐ ркорк╛рккрлЛ</li>
        </ul>
      </div>`;
    }
  });

  // Card 3: General study plan
  recCards += `
  <div class="rec-card">
    <div class="rec-title">ЁЯУЦ ркжрлИркирк┐ркХ ркЕркнрлНркпрк╛рк╕ ркпрлЛркЬркирк╛</div>
    <ul class="rec-list">
      <li>ркжрк░рк░рлЛркЬ 3-4 рк╡рк┐рк╖ркпрлЛркирлЛ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ - рк╡рк┐рк╡рк┐ркзркдрк╛ ркЬрк░рлВрк░рлА ркЫрлЗ</li>
      <li>ркжрк░рлЗркХ рк╡рк┐рк╖ркпркирлЗ 2-2.5 ркХрк▓рк╛ркХ рк╕ркоркп ркЖрккрлЛ рк╕рк╛ркерлЗ 10 ркорк┐ркирк┐ркЯ ркирлЛ break</li>
      <li>ркирк┐ркпркорк┐ркд рк░рк┐рк╡рк┐ркЭрки ркХрк░рлЛ - ркПркХ рк╡рк╛рк░ рк╡рк╛ркВркЪрлНркпрлБркВ ркПркЯрк▓рлЗ ркпрк╛ркж рк░рк╣рлЗ ркирк╣рлАркВ</li>
      <li>ркжрк░ ркЕркарк╡рк╛ркбрк┐ркпрлЗ ркорлЛркХ ркЯрлЗрк╕рлНркЯ рк▓рлЛ ркЕркирлЗ ркнрлВрк▓рлЛ ркорк╛ркВркерлА рк╢рлАркЦрлЛ</li>
      <li>рк╕рк╡рк╛рк░ркирк╛ рк╕ркоркпрлЗ ркорлБрк╢рлНркХрлЗрк▓ рк╡рк┐рк╖ркпрлЛ ркЕркирлЗ рк╕рк╛ркВркЬрлЗ рк╕рк░рк│ рк╡рк┐рк╖ркпрлЛ рк╡рк╛ркВркЪрлЛ</li>
    </ul>
  </div>`;

  // Card 4: Weak chapters (<70% threshold)
  let weakChapters = [];
  Object.entries(subjectMap).forEach(([subjId, subjData]) => {
    Object.entries(subjData.chapters).forEach(([chId, chData]) => {
      const chPer = ((chData.correct / chData.total) * 100);
      if (chPer < 70) {
        weakChapters.push({ 
          subject: subjData.name, 
          chapter: chData.name, 
          percentage: chPer 
        });
      }
    });
  });

  if (weakChapters.length > 0) {
    recCards += `
    <div class="rec-card">
      <div class="rec-title">тЪая╕П ркиркмрк│рк╛ ркЪрлЗрккрлНркЯрк░рлНрк╕ - ркзрлНркпрк╛рки ркЖрккрлЛ</div>
      <ul class="rec-list">`;
    
    weakChapters.forEach(ch => {
      const advice = ch.percentage < 40 ? 'ркорлВрк│ркнрлВркд concepts рклрк░рлАркерлА рк╡рк╛ркВркЪрлЛ ркЕркирлЗ notes ркмркирк╛рк╡рлЛ' : 
                     ch.percentage < 55 ? 'рк╡ркзрлБ practice ркХрк░рлЛ ркЕркирлЗ mock questions ркЙркХрлЗрк▓рлЛ' : 
                     'ркирк┐ркпркорк┐ркд рк░рк┐рк╡рк┐ркЭрки ркХрк░рлЛ ркЕркирлЗ previous errors review ркХрк░рлЛ';
      recCards += `<li>${ch.subject}: ${ch.chapter} (${ch.percentage.toFixed(0)}%) - ${advice}</li>`;
    });
    
    recCards += `
      </ul>
    </div>`;
  }

  // Separate Card: KAPiLa's Extra Suggestions
  const extraSuggestions = `
  <div class="rec-card extra">
    <div class="rec-title">ЁЯТб KAPiLa's Extra Suggestions</div>
    <ul class="rec-list">
      <li>ркдркорк╛рк░рк╛ ркорк┐ркдрлНрк░рлЛ рк╕рк╛ркерлЗ ркиркмрк│рк╛ рк╡рк┐рк╖ркпрлЛ рккрк░ ркЪрк░рлНркЪрк╛ ркХрк░рлЛ - рк╢рлАркЦрк╡рк╛ркирлЛ рк╢рлНрк░рлЗрк╖рлНрка ркорк╛рк░рлНркЧ</li>
      <li>ркЬрлЗ рк╡рк┐рк╖ркп ркдркоркирлЗ ркУркЫрлЛ ркЖрк╡ркбрлЗ ркЫрлЗ ркдрлЗркирлА ркЪрк░рлНркЪрк╛ ркХрк░рлЛ ркЕркирлЗ рк╕ркоркЬрлЛ</li>
      <li>ркЬрлЗ рк╡рк┐рк╖ркп ркдркорк╛рк░рк╛ ркорк┐ркдрлНрк░ркирлЗ ркУркЫрлЛ ркЖрк╡ркбрлЗ ркЫрлЗ ркдрлЛ ркдркорлЗ ркдрлЗркирлЗ рк╢рлАркЦрк╡рк╛ркбрлЛ - ркЖркерлА ркдркорк╛рк░рлБркВ рккркг рк░рк┐рк╡рк┐ркЭрки ркерк╢рлЗ</li>
      <li>рк░рлЛркЬ рк░рк╛ркдрлНрк░рлЗ рк╕рлВркдрк╛ркВ рккрк╣рлЗрк▓рк╛ркВ ркжрк┐рк╡рк╕ ркжрк░ркорк┐ркпрк╛рки ркЬрлЗ рк╡рк╛ркВркЪрлНркпрлБркВ ркЫрлЗ ркдрлЗркирлБркВ ркоркирки ркХрк░рлЛ</li>
      <li>ркдрлЗ ркЯрлЛрккрк┐ркХ ркпрк╛ркж ркХрк░рлЛ ркЕркирлЗ ркоркиркорк╛ркВ revision ркХрк░рлЛ - ркЖ ркПркХ рк╕рлМркерлА ркорлЛркЯрлА ркЬркбрлАркмрлБркЯрлНркЯрлА ркЫрлЗ!</li>
      <li>ркЧрлНрк░рлБркк рк╕рлНркЯркбрлА ркХрк░рк╡рк╛ркерлА рк╕ркоркЬ рк╡ркзрлБ рк╕рлНрккрк╖рлНркЯ ркерк╛ркп ркЫрлЗ ркЕркирлЗ motivation ркорк│рлЗ ркЫрлЗ</li>
      <li>рк╣рлЗрк▓рлНркерлА lifestyle ркЬрк╛рк│рк╡рлЛ - рк╕рк╛рк░рлА ркКркВркШ, рк╕рк╛рк░рлБркВ ркЦрк╛рк╡рк╛ркирлБркВ ркЕркирлЗ ркерлЛркбрлА exercise</li>
    </ul>
  </div>`;

  const improvementNeeded = (100 - percentage).toFixed(0);

  app.innerHTML = `
  <div class="sticky-header">
    <div class="sticky-header-content">
      <div class="page-title">${testName}</div>
      <div class="test-title">Performance Dashboard</div>
    </div>
    <a href="select-test.html" class="home-btn">ЁЯПа Home</a>
  </div>

  <div class="card student-card">
    <div class="student-header">
      <div class="avatar">${firstLetter}</div>
      <div style="flex:1">
        <h2 class="student-name">${userName}</h2>
        <div class="student-meta">
          <span class="meta-badge level-badge level-${levelClass}" onclick="showLevelInfo()">ЁЯУК ${level}</span>
          <span class="meta-badge" style="color:#f59e0b">ЁЯПЖ Rank: #${userRank}</span>
          <span class="meta-badge" style="color:#6366f1">ЁЯУЕ ${date}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ркЯрлЗрк╕рлНркЯркирлБркВ рккрк░рк┐ркгрк╛рко</h3>
    <canvas id="pieChart" style="max-height:250px"></canvas>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">ркорлЗрк│рк╡рлЗрк▓/ркХрлБрк▓ ркЧрлБркг</div>
      <div class="stat-value">${testResult.score}/${testResult.total_questions}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЪрлЛркХрк╕рк╛ркИ</div>
      <div class="stat-value" style="color:#22c55e">${testResult.percentage}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕ркоркп/рккрлНрк░рк╢рлНрки</div>
      <div class="stat-value">${timePerQ}s</div>
    </div>
    <div class="stat-card clickable" onclick="showConcentrationInfo()">
      <div class="stat-label">ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ тД╣я╕П</div>
      <div class="stat-value" style="color:#f59e0b">${concentrationRating}/10</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕рк░рк│ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
      <div class="stat-value">${diffStats.easy.correct}/${diffStats.easy.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркорлБрк╢рлНркХрлЗрк▓ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
      <div class="stat-value">${diffStats.hard.correct}/${diffStats.hard.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЯрк╛рк░рлНркЧрлЗркЯ рк╕рлНркХрлЛрк░</div>
      <div class="stat-value">60</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕рлБркзрк╛рк░рлЛ ркЬрк░рлВрк░</div>
      <div class="stat-value" style="color:#f59e0b">${improvementNeeded}%</div>
    </div>
    <div class="stat-card" style="grid-column:span 2">
      <div class="stat-label">ркмрк╛ркХрлА рккрлНрк░рк╢рлНркирлЛ</div>
      <div class="stat-value">${String(testResult.skipped_questions).padStart(2, '0')}</div>
    </div>
  </div>

  <div class="card">
    <h3>ркдркорк╛рк░рлА рккрлНрк░ркЧркдрк┐ (Trend)</h3>
    <canvas id="trendChart" style="max-height:250px"></canvas>
  </div>

  <div class="card">
    <div class="section-title">ЁЯУК рк╡рк┐рк╖ркп ркЕркирлЗ ркЪрлЗрккрлНркЯрк░ рк╡рк╛рк░ ркПркирк╛рк▓рк┐рк╕рк┐рк╕</div>
    ${subjectHTML}
  </div>

  ${recCards}
  ${extraSuggestions}

  <button class="blue back-btn" onclick="window.location.href='select-test.html'">ЁЯПа Back to Home</button>
  `;

  // Draw pie chart
  setTimeout(() => {
    const ctx = document.getElementById('pieChart');
    if (ctx) {
      new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['рк╕рк╛ркЪрк╛', 'ркЦрлЛркЯрк╛', 'ркмрк╛ркХрлА'],
          datasets: [{
            data: [testResult.correct_answers, testResult.wrong_answers, testResult.skipped_questions],
            backgroundColor: ['#22c55e', '#ef4444', '#e5e7eb']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 15, font: { size: 13 } }
            }
          }
        }
      });
    }

    // Draw trend chart (last 5 tests)
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx && previousTests.length > 0) {
      const labels = previousTests.map((_, idx) => `T${previousTests.length - idx}`).reverse();
      const scores = previousTests.map(t => parseFloat(t.percentage)).reverse();
      
      new Chart(trendCtx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'рк╕рлНркХрлЛрк░ %',
            data: scores,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }
  }, 100);
}

function showConcentrationInfo() {
  showModal(
    'тД╣я╕П',
    'ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ',
    'ркЖ рк░рлЗркЯрк┐ркВркЧ ркдркорк╛рк░рлА рк╕рлНрккрлАркб ркЕркирлЗ ркЪрлЛркХрк╕рк╛ркИ ркмркВркирлЗ рккрк░ ркЖркзрк╛рк░рк┐ркд ркЫрлЗ.\n\n' +
    'ркЬрлЛ ркдркорлЗ ркмркзрк╛ рккрлНрк░рк╢рлНркирлЛ рк╕рк╛ркЪрк╛ ркХрк░рлЛ рккркг рк╡ркзрлБ рк╕ркоркп рк▓рлЛ ркдрлЛ, ркПркХрк╛ркЧрлНрк░ркдрк╛ ркдркорк╛рк░рлА ркУркЫрлА ркЬ ркЧркгрк╛рк╢рлЗ. ркЭркбркк ркЕркирлЗ ркЪрлЛркХрк╕рк╛ркИ ркЙрккрк░ ркПркХрк╛ркЧрлНрк░ркдрк╛ркирлБркВ ркорк╛рккрки ркерк╛ркп ркЫрлЗ.'
  );
}

function showLevelInfo() {
  const levelData = [
    { name: 'Initial', range: '1-10%', class: 'level-initial' },
    { name: 'Starter', range: '11-20%', class: 'level-starter' },
    { name: 'Good', range: '21-30%', class: 'level-good' },
    { name: 'Better', range: '31-40%', class: 'level-better' },
    { name: 'Nice', range: '41-50%', class: 'level-nice' },
    { name: 'Very Good', range: '51-60%', class: 'level-verygood' },
    { name: 'Very Nice', range: '61-70%', class: 'level-verynice' },
    { name: 'Excellent', range: '71-80%', class: 'level-excellent' },
    { name: 'Excellent+', range: '81-90%', class: 'level-excellentplus' },
    { name: 'Perfect', range: '91-100%', class: 'level-perfect' }
  ];
  
  let levelHTML = '<div class="level-grid">';
  levelData.forEach(level => {
    levelHTML += `
      <div class="level-item">
        <span class="level-badge ${level.class}" style="margin:0;float:none">${level.name}</span>
        <span class="level-range">${level.range}</span>
      </div>
    `;
  });
  levelHTML += '</div>';
  
  document.getElementById('modalIcon').innerText = 'ЁЯУК';
  document.getElementById('modalTitle').innerText = 'Performance Levels';
  document.getElementById('modalText').innerHTML = 'ркдркорк╛рк░рк╛ рккрлНрк░ркжрк░рлНрк╢ркиркирк╛ ркЖркзрк╛рк░рлЗ ркЖ levels ркиркХрлНркХрлА ркерк╛ркп ркЫрлЗ:' + levelHTML;
  document.getElementById('modal').querySelector('.modal-content').classList.add('level-info-modal');
  document.getElementById('modal').classList.add('show');
}

function hideModal() {
  document.getElementById('modal').classList.remove('show');
  document.getElementById('modal').querySelector('.modal-content').classList.remove('level-info-modal');
}
</script>
</body>
</html>
