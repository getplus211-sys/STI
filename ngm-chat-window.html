<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,sans-serif;background:#e5ddd5;display:flex;flex-direction:column;height:100vh;overflow:hidden}

/* --- Fixed Header --- */
.h{
    height:100px;background:linear-gradient(135deg,var(--pc),var(--sc));
    display:flex;align-items:flex-end;padding:0 10px 15px 10px;z-index:100;flex-shrink:0;
}
.bb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:none;border:none}
.bb svg{width:24px;height:24px;fill:#fff}
.hi{flex:1;display:flex;align-items:center;gap:12px;margin-left:5px}
.ha{width:50px;height:50px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;overflow:hidden;flex-shrink:0}
.ha img{width:100%;height:100%;object-fit:cover}
.hti{flex:1;overflow:hidden}.hn{color:#fff;font-size:18px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.hs{color:rgba(255,255,255,0.9);font-size:12px}

/* --- Messages Container --- */
.mc{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column}
.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}
.mb{max-width:75%;padding:8px 12px;border-radius:12px;position:relative;word-wrap:break-word;box-shadow:0 1px 1px rgba(0,0,0,0.1)}
.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}.m.received .mb{background:#fff;border-bottom-left-radius:2px}
.mt{font-size:17px;color:#000;line-height:1.4}.mti{font-size:10px;color:#666;margin-top:4px;text-align:right}

/* --- Large Emoji Animation (No Blue Highlight) --- */
.mb.emoji-xl{background:none !important;padding:0 !important;box-shadow:none !important}
.mb.emoji-xl .mt{font-size:60px !important;line-height:1;cursor:pointer;display:inline-block;user-select:none}
.emoji-bounce{animation:teleBounce 0.5s ease}
@keyframes teleBounce{0%,100%{transform:scale(1)}30%{transform:scale(1.3) rotate(-5deg)}60%{transform:scale(1.1) rotate(5deg)}}

/* --- Footer & Keyboard Area --- */
.f-container{display:flex;flex-direction:column;background:#f5f5f5;border-top:1px solid #ddd;flex-shrink:0}
.ic{padding:8px;display:flex;gap:8px;align-items:flex-end}
.ab{width:42px;height:42px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer}
.mitw{flex:1;background:#fff;border-radius:22px;display:flex;align-items:center;border:1px solid #eee}
.mi{flex:1;padding:10px 15px;border:none;font-size:16px;resize:none;max-height:100px;overflow-y:auto;background:transparent;outline:none}
.sb{width:42px;height:42px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}
.sb svg{width:22px;height:22px;fill:#fff}

/* Emoji Keyboard Scrollable */
.ek{display:none;height:280px;background:#fff;overflow-y:auto;border-top:1px solid #ddd}
.ek.show{display:block}
.eg{display:grid;grid-template-columns:repeat(7,1fr);padding:10px;gap:10px}
.ee{font-size:32px;text-align:center;cursor:pointer}
</style>
</head>
<body>

    <div class="h">
        <button class="bb" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
        <div class="hi" onclick="openUserInfo()">
            <div class="ha" id="chatAvatar">?</div>
            <div class="hti"><div class="hn" id="chatTitle">Loading...</div><div class="hs" id="chatStatus"></div></div>
        </div>
        <button class="bb"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
    </div>

    <div class="mc" id="messagesContainer"></div>

    <div class="f-container">
        <div class="ic">
            <button class="ab">ğŸ“</button>
            <div class="mitw">
                <textarea class="mi" id="messageInput" placeholder="Type a message..." rows="1" onfocus="hideEmoji()"></textarea>
            </div>
            <button class="ab" onclick="toggleEmoji()" id="emojiBtn">ğŸ˜Š</button>
            <button class="sb" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
        <div class="ek" id="emojiKeyboard"><div class="eg" id="emojiGrid"></div></div>
    </div>

<script>
const SUPABASE_URL='https://bhmycvrbucmbbrpzeane.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser, chatId, otherUser;
const emojis=['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¥³','ğŸ¤¡','ğŸ‘»','ğŸ’€','ğŸ‘½','ğŸ¤–','ğŸ‘','â¤ï¸','ğŸ”¥','âœ¨'];

async function init(){
    const {data:{user}} = await sb.auth.getUser();
    if(!user) return; currentUser = user;
    const params = new URLSearchParams(window.location.search);
    chatId = params.get('chat');
    await loadChat();
    await loadMessages();
    initEmojis();
    sb.channel('m').on('postgres_changes',{event:'INSERT',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${chatId}`},loadMessages).subscribe();
    setInterval(checkOnlineStatus, 3000);
}

async function loadChat(){
    const {data:chat} = await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();
    if(chat){
        const otherId = (chat.user1_id === currentUser.id) ? chat.user2_id : chat.user1_id;
        const {data:u} = await sb.from('ngm_users').select('*').eq('user_id',otherId).single();
        if(u){ otherUser = u; updateUI(u); }
    }
}

function updateUI(user){
    document.getElementById('chatTitle').textContent = user.full_name || user.mobile;
    document.getElementById('chatAvatar').innerHTML = user.profile_picture_url ? `<img src="${user.profile_picture_url}">` : `<span>${(user.full_name||'?').charAt(0)}</span>`;
    const diff = Date.now() - new Date(user.last_seen).getTime();
    const statusEl = document.getElementById('chatStatus');
    if(diff < 20000) statusEl.textContent = 'online';
    else statusEl.textContent = 'last seen ' + new Date(user.last_seen).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}

async function checkOnlineStatus(){ if(otherUser){ const {data:u} = await sb.from('ngm_users').select('last_seen').eq('user_id',otherUser.user_id).single(); if(u) updateUI(u); } }

function renderMessages(messages){
    const container = document.getElementById('messagesContainer');
    container.innerHTML = messages.map(msg => {
        const isSent = msg.sender_id === currentUser.id;
        const isOnlyEmoji = /^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\s)+$/u.test(msg.content.trim()) && (msg.content.match(/\p{Emoji_Presentation}|\p{Emoji}\uFE0F/gu) || []).length === 1;
        return `<div class="m ${isSent?'sent':'received'}">
            <div class="mb ${isOnlyEmoji?'emoji-xl':''}">
                <div class="mt" onclick="animateEmoji(this)">${msg.content}</div>
                ${!isOnlyEmoji ? `<div class="mti">${new Date(msg.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>` : ''}
            </div>
        </div>`;
    }).join('');
    container.scrollTop = container.scrollHeight;
}

function animateEmoji(el){
    if(el.parentElement.classList.contains('emoji-xl')){
        el.classList.remove('emoji-bounce'); void el.offsetWidth; el.classList.add('emoji-bounce');
    }
}

async function loadMessages(){
    const {data:msgs} = await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});
    renderMessages(msgs || []);
}

async function sendMessage(){
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if(!text) return;
    await sb.from('ngm_messages').insert({chat_id:chatId, sender_id:currentUser.id, content:text});
    input.value = ''; loadMessages();
}

function initEmojis(){ document.getElementById('emojiGrid').innerHTML = emojis.map(e => `<div class="ee" onclick="addEmoji('${e}')">${e}</div>`).join(''); }
function addEmoji(e){ document.getElementById('messageInput').value += e; }
function toggleEmoji(){ 
    const ek = document.getElementById('emojiKeyboard');
    ek.classList.toggle('show');
    document.getElementById('emojiBtn').textContent = ek.classList.contains('show') ? 'âŒ¨ï¸' : 'ğŸ˜Š';
    if(ek.classList.contains('show')) document.getElementById('messageInput').blur();
    document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
}
function hideEmoji(){ document.getElementById('emojiKeyboard').classList.remove('show'); document.getElementById('emojiBtn').textContent = 'ğŸ˜Š'; }
function goBack(){ window.location.href='ngm-chats.html'; }
init();
</script>
</body>
</html>
