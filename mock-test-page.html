<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STI Mock Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
    header, footer { background:#222; color:#fff; padding:15px; text-align:center; }
    header h1 { margin:0; }
    .home-btn { background:#4CAF50; color:#fff; padding:8px 15px; border:none; cursor:pointer; border-radius:5px; }
    main { padding:20px; }
    .card-container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; width:250px; padding:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .card h3 { margin:10px 0; }
    .buy-btn { background:#007BFF; color:#fff; padding:10px 20px; border:none; cursor:pointer; border-radius:5px; }
    .buy-btn:disabled { background:#aaa; cursor:not-allowed; }
    footer button { background:#25D366; color:#fff; padding:10px 20px; border:none; cursor:pointer; border-radius:5px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>STI Mock Test</h1>
    <p id="studentName">Student: Loading...</p>
    <button class="home-btn" onclick="goHome()">ğŸ  Go to Home</button>
  </header>

  <!-- Main Content -->
  <main>
    <h2>STI àª¨àª¾ 5 Mock Test àª–àª°à«€àª¦àªµàª¾ àª®àª¾àªŸà«‡àª¨à«àª‚ àª•àª¾àª°à«àª¡</h2>
    <p>Mock test àªàª• àª¯à«àªàª° àª®àª¾àª¤à«àª° àªàª• àªµàª–àª¤ àªœ àª–àª°à«€àª¦à«€ àª¶àª•à«‡ àª›à«‡. àªàª•àªµàª¾àª° àª–àª°à«€àª¦à«‡àª² àª¹à«‹àª¯ àª¤à«‹ àª¬à«€àªœàªµàª¾àª° àª®à«‡àª¸à«‡àªœ àª†àªµàª¶à«‡.</p>
    
    <div class="card-container" id="testCards">
      <!-- Cards injected by JS -->
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <button onclick="openWhatsapp()">ğŸ“± Whatsapp Contact Us</button>
  </footer>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase client init
    const supabaseUrl = "https://bhmycvrbucmbbrpzeane.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    // Load logged-in user profile (replace with your auth flow)
    async function loadProfile() {
      const { data, error } = await supabase.from("profiles").select("*").limit(1);
      if (error) { console.error(error); return; }
      if (data.length > 0) {
        currentUser = data[0];
        document.getElementById("studentName").innerText = "Student: " + currentUser.full_name;
        checkPurchaseStatus();
      }
    }

    // Render 5 mock test cards
    function renderCards(purchased) {
      const container = document.getElementById("testCards");
      container.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>Mock Test ${i}</h3>
          <p>200 Marks | 2 Hrs | -0.33 Negative</p>
          <button class="buy-btn" ${purchased ? "disabled" : ""} onclick="buyTest(${i})">
            ${purchased ? "Already Purchased" : "Buy & Start"}
          </button>
        `;
        container.appendChild(card);
      }
    }

    // Check purchase status
    async function checkPurchaseStatus() {
      if (!currentUser) return;
      const { data, error } = await supabase
        .from("user_access")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("plan_name", "mock-test")
        .eq("is_active", true);

      if (error) { console.error(error); return; }
      renderCards(data.length > 0);
    }

    // Buy test logic
    async function buyTest(testNumber) {
      if (!currentUser) { alert("User not loaded"); return; }

      const { data, error } = await supabase
        .from("user_access")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("plan_name", "mock-test")
        .eq("is_active", true);

      if (error) { console.error(error); return; }

      if (data.length > 0) {
        alert("àª¤àª®à«‡ àªªàª¹à«‡àª²à«‡àª¥à«€ àªœ Mock Test àª–àª°à«€àª¦à«€ àª²à«€àª§à«àª‚ àª›à«‡!");
        return;
      }

      const { error: insertError } = await supabase.from("user_access").insert({
        user_id: currentUser.id,
        plan_name: "mock-test",
        is_active: true,
        access_type: "paid",
        created_at: new Date().toISOString()
      });

      if (insertError) { console.error(insertError); return; }

      window.location.href = `mock-test-${testNumber}.html`;
    }

    // Go Home
    function goHome() {
      window.location.href = "index.html";
    }

    // Whatsapp redirect
    function openWhatsapp() {
      window.location.href = "https://wa.me/919925858057";
    }

    // Init
    loadProfile();
  </script>
</body>
</html>
