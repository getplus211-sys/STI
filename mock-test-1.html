<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mock Test Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;
box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3{margin:6px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer}
.primary{background:#2563eb;color:#fff}
.gray{background:#e5e7eb}
.danger{background:#dc2626;color:#fff}
.option{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0;cursor:pointer}
.option.active{background:#2563eb;color:#fff}
.top{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.6);
display:flex;align-items:center;justify-content:center;z-index:9}
.hidden{display:none}
.rank{display:flex;gap:10px;align-items:center}
.rank.me{border:2px solid #2563eb}
.loader{text-align:center;padding:40px}
.loader-icon{font-size:40px;animation:spin 2s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.qgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(45px,1fr));gap:8px;margin:15px 0}
.qbtn{padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-weight:600;font-size:14px}
.qbtn.answered{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.current{background:#2563eb;color:#fff;border-color:#2563eb}
.qbtn.correct{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.wrong{background:#ef4444;color:#fff;border-color:#ef4444}
.qbtn.skipped{background:#cbd5e1;color:#333;border-color:#cbd5e1}

.submit-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  gap: 10px;
}

.submit-header button {
  width: auto;
  padding: 12px 24px;
  font-weight: bold;
}

.submit-header #timer {
  font-size: 20px;
  font-weight: bold;
  color: #dc2626;
}

.mobile-nav {
  position: fixed;
  bottom: 20px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  padding: 0 15px;
  z-index: 10;
  pointer-events: none;
}

.mobile-nav button {
  pointer-events: all;
  width: 70px;
  height: 70px;
  border-radius: 50%;
  font-size: 24px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  border: none;
  cursor: pointer;
  transition: transform 0.2s;
}

.mobile-nav button:active {
  transform: scale(0.9);
}

.mobile-nav button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.nav-prev {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.nav-next {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

@media (min-width: 768px) {
  .mobile-nav {
    display: none;
  }
}

.confirm-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.confirm-box {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.confirm-box h3 {
  color: #2563eb;
  font-size: 24px;
  margin-bottom: 10px;
}

.confirm-box p {
  font-size: 18px;
  margin: 20px 0;
}

.confirm-btns {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.confirm-btns button {
  flex: 1;
  padding: 15px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

.btn-yes {
  background: linear-gradient(135deg, #FF9933 0%, #FF6600 100%);
  color: white;
}

.btn-cancel {
  background: #e5e7eb;
  color: #374151;
}

.terms-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.terms-box {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

.terms-box h3 {
  background: linear-gradient(135deg, #FF9933 0%, #138808 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 28px;
  margin-bottom: 20px;
  text-align: center;
}

.terms-content {
  line-height: 1.8;
  font-size: 16px;
  margin: 20px 0;
}

.terms-content ul {
  padding-left: 20px;
}

.terms-content li {
  margin: 10px 0;
}

.terms-box button {
  background: linear-gradient(135deg, #FF9933 0%, #FF6600 100%);
  color: white;
  padding: 15px;
  font-size: 18px;
  font-weight: bold;
  margin-top: 20px;
}
</style>
</head>

<body>
<div class="container" id="app">
  <div class="card loader">
    <div class="loader-icon">â³</div>
    <h3>Loading...</h3>
    <p>Please wait</p>
  </div>
</div>

<div class="popup hidden" id="purchasePopup">
  <div class="card">
    <h3>Access Required</h3>
    <p>Please purchase plan to attempt this test.</p>
    <button class="primary" onclick="location.href='/purchase.html'">Purchase Now</button>
  </div>
</div>

<script>

const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";

const urlParams = new URLSearchParams(window.location.search);
const TEST_ID = urlParams.get('test') || 'mock_test_1';

const TEST_NAMES = {
  'mock_test_1': 'Mock Test 1',
  'mock_test_2': 'Mock Test 2', 
  'mock_test_3': 'Mock Test 3',
  'mock_test_4': 'Mock Test 4',
  'mock_test_5': 'Mock Test 5'
};

const TEST_NAME = TEST_NAMES[TEST_ID] || 'Mock Test';
const TOTAL_TIME = 120 * 60;
const TIMEOUT_MS = 15000;

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const app = document.getElementById("app");
const purchasePopup = document.getElementById("purchasePopup");
let user, questions=[], answers={}, current=0;
let timeLeft=TOTAL_TIME, timer, submitted=false;

const timeout = (ms) => new Promise((_, reject) => 
  setTimeout(() => reject(new Error('Request timeout')), ms)
);

function showError(message, showRetry = true) {
  app.innerHTML = `
    <div class="card">
      <h3>âš ï¸ Error</h3>
      <p>${message}</p>
      ${showRetry ? '<button class="primary" onclick="location.reload()">Retry</button>' : ''}
    </div>
  `;
}

(async()=>{
  try {
    if (!navigator.onLine) {
      showError('No internet connection. Please check and try again.');
      return;
    }

    const {data:{user:u}} = await Promise.race([
      sb.auth.getUser(),
      timeout(TIMEOUT_MS)
    ]);

    if(!u){
      showError('Please login first', false);
      return;
    }
    user=u;

    const {data:access} = await Promise.race([
      sb
        .from("user_access")
        .select("*")
        .eq("user_id",user.id)
        .eq("is_active",true)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if(!access){
      purchasePopup.classList.remove("hidden");
      app.innerHTML="";
      return;
    }

    const { data: existingResult } = await Promise.race([
      sb
        .from("test_results")
        .select("total_score, correct_count, wrong_count, skipped_count, e_count, time_taken_seconds, answers")
        .eq("user_id", user.id)
        .eq("test_id", TEST_ID)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (existingResult) {
      answers = existingResult.answers || {};

      const { data: qData } = await Promise.race([
        sb
          .from("questions")
          .select("*")
          .eq("test_id", TEST_ID)
          .order("id"),
        timeout(TIMEOUT_MS)
      ]);

      questions = qData || [];

      loadResult(
        existingResult.total_score, 
        existingResult.correct_count, 
        existingResult.wrong_count, 
        existingResult.skipped_count, 
        existingResult.e_count,
        existingResult.time_taken_seconds
      );
    }
    else {
      loadIntro();
    }
  } catch(err) {
    console.error('Init error:', err);
    if(err.message === 'Request timeout') {
      showError('Server is taking too long to respond. Please check your connection and try again.');
    } else {
      showError('Failed to load. Please try again.');
    }
  }
})();

function showTermsPopup() {
  const popup = document.createElement('div');
  popup.className = 'terms-popup';
  popup.innerHTML = `
    <div class="terms-box">
      <h3>ğŸ‡®ğŸ‡³ KAPiLa Institute ğŸ‡®ğŸ‡³</h3>
      <div class="terms-content">
        <h4>ğŸ“‹ àª¶àª°àª¤à«‹ àª…àª¨à«‡ àª¨àª¿àª¯àª®à«‹:</h4>
        <ul>
          <li>â±ï¸ <b>àª•à«àª² àª¸àª®àª¯:</b> 120 àª®àª¿àª¨àª¿àªŸ</li>
          <li>âŒ <b>àª¨à«‡àª—à«‡àªŸàª¿àªµ àª®àª¾àª°à«àª•àª¿àª‚àª—:</b> àª–à«‹àªŸàª¾/àª›à«‹àª¡à«‡àª²àª¾ àªœàªµàª¾àª¬ àª®àª¾àªŸà«‡ 0.33</li>
          <li>âœ… <b>E àªµàª¿àª•àª²à«àªª:</b> àª¨à«‡àª—à«‡àªŸàª¿àªµ àª®àª¾àª°à«àª•àª¿àª‚àª— àª¨àª¥à«€</li>
          <li>ğŸš« àªàª• àªµàª–àª¤ àª¸àª¬àª®àª¿àªŸ àª•àª°à«àª¯àª¾ àªªàª›à«€ àª«àª°à«€àª¥à«€ àªŸà«‡àª¸à«àªŸ àª†àªªà«€ àª¶àª•àª¾àª¶à«‡ àª¨àª¹à«€àª‚</li>
          <li>âš¡ àª¸àª®àª¯ àªªà«‚àª°à«‹ àª¥àª¯àª¾ àªªàª›à«€ àªŸà«‡àª¸à«àªŸ àª“àªŸà«‹àª®à«‡àªŸàª¿àª• àª¸àª¬àª®àª¿àªŸ àª¥àª¶à«‡</li>
          <li>ğŸ¯ àª¦àª°à«‡àª• àªªà«àª°àª¶à«àª¨ àª®àª¾àªŸà«‡ àªªà«‹àªˆàª¨à«àªŸà«àª¸ àª¸àª®àª¾àª¨ àª›à«‡</li>
        </ul>
        <p style="text-align:center; margin-top:20px; font-weight:bold; color:#FF9933;">
          ğŸ™ àªœàª¯ àª¶à«àª°à«€ àª°àª¾àª® ğŸ™
        </p>
      </div>
      <button onclick="acceptTerms()">àª¸à«àªµà«€àª•àª¾àª°à«‹ àª…àª¨à«‡ àª†àª—àª³ àªµàª§à«‹</button>
    </div>
  `;
  document.body.appendChild(popup);
}

function acceptTerms() {
  document.querySelector('.terms-popup')?.remove();
  document.getElementById('agree').checked = true;
}

function loadIntro() {
  app.innerHTML = `
    <div class="card" style="box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
      <h3 style="color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px;">ğŸ“‹ Instructions</h3>
      <ul style="line-height: 2; font-size: 16px;">
        <li>â±ï¸ <b>Total Time:</b> 120 Minutes</li>
        <li>âŒ <b>Negative Marking:</b> 0.33 for wrong/skipped answers</li>
        <li>âœ… <b>E Option:</b> No negative marking</li>
      </ul>
      
      <div style="background: linear-gradient(135deg, #FFE5B4 0%, #FFF4E0 100%); border-left: 4px solid #FF9933; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <label style="display: flex; align-items: center; font-size: 16px; cursor: pointer;">
          <input type="checkbox" id="agree" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer; accent-color: #FF9933;">
          <span style="color: #FF6600; font-weight: 600;" onclick="showTermsPopup()">àª¹à«àª‚ àª¶àª°àª¤à«‹ àª…àª¨à«‡ àª¨àª¿àª¯àª®à«‹ àª¸à«àªµà«€àª•àª¾àª°à«àª‚ àª›à«àª‚ (àªµàª¾àª‚àªšàªµàª¾ àª•à«àª²àª¿àª• àª•àª°à«‹)</span>
        </label>
      </div>

      <button class="primary" onclick="startTest()" style="font-size: 18px; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);">
        ğŸš€ Start Test Now
      </button>
    </div>
  `;
}

async function startTest(){
  const agreeCheckbox = document.getElementById('agree');
  if(!agreeCheckbox.checked){
    alert("Please accept instructions");
    return;
  }

  try {
    const { data: existingResult } = await Promise.race([
      sb
        .from("test_results")
        .select("id")
        .eq("user_id", user.id)
        .eq("test_id", TEST_ID)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (existingResult) {
      alert("àª¤àª®à«‡ àª† àªŸà«‡àª¸à«àªŸ àªªàª¹à«‡àª²à«‡àª¥à«€ àª†àªªà«€ àª¦à«€àª§à«€ àª›à«‡. àª¤àª®à«‡ àª¤à«‡àª¨à«‡ àª«àª°à«€àª¥à«€ àª†àªªà«€ àª¶àª•àª¤àª¾ àª¨àª¥à«€.");
      location.reload(); 
      return;
    }

    const { data, error } = await Promise.race([
      sb
        .from("questions")
        .select("*")
        .eq("test_id", TEST_ID)
        .order("id"),
      timeout(TIMEOUT_MS)
    ]);

    if (error || !data || data.length === 0) {
      showError("Failed to load questions. Please try again.");
      return;
    }

    questions = data;
    renderQuestion();
    startTimer();
  } catch(err) {
    console.error('Start test error:', err);
    showError('Failed to start test. Please try again.');
  }
}

function renderQuestion(){
  const q = questions[current];
  
  let gridHTML = '<div class="card"><h4>Question Navigator</h4><div class="qgrid">';
  questions.forEach((ques, idx) => {
    let btnClass = 'qbtn';
    if(idx === current) btnClass += ' current';
    else if(answers[ques.id]) btnClass += ' answered';
    gridHTML += `<button class="${btnClass}" onclick="goToQuestion(${idx})">${idx+1}</button>`;
  });
  gridHTML += '</div></div>';

  app.innerHTML=`
  <div class="submit-header">
    <button class="danger" onclick="submitTest()">Submit Test</button>
    <div id="timer"></div>
  </div>

  <div class="card">
    <div style="font-weight:700; margin-bottom:10px;">Q ${current+1}/${questions.length}</div>
    <p>${q.question_text}</p>
    ${["a","b","c","d","e"].map((o,i)=>`
      <div class="option ${answers[q.id]==i+1?"active":""}"
        onclick="selectAnswer(${q.id},${i+1})">
        ${q["option_"+o]}
      </div>`).join("")}
  </div>

  ${gridHTML}
  `;

  updateMobileNav();
}

function updateMobileNav() {
  let navDiv = document.querySelector('.mobile-nav');
  
  if(!navDiv) {
    navDiv = document.createElement('div');
    navDiv.className = 'mobile-nav';
    document.body.appendChild(navDiv);
  }
  
  navDiv.innerHTML = `
    <button class="nav-prev" onclick="prev()" ${current === 0 ? 'disabled' : ''}>â—€</button>
    <button class="nav-next" onclick="next()" ${current === questions.length-1 ? 'disabled' : ''}>â–¶</button>
  `;
}

function goToQuestion(idx){
  current = idx;
  renderQuestion();
}

function selectAnswer(qid,val){
  answers[qid]=val;
  renderQuestion();
}

function next(){ 
  if(current<questions.length-1){
    current++;
    renderQuestion();
  }
}

function prev(){ 
  if(current>0){
    current--;
    renderQuestion();
  }
}

function startTimer(){
  timer=setInterval(()=>{
    timeLeft--;
    const t=document.getElementById("timer");
    if(t) t.innerText=Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,"0");
    if(timeLeft<=0){
      clearInterval(timer);
      submitTest(true);
    }
  },1000);
}

async function submitTest(auto=false){
  if(submitted) return;
  
  if(!auto) {
    const confirmPopup = document.createElement('div');
    confirmPopup.className = 'confirm-popup';
    confirmPopup.innerHTML = `
      <div class="confirm-box">
        <h3>ğŸ›ï¸ KAPiLa Institute</h3>
        <p style="font-size: 20px; font-weight: 600;">àª¶à«àª‚ àª¤àª®à«‡ àªšà«‹àª•à«àª•àª¸ àª¸àª¬àª®àª¿àªŸ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?</p>
        <div class="confirm-btns">
          <button class="btn-cancel" onclick="this.closest('.confirm-popup').remove()">àª°àª¦ àª•àª°à«‹</button>
          <button class="btn-yes" onclick="confirmSubmit()"><b>àª¹àª¾, àªœàª¯ àª¶à«àª°à«€ àª°àª¾àª® ğŸ™</b></button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmPopup);
    return;
  }
  
  submitted=true;
  clearInterval(timer);
  document.querySelector('.mobile-nav')?.remove();

  try {
    let correct=0, wrong=0, skip=0, e=0, score=0;

    questions.forEach(q=>{
      const a=answers[q.id];
      if(!a){skip++;score-=0.33;}
      else if(a===5){e++;}
      else if(a===q.correct_option){correct++;score++;}
      else{wrong++;score-=0.33;}
    });

    score = Number(score.toFixed(2));
    const safeAnswers = JSON.parse(JSON.stringify(answers));

    const {error} = await Promise.race([
      sb.from("test_results").insert({
        user_id:user.id,
        test_id:TEST_ID,
        total_score:score,
        correct_count:correct,
        wrong_count:wrong,
        skipped_count:skip,
        e_count:e,
        time_taken_seconds:TOTAL_TIME-timeLeft,
        answers:safeAnswers
      }),
      timeout(TIMEOUT_MS)
    ]);

    if(error){
      alert("Result save failed: "+error.message);
      submitted = false;
      return;
    }

    loadResult(score,correct,wrong,skip,e,TOTAL_TIME-timeLeft);
  } catch(err) {
    console.error('Submit error:', err);
    alert("Failed to submit. Please try again.");
    submitted = false;
  }
}

function confirmSubmit() {
  document.querySelector('.confirm-popup')?.remove();
  submitTest(true);
}

function loadResult(score, c, w, s, e, timeFromDB = null) {
  const timeTaken = timeFromDB !== null ? timeFromDB : (TOTAL_TIME - timeLeft);
  const minutes = Math.floor(timeTaken / 60);
  const seconds = timeTaken % 60;

  app.innerHTML = `
  <div class="card">
    <h2>Your Score: ${score}</h2>
    <div style="margin: 15px 0; line-height: 1.6;">
      <p><b>Correct:</b> ${c} | <b>Wrong:</b> ${w}</p>
      <p><b>Skipped:</b> ${s} | <b>E Options:</b> ${e}</p>
      <p><b>Time Taken:</b> ${minutes}m ${seconds}s</p>
    </div>
    <canvas id="chart"></canvas><br>
    
    <button class="primary" onclick="loadLeaderboard()">View Leaderboard</button>
    <br><br>
    <button class="gray" onclick="viewSolutions()">View Answers / Solutions</button>
  </div>`;

  const chart = document.getElementById("chart");
  new Chart(chart, {
    type: "pie",
    data: {
      labels: ["Correct", "Wrong", "Skipped", "E"],
      datasets: [{ 
        data: [c, w, s, e], 
        backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1', '#eab308'] 
      }]
    }
  });
}

function viewSolutions() {
  let gridHTML = '<div class="card"><h4>Question Navigator</h4><div class="qgrid">';
  questions.forEach((q, idx) => {
    const userAns = answers[q.id];
    const isCorrect = userAns === q.correct_option;
    let btnClass = 'qbtn';
    if(!userAns) btnClass += ' skipped';
    else if(isCorrect) btnClass += ' correct';
    else btnClass += ' wrong';
    gridHTML += `<button class="${btnClass}" onclick="scrollToSolution(${idx})">${idx+1}</button>`;
  });
  gridHTML += '</div></div>';

  let solutionHTML = `<h3>Answer Key & Solutions</h3>
                      <button class="gray" style="margin-bottom:15px" onclick="location.reload()">Back to Result</button>
                      ${gridHTML}`;

  questions.forEach((q, index) => {
    const userAns = answers[q.id];
    const isCorrect = userAns === q.correct_option;
    const options = ["a", "b", "c", "d", "e"];
    
    solutionHTML += `
    <div class="card" id="sol${index}" style="border-left: 5px solid ${isCorrect ? '#22c55e' : '#ef4444'}">
      <p><b>Q${index + 1}:</b> ${q.question_text}</p>
      <p><b>Your Answer:</b> ${userAns ? q["option_" + options[userAns - 1]] : "Skipped"}</p>
      <p style="color: #22c55e"><b>Correct Answer:</b> ${q["option_" + options[q.correct_option - 1]]}</p>
      ${q.solution ? `<div style="background:#f8fafc; padding:10px; margin-top:10px; font-size:14px;"><b>Solution:</b> ${q.solution}</div>` : ""}
    </div>`;
  });

  solutionHTML += `<button class="primary" onclick="location.reload()">Finish</button>`;
  app.innerHTML = solutionHTML;
  window.scrollTo(0, 0);
}

function scrollToSolution(idx){
  const el = document.getElementById('sol'+idx);
  if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

async function loadLeaderboard(){
  try {
    const { data: results, error } = await Promise.race([
      sb
        .from("test_results")
        .select("user_id,total_score,time_taken_seconds")
        .eq("test_id", TEST_ID)
        .order("total_score", { ascending: false })
        .order("time_taken_seconds", { ascending: true }),
      timeout(TIMEOUT_MS)
    ]);

    if(error){
      alert("Failed to load leaderboard: " + error.message);
      return;
    }

    const userIds = results.map(r => r.user_id);

    const { data: profiles } = await Promise.race([
      sb
        .from("profiles")
        .select("id, full_name")
        .in("id", userIds),
      timeout(TIMEOUT_MS)
    ]);

    const nameMap = {};
    if(profiles) {
      profiles.forEach(p => nameMap[p.id] = p.full_name);
    }

    const myIndex = results.findIndex(r => r.user_id === user.id);
    if (myIndex === -1) {
      alert("Your result not found in leaderboard");
      return;
    }

    const myRank = myIndex + 1;
    const myData = results[myIndex];

    const listHTML = results
      .filter(r => r.user_id !== user.id)
      .map((u, i) => `
        <div class="card rank">
          <b>Rank #${results.indexOf(u) + 1}</b><br>
          Name: ${nameMap[u.user_id] || "User"}<br>
          Score: ${u.total_score}<br>
          Time: ${u.time_taken_seconds} sec
        </div>
      `).join("");

    app.innerHTML = `
      <button class="gray" onclick="location.reload()">â¬… Back to Result</button>
      <br><br>

      <div class="card rank me">
        <b>Your Rank: #${myRank}</b><br>
        Name: ${nameMap[user.id] || "You"}<br>
        Score: ${myData.total_score}<br>
        Time: ${myData.time_taken_seconds} sec
      </div>

      <h2>Leaderboard</h2>
      ${listHTML}
    `;
  } catch(err) {
    console.error('Leaderboard error:', err);
    alert("Failed to load leaderboard. Please try again.");
  }
}

</script>
</body>
</html>
