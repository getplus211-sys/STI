<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NGM Chat Window</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --h: 90px; --f: 60px; }
        body { font-family: -apple-system, sans-serif; background-color: #E5DDD5; }
        .ngm-header { height: var(--h); background: #517da2; color: white; position: fixed; top: 0; width: 100%; max-width: 448px; z-index: 100; display: flex; align-items: flex-end; padding: 0 15px 12px; }
        .ngm-footer { height: var(--f); background: #f0f0f0; position: fixed; bottom: 0; width: 100%; max-width: 448px; z-index: 100; display: flex; align-items: center; padding: 0 10px; border-top: 1px solid #ddd; }
        .chat-container { margin-top: var(--h); margin-bottom: var(--f); padding: 15px; display: flex; flex-direction: column; gap: 8px; min-height: calc(100vh - var(--h) - var(--f)); }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-sent { align-self: flex-end; background-color: #effdde; color: #000; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background-color: #fff; color: #000; border-bottom-left-radius: 2px; }
        .msg-time { font-size: 10px; color: #888; text-align: right; margin-top: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input:focus { outline: none; }
    </style>
</head>
<body class="flex justify-center overflow-x-hidden">

<div class="w-full max-w-md bg-transparent min-h-screen relative flex flex-col">
    <header class="ngm-header shadow-md">
        <div class="flex items-center w-full gap-3">
            <button onclick="location.href='ngm-chats.html'" class="text-2xl font-light">‚Üê</button>
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold text-lg" id="chat-icon">?</div>
            <div class="flex-1 overflow-hidden">
                <h2 class="font-bold text-base truncate" id="chat-name">Loading...</h2>
                <p class="text-[11px] opacity-80" id="chat-status">online</p>
            </div>
            <div class="text-xl">‚ãÆ</div>
        </div>
    </header>

    <main class="chat-container no-scrollbar" id="message-list">
        </main>

    <footer class="ngm-footer">
        <div class="flex w-full items-center gap-2">
            <button class="text-gray-500 text-2xl px-1">üìé</button>
            <input type="text" id="msgInput" placeholder="Message" class="flex-1 bg-white rounded-full px-4 py-2 text-sm border-none shadow-sm">
            <button onclick="sendMessage()" id="sendBtn" class="bg-[#517da2] text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </footer>
</div>

<script>
    const CONFIG = {
        URL: 'https://bhmycvrbucmbbrpzeane.supabase.co',
        KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4'
    };

    const _supabase = supabase.createClient(CONFIG.URL, CONFIG.KEY);
    const urlParams = new URLSearchParams(window.location.search);
    const currentChatId = urlParams.get('chat_id');
    const myId = 'me'; // ‡™Ü‡™®‡´á ‡™§‡™Æ‡´á ‡™§‡™Æ‡™æ‡™∞‡™æ ‡™∞‡™ø‡™Ø‡™≤ ‡™Ø‡´Å‡™ù‡™∞ ‡™Ü‡™à‡™°‡´Ä ‡™•‡´Ä ‡™∞‡™ø‡™™‡´ç‡™≤‡´á‡™∏ ‡™ï‡™∞‡´Ä ‡™∂‡™ï‡´ã ‡™õ‡´ã

    // 1. Load Everything
    async function init() {
        if (!currentChatId) {
            alert("Chat ID is missing!");
            return;
        }
        document.getElementById('chat-name').innerText = "ID: " + currentChatId.substring(0, 8);
        await loadMessages();
        subscribeToMessages();
    }

    // 2. Fetch Messages from ngm_messages Table
    async function loadMessages() {
        const { data, error } = await _supabase
            .from('ngm_messages')
            .select('*')
            .eq('chat_id', currentChatId)
            .order('created_at', { ascending: true });

        if (error) console.error("Error loading messages:", error);
        else renderMessages(data);
    }

    // 3. Render Logic
    function renderMessages(messages) {
        const list = document.getElementById('message-list');
        list.innerHTML = messages.map(m => {
            const isMe = m.sender_id === myId;
            const time = new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            return `
                <div class="msg ${isMe ? 'msg-sent' : 'msg-received'}">
                    <div>${m.content}</div>
                    <div class="msg-time">${time}</div>
                </div>
            `;
        }).join('');
        window.scrollTo(0, document.body.scrollHeight);
    }

    // 4. Send Message Function
    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        const { error } = await _supabase
            .from('ngm_messages')
            .insert([{
                chat_id: currentChatId,
                sender_id: myId,
                content: text,
                message_type: 'text'
            }]);

        if (error) {
            console.error("Send error:", error);
            alert("Message not sent!");
        }
    }

    // 5. Real-time Subscription (Live Chat)
    function subscribeToMessages() {
        _supabase
            .channel('public:ngm_messages')
            .on('postgres_changes', { 
                event: 'INSERT', 
                schema: 'public', 
                table: 'ngm_messages',
                filter: `chat_id=eq.${currentChatId}`
            }, (payload) => {
                loadMessages(); // Refresh when new message arrives
            })
            .subscribe();
    }

    // Enter Key Support
    document.getElementById('msgInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    init();
</script>
</body>
</html>
