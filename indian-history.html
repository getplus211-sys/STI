<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ркнрк╛рк░ркдркирлЛ ркЗркдрк┐рк╣рк╛рк╕ - KLS Quiz System</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;background:#f3f4f6;padding-top:130px;padding-bottom:70px}

/* Header */
.header{position:fixed;top:0;left:0;right:0;z-index:1000;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.header-top{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb}
.brand{flex:1}
.brand-name{font-size:18px;font-weight:bold;color:#667eea;line-height:1.2}
.brand-subtitle{font-size:10px;color:#764ba2}
.header-right{display:flex;align-items:center;gap:8px}
.user-name{font-size:12px;font-weight:bold;color:#1f2937}

/* Chapters Horizontal Scroll */
.chapters-header{overflow-x:auto;overflow-y:hidden;white-space:nowrap;padding:12px 16px;background:#fff;-webkit-overflow-scrolling:touch}
.chapters-header::-webkit-scrollbar{height:4px}
.chapters-header::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}
.chapter-tab{display:inline-block;padding:8px 16px;margin-right:8px;background:#f3f4f6;border-radius:20px;font-size:13px;font-weight:600;color:#6b7280;cursor:pointer;transition:all 0.2s;border:2px solid transparent}
.chapter-tab:hover{background:#e5e7eb}
.chapter-tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:#667eea}

/* Container */
.container{padding:0 16px;max-width:600px;margin:0 auto}

/* Chapter Title */
.chapter-title{background:#fff;padding:16px;margin:16px 16px 0 16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
.chapter-title h2{font-size:18px;color:#1f2937;font-weight:600;line-height:1.4}

/* Quiz List */
.quiz-list{padding:16px}
.quiz-item{background:#fff;padding:16px;margin-bottom:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08);cursor:pointer;transition:all 0.2s;border:2px solid transparent}
.quiz-item:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:translateY(-2px);border-color:#667eea}
.quiz-item:active{transform:translateY(0)}
.quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.quiz-name{font-size:16px;font-weight:600;color:#1f2937}
.quiz-badge{background:#22c55e;color:#fff;font-size:11px;padding:4px 10px;border-radius:12px;font-weight:600}
.quiz-badge.medium{background:#f59e0b}
.quiz-badge.hard{background:#ef4444}
.quiz-info{display:flex;gap:16px;margin-top:8px}
.quiz-info-item{display:flex;align-items:center;gap:6px;font-size:13px;color:#6b7280}

/* Loading State */
.loading{text-align:center;padding:60px 20px;color:#6b7280}
.spinner{font-size:48px;margin:0 auto 16px;animation:spin 2s linear infinite;display:inline-block}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.loading h3{margin-top:16px;font-size:16px;font-weight:500}

/* Footer */
.footer{position:fixed;bottom:0;left:0;right:0;z-index:1000;background:#fff;padding:12px 16px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);display:flex;justify-content:space-around;align-items:center}
.footer-btn{background:none;border:none;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:24px;color:#6b7280;cursor:pointer}
.footer-btn.active{color:#667eea}
.footer-label{font-size:9px;font-weight:600}
</style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <div class="brand">
      <div class="brand-name">ркнрк╛рк░ркдркирлЛ ркЗркдрк┐рк╣рк╛рк╕</div>
      <div class="brand-subtitle">KAPiLa Learning</div>
    </div>
    <div class="header-right">
      <span id="userNameDisplay" class="user-name" style="display:none"></span>
    </div>
  </div>
  <div class="chapters-header" id="chaptersHeader">
    <div class="loading" style="padding:12px 0">
      <span class="spinner" style="font-size:20px;margin:0">тП│</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="chapter-title" id="chapterTitle" style="display:none">
    <h2></h2>
  </div>
  <div class="quiz-list" id="quizList">
    <div class="loading">
      <div class="spinner">тП│</div>
      <h3>рккрлНрк░ркХрк░ркг рккрк╕ркВркж ркХрк░рлЛ</h3>
    </div>
  </div>
</div>

<footer class="footer">
  <button class="footer-btn active" onclick="window.location.href='index-kapila.html'">
    <span>ЁЯПа</span>
    <span class="footer-label">Home</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='kls-overall-performance.html'">
    <span>ЁЯУК</span>
    <span class="footer-label">Performance</span>
  </button>
  <button class="footer-btn" onclick="window.open('tel:+916353511804')">
    <span>ЁЯУЮ</span>
    <span class="footer-label">Call</span>
  </button>
  <button class="footer-btn" onclick="window.open('https://wa.me/916353511804', '_blank')">
    <span>ЁЯТм</span>
    <span class="footer-label">WhatsApp</span>
  </button>
</footer>

<script>
// Supabase Configuration
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYwNzQ1MTEsImV4cCI6MjA1MTY1MDUxMX0.t4MkVufW2r6_gaIZ46tQK-DUd_shvOYqbGz6_xrBSko";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// Subject Configuration
const SUBJECT_ID = '00000000-0000-0000-0000-000000000004';
const SUBJECT_CODE = 'INDIAN_HISTORY';

let currentUser = null;
let currentChapter = null;

// Initialize
init();

async function init() {
  try {
    // Check user login
    const { data: { user } } = await sb.auth.getUser();
    currentUser = user;
    
    // Fetch and display user profile
    if (currentUser) {
      const { data: profile } = await sb.from('profiles').select('full_name').eq('id', currentUser.id).single();
      if (profile) {
        document.getElementById('userNameDisplay').innerText = profile.full_name.split(' ')[0];
        document.getElementById('userNameDisplay').style.display = 'block';
      }
    }
    
    // Load chapters
    await loadChapters();
    
  } catch (err) {
    console.error('Init error:', err);
  }
}

async function loadChapters() {
  try {
    const { data: chapters, error } = await sb
      .from('kls_chapters')
      .select('*')
      .eq('subject_id', SUBJECT_ID)
      .order('chapter_code');
    
    if (error) throw error;
    
    if (!chapters || chapters.length === 0) {
      document.getElementById('chaptersHeader').innerHTML = '<div style="padding:12px;color:#6b7280">No chapters found</div>';
      return;
    }
    
    const chaptersHTML = chapters.map((ch, index) => 
      \`<div class="chapter-tab" data-code="\${ch.chapter_code}" onclick="selectChapter('\${ch.chapter_code}', '\${ch.name}')">рккрлНрк░ркХрк░ркг \${index + 1}</div>\`
    ).join('');
    
    document.getElementById('chaptersHeader').innerHTML = chaptersHTML;
    
    // Auto-select first chapter
    if (chapters.length > 0) {
      selectChapter(chapters[0].chapter_code, chapters[0].name);
    }
    
  } catch (err) {
    console.error('Chapters error:', err);
    document.getElementById('chaptersHeader').innerHTML = '<div style="padding:12px;color:#ef4444">Error loading chapters</div>';
  }
}

async function selectChapter(chapterCode, chapterName) {
  currentChapter = chapterCode;
  
  // Update chapter title
  document.getElementById('chapterTitle').style.display = 'block';
  document.getElementById('chapterTitle').querySelector('h2').innerText = chapterName;
  
  // Update active tab
  document.querySelectorAll('.chapter-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.getAttribute('data-code') === chapterCode) {
      tab.classList.add('active');
      tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }
  });
  
  // Show loading
  document.getElementById('quizList').innerHTML = \`
    <div class="loading">
      <div class="spinner">тП│</div>
      <h3>рк▓рлЛркбрк┐ркВркЧ ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
    </div>
  \`;
  
  // Load quizzes for this chapter
  await loadQuizzes(chapterCode);
}

async function loadQuizzes(chapterCode) {
  try {
    const { data, error } = await sb
      .from('kls_quizzes')
      .select('*')
      .eq('chapter_code', chapterCode)
      .eq('is_active', true)
      .order('difficulty_level');
    
    if (error) throw error;
    
    const quizList = document.getElementById('quizList');
    
    if (!data || data.length === 0) {
      quizList.innerHTML = \`
        <div class="loading">
          <h3 style="color:#6b7280">ркЖ рккрлНрк░ркХрк░ркгркорк╛ркВ ркХрлЛркИ quiz ркиркерлА</h3>
          <p style="font-size:14px;margin-top:8px">Quiz ркЬрк▓рлНркжрлА LIVE ркерк╢рлЗ</p>
        </div>
      \`;
      return;
    }
    
    quizList.innerHTML = data.map(quiz => {
      const difficultyClass = quiz.difficulty_level === 'рк╕рк░рк│' ? '' : 
                              quiz.difficulty_level === 'ркоркзрлНркпрко' ? 'medium' : 'hard';
      
      return \`
        <div class="quiz-item" onclick="startQuiz('\${quiz.quiz_id}')">
          <div class="quiz-header">
            <div class="quiz-name">\${quiz.quiz_name}</div>
            <div class="quiz-badge \${difficultyClass}">\${quiz.difficulty_level}</div>
          </div>
          <div class="quiz-info">
            <div class="quiz-info-item">
              <span>ЁЯУЭ</span>
              <span>\${quiz.total_questions} рккрлНрк░рк╢рлНркирлЛ</span>
            </div>
            <div class="quiz-info-item">
              <span>тП▒я╕П</span>
              <span>\${quiz.time_limit} ркорк┐ркирк┐ркЯ</span>
            </div>
          </div>
        </div>
      \`;
    }).join('');
    
  } catch (err) {
    console.error('Quizzes error:', err);
    document.getElementById('quizList').innerHTML = \`
      <div class="loading">
        <h3 style="color:#ef4444">Quiz рк▓рлЛркб ркХрк░рк╡рк╛ркорк╛ркВ рк╕ркорк╕рлНркпрк╛</h3>
        <p style="font-size:14px;margin-top:8px">ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ</p>
      </div>
    \`;
  }
}

function startQuiz(quizId) {
  // Redirect to KLS Quiz Engine
  window.location.href = 'kls-quiz-engine.html?quiz_id=' + quizId;
}
</script>
</body>
</html>
