<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>LRD Quiz Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:14px}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
button{border:none;border-radius:14px;padding:14px;font-size:16px;font-weight:600;cursor:pointer;width:100%}
.primary{background:#22c55e;color:#fff}
.gray{background:#e5e7eb}
.option{border:2px solid #e5e7eb;border-radius:12px;padding:14px;margin:10px 0;cursor:pointer}
.option.selected{border-color:#22c55e;background:#f0fdf4}
.hidden{display:none}
#timer{font-weight:800;color:#dc2626}
.q-nav{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:16px}
.q-num{padding:10px;text-align:center;background:#e5e7eb;border-radius:10px;font-weight:700;cursor:pointer}
.q-num.active{background:#22c55e;color:#fff}
.q-num.answered{background:#8b5cf6;color:#fff}
</style>
</head>

<body>

<div class="container">

<!-- SETUP -->
<div id="setup" class="card">
<h2 id="test-title">Quiz</h2>
<p id="test-desc">Loading...</p>
<button class="primary hidden" id="startBtn">Start Test</button>
</div>

<!-- QUIZ -->
<div id="quiz" class="hidden">
<div class="card" style="display:flex;justify-content:space-between">
<b id="progress"></b>
<span id="timer"></span>
</div>

<div class="card">
<div id="question"></div>
<div id="options"></div>
</div>

<div style="display:flex;gap:10px">
<button class="gray" onclick="prevQ()">‚¨Ö Prev</button>
<button class="primary" onclick="nextQ()">Next ‚û°</button>
</div>

<div class="q-nav" id="nav"></div>

<button class="primary" style="margin-top:20px;background:#dc2626" onclick="submitTest()">Finish & Submit</button>
</div>

<!-- RESULT -->
<div id="result" class="hidden">
<div class="card" style="text-align:center">
<h2>üéâ Result</h2>
<canvas id="chart"></canvas>
<div id="summary"></div>
<button class="primary" onclick="showSolutions()">üìñ Solutions</button>
<button class="gray" onclick="location.reload()">üè† Home</button>
</div>
<div id="solutions"></div>
</div>

</div>

<script>
/* ========= SUPABASE ========= */
const sb = supabase.createClient(
  "https://bhmycvrbucmbbrpzeane.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4"
);

const quizId = new URLSearchParams(location.search).get("id");
let user, questions=[], answers={}, index=0, time=0, timer;

/* ========= INIT ========= */
(async()=>{
const {data:{session}} = await sb.auth.getSession();
if(!session){ alert("Login required"); return; }
user=session.user;

/* mapping */
const {data:map} = await sb.from("quiz_test_mapping")
.select("lrd_test_id").eq("quiz_id",quizId).maybeSingle();
const testId = map?.lrd_test_id;

/* test */
const {data:test} = await sb.from("lrd_tests").select("*").eq("id",testId).single();
document.getElementById("test-title").innerText=test.title;
document.getElementById("test-desc").innerText=`${test.duration_minutes} Minutes | ${test.total_marks} Marks`;

/* questions */
const {data:q} = await sb.from("lrd_quiz_questions")
.select("*").eq("quiz_id",quizId).order("question_number");
questions=q;

document.getElementById("startBtn").classList.remove("hidden");
document.getElementById("startBtn").onclick=startTest;
})();

/* ========= TEST ========= */
function startTest(){
document.getElementById("setup").classList.add("hidden");
document.getElementById("quiz").classList.remove("hidden");
time=questions.length*60;
timer=setInterval(()=>{
time--;
document.getElementById("timer").innerText=
Math.floor(time/60)+":"+String(time%60).padStart(2,"0");
if(time<=0) submitTest();
},1000);
render();
}

function render(){
const q=questions[index];
document.getElementById("progress").innerText=`Q ${index+1}/${questions.length}`;
document.getElementById("question").innerHTML="<b>"+q.question_text+"</b>";
const opt=document.getElementById("options");
opt.innerHTML="";
["a","b","c","d","e"].forEach((k,i)=>{
if(q["option_"+k]){
const d=document.createElement("div");
d.className="option"+(answers[index]==k?" selected":"");
d.innerText=q["option_"+k];
d.onclick=()=>{answers[index]=k;render();nav();};
opt.appendChild(d);
}});
nav();
}

function nav(){
const n=document.getElementById("nav"); n.innerHTML="";
questions.forEach((_,i)=>{
const d=document.createElement("div");
d.className="q-num"+(i==index?" active":"")+(answers[i]?" answered":"");
d.innerText=i+1;
d.onclick=()=>{index=i;render();}
n.appendChild(d);
});
}
function nextQ(){ if(index<questions.length-1){index++;render();}}
function prevQ(){ if(index>0){index--;render();}}

/* ========= SUBMIT ========= */
async function submitTest(){
clearInterval(timer);

let correct=0,wrong=0,skip=0;
questions.forEach((q,i)=>{
if(!answers[i]) skip++;
else if(answers[i]===q.correct_option) correct++;
else wrong++;
});

/* insert per question */
const rows = questions.map((q,i)=>({
student_id:user.id,
test_id:q.quiz_id,
question_id:q.id,
subject_id:q.subject_id,
chapter_id:q.chapter_id,
question_text:q.question_text,
option_a:q.option_a,
option_b:q.option_b,
option_c:q.option_c,
option_d:q.option_d,
option_e:q.option_e,
correct_option:q.correct_option,
student_answer:answers[i]||null,
is_correct:answers[i]===q.correct_option,
is_attempted:!!answers[i],
question_number:q.question_number,
total_questions:questions.length,
marks_obtained:answers[i]===q.correct_option?q.marks:0,
marks_allocated:q.marks
}));

await sb.from("lrd_results").insert(rows);

showResult(correct,wrong,skip);
}

/* ========= RESULT ========= */
function showResult(c,w,s){
document.getElementById("quiz").classList.add("hidden");
document.getElementById("result").classList.remove("hidden");
document.getElementById("summary").innerHTML=
`‚úî ${c} | ‚ùå ${w} | ‚ö™ ${s}`;

new Chart(document.getElementById("chart"),{
type:"doughnut",
data:{labels:["Correct","Wrong","Skipped"],
datasets:[{data:[c,w,s]}]}
});
}

/* ========= SOLUTIONS ========= */
function showSolutions(){
const box=document.getElementById("solutions");
box.innerHTML="<h3>Solutions</h3>";
questions.forEach((q,i)=>{
box.innerHTML+=`
<div class="card">
<b>Q${i+1}</b>
<p>${q.question_text}</p>
<p>‚úî Correct: ${q["option_"+q.correct_option]}</p>
<p>üí° ${q.solution||""}</p>
</div>`;
});
}
</script>

</body>
</html>
