<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Beginners - પર્ફોર્મન્સ ડેશબોર્ડ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@300;400;600;700&display=swap');
        body { 
            font-family: 'Hind Vadodara', sans-serif; 
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
        }
        .subject-card:hover { 
            transform: translateY(-5px); 
            transition: all 0.3s ease; 
        }
        nav {
            background: #1e40af;
            color: white;
            padding: 16px 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-logo {
            background: white;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
        }
        .nav-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            background: #1d4ed8;
        }
        .loading {
            text-align: center;
            padding: 100px 20px;
            font-size: 20px;
            color: #64748b;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-left">
            <div class="nav-logo">LRD</div>
            <h1 style="font-size: 20px; font-weight: bold; margin: 0;">Beginners</h1>
        </div>
        <button class="nav-btn" onclick="goHome()">
            <i class="fas fa-home"></i> હોમ
        </button>
    </nav>

    <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin" style="font-size: 48px;"></i>
        <p>લોડ થઈ રહ્યું છે...</p>
    </div>

    <div id="dashboard" class="hidden"></div>

    <script>
        const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let allCharts = [];

        async function init() {
            // Check authentication
            const { data: { session }, error: authError } = await sb.auth.getSession();
            if (!session) {
                alert('કૃપા કરીને પહેલા લોગિન કરો.');
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;

            // Get result_id from URL or fetch latest result
            const params = new URLSearchParams(window.location.search);
            let resultId = params.get('result_id');

            if (!resultId) {
                // Fetch latest result for this user
                const { data: latestResult } = await sb
                    .from('lrd_test_results')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (!latestResult) {
                    document.getElementById('loading').innerHTML = `
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #f59e0b;"></i>
                        <p>તમે હજુ સુધી કોઈ ટેસ્ટ આપ્યો નથી.</p>
                    `;
                    return;
                }
                resultId = latestResult.id;
            }

            await loadDashboard(resultId);
        }

        async function loadDashboard(resultId) {
            try {
                // Fetch test result
                const { data: result, error: resultError } = await sb
                    .from('lrd_test_results')
                    .select('*')
                    .eq('id', resultId)
                    .single();

                if (resultError) throw resultError;

                // Fetch user profile
                const { data: profile } = await sb
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                // Fetch test info
                const { data: testInfo } = await sb
                    .from('lrd_tests')
                    .select('*')
                    .eq('id', result.test_id)
                    .single();

                // Fetch question responses for chapter analysis
                const { data: responses } = await sb
                    .from('lrd_question_responses')
                    .select('*')
                    .eq('result_id', resultId);

                // Fetch all questions separately
                const questionIds = responses?.map(r => r.question_id) || [];
                const { data: questions } = questionIds.length > 0 ? await sb
                    .from('lrd_questions')
                    .select('id, chapter_id, difficulty_level')
                    .in('id', questionIds) : { data: [] };

                // Merge responses with question data
                const responsesWithQuestions = responses?.map(resp => ({
                    ...resp,
                    lrd_questions: questions?.find(q => q.id === resp.question_id)
                })) || [];

                // Fetch chapters
                const { data: chapters } = await sb
                    .from('lrd_chapters')
                    .select('*');

                // Fetch subjects
                const { data: subjects } = await sb
                    .from('lrd_subjects')
                    .select('*');

                // Calculate chapter-wise performance
                const chapterStats = calculateChapterStats(responsesWithQuestions, chapters);

                // Fetch rule engine suggestions
                const suggestions = await getRuleSuggestions(result, chapterStats);

                // Fetch recent test history
                const { data: testHistory } = await sb
                    .from('lrd_test_results')
                    .select('obtained_marks, created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: true })
                    .limit(10);

                // Render dashboard
                renderDashboard({
                    result,
                    profile,
                    testInfo,
                    chapterStats,
                    subjects,
                    suggestions,
                    testHistory
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ef4444;"></i>
                    <p>ડેટા લોડ કરવામાં સમસ્યા આવી.</p>
                `;
            }
        }

        function calculateChapterStats(responses, chapters) {
            const stats = {};
            
            responses.forEach(resp => {
                const chapterId = resp.lrd_questions?.chapter_id;
                if (!chapterId) return;

                if (!stats[chapterId]) {
                    stats[chapterId] = {
                        total: 0,
                        correct: 0,
                        easy_total: 0,
                        easy_correct: 0,
                        hard_total: 0,
                        hard_correct: 0
                    };
                }

                stats[chapterId].total++;
                if (resp.is_correct) stats[chapterId].correct++;

                const difficulty = resp.lrd_questions?.difficulty_level?.toLowerCase();
                if (difficulty === 'easy') {
                    stats[chapterId].easy_total++;
                    if (resp.is_correct) stats[chapterId].easy_correct++;
                } else {
                    stats[chapterId].hard_total++;
                    if (resp.is_correct) stats[chapterId].hard_correct++;
                }
            });

            // Add chapter names
            Object.keys(stats).forEach(chapterId => {
                const chapter = chapters.find(c => c.id == chapterId);
                if (chapter) {
                    stats[chapterId].name = chapter.name;
                    stats[chapterId].chapter_code = chapter.chapter_code;
                    stats[chapterId].subject_id = chapter.subject_id;
                }
            });

            return stats;
        }

        async function getRuleSuggestions(result, chapterStats) {
            const suggestions = [];

            // Calculate speed category
            const avgTime = result.avg_time_per_question;
            let speedCategory = 'average';
            if (avgTime < 30) speedCategory = 'fast';
            else if (avgTime > 60) speedCategory = 'slow';

            // For each chapter, get suggestions from rule engine
            for (const chapterId in chapterStats) {
                const stat = chapterStats[chapterId];
                const accuracy = (stat.correct / stat.total) * 100;

                // Get subject code for this chapter
                const { data: chapter } = await sb
                    .from('lrd_chapters')
                    .select('subject_id, lrd_subjects(subject_code)')
                    .eq('id', chapterId)
                    .single();

                const subjectCode = chapter?.lrd_subjects?.subject_code;

                if (subjectCode) {
                    const { data: rules } = await sb
                        .from('lrd_rule_engine')
                        .select('*')
                        .eq('subject_id', subjectCode)
                        .eq('chapter_code', stat.chapter_code)
                        .lte('min_score', accuracy)
                        .gte('max_score', accuracy)
                        .eq('speed_category', speedCategory)
                        .order('priority', { ascending: true });

                    if (rules && rules.length > 0) {
                        suggestions.push({
                            chapter: stat.name,
                            rule: rules[0]
                        });
                    }
                }
            }

            return suggestions;
        }

        function renderDashboard(data) {
            const { result, profile, testInfo, chapterStats, subjects, suggestions, testHistory } = data;

            // Get user initials
            const initials = profile?.full_name?.split(' ').map(n => n[0]).join('').toUpperCase() || 'U';

            // Calculate percentages
            const totalQuestions = result.easy_total + result.hard_total;
            const correctCount = result.easy_correct + result.hard_correct;
            const wrongCount = totalQuestions - correctCount - result.unanswered_count;

            // Format date
            const testDate = new Date(result.created_at).toLocaleDateString('en-GB');

            // Group chapters by subject
            const subjectGroups = {};
            Object.values(chapterStats).forEach(stat => {
                if (!subjectGroups[stat.subject_id]) {
                    const subject = subjects.find(s => s.id == stat.subject_id);
                    subjectGroups[stat.subject_id] = {
                        name: subject?.name || 'અજ્ઞાત વિષય',
                        chapters: []
                    };
                }
                subjectGroups[stat.subject_id].chapters.push(stat);
            });

            const html = `
<div style="max-width: 1200px; margin: 0 auto; padding: 24px;">
    
    <!-- Profile Card -->
    <div style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; margin-bottom: 32px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                ${initials}
            </div>
            <div>
                <p style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600; margin: 0 0 5px 0;">વિદ્યાર્થી</p>
                <h2 style="font-size: 24px; font-weight: bold; color: #1e293b; margin: 0;">${profile?.full_name || 'વિદ્યાર્થી'}</h2>
            </div>
        </div>
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <p style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 8px;">લેવલ</p>
                <span style="background: #fed7aa; color: #ea580c; padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-block;">${profile?.current_level || 'ગોલ્ડ'}</span>
            </div>
            <div style="text-align: center;">
                <p style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 8px;">રેન્ક</p>
                <p style="font-size: 24px; font-weight: 900; color: #1e40af; margin: 0;">#${profile?.current_rank || '-'}</p>
            </div>
            <div style="text-align: center;">
                <p style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 8px;">તારીખ</p>
                <p style="font-size: 16px; font-weight: bold; color: #475569; margin: 0;">${testDate}</p>
            </div>
        </div>
    </div>

    <!-- Metrics Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        
        <!-- Pie Chart -->
        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center;">
            <h3 style="font-weight: bold; color: #475569; margin: 0 0 16px 0; text-align: center; font-size: 16px;">ટેસ્ટનું પરિણામ</h3>
            <div style="width: 100%; max-width: 200px;">
                <canvas id="performancePie"></canvas>
            </div>
        </div>

        <!-- Stats Grid - 2x4 Layout -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">કુલ/મેળવેલ</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${testInfo?.total_marks || 100}/<span style="color: #2563eb;">${result.obtained_marks.toFixed(0)}</span></p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ચોકસાઈ</p>
                <p style="font-size: 18px; font-weight: bold; color: #10b981; margin: 0;">${result.accuracy_percentage.toFixed(1)}%</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">સમય/પ્રશ્ન</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${Math.round(result.avg_time_per_question)}s</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">એકાગ્રતા</p>
                <p style="font-size: 18px; font-weight: bold; color: #8b5cf6; margin: 0;">${result.concentration_rating}/10</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">સરળ</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${result.easy_correct}/${result.easy_total}</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">અઘરા</p>
                <p style="font-size: 18px; font-weight: bold; color: #ef4444; margin: 0;">${result.hard_correct}/${result.hard_total}</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">ટાર્ગેટ</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${testInfo?.target_score || 90}</p>
            </div>
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center;">
                <p style="color: #64748b; font-size: 13px; margin: 0 0 6px 0;">બાકી</p>
                <p style="font-size: 18px; font-weight: bold; margin: 0;">${result.unanswered_count}</p>
            </div>
        </div>
    </div>

    <!-- Subject & Chapter Analysis -->
    <h3 style="font-size: 18px; font-weight: bold; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-book-open" style="color: #2563eb;"></i> વિષય અને ચેપ્ટરવાર એનાલિસિસ
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
        ${Object.values(subjectGroups).map((subject, idx) => {
            const totalCorrect = subject.chapters.reduce((sum, ch) => sum + ch.correct, 0);
            const totalQuestions = subject.chapters.reduce((sum, ch) => sum + ch.total, 0);
            const subjectAccuracy = ((totalCorrect / totalQuestions) * 100).toFixed(0);
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'];
            const bgColors = ['#eff6ff', '#f5f3ff', '#f0fdf4', '#fffbeb'];
            const color = colors[idx % colors.length];
            const bgColor = bgColors[idx % bgColors.length];

            return `
            <div class="subject-card" style="background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
                <div style="background: ${bgColor}; padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="font-weight: bold; color: ${color}; font-size: 18px; margin: 0;">${subject.name}</h4>
                    <span style="background: ${color}; color: white; font-size: 12px; padding: 4px 12px; border-radius: 12px; font-weight: 600;">નિપુણતા: ${subjectAccuracy}%</span>
                </div>
                <div style="padding: 16px;">
                    <table style="width: 100%; font-size: 14px;">
                        <thead style="color: #64748b; text-transform: uppercase; font-size: 11px;">
                            <tr>
                                <th style="padding-bottom: 12px; text-align: left; font-weight: 600;">ચેપ્ટર</th>
                                <th style="padding-bottom: 12px; text-align: center; font-weight: 600;">પ્રશ્નો</th>
                                <th style="padding-bottom: 12px; text-align: center; font-weight: 600;">સાચા</th>
                                <th style="padding-bottom: 12px; text-align: right; font-weight: 600;">પરિણામ</th>
                            </tr>
                        </thead>
                        <tbody style="color: #475569;">
                            ${subject.chapters.map(ch => {
                                const chAccuracy = ((ch.correct / ch.total) * 100).toFixed(0);
                                const resultColor = chAccuracy >= 75 ? '#10b981' : chAccuracy >= 50 ? '#f59e0b' : '#ef4444';
                                return `
                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                    <td style="padding: 12px 0; font-weight: 500; color: #334155;">${ch.name}</td>
                                    <td style="padding: 12px 0; text-align: center;">${ch.total}</td>
                                    <td style="padding: 12px 0; text-align: center;">${ch.correct}</td>
                                    <td style="padding: 12px 0; text-align: right; color: ${resultColor}; font-weight: bold;">${chAccuracy}%</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            `;
        }).join('')}
    </div>

    <!-- Progress & Action Plan -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
        
        <!-- Progress Chart -->
        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <h3 style="font-weight: bold; color: #475569; margin: 0 0 16px 0; text-align: center; font-size: 16px;">તમારી પ્રગતિ</h3>
            <canvas id="trendLine"></canvas>
        </div>

        <!-- Action Plan -->
        <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 20px; right: 20px; opacity: 0.1; font-size: 48px;">
                <i class="fas fa-bullseye"></i>
            </div>
            <h3 style="font-size: 18px; font-weight: bold; margin: 0 0 16px 0; color: #fbbf24; border-bottom: 2px solid rgba(251,191,36,0.3); padding-bottom: 10px;">
                તમારા માટે એક્શન પ્લાન
            </h3>
            <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                <div>
                    <p style="font-size: 12px; font-weight: bold; color: #93c5fd; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 10px 0;">વધારે સમય આપો:</p>
                    <ul style="margin: 0; padding-left: 0; list-style: none;">
                        ${suggestions.slice(0, 3).map(s => `
                            <li style="display: flex; align-items: start; gap: 8px; margin-bottom: 10px; color: #cbd5e1; font-size: 13px; line-height: 1.5;">
                                <i class="fas fa-check-circle" style="color: #10b981; margin-top: 2px; flex-shrink: 0;"></i>
                                <span><strong>${s.chapter}:</strong> ${s.rule.suggestion_text || 'વધુ પ્રેક્ટિસ કરો'}</span>
                            </li>
                        `).join('')}
                        ${suggestions.length === 0 ? '<li style="color: #cbd5e1; font-size: 13px;">તમારું પરફોર્મન્સ સારું છે! આ રીતે ચાલુ રાખો.</li>' : ''}
                    </ul>
                </div>
                <div>
                    <p style="font-size: 12px; font-weight: bold; color: #93c5fd; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 10px 0;">વાંચન સૂચન:</p>
                    <p style="color: #cbd5e1; font-size: 13px; line-height: 1.6; margin: 0;">
                        ${suggestions.length > 0 && suggestions[0].rule.action_plan_text ? 
                            suggestions[0].rule.action_plan_text : 
                            'તમારા નબળા વિષયો પર વધુ ધ્યાન આપો. રોજિંદા પ્રેક્ટિસ કરતા રહો અને સતત પરિણામો તપાસો.'}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Motivational Quote -->
    <div style="background: white; border-left: 4px solid #2563eb; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;">
        <p style="color: #1e293b; font-style: italic; font-size: 16px; font-weight: 600; margin: 0;">
            "આવતા ટેસ્ટમાં ${Math.ceil(result.obtained_marks + 10)} ગુણ લાવવાનું લક્ષ્ય રાખવું!"
        </p>
    </div>

</div>
            `;

            document.getElementById('dashboard').innerHTML = html;

            // Render Charts
            setTimeout(() => {
                renderPieChart(correctCount, wrongCount, result.unanswered_count);
                renderTrendChart(testHistory);
            }, 100);
        }

        function renderPieChart(correct, wrong, skipped) {
            const ctx = document.getElementById('performancePie');
            if (!ctx) return;

            allCharts.push(new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['સાચા', 'ખોટા', 'બાકી'],
                    datasets: [{
                        data: [correct, wrong, skipped],
                        backgroundColor: ['#10B981', '#EF4444', '#E5E7EB'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    cutout: '70%', 
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        } 
                    } 
                }
            }));
        }

        function renderTrendChart(history) {
            const ctx = document.getElementById('trendLine');
            if (!ctx) return;

            const labels = history.map((_, i) => `T${i + 1}`);
            const scores = history.map(h => h.obtained_marks);

            allCharts.push(new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'સ્કોર',
                        data: scores,
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#2563EB'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            }));
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Cleanup charts before page unload
        window.addEventListener('beforeunload', () => {
            allCharts.forEach(chart => chart.destroy());
        });

        init();
    </script>
</body>
</html>
