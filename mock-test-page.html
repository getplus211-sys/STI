<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Dashboard | Kapil Institute</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }
        header {
            background-color: #007bff;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header .user-info {
            font-size: 1.1em;
            font-weight: bold;
        }
        header a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border: 1px solid white;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        header a:hover {
            background-color: #0056b3;
        }
        .container {
            padding: 30px;
            max-width: 1200px;
            margin: 20px auto;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card h3 {
            color: #007bff;
            margin-top: 0;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        /* рккрлЗркорлЗркирлНркЯ ркХрк╛рк░рлНркб ркорк╛ркЯрлЗ ркЦрк╛рк╕ рк╕рлНркЯрк╛ркЗрк▓ */
        #payment-card {
            background-color: #fff3cd; /* рккрлАрк│рлЛ ркмрлЗркХркЧрлНрк░рк╛ркЙркирлНркб */
            border: 1px solid #ffeeba;
            grid-column: 1 / -1; /* ркЖ ркХрк╛рк░рлНркбркирлЗ ркЖркЦрлА рк░рлЛ рккрк░ рклрлЗрк▓рк╛рк╡рлЛ */
            text-align: center;
            padding: 30px;
        }
        #rzp-button {
            background-color: #28a745; /* рк▓рлАрк▓рлБркВ ркмркЯрки */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #rzp-button:hover {
            background-color: #218838;
        }
        /* ркЯрлЗрк╕рлНркЯ ркПркХрлНрк╕рлЗрк╕ ркХрк╛рк░рлНркбрлНрк╕ */
        .test-card-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .test-card-content button:hover {
            background-color: #0056b3;
        }
        .test-card-content .locked {
            color: #dc3545;
            font-weight: bold;
        }
        footer {
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 15px 0;
            margin-top: 40px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
    ркбрлЗркЯрк╛ рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлЛ ркЫрлЗ... ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ.
</div>

<header id="main-header" style="display:none;">
    <div class="user-info">
        рк╕рлНрк╡рк╛ркЧркд ркЫрлЗ, <span id="user-display-name">Guest</span>!
    </div>
    <a href="/index.html">Go to Home</a>
</header>

<div class="container" id="main-content" style="display:none;">
    <h2>Mock Test Series Dashboard</h2>
    <p>ркЕрк╣рлАркВ ркдркорлЗ STI 5 Mock Test Series ркЦрк░рлАркжрлА рк╢ркХрлЛ ркЫрлЛ ркЕркирлЗ ркПркХрлНрк╕рлЗрк╕ ркХрк░рлНркпрк╛ рккркЫрлА ркЯрлЗрк╕рлНркЯ ркЖрккрлА рк╢ркХрлЛ ркЫрлЛ.</p>

    <div class="card-grid">
        <div id="payment-card">
            <h3>STI 5 Mock Test Series - ркЦрк░рлАркжрлА ркХрк░рлЛ</h3>
            <p>рккрк╛ркВркЪрлЗркп ркорлЛркХ ркЯрлЗрк╕рлНркЯркирлЛ рк╕ркВрккрлВрк░рлНркг ркПркХрлНрк╕рлЗрк╕ ркорлЗрк│рк╡рлЛ.</p>
            <p style="font-size:1.5em; font-weight:bold; color:#dc3545;">рклркХрлНркд тВ╣99/-</p>
            <button id="rzp-button">тВ╣99 ркорк╛ркВ рк╣ркоркгрк╛ркВ ркЦрк░рлАркжрлЛ</button>
            <p style="margin-top:10px; font-size:0.9em; color:#856404;">ркЦрк░рлАркжрлА ркХрк░рлНркпрк╛ рккркЫрлА, ркирлАркЪрлЗркирк╛ ркХрк╛рк░рлНркбрлНрк╕ ркдркоркирлЗ ркЖрккркорлЗрк│рлЗ ркПркХрлНрк╕рлЗрк╕ ркЖрккрк╢рлЗ.</p>
        </div>
    </div>
    
    <h3 style="margin-top: 40px;">ркдркорк╛рк░рк╛ ркорлЛркХ ркЯрлЗрк╕рлНркЯрлНрк╕</h3>
    <div class="card-grid" id="test-cards-container">
        </div>
</div>

<footer>
    Contact Us: <a href="tel:+916353511804" style="color: #ffc107; text-decoration: none;">+91 63535 11804</a>
</footer>

<script>
    // ===============================================
    // Supabase ркЕркирлЗ Razorpay рк╕рлЗркЯрк┐ркВркЧрлНрк╕
    // ===============================================
    const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
    
    // ЁЯЫС IMPORTANT: ркЕрк╣рлАркВ ркдркорк╛рк░рлА LIVE Razorpay Key ID ркирк╛ркЦрлЛ ЁЯЫС
    const RAZORPAY_KEY_ID = 'rzp_live_RrlYub6HRqZ8MD'; 

    const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const mockTests = [
        { name: "STI Mock Test - 1", file: "STI-mock-test-1.html" },
        { name: "STI Mock Test - 2", file: "STI-mock-test-2.html" },
        { name: "STI Mock Test - 3", file: "STI-mock-test-3.html" },
        { name: "STI Mock Test - 4", file: "STI-mock-test-4.html" },
        { name: "STI Mock Test - 5", file: "STI-mock-test-5.html" }
    ];

    let currentUserSession = null;
    let hasPaidAccess = false;
    
    // ===============================================
    // рк▓рлЛркЧрк┐рки ркЕркирлЗ ркПркХрлНрк╕рлЗрк╕ ркЪрлЗркХ
    // ===============================================
    async function checkLoginAndAccess() {
        // рк▓рлЛркбрк┐ркВркЧ ркУрк╡рк░рк▓рлЗ ркмркдрк╛рк╡рлЛ
        document.getElementById('loading-overlay').style.display = 'flex';

        const { data: { session }, error: authError } = await sbClient.auth.getSession();
        
        if (authError || !session) {
            // рк▓рлЛркЧрк┐рки ркиркерлА: рк╣рлЛрко рккрлЗркЬ рккрк░ ркорлЛркХрк▓рлЛ
            alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ Mock Test Dashboard ркЬрлЛрк╡рк╛ ркорк╛ркЯрлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЛркЧрк┐рки ркХрк░рлЛ.");
            window.location.href = '/index.html'; 
            return;
        }

        currentUserSession = session;
        const userId = session.user.id;
        const userName = session.user.user_metadata.full_name || session.user.email;

        // рк╣рлЗркбрк░ ркЕрккркбрлЗркЯ ркХрк░рлЛ
        document.getElementById('user-display-name').textContent = userName;
        document.getElementById('main-header').style.display = 'flex';


        // ркПркХрлНрк╕рлЗрк╕ ркЪрлЗркХ ркХрк░рлЛ
        const { data: accessData } = await sbClient
            .from('user_access')
            .select('is_active')
            .eq('user_id', userId)
            .eq('access_type', 'STI_MOCK_TEST') 
            .maybeSingle(); 

        if (accessData && accessData.is_active === true) {
            hasPaidAccess = true;
            // ркЬрлЛ ркПркХрлНрк╕рлЗрк╕ рк╣рлЛркп, ркдрлЛ рккрлЗркорлЗркирлНркЯ ркХрк╛рк░рлНркб ркЫрлБрккрк╛рк╡рлЛ
            document.getElementById('payment-card').style.display = 'none';
        }

        // ркХркирлНркЯрлЗркирлНркЯ ркмркдрк╛рк╡рлЛ ркЕркирлЗ рк▓рлЛркбрк┐ркВркЧ ркЫрлБрккрк╛рк╡рлЛ
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('loading-overlay').style.display = 'none';

        // ркХрк╛рк░рлНркбрлНрк╕ ркЬркирк░рлЗркЯ ркХрк░рлЛ
        renderTestCards();
    }
    
    // ===============================================
    // ркХрк╛рк░рлНркбрлНрк╕ рк░рлЗркирлНркбрк░ ркХрк░рк╡рк╛ (ркПркХрлНрк╕рлЗрк╕ркирк╛ ркЖркзрк╛рк░рлЗ)
    // ===============================================
    function renderTestCards() {
        const container = document.getElementById('test-cards-container');
        container.innerHTML = ''; // ркЬрлВркирк╛ ркХрк╛рк░рлНркбрлНрк╕ рк╕рк╛ркл ркХрк░рлЛ

        mockTests.forEach(test => {
            const card = document.createElement('div');
            card.className = 'card test-card-content';
            
            let cardContent = `
                <h3>${test.name}</h3>
                <p>ркЖ ркорлЛркХ ркЯрлЗрк╕рлНркЯркорк╛ркВ 100 рккрлНрк░рк╢рлНркирлЛ ркЫрлЗ ркЕркирлЗ ркдрлЗ 2 ркХрк▓рк╛ркХркирлЛ рк╕ркоркп рк▓рлЗрк╢рлЗ.</p>
            `;
            
            if (hasPaidAccess) {
                // ркПркХрлНрк╕рлЗрк╕ рк╣рлЛркп ркдрлЛ ркмркЯрки ркмркдрк╛рк╡рлЛ
                cardContent += `<button onclick="window.location.href='/${test.file}'">ркЯрлЗрк╕рлНркЯ ркЖрккрлЛ</button>`;
            } else {
                // ркПркХрлНрк╕рлЗрк╕ рки рк╣рлЛркп ркдрлЛ рк▓рлЛркХ ркХрк░рлЗрк▓рлЛ ркорлЗрк╕рлЗркЬ ркмркдрк╛рк╡рлЛ
                cardContent += `<p class="locked">ЁЯФР ркЦрк░рлАркжрлАркирлА ркЬрк░рлВрк░ ркЫрлЗ (тВ╣99)</p>`;
            }

            card.innerHTML = cardContent;
            container.appendChild(card);
        });
    }

    // ===============================================
    // Razorpay рккрлЗркорлЗркирлНркЯ рк▓рлЛркЬрк┐ркХ
    // ===============================================
    async function startPayment() {
        if (!currentUserSession) {
            alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрлЗркорлЗркирлНркЯ рк╢рк░рлВ ркХрк░ркдрк╛ рккрк╣рлЗрк▓рк╛ рклрк░рлАркерлА рк▓рлЛркЧрк┐рки ркХрк░рлЛ.");
            window.location.reload();
            return;
        }

        const userId = currentUserSession.user.id;
        const amount_in_paise = 9900; // тВ╣99 = 9900 paise

        var options = {
            "key": RAZORPAY_KEY_ID, 
            "amount": amount_in_paise, 
            "currency": "INR",
            "name": "Kapil Institute",
            "description": "STI 5 Mock Test Series Access",
            "handler": function (response){
                alert("рккрлЗркорлЗркирлНркЯ рк╕рклрк│! рк╣рк╡рлЗ ркдркоркирлЗ ркорлЛркХ ркЯрлЗрк╕рлНркЯркирлЛ ркПркХрлНрк╕рлЗрк╕ ркорк│рлА ркЧркпрлЛ ркЫрлЗ.");
                // рккрлЗркорлЗркирлНркЯ рк╕рклрк│ ркеркпрк╛ рккркЫрлА ркбрлЗрк╢ркмрлЛрк░рлНркб ркЕрккркбрлЗркЯ ркХрк░рлЛ
                checkLoginAndAccess();
            },
            "prefill": {
                "name": currentUserSession.user.user_metadata.full_name || "",
                "email": currentUserSession.user.email,
                "contact": currentUserSession.user.user_metadata.mobile || ""
            },
            "notes": {
                // ркЖ 'user_id' рк╡рлЗркмрк╣рлВркХ ркжрлНрк╡рк╛рк░рк╛ Edge Function ркирлЗ ркорк│рк╢рлЗ.
                "receipt": userId 
            },
            "theme": {
                "color": "#007bff"
            }
        };

        var rzp1 = new Razorpay(options);
        rzp1.open();
    }

    // ркЗрк╡рлЗркирлНркЯ рк▓рк┐рк╕ркирк░рлНрк╕
    document.addEventListener('DOMContentLoaded', () => {
        checkLoginAndAccess();
        const rzpButton = document.getElementById('rzp-button');
        if (rzpButton) {
            rzpButton.onclick = startPayment;
        }
    });

</script>

</body>
</html>
