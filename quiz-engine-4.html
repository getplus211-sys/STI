<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Quiz Engine V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hind Vadodara', sans-serif; background: #f1f5f9; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(30,64,175,0.3); }
        .timer { font-size: 24px; font-weight: bold; }
        .question-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .option { background: #f8fafc; border: 2px solid #e2e8f0; padding: 16px; margin: 10px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .option:hover { background: #e0f2fe; border-color: #3b82f6; }
        .option.selected { background: #dbeafe; border-color: #2563eb; font-weight: 600; }
        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1e40af; transform: translateY(-2px); }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .difficulty-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .difficulty-easy { background: #dcfce7; color: #166534; }
        .difficulty-medium { background: #fef3c7; color: #92400e; }
        .difficulty-hard { background: #fee2e2; color: #991b1b; }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; margin: 20px 0; }
        .nav-btn { padding: 10px; text-align: center; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .nav-btn.answered { background: #dbeafe; border-color: #2563eb; color: #1e40af; }
        .nav-btn.current { background: #2563eb; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 16px; max-width: 500px; text-align: center; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .question-card { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    <h1 style="font-size: 24px; margin-bottom: 5px;" id="testTitle">àª²à«‹àª¡ àª•àª°à«€ àª°àª¹à«àª¯àª¾ àª›à«€àª...</h1>
                    <p style="opacity: 0.9; font-size: 14px;" id="testInfo">àª•à«àª² àªªà«àª°àª¶à«àª¨à«‹: -</p>
                </div>
                <div class="timer" id="timer">00:00</div>
            </div>
        </div>

        <div id="mainContent"></div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;" id="modalTitle"></h2>
            <p style="margin-bottom: 20px; color: #64748b;" id="modalText"></p>
            <button class="btn btn-primary" onclick="closeModal()">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const QUIZ_ID = new URLSearchParams(window.location.search).get('id') || 'DEMO_QUIZ_001';
        
        let user = null;
        let quiz = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questionTimes = [];
        let startTime = Date.now();
        let timerInterval = null;
        let questionStartTime = Date.now();

        async function init() {
            const { data: { user: authUser } } = await sb.auth.getUser();
            if (!authUser) {
                alert('àª²à«‹àª—àª¿àª¨ àªœàª°à«‚àª°à«€ àª›à«‡!');
                window.location.href = 'index.html';
                return;
            }
            user = authUser;

            // Load quiz and questions
            const { data: quizData } = await sb.from('lrd_quizzes').select('*').eq('quiz_id', QUIZ_ID).single();
            if (!quizData) {
                showModal('âŒ', 'Error', 'Quiz àª¨àª¥à«€ àª®àª³à«€!');
                return;
            }
            quiz = quizData;

            const { data: questionsData } = await sb.from('lrd_quiz_questions').select('*').eq('quiz_id', QUIZ_ID).order('question_number');
            if (!questionsData || questionsData.length === 0) {
                showModal('âŒ', 'Error', 'àªªà«àª°àª¶à«àª¨à«‹ àª¨àª¥à«€ àª®àª³à«àª¯àª¾!');
                return;
            }
            questions = questionsData;
            userAnswers = new Array(questions.length).fill(null);
            questionTimes = new Array(questions.length).fill(0);

            // Check if already attempted
            const { data: existingAttempt } = await sb
                .from('lrd_test_attempts')
                .select('id')
                .eq('user_id', user.id)
                .eq('quiz_id', QUIZ_ID)
                .maybeSingle();

            if (existingAttempt) {
                if (confirm('àª¤àª®à«‡ àª† àªŸà«‡àª¸à«àªŸ àªªàª¹à«‡àª²à«‡àª¥à«€ àª†àªªà«€ àª›à«‡. àª«àª°à«€àª¥à«€ àª†àªªàªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?')) {
                    await sb.from('lrd_test_attempts').delete().eq('id', existingAttempt.id);
                } else {
                    window.location.href = `performance-dashboard-v2.html?attempt_id=${existingAttempt.id}`;
                    return;
                }
            }

            document.getElementById('testTitle').textContent = quiz.title;
            document.getElementById('testInfo').textContent = `àª•à«àª² ${questions.length} àªªà«àª°àª¶à«àª¨à«‹ | ${quiz.total_marks} àª—à«àª£ | ${quiz.duration_minutes} àª®àª¿àª¨àª¿àªŸ`;

            startTest();
        }

        function startTest() {
            startTime = Date.now();
            questionStartTime = Date.now();
            startTimer();
            renderQuestion();
        }

        function startTimer() {
            const duration = quiz.duration_minutes * 60;
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, duration - elapsed);
                
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                document.getElementById('timer').textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

                if (remaining === 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function renderQuestion() {
            const q = questions[currentQuestionIndex];
            const difficultyClass = q.difficulty_level?.toLowerCase() === 'easy' ? 'difficulty-easy' : 
                                   q.difficulty_level?.toLowerCase() === 'medium' ? 'difficulty-medium' : 'difficulty-hard';

            document.getElementById('mainContent').innerHTML = `
                <div class="question-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <span style="font-weight: 600; color: #64748b;">àªªà«àª°àª¶à«àª¨ ${currentQuestionIndex + 1}/${questions.length}</span>
                            <span class="difficulty-badge ${difficultyClass}" style="margin-left: 10px;">${q.difficulty_level || 'Medium'}</span>
                        </div>
                        <div style="font-size: 14px; color: #64748b;">
                            <strong>${q.subject_name}</strong> â€¢ ${q.chapter_name}
                        </div>
                    </div>

                    <p style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 20px; line-height: 1.6;">${q.question_text}</p>

                    <div>
                        ${['a', 'b', 'c', 'd', 'e'].filter(opt => q['option_' + opt]).map((opt, idx) => `
                            <div class="option ${userAnswers[currentQuestionIndex] == (idx + 1) ? 'selected' : ''}" 
                                 onclick="selectOption(${idx + 1})">
                                <strong>${opt.toUpperCase()}.</strong> ${q['option_' + opt]}
                            </div>
                        `).join('')}
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="prevQuestion()" 
                                ${currentQuestionIndex === 0 ? 'disabled style="opacity:0.5;"' : ''}>
                            â† àªªàª¹à«‡àª²àª¾àª¨à«‹
                        </button>
                        <button class="btn btn-danger" onclick="clearAnswer()">àª¸àª¾àª« àª•àª°à«‹</button>
                        ${currentQuestionIndex === questions.length - 1 ?
                            '<button class="btn btn-success" onclick="confirmSubmit()">Submit àª•àª°à«‹ âœ“</button>' :
                            '<button class="btn btn-primary" onclick="nextQuestion()">àª†àª—àª³àª¨à«‹ â†’</button>'
                        }
                    </div>
                </div>

                <div class="question-card">
                    <h3 style="margin-bottom: 15px; color: #475569;">àª¨à«‡àªµàª¿àª—à«‡àª¶àª¨</h3>
                    <div class="nav-grid">
                        ${questions.map((_, idx) => `
                            <div class="nav-btn ${idx === currentQuestionIndex ? 'current' : ''} 
                                               ${userAnswers[idx] !== null ? 'answered' : ''}"
                                 onclick="goToQuestion(${idx})">
                                ${idx + 1}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px; font-size: 14px; color: #64748b;">
                        àªœàªµàª¾àª¬ àª†àªªà«àª¯àª¾: <strong>${userAnswers.filter(a => a !== null).length}</strong> | 
                        àª¬àª¾àª•à«€: <strong>${userAnswers.filter(a => a === null).length}</strong>
                    </div>
                </div>
            `;
        }

        function selectOption(optionNum) {
            // Save time spent on previous answer
            if (userAnswers[currentQuestionIndex] !== null) {
                const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
                questionTimes[currentQuestionIndex] += timeSpent;
            }
            
            userAnswers[currentQuestionIndex] = optionNum;
            questionStartTime = Date.now();
            renderQuestion();
        }

        function clearAnswer() {
            userAnswers[currentQuestionIndex] = null;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                saveQuestionTime();
                currentQuestionIndex--;
                questionStartTime = Date.now();
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                saveQuestionTime();
                currentQuestionIndex++;
                questionStartTime = Date.now();
                renderQuestion();
            }
        }

        function goToQuestion(idx) {
            saveQuestionTime();
            currentQuestionIndex = idx;
            questionStartTime = Date.now();
            renderQuestion();
        }

        function saveQuestionTime() {
            const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
            questionTimes[currentQuestionIndex] += timeSpent;
        }

        function confirmSubmit() {
            const answered = userAnswers.filter(a => a !== null).length;
            const skipped = questions.length - answered;
            
            if (skipped > 0) {
                if (confirm(`${skipped} àªªà«àª°àª¶à«àª¨à«‹ àª¬àª¾àª•à«€ àª›à«‡! Submit àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?`)) {
                    submitTest();
                }
            } else {
                submitTest();
            }
        }

        async function submitTest() {
            clearInterval(timerInterval);
            saveQuestionTime();

            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            
            // Calculate stats
            let correct = 0, wrong = 0, skipped = 0;
            let easy_attempted = 0, easy_correct = 0;
            let medium_attempted = 0, medium_correct = 0;
            let hard_attempted = 0, hard_correct = 0;
            let obtainedMarks = 0;

            questions.forEach((q, i) => {
                const userAns = userAnswers[i];
                const correctAns = parseInt(q.correct_option) || q.correct_option.toLowerCase().charCodeAt(0) - 96;
                const difficulty = q.difficulty_level?.toLowerCase() || 'medium';

                if (!userAns) {
                    skipped++;
                } else {
                    const isCorrect = parseInt(userAns) === correctAns;
                    
                    if (isCorrect) {
                        correct++;
                        obtainedMarks += parseFloat(q.marks);
                    } else {
                        wrong++;
                        obtainedMarks -= parseFloat(q.negative_marks);
                    }

                    if (difficulty === 'easy') {
                        easy_attempted++;
                        if (isCorrect) easy_correct++;
                    } else if (difficulty === 'hard') {
                        hard_attempted++;
                        if (isCorrect) hard_correct++;
                    } else {
                        medium_attempted++;
                        if (isCorrect) medium_correct++;
                    }
                }
            });

            obtainedMarks = Math.max(0, obtainedMarks);
            const accuracy = questions.length > 0 ? (correct / questions.length) * 100 : 0;
            const avgTime = totalTime / questions.length;
            const speedCategory = avgTime < 30 ? 'fast' : avgTime > 60 ? 'slow' : 'average';
            const concentration = Math.min(10, Math.max(1, Math.round(accuracy / 10)));

            // Insert attempt
            const { data: attemptData, error: attemptError } = await sb.from('lrd_test_attempts').insert({
                user_id: user.id,
                quiz_id: QUIZ_ID,
                total_questions: questions.length,
                attempted_questions: correct + wrong,
                correct_answers: correct,
                wrong_answers: wrong,
                skipped_questions: skipped,
                obtained_marks: obtainedMarks,
                total_marks: quiz.total_marks,
                accuracy_percentage: accuracy,
                total_time_seconds: totalTime,
                avg_time_per_question: avgTime,
                easy_attempted, easy_correct,
                medium_attempted, medium_correct,
                hard_attempted, hard_correct,
                speed_category,
                concentration_rating: concentration,
                completed_at: new Date().toISOString()
            }).select().single();

            if (attemptError) {
                showModal('âŒ', 'Error', 'Results save àª•àª°àª¤à«€ àªµàª–àª¤à«‡ error àª†àªµà«€!');
                return;
            }

            // Insert responses
            const responses = questions.map((q, i) => {
                const correctAns = parseInt(q.correct_option) || q.correct_option.toLowerCase().charCodeAt(0) - 96;
                const userAns = userAnswers[i];
                const isCorrect = userAns ? parseInt(userAns) === correctAns : false;
                const marksObtained = !userAns ? 0 : isCorrect ? parseFloat(q.marks) : -parseFloat(q.negative_marks);

                return {
                    attempt_id: attemptData.id,
                    question_id: q.id,
                    subject_name: q.subject_name,
                    chapter_name: q.chapter_name,
                    difficulty_level: q.difficulty_level,
                    user_answer: userAns ? String.fromCharCode(96 + parseInt(userAns)) : null,
                    correct_answer: q.correct_option,
                    is_correct: isCorrect,
                    time_spent_seconds: questionTimes[i] || 0,
                    marks_obtained: marksObtained
                };
            });

            await sb.from('lrd_test_responses').insert(responses);

            // Update profile
            await sb.from('profiles').update({
                total_tests_taken: sb.raw('total_tests_taken + 1')
            }).eq('id', user.id);

            // Show results
            showResults(attemptData);
        }

        function showResults(attempt) {
            document.getElementById('mainContent').innerHTML = `
                <div class="question-card" style="text-align: center;">
                    <h2 style="color: #1e40af; margin-bottom: 20px;">âœ… àªŸà«‡àª¸à«àªŸ àªªà«‚àª°à«àª£ àª¥àªˆ!</h2>
                    
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); padding: 30px; border-radius: 16px; margin: 20px 0;">
                        <div style="font-size: 48px; font-weight: 900; color: #1e40af; margin-bottom: 10px;">
                            ${attempt.obtained_marks.toFixed(2)}/${attempt.total_marks}
                        </div>
                        <div style="font-size: 20px; color: #64748b;">
                            Accuracy: ${attempt.accuracy_percentage.toFixed(1)}%
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; text-align: left;">
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 12px;">
                            <div style="color: #166534; font-size: 14px;">àª¸àª¾àªšàª¾</div>
                            <div style="font-size: 24px; font-weight: bold; color: #22c55e;">${attempt.correct_answers}</div>
                        </div>
                        <div style="background: #fef2f2; padding: 15px; border-radius: 12px;">
                            <div style="color: #991b1b; font-size: 14px;">àª–à«‹àªŸàª¾</div>
                            <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${attempt.wrong_answers}</div>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 12px;">
                            <div style="color: #475569; font-size: 14px;">àª¸àª®àª¯</div>
                            <div style="font-size: 24px; font-weight: bold; color: #64748b;">${Math.floor(attempt.total_time_seconds / 60)}m</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 12px;">
                            <div style="color: #92400e; font-size: 14px;">àª¬àª¾àª•à«€</div>
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${attempt.skipped_questions}</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="viewPerformance('${attempt.id}')">
                            ğŸ“Š Performance àªœà«àª“
                        </button>
                        <button class="btn btn-success" onclick="viewSolutions()">
                            ğŸ“– Solutions àªœà«àª“
                        </button>
                    </div>
                </div>
            `;
        }

        function viewPerformance(attemptId) {
            window.location.href = `performance-dashboard-v2.html?attempt_id=${attemptId}`;
        }

        function viewSolutions() {
            let html = '<div class="question-card"><h2 style="margin-bottom: 20px;">Solutions</h2>';
            
            questions.forEach((q, i) => {
                const correctAns = parseInt(q.correct_option) || q.correct_option.toLowerCase().charCodeAt(0) - 96;
                const userAns = userAnswers[i];
                const isCorrect = userAns && parseInt(userAns) === correctAns;
                const answerColor = !userAns ? '#f59e0b' : isCorrect ? '#22c55e' : '#ef4444';

                html += `
                    <div style="background: #f8fafc; padding: 20px; margin: 15px 0; border-radius: 12px; border-left: 4px solid ${answerColor};">
                        <div style="font-weight: 600; margin-bottom: 10px;">Q${i + 1}. ${q.question_text}</div>
                        ${!userAns ? 
                            '<div style="color: #f59e0b;">âš ï¸ àª†àªªà«‡àª² àª¨àª¥à«€</div>' :
                            `<div style="color: ${answerColor};">àª¤àª®àª¾àª°à«‹ àªœàªµàª¾àª¬: ${q['option_' + String.fromCharCode(96 + parseInt(userAns))]}</div>`
                        }
                        <div style="color: #22c55e; margin-top: 5px;">âœ“ àª¸àª¾àªšà«‹ àªœàªµàª¾àª¬: ${q['option_' + String.fromCharCode(96 + correctAns)]}</div>
                        ${q.solution ? `<div style="margin-top: 10px; padding: 10px; background: #eff6ff; border-radius: 8px; color: #1e40af;">${q.solution}</div>` : ''}
                    </div>
                `;
            });

            html += '<button class="btn btn-primary" onclick="renderQuestion()">àªªàª¾àª›àª¾ àªœàª¾àª“</button></div>';
            document.getElementById('mainContent').innerHTML = html;
        }

        function showModal(icon, title, text) {
            document.getElementById('modalTitle').textContent = icon + ' ' + title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
