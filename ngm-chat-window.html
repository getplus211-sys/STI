<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ngm-chat-window</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .ngm-header { height: 90px; }
        .ngm-footer { height: 50px; } /* Chat input માટે થોડો મોટો footer */
        .chat-bg { background-color: #E5DDD5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
    </style>
</head>
<body class="chat-bg flex flex-col h-screen max-w-md mx-auto border-x shadow-2xl overflow-hidden">
    
    <header class="ngm-header bg-[#517da2] text-white flex items-end pb-3 px-3 shrink-0 shadow-md">
        <div class="flex items-center gap-3 w-full">
            <button onclick="history.back()" class="text-2xl">←</button>
            <div class="w-10 h-10 bg-orange-400 rounded-full flex items-center justify-center font-bold">R</div>
            <div class="flex-1 min-w-0">
                <h2 class="font-bold leading-tight truncate">Radhe Radhe</h2>
                <span class="text-[11px] text-blue-100">online</span>
            </div>
            <div class="text-xl">⋮</div>
        </div>
    </header>

    <main id="message-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 no-scrollbar">
        </main>

    <div class="p-2 bg-white flex items-center gap-2 border-t">
        <input id="msgInput" type="text" placeholder="Message" class="flex-1 outline-none px-4 py-2 bg-gray-100 rounded-full text-sm">
        <button onclick="sendMsg()" class="bg-[#517da2] text-white p-2 px-4 rounded-full font-bold">Send</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const chatId = new URLSearchParams(window.location.search).get('chat_id');

        async function loadMessages() {
            const { data } = await _supabase.from('ngm_messages').select('*').eq('chat_id', chatId).order('created_at', { ascending: true });
            if (data) {
                const box = document.getElementById('message-box');
                box.innerHTML = data.map(m => `
                    <div class="max-w-[85%] p-2.5 rounded-xl shadow-sm text-sm ${m.sender_id === 'me' ? 'bg-[#effdde] self-end' : 'bg-white self-start'}">
                        ${m.content}
                        <div class="text-[10px] text-gray-400 text-right mt-1">${new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            }
        }

        async function sendMsg() {
            const input = document.getElementById('msgInput');
            if(!input.value) return;
            const { error } = await _supabase.from('ngm_messages').insert([{ chat_id: chatId, content: input.value, sender_id: 'me', message_type: 'text' }]);
            if(!error) { input.value = ""; loadMessages(); }
        }

        loadMessages();
        // Real-time Updates
        _supabase.channel('messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ngm_messages' }, payload => {
            if(payload.new.chat_id === chatId) loadMessages();
        }).subscribe();
    </script>
</body>
</html>
