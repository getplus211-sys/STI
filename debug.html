<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mock Test System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:linear-gradient(135deg,#eef2ff,#f8fafc)}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:rgba(255,255,255,.85);backdrop-filter:blur(12px);
border-radius:18px;padding:16px;margin-bottom:14px;
box-shadow:0 10px 30px rgba(0,0,0,.08)}
button{border:none;border-radius:14px;padding:14px;font-size:16px}
.primary{background:#2563eb;color:#fff}
.danger{background:#dc2626;color:#fff}
.gray{background:#e5e7eb}
.option{border:1px solid #ddd;padding:12px;border-radius:12px;margin:8px 0}
.option.active{background:#2563eb;color:#fff}
.flex{display:flex;justify-content:space-between;align-items:center}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9}
.hidden{display:none}

/* Leaderboard */
.rank-card{display:flex;align-items:center;gap:12px;padding:12px}
.rank{font-size:18px;font-weight:700;width:40px;text-align:center}
.me{border:2px solid #2563eb}
.gold{background:#fde68a}
.silver{background:#e5e7eb}
.bronze{background:#fed7aa}
.sticky{position:sticky;top:10px;z-index:5}
</style>
</head>

<body>
<div class="container" id="app">Loading...</div>

<div class="popup hidden" id="purchasePopup">
  <div class="card">
    <h3>Access Required</h3>
    <p>Please purchase a plan to access this test.</p>
    <button class="primary" onclick="location.href='/purchase.html'">Purchase Now</button>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
 "https://bhmycvrbucmbbrpzeane.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4"
);

const TEST_ID="mock_test_1";
const TOTAL_TIME=120*60;

let user,questions=[],answers={},current=0,timeLeft=TOTAL_TIME,attemptId,timer;

(async()=>{
 const {data:{user:u}}=await supabase.auth.getUser();
 if(!u){app.innerHTML="Login required";return;}
 user=u;

 const {data:access}=await supabase.from("user_access")
 .select("*").eq("user_id",user.id).eq("is_active",true).single();

 if(!access){
  purchasePopup.classList.remove("hidden");
  app.innerHTML="";
  return;
 }

 const {data:attempt}=await supabase.from("test_attempts")
 .select("*").eq("user_id",user.id).eq("test_id",TEST_ID).single();

 if(attempt && attempt.is_submitted){loadResult();return;}

 if(!attempt){
  const {data:a}=await supabase.from("test_attempts").insert({
   user_id:user.id,test_id:TEST_ID,is_submitted:false
  }).select().single();
  attemptId=a.id;
 } else attemptId=attempt.id;

 loadIntro();
})();

function loadIntro(){
 app.innerHTML=`
 <div class="card">
  <h2>Mock Test 1</h2>
  <p>200 Questions â€¢ 120 Minutes</p>
  <label><input type="checkbox" id="agree"> I accept instructions</label><br><br>
  <button class="primary" onclick="startTest()">Start Test</button>
 </div>`;
}

async function startTest(){
 if(!agree.checked)return alert("Accept rules");
 const {data}=await supabase.from("questions")
 .select("*").eq("test_id",TEST_ID).order("id");
 questions=data;
 renderQuestion();
 startTimer();
}

function renderQuestion(){
 const q=questions[current];
 app.innerHTML=`
 <div class="flex">
  <b>Q ${current+1}/${questions.length}</b>
  <b id="timer"></b>
 </div>
 <div class="card">
  <p>${q.question_text}</p>
  ${["a","b","c","d","e"].map((o,i)=>`
   <div class="option ${answers[q.id]==i+1?"active":""}" 
   onclick="answers[${q.id}]=${i+1};renderQuestion()">
   ${q["option_"+o]}
   </div>`).join("")}
 </div>
 <button class="gray" onclick="current=Math.max(0,current-1);renderQuestion()">Prev</button>
 <button class="gray" onclick="current=Math.min(questions.length-1,current+1);renderQuestion()">Next</button>
 <button class="danger" onclick="submitTest()">Submit</button>
 `;
}

function startTimer(){
 timer=setInterval(()=>{
  timeLeft--;
  timerEl=document.getElementById("timer");
  if(timerEl) timerEl.innerText=
   Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,"0");
  if(timeLeft<=0){clearInterval(timer);submitTest(true);}
 },1000);
}

async function submitTest(auto=false){
 if(!auto && !confirm("Submit test?"))return;

 let correct=0,wrong=0,skip=0,e=0,score=0;
 questions.forEach(q=>{
  const a=answers[q.id];
  if(!a){skip++;score-=0.33}
  else if(a==5){e++}
  else if(a==q.correct_option){correct++;score++}
  else{wrong++;score-=0.33}
 });

 await supabase.from("test_results").insert({
  user_id:user.id,test_id:TEST_ID,total_score:score,
  correct_count:correct,wrong_count:wrong,
  skipped_count:skip,e_count:e,
  time_taken_seconds:TOTAL_TIME-timeLeft,
  answers
 });

 await supabase.from("test_attempts").update({
  is_submitted:true,submitted_at:new Date()
 }).eq("id",attemptId);

 loadResult();
}

async function loadResult(){
 const {data:r}=await supabase.from("test_results")
 .select("*").eq("user_id",user.id).eq("test_id",TEST_ID).single();

 app.innerHTML=`
 <div class="card">
  <h2>Your Score: ${r.total_score}</h2>
  <canvas id="chart"></canvas>
  <button class="primary" onclick="loadLeaderboard()">View Leaderboard</button>
 </div>`;
 new Chart(chart,{
  type:"pie",
  data:{labels:["Correct","Wrong","Skip","E"],
  datasets:[{data:[r.correct_count,r.wrong_count,r.skipped_count,r.e_count]}]}
 });
}

async function loadLeaderboard(){
 const {data}=await supabase.from("test_results")
 .select("user_id,total_score,time_taken_seconds,profiles(full_name)")
 .eq("test_id",TEST_ID)
 .order("total_score",{ascending:false})
 .order("time_taken_seconds",{ascending:true});

 let myCard="";
 let list=data.map((u,i)=>{
  let cls=i==0?"gold":i==1?"silver":i==2?"bronze":"";
  let me=u.user_id===user.id?"me":"";
  if(me){
   myCard=`
   <div class="card sticky me">
    <b>Your Rank: ${i+1}</b><br>
    Score: ${u.total_score}<br>
    Time: ${u.time_taken_seconds}s
   </div>`;
  }
  return `
  <div class="card rank-card ${cls} ${me}">
   <div class="rank">${i+1}</div>
   <div>
    <b>${u.profiles?.full_name || "User"}</b><br>
    Score: ${u.total_score} | Time: ${u.time_taken_seconds}s
   </div>
  </div>`;
 }).join("");

 app.innerHTML=myCard+list;
}
</script>
</body>
</html>
