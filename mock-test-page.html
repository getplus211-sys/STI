<script>
    // 1. SUPABASE CLIENT
    const sb = supabase.createClient(
      "https://bhmycvrbucmbbrpzeane.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4"
    );

    let currentUser = null;
    const nameBox = document.getElementById("user-name-display");
    const accessBox = document.getElementById("access-status");
    const buyBtn = document.getElementById("buy-btn");

    // INIT - પેજ લોડ થાય ત્યારે યુઝર ચેક કરો
    (async () => {
      const { data } = await sb.auth.getSession();
      if (!data.session) {
        nameBox.textContent = "લોગિન નથી";
        buyBtn.disabled = true;
        return;
      }
      currentUser = data.session.user;
      await loadUserName(); // નામ ફેચ કરશે
      await checkAccess();  // એક્સેસ ચેક કરશે
    })();

    // પ્રોબ્લેમ 3: નામ ફેચ કરવું
    async function loadUserName() {
      const { data, error } = await sb
        .from("profiles")
        .select("full_name")
        .eq("id", currentUser.id)
        .single();
      if (data) nameBox.textContent = data.full_name;
    }

    async function checkAccess() {
      const { data } = await sb
        .from("user_access")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("is_active", true)
        .limit(1);

      if (data && data.length > 0) {
        unlockTests();
        buyBtn.textContent = "Already Purchased";
        buyBtn.disabled = true;
        accessBox.innerHTML = `<span style="color:#1b5e20;">Access Active — All tests unlocked</span>`;
      } else {
        lockTests();
      }
    }

    // પ્રોબ્લેમ 1 અને 2: પેમેન્ટ અને ડેટા ઇન્સર્ટ
    async function startPurchase() {
      buyBtn.disabled = true;
      buyBtn.textContent = "ઓર્ડર બની રહ્યો છે...";

      try {
        // A. ઓર્ડર ક્રિએટ કરો
        const res = await fetch("https://bhmycvrbucmbbrpzeane.supabase.co/functions/v1/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: currentUser.id,
            amount: 4900, // ₹49
            plan_name: "PSI-ASI-Series"
          })
        });

        const order = await res.json();

        // B. Razorpay ઓપન કરો
        const options = {
          key: "rzp_test_RscLDjVDOh4bTb",
          amount: order.amount,
          currency: order.currency,
          name: "STI Mock Test",
          order_id: order.order_id,
          handler: async function (response) {
            // પેમેન્ટ પછી વેરિફિકેશન અને ડેટા ઇન્સર્ટ
            const verify = await fetch("https://bhmycvrbucmbbrpzeane.supabase.co/functions/v1/verify_payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: currentUser.id, // આ સૌથી જરૂરી છે
                plan_name: "PSI-ASI-Series",
                razorpay_payment_id: response.razorpay_payment_id
              })
            });

            const v = await verify.json();
            if (v.success) {
              alert("પેમેન્ટ સફળ! હવે તમે ટેસ્ટ આપી શકશો.");
              window.location.reload(); // આનાથી પ્રોબ્લેમ 2 સોલ્વ થશે (રિડાયરેક્ટ/રિફ્રેશ)
            }
          },
          modal: {
            ondismiss: function() { buyBtn.disabled = false; buyBtn.textContent = "Buy Full Series (₹49)"; }
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        alert("કાંઈક ભૂલ થઈ છે. ફરી ટ્રાય કરો.");
        buyBtn.disabled = false;
      }
    }

    function lockTests() {
      document.querySelectorAll("[data-test-btn]").forEach(btn => btn.disabled = true);
    }

    function unlockTests() {
      document.querySelectorAll("[data-test-btn]").forEach(btn => btn.disabled = false);
      document.querySelectorAll("[data-lock-badge]").forEach(b => {
        b.textContent = "Unlocked";
        b.className = "badge-unlock";
      });
    }

    function openTest(url) { window.location.href = url; }
</script>
