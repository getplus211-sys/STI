<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2;--bg:#e5ddd5;--sent:#dcf8c6;--rcv:#fff}*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{font-family:-apple-system,sans-serif;background:var(--bg)}.c{max-width:480px;margin:0 auto;min-height:100vh;position:relative;background:var(--bg)}.h{position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;height:90px;background:linear-gradient(135deg,var(--pc),var(--sc));z-index:100;box-shadow:0 2px 5px rgba(0,0,0,.1);display:flex;flex-direction:column;justify-content:flex-end;padding:0 10px 10px}.ht{display:flex;align-items:center;gap:10px}.bb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.bb svg{width:24px;height:24px;fill:#fff}.chi{flex:1;display:flex;align-items:center;gap:10px}.ca{width:45px;height:45px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;overflow:hidden;position:relative;flex-shrink:0;cursor:pointer}.ca img{width:100%;height:100%;object-fit:cover}.ca .on{position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:#4caf50;border:2px solid #fff;border-radius:50%}.ci{flex:1;cursor:pointer}.cn{color:#fff;font-size:17px;font-weight:600;margin-bottom:2px}.cs{color:rgba(255,255,255,.85);font-size:13px}.cmc{color:rgba(255,255,255,.7);font-size:12px;margin-top:2px}.ha{display:flex;gap:8px}.ib{width:36px;height:36px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none}.ib svg{width:18px;height:18px;fill:#fff}.mc{padding:100px 10px 150px;min-height:100vh}.m{margin-bottom:8px;display:flex;position:relative}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}.m.rpl{margin-top:4px}.mb{max-width:75%;position:relative}.rp{background:rgba(0,0,0,.05);border-left:3px solid var(--pc);padding:6px 10px;border-radius:6px 6px 0 0;margin-bottom:2px;font-size:12px}.rpn{color:var(--pc);font-weight:600;margin-bottom:2px}.rpt{color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.bl{padding:10px 12px;border-radius:8px;position:relative;cursor:pointer}.m.sent .bl{background:var(--sent);border-bottom-right-radius:2px}.m.received .bl{background:var(--rcv);border-bottom-left-radius:2px}.mt{font-size:15px;color:#000;word-wrap:break-word;-webkit-user-select:text;user-select:text;white-space:pre-wrap}.me{font-style:italic;color:#666;margin-top:3px;font-size:12px}.mf{display:flex;align-items:center;gap:6px;margin-top:6px;justify-content:flex-end}.mti{font-size:11px;color:#666}.tk{display:inline-flex;align-items:center}.tk svg{width:16px;height:16px;margin-left:3px}.ctx{position:fixed;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:300;min-width:200px;display:none}.ctx.show{display:block}.cti{padding:12px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;border-bottom:1px solid #f0f0f0}.cti:last-child{border:none}.cti:active{background:#f5f5f5}.cti svg{width:20px;height:20px;fill:#666}.cti.del{color:#f44336}.cti.del svg{fill:#f44336}.tb{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;z-index:99}.rpl{background:#f0f0f0;padding:8px 15px;display:none;align-items:center;gap:10px}.rpl.show{display:flex}.rpl .rt{flex:1;font-size:13px;overflow:hidden}.rpl .rn{color:var(--pc);font-weight:600;margin-bottom:2px}.rpl .rc{color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rpl .cls{width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer}.rpl .cls svg{width:18px;height:18px;fill:#666}.ti{display:flex;padding:8px;gap:8px}.tic{display:flex;gap:8px}.tib{width:40px;height:40px;background:none;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:50%}.tib:active{background:#f0f0f0}.tib svg{width:22px;height:22px;fill:#666}.mi{flex:1;padding:10px 15px;border:1px solid #e0e0e0;border-radius:22px;font-size:15px;-webkit-user-select:text;user-select:text;max-height:120px;overflow-y:auto;resize:none}.se{width:44px;height:44px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}.se svg{width:22px;height:22px;fill:#fff}.em{text-align:center;padding:60px 20px;color:#999}.ep{position:fixed;bottom:70px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-radius:12px 12px 0 0;box-shadow:0 -2px 10px rgba(0,0,0,.1);max-height:300px;overflow-y:auto;display:none;z-index:98}.ep.show{display:block}.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:15px}.ej{font-size:28px;cursor:pointer;text-align:center;padding:8px}.ej:active{background:#f0f0f0;border-radius:8px}
</style>
</head>
<body>
<div class="c">
<div class="h">
<div class="ht">
<button class="bb" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<div class="chi" onclick="openUserInfo()">
<div class="ca" id="ca">?</div>
<div class="ci">
<div class="cn" id="cn">Loading...</div>
<div class="cs" id="cs"></div>
<div class="cmc" id="cmc"></div>
</div>
</div>
<div class="ha">
<button class="ib" onclick="toggleSearch()"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></button>
<button class="ib" onclick="openMenu()"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
</div>
</div>
</div>
<div class="mc" id="mc"></div>
<div class="tb">
<div class="rpl" id="rpl">
<div class="rt">
<div class="rn" id="rpn"></div>
<div class="rc" id="rpc"></div>
</div>
<div class="cls" onclick="cancelReply()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></div>
</div>
<div class="ti">
<div class="tic">
<button class="tib" onclick="toggleEmoji()"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg></button>
<button class="tib"><svg viewBox="0 0 24 24"><path d="M18.5 4l-1.16 4.89A2.5 2.5 0 0 0 15 11.5 2.5 2.5 0 0 0 17.5 14c.17 0 .33-.03.5-.07L19.5 19H21V4h-2.5M7 9v2h7V9H7m0 3v2h5v-2H7z"/></svg></button>
</div>
<textarea class="mi" id="mi" placeholder="Message..." rows="1"></textarea>
<button class="se" onclick="sendMsg()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</div>
</div>
<div class="ep" id="ep">
<div class="eg">
<div class="ej" onclick="addEmoji('üòÄ')">üòÄ</div><div class="ej" onclick="addEmoji('üòÇ')">üòÇ</div><div class="ej" onclick="addEmoji('üòç')">üòç</div><div class="ej" onclick="addEmoji('üò¢')">üò¢</div><div class="ej" onclick="addEmoji('üò°')">üò°</div><div class="ej" onclick="addEmoji('üëç')">üëç</div><div class="ej" onclick="addEmoji('üëé')">üëé</div><div class="ej" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div><div class="ej" onclick="addEmoji('üî•')">üî•</div><div class="ej" onclick="addEmoji('‚ú®')">‚ú®</div><div class="ej" onclick="addEmoji('üéâ')">üéâ</div><div class="ej" onclick="addEmoji('üíØ')">üíØ</div><div class="ej" onclick="addEmoji('üôè')">üôè</div><div class="ej" onclick="addEmoji('üëè')">üëè</div><div class="ej" onclick="addEmoji('ü§î')">ü§î</div><div class="ej" onclick="addEmoji('üòé')">üòé</div>
</div>
</div>
<div class="ctx" id="ctx"></div>
</div>
<script>
const U='https://bhmycvrbucmbbrpzeane.supabase.co',K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4',sb=window.supabase.createClient(U,K);
let currentUser,chatId,otherUser,msgChannel,statusChannel,replyMsgId=null,editMsgId=null,messages=[];
(()=>{const t={purple:{primary:'#667eea',secondary:'#764ba2'},blue:{primary:'#4facfe',secondary:'#00f2fe'},pink:{primary:'#f093fb',secondary:'#f5576c'},green:{primary:'#43e97b',secondary:'#38f9d7'},orange:{primary:'#fa709a',secondary:'#fee140'},red:{primary:'#ff6b6b',secondary:'#ee5a6f'},teal:{primary:'#2bcbba',secondary:'#45caff'},indigo:{primary:'#4776e6',secondary:'#8e54e9'}},th=localStorage.getItem('nandigram_theme')||'purple';if(t[th]){document.documentElement.style.setProperty('--pc',t[th].primary);document.documentElement.style.setProperty('--sc',t[th].secondary)}})();
async function init(){try{await checkAuth();if(!currentUser){window.location.href='login.html';return}const p=new URLSearchParams(window.location.search);chatId=p.get('chat');if(!chatId){window.location.href='ngm-chats.html';return}await updateOnlineStatus(true);await loadChatInfo();await loadMessages();startRealtime();startStatusTracking()}catch(e){console.error(e);window.location.href='login.html'}}
async function checkAuth(){const{data,error}=await sb.auth.getUser();if(error||!data||!data.user){currentUser=null;return}currentUser=data.user}
async function updateOnlineStatus(on){if(!currentUser)return;try{await sb.from('ngm_users').update({is_online:on,last_seen:new Date().toISOString()}).eq('user_id',currentUser.id)}catch(e){}}
async function loadChatInfo(){try{const{data:c}=await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();if(!c)return;if(c.chat_type==='personal'){const oid=c.user1_id===currentUser.id?c.user2_id:c.user1_id,{data:u}=await sb.from('ngm_users').select('*').eq('user_id',oid).single();otherUser=u;if(u){document.getElementById('cn').textContent=u.full_name||u.mobile||'Unknown';const ini=u.full_name?u.full_name.charAt(0).toUpperCase():'?';document.getElementById('ca').innerHTML=u.profile_picture_url?`<img src="${u.profile_picture_url}">${u.is_online?'<span class="on"></span>':''}`:`<span>${ini}</span>${u.is_online?'<span class="on"></span>':''}`;updateDisplayStatus(u)}}}catch(e){console.error(e)}}
function updateDisplayStatus(u){if(u.is_online){document.getElementById('cs').textContent='online'}else if(u.last_seen){const ls=new Date(u.last_seen),n=new Date(),df=n-ls;if(df<60000)document.getElementById('cs').textContent='last seen just now';else if(df<3600000)document.getElementById('cs').textContent=`last seen ${Math.floor(df/60000)}m ago`;else if(df<86400000)document.getElementById('cs').textContent=`last seen ${Math.floor(df/3600000)}h ago`;else document.getElementById('cs').textContent=`last seen ${Math.floor(df/86400000)}d ago`}else{document.getElementById('cs').textContent='offline'}}
async function loadMessages(){try{const{data:m}=await sb.from('ngm_messages').select('*').eq('chat_id',chatId).eq('is_deleted',false).order('created_at',{ascending:true});messages=m||[];renderMessages();updateMsgCount()}catch(e){console.error(e)}}
function renderMessages(){const cn=document.getElementById('mc');if(messages.length===0){cn.innerHTML='<div class="em">No messages yet</div>';return}cn.innerHTML=messages.map(m=>{const isSent=m.sender_id===currentUser.id,ti=new Date(m.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),replyMsg=m.reply_to_message_id?messages.find(x=>x.message_id===m.reply_to_message_id):null;let statusIcon='';if(isSent){if(m.is_read_by_all)statusIcon='<svg viewBox="0 0 24 24" fill="#4fc3f7"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>';else if(m.is_delivered)statusIcon='<svg viewBox="0 0 24 24" fill="#999"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>';else statusIcon='<svg viewBox="0 0 24 24" fill="#999"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'}return`<div class="m ${isSent?'sent':'received'}${replyMsg?' rpl':''}" data-id="${m.message_id}" oncontextmenu="showContextMenu(event,'${m.message_id}',${isSent})"><div class="mb">${replyMsg?`<div class="rp"><div class="rpn">${replyMsg.sender_id===currentUser.id?'You':'Them'}</div><div class="rpt">${replyMsg.content}</div></div>`:''}
<div class="bl"><div class="mt">${m.content}</div>${m.is_edited?'<div class="me">edited</div>':''}<div class="mf"><span class="mti">${ti}</span>${isSent?`<span class="tk">${statusIcon}</span>`:''}</div></div></div></div>`}).join('');cn.scrollTop=cn.scrollHeight}
function updateMsgCount(){document.getElementById('cmc').textContent=`${messages.length} messages`}
async function sendMsg(){const inp=document.getElementById('mi'),tx=inp.value.trim();if(!tx||!currentUser)return;try{const msg={chat_id:chatId,sender_id:currentUser.id,content:tx,message_type:'text',is_deleted:false,is_edited:false,is_delivered:false,is_read_by_all:false,created_at:new Date().toISOString()};if(replyMsgId)msg.reply_to_message_id=replyMsgId;if(editMsgId){await sb.from('ngm_messages').update({content:tx,is_edited:true,edited_at:new Date().toISOString()}).eq('message_id',editMsgId);editMsgId=null}else{await sb.from('ngm_messages').insert(msg)}await sb.from('ngm_chats').update({last_message_at:new Date().toISOString()}).eq('chat_id',chatId);inp.value='';cancelReply()}catch(e){console.error(e)}}
function startRealtime(){if(msgChannel)msgChannel.unsubscribe();msgChannel=sb.channel(`chat:${chatId}`).on('postgres_changes',{event:'*',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${chatId}`},()=>loadMessages()).subscribe()}
function startStatusTracking(){if(!otherUser)return;if(statusChannel)statusChannel.unsubscribe();statusChannel=sb.channel(`status:${otherUser.user_id}`).on('postgres_changes',{event:'UPDATE',schema:'public',table:'ngm_users',filter:`user_id=eq.${otherUser.user_id}`},p=>{const u=p.new;const ca=document.getElementById('ca'),onDot=ca.querySelector('.on');if(u.is_online&&!onDot)ca.innerHTML+=`<span class="on"></span>`;else if(!u.is_online&&onDot)onDot.remove();updateDisplayStatus(u)}).subscribe()}
function showContextMenu(e,mid,isSent){e.preventDefault();const ctx=document.getElementById('ctx');ctx.innerHTML=`<div class="cti" onclick="setReply('${mid}')"><svg viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>Reply</div>${isSent?`<div class="cti" onclick="editMsg('${mid}')"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</div>`:''}<div class="cti" onclick="copyMsg('${mid}')"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</div>${isSent?`<div class="cti del" onclick="deleteMsg('${mid}')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</div>`:''}`;ctx.style.left=e.pageX+'px';ctx.style.top=e.pageY+'px';ctx.classList.add('show');setTimeout(()=>document.addEventListener('click',()=>ctx.classList.remove('show'),{once:true}),100)}
function setReply(mid){const m=messages.find(x=>x.message_id===mid);if(!m)return;replyMsgId=mid;document.getElementById('rpn').textContent=m.sender_id===currentUser.id?'You':'Them';document.getElementById('rpc').textContent=m.content;document.getElementById('rpl').classList.add('show')}
function cancelReply(){replyMsgId=null;editMsgId=null;document.getElementById('rpl').classList.remove('show');document.getElementById('mi').value=''}
function editMsg(mid){const m=messages.find(x=>x.message_id===mid);if(!m)return;editMsgId=mid;document.getElementById('mi').value=m.content;document.getElementById('mi').focus()}
function copyMsg(mid){const m=messages.find(x=>x.message_id===mid);if(!m)return;navigator.clipboard.writeText(m.content);alert('Copied!')}
async function deleteMsg(mid){if(!confirm('Delete this message?'))return;try{await sb.from('ngm_messages').update({is_deleted:true}).eq('message_id',mid);loadMessages()}catch(e){console.error(e)}}
function toggleEmoji(){document.getElementById('ep').classList.toggle('show')}
function addEmoji(e){document.getElementById('mi').value+=e;document.getElementById('ep').classList.remove('show')}
function openUserInfo(){if(otherUser)window.location.href=`ngm-user-info.html?user=${otherUser.user_id}`}
function toggleSearch(){}
function openMenu(){}
function goBack(){if(msgChannel)msgChannel.unsubscribe();if(statusChannel)statusChannel.unsubscribe();updateOnlineStatus(false);window.location.href='ngm-chats.html'}
document.getElementById('mi').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}});
document.getElementById('mi').addEventListener('input',e=>{e.target.style.height='auto';e.target.style.height=e.target.scrollHeight+'px'});
window.addEventListener('beforeunload',()=>{if(msgChannel)msgChannel.unsubscribe();if(statusChannel)statusChannel.unsubscribe();updateOnlineStatus(false)});
setInterval(()=>updateOnlineStatus(true),30000);
init();
</script>
</body>
</html>
