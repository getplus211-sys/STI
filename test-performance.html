<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Beginners - ટેસ્ટ પર્ફોર્મન્સ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@300;400;600;700&display=swap');
        
        :root {
            --primary: #1e40af;
            --secondary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body { font-family: 'Hind Vadodara', sans-serif; background-color: #f1f5f9; margin: 0; color: #334155; }
        
        /* Navigation */
        nav { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-between: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); sticky top: 0; z-index: 100; }
        .nav-brand { display: flex; align-items: center; gap: 10px; }
        .nav-logo { background: white; color: var(--primary); padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .nav-btns { display: flex; gap: 10px; }
        .btn { padding: 8px 20px; border-radius: 50px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.3s; color: white; text-decoration: none; }
        .btn-home { background: var(--secondary); }
        .btn-overall { background: var(--success); }

        /* Dashboard Layout */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        /* Profile Card */
        .card { background: var(--white); border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 2rem; }
        .profile-flex { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 60px; height: 60px; background: #dbeafe; color: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
        .stats-group { display: flex; gap: 30px; text-align: center; }
        .stat-label { font-size: 12px; color: #94a3b8; font-weight: bold; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: 900; color: var(--primary); margin-top: 4px; }
        .badge { background: #ffedd5; color: #9a3412; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        /* Grid System */
        .grid-3 { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .mini-card { background: white; padding: 1rem; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .mini-card p { margin: 0; font-size: 13px; color: #64748b; }
        .mini-card h4 { margin: 5px 0 0 0; font-size: 18px; color: var(--dark); }

        /* Table Style */
        .subjects-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        @media (max-width: 768px) { .subjects-grid { grid-template-columns: 1fr; } }
        
        .subject-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
        .subject-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-bottom: 1px solid var(--border); }
        .table-container { padding: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: #94a3b8; padding-bottom: 10px; font-size: 11px; text-transform: uppercase; }
        td { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }

        /* Action Plan */
        .action-plan { background: var(--dark); color: white; padding: 2rem; border-radius: 20px; position: relative; overflow: hidden; }
        .action-plan h3 { color: #fde047; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-top: 0; }
        .plan-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 600px) { .plan-grid { grid-template-columns: 1fr; } }
        ul { list-style: none; padding: 0; font-size: 14px; color: #cbd5e1; }
        li { margin-bottom: 8px; display: flex; gap: 10px; align-items: start; }
        li i { color: var(--success); margin-top: 4px; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-brand">
            <div class="nav-logo">LRD</div>
            <h1 style="font-size: 20px; margin:0;">Beginners</h1>
        </div>
        <div class="nav-btns">
            <a href="quiz-engine-updated__6_.html" class="btn btn-home"><i class="fas fa-home"></i> હોમ</a>
            <a href="overall-performance.html" class="btn btn-overall"><i class="fas fa-chart-line"></i> Overall</a>
        </div>
    </nav>

    <div id="app" class="container">
        <div style="text-align: center; padding: 50px;">લોડ થઈ રહ્યું છે...</div>
    </div>

    <script>
        const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhbHp1bG5ld3ZteXV0ZnFyeWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MjYzMDIsImV4cCI6MjA4MjEwMjMwMn0.oXIheubGUVzQAF8oZmE_U4W94R-nD068cXzTuw_sEro"; // પેસ્ટ કરો
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const params = new URLSearchParams(window.location.search);
        const RESULT_ID = params.get('result_id');

        async function init() {
            const { data: { session } } = await sb.auth.getSession();
            if (!session) { alert('લોગિન જરૂરી છે'); return; }
            if (!RESULT_ID) { alert('રિઝલ્ટ આઈડી મળ્યું નથી'); return; }
            await loadData(session.user.id);
        }

        async function loadData(userId) {
            try {
                const { data: result } = await sb.from('lrd_test_results').select('*, lrd_tests(*)').eq('id', RESULT_ID).single();
                const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
                const { data: responses } = await sb.from('lrd_question_responses').select(`*, lrd_questions(*, lrd_chapters(*, lrd_subjects(*)))`).eq('result_id', RESULT_ID);

                const subjectData = processData(responses);
                const suggestions = await fetchRules(result, subjectData);
                render(profile, result, subjectData, suggestions);
            } catch (e) { console.error(e); }
        }

        function processData(responses) {
            const map = {};
            responses.forEach(r => {
                const q = r.lrd_questions;
                const ch = q.lrd_chapters;
                const sub = ch.lrd_subjects;
                if(!map[sub.id]) map[sub.id] = { name: sub.name, chapters: {} };
                if(!map[sub.id].chapters[ch.id]) map[sub.id].chapters[ch.id] = { name: ch.name, code: ch.chapter_code, total: 0, correct: 0 };
                map[sub.id].chapters[ch.id].total++;
                if(r.is_correct) map[sub.id].chapters[ch.id].correct++;
            });
            return map;
        }

        async function fetchRules(res, subData) {
            const suggestions = [];
            for (let sId in subData) {
                for (let cId in subData[sId].chapters) {
                    const ch = subData[sId].chapters[cId];
                    const score = (ch.correct / ch.total) * 100;
                    const speed = res.avg_time_per_question < 30 ? 'fast' : res.avg_time_per_question < 60 ? 'medium' : 'slow';
                    
                    const { data } = await sb.from('lrd_rule_engine')
                        .select('*')
                        .eq('chapter_code', ch.code)
                        .lte('min_score', score)
                        .gte('max_score', score)
                        .eq('speed_category', speed);
                    if(data) suggestions.push(...data);
                }
            }
            return suggestions;
        }

        function render(profile, res, subData, rules) {
            const initials = profile.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            let subjectsHTML = '';
            for(let id in subData) {
                let chHTML = '';
                let subTotal = 0, subCorrect = 0;
                for(let cid in subData[id].chapters) {
                    const c = subData[id].chapters[cid];
                    const pct = ((c.correct/c.total)*100).toFixed(0);
                    subTotal += c.total; subCorrect += c.correct;
                    chHTML += `<tr><td>${c.name}</td><td style="text-align:center">${c.total}</td><td style="text-align:center">${c.correct}</td><td style="text-align:right; font-weight:bold">${pct}%</td></tr>`;
                }
                const subPct = ((subCorrect/subTotal)*100).toFixed(0);
                subjectsHTML += `
                <div class="subject-card">
                    <div class="subject-header">
                        <h4 style="margin:0; color:var(--primary)">${subData[id].name}</h4>
                        <span class="badge" style="background:var(--primary); color:white">નિપુણતા: ${subPct}%</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ચેપ્ટર</th><th style="text-align:center">કુલ</th><th style="text-align:center">સાચા</th><th style="text-align:right">પરિણામ</th></tr></thead>
                            <tbody>${chHTML}</tbody>
                        </table>
                    </div>
                </div>`;
            }

            document.getElementById('app').innerHTML = `
                <div class="card profile-flex">
                    <div class="user-info">
                        <div class="avatar">${initials}</div>
                        <div><p class="stat-label" style="margin:0">વિદ્યાર્થી</p><h2 style="margin:0">${profile.full_name}</h2></div>
                    </div>
                    <div class="stats-group">
                        <div><p class="stat-label">લેવલ</p><span class="badge">${profile.current_level}</span></div>
                        <div><p class="stat-label">રેન્ક</p><p class="stat-value">#${profile.current_rank}</p></div>
                        <div><p class="stat-label">તારીખ</p><p class="stat-value" style="font-size:16px">${new Date(res.created_at).toLocaleDateString('gu-IN')}</p></div>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="card" style="text-align:center">
                        <h4 style="margin-top:0">ટેસ્ટનું પરિણામ</h4>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="summary-grid">
                        <div class="mini-card"><p>મેળવેલ ગુણ</p><h4>${res.obtained_marks} / 100</h4></div>
                        <div class="mini-card"><p>ચોકસાઈ</p><h4 style="color:var(--success)">${res.accuracy_percentage}%</h4></div>
                        <div class="mini-card"><p>સમય/પ્રશ્ન</p><h4>${res.avg_time_per_question} સેકન્ડ</h4></div>
                        <div class="mini-card"><p>એકાગ્રતા</p><h4 style="color:purple">${res.concentration_rating}/10</h4></div>
                        <div class="mini-card"><p>સરળ (સાચા/કુલ)</p><h4>${res.easy_correct}/${res.easy_total}</h4></div>
                        <div class="mini-card"><p>અઘરા (સાચા/કુલ)</p><h4 style="color:var(--danger)">${res.hard_correct}/${res.hard_total}</h4></div>
                    </div>
                </div>

                <h3 style="margin-bottom:1rem"><i class="fas fa-book-open"></i> વિષય અને ચેપ્ટરવાર એનાલિસિસ</h3>
                <div class="subjects-grid">${subjectsHTML}</div>

                <div class="action-plan">
                    <h3>તમારા માટે એક્શન પ્લાન</h3>
                    <div class="plan-grid">
                        <div><p style="color:var(--secondary); font-weight:bold">વધારે સમય આપો:</p><ul>${rules.map(r => `<li><i class="fas fa-check-circle"></i> ${r.suggestion_text}</li>`).join('') || 'શાબાશ! મહેનત ચાલુ રાખો.'}</ul></div>
                        <div><p style="color:var(--secondary); font-weight:bold">વાંચન સૂચન:</p><p style="font-size:14px">${rules[0]?.action_plan_text || 'તમારા નબળા વિષયો પર વધુ ધ્યાન આપો.'}</p></div>
                    </div>
                </div>
            `;
            
            const correct = res.easy_correct + res.hard_correct;
            const wrong = (res.easy_total + res.hard_total) - correct - res.unanswered_count;
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: { labels: ['સાચા', 'ખોટા', 'બાકી'], datasets: [{ data: [correct, wrong, res.unanswered_count], backgroundColor: ['#10B981', '#EF4444', '#E5E7EB'] }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }
        init();
    </script>
</body>
</html>
