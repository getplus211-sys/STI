<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* --- તમારો અસલી કલર અને બેકગ્રાઉન્ડ --- */
:root{--pc:#667eea;--sc:#764ba2}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,sans-serif;background:#e5ddd5;padding-bottom:120px}

/* --- હેડર ૧૦૦px અને સ્ટેટસ લોજિક --- */
.h{position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;height:100px;background:linear-gradient(135deg,var(--pc),var(--sc));display:flex;align-items:flex-end;padding:0 10px 15px 10px;z-index:100}
.hi{flex:1;display:flex;align-items:center;gap:12px;margin-left:5px}
.ha{width:50px;height:50px;border-radius:50%;background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center}
.ha img{width:100%;height:100%;object-fit:cover}
.hti{flex:1;overflow:hidden}.hn{color:#fff;font-size:20px;font-weight:600}.hs{color:rgba(255,255,255,0.9);font-size:13px}

/* --- મેસેજ અને ટેક્સ્ટ સાઈઝ (૧૭px) --- */
.mc{padding:115px 10px 10px;min-height:100vh}
.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}
.mb{max-width:75%;padding:10px 14px;border-radius:12px;position:relative;word-wrap:break-word}
.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}.m.received .mb{background:#fff;border-bottom-left-radius:2px}
.mt{font-size:17px;color:#333;line-height:1.4}
.mti{font-size:11px;color:#666;margin-top:4px;text-align:right}

/* --- ઈમોજી ૬૦px અને ટેલિગ્રામ એનિમેશન --- */
.mb.emoji-only{background:none !important;box-shadow:none !important;padding:0 !important}
.mb.emoji-only .mt{font-size:60px !important;line-height:1;cursor:pointer;display:inline-block;transition:transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
.emoji-bounce{animation:teleBounce 0.5s ease}
@keyframes teleBounce{0%,100%{transform:scale(1)}30%{transform:scale(1.3) rotate(-5deg)}60%{transform:scale(1.1) rotate(5deg)}}

/* --- ફૂટર અને ઇનપુટ --- */
.ic{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f5f5f5;padding:10px 8px;z-index:100;border-top:1px solid #ddd}
.it{display:flex;gap:8px;align-items:flex-end}
.mitw{flex:1;background:#fff;border-radius:20px;display:flex;align-items:center}
.mi{flex:1;padding:10px 15px;border:none;font-size:16px;outline:none;background:transparent;resize:none;max-height:100px}
.sb{width:40px;height:40px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
    <div class="h">
        <div class="hi">
            <div class="ha" id="chatAvatar">?</div>
            <div class="hti"><div class="hn" id="chatTitle">Loading...</div><div class="hs" id="chatStatus"></div></div>
        </div>
    </div>
    <div class="mc" id="messagesContainer"></div>
    <div class="ic">
        <div class="it">
            <div class="mitw"><textarea class="mi" id="messageInput" placeholder="Type a message..." rows="1"></textarea></div>
            <button class="sb" onclick="sendMessage()"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>

<script>
// --- તમારો અસલી Supabase કોડ અહીં આવશે ---
const SUPABASE_URL='https://bhmycvrbucmbbrpzeane.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser, chatId;

async function init(){
    const {data:{user}}=await sb.auth.getUser();
    currentUser=user;
    chatId=new URLSearchParams(window.location.search).get('chat');
    loadMessages();
    // અસલી સ્ટેટસ અને રિયલ ટાઈમ લોજિક અહીં ચાલુ રાખવું
}

function renderMessages(messages){
    const container=document.getElementById('messagesContainer');
    container.innerHTML=messages.map(msg=>{
        const isSent=msg.sender_id===currentUser.id;
        const content=msg.content.trim();
        // માત્ર એક ઈમોજી ચેક કરવા માટેનું લોજિક
        const isEmoji=/^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)$/u.test(content);
        
        return `<div class="m ${isSent?'sent':'received'}">
            <div class="mb ${isEmoji?'emoji-only':''}">
                <div class="mt" onclick="this.classList.add('emoji-bounce');setTimeout(()=>this.classList.remove('emoji-bounce'),500)">${msg.content}</div>
                ${!isEmoji?`<div class="mti">${new Date(msg.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`:''}
            </div>
        </div>`;
    }).join('');
    window.scrollTo(0,document.body.scrollHeight);
}

async function loadMessages(){
    const {data:msgs}=await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});
    renderMessages(msgs||[]);
}

async function sendMessage(){
    const input=document.getElementById('messageInput');
    if(!input.value.trim()) return;
    await sb.from('ngm_messages').insert({chat_id:chatId,sender_id:currentUser.id,content:input.value});
    input.value=''; loadMessages();
}
init();
</script>
</body>
</html>
