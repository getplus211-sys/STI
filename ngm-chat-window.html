<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Nandigram Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}
*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{font-family:-apple-system,sans-serif;background:#e5ddd5;padding-bottom:120px}

/* --- HEADER 100px - Content at Bottom --- */
.h{
    position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;
    height:100px;
    background:linear-gradient(135deg,var(--pc),var(--sc));
    display:flex;
    align-items:flex-end;
    padding:0 15px 15px;
    z-index:100;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.hi{flex:1;display:flex;align-items:center;gap:12px;cursor:pointer}
.ha{width:45px;height:45px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;flex-shrink:0}
.hn{color:#fff;font-size:18px;font-weight:600}
.hs{color:rgba(255,255,255,0.8);font-size:12px}

/* --- MESSAGES CONTAINER --- */
.mc{padding:115px 10px 10px; min-height:100vh}

.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}
.mb{max-width:75%;padding:8px 12px;border-radius:12px;position:relative;word-wrap:break-word;background:#fff}
.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}

/* --- EMOJI 2X SIZE --- */
.mb.emoji-xl{background:none!important; font-size:160px; line-height:1; animation:bounce 0.6s}
.mb.emoji-lg{background:none!important; font-size:120px; line-height:1}
.mb.emoji-md{background:none!important; font-size:90px; line-height:1}

.mt{font-size:15px;color:#000}.mti{font-size:10px;color:#888;text-align:right;margin-top:4px}

/* --- INPUT AREA --- */
.ic{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f0f0f0;padding:10px;z-index:100;display:flex;gap:8px;align-items:center}
.mitw{flex:1;background:#fff;border-radius:25px;padding:5px 15px}
.mi{width:100%;border:none;outline:none;font-size:15px;min-height:30px;background:transparent}
.sb{width:45px;height:45px;background:var(--pc);border:none;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}

.loading{text-align:center;padding:50px;color:gray}
</style>
</head>
<body>

<div class="h">
    <div class="hi" onclick="history.back()">
        <div class="ha" id="chatAvatar">?</div>
        <div>
            <div class="hn" id="chatTitle">Loading...</div>
            <div class="hs" id="chatStatus">online</div>
        </div>
    </div>
</div>

<div class="mc" id="messagesContainer">
    <div class="loading">મેસેજ લોડ થઈ રહ્યા છે...</div>
</div>

<div class="ic">
    <div class="mitw">
        <textarea class="mi" id="messageInput" placeholder="મેસેજ લખો..." rows="1"></textarea>
    </div>
    <button class="sb" onclick="sendMessage()">➤</button>
</div>

<script>
const U='https://bhmycvrbucmbbrpzeane.supabase.co',K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
const sb=supabase.createClient(U,K);
let cu, chatId;

async function init(){
    const {data:{user}} = await sb.auth.getUser();
    if(!user) { location.href='login.html'; return; }
    cu = user;

    const params = new URLSearchParams(window.location.search);
    chatId = params.get('chat');
    
    if(!chatId) { location.href='ngm-chats.html'; return; }

    loadChatHeader();
    loadMessages();
    
    // Realtime subscription
    sb.channel('msgs').on('postgres_changes',{event:'INSERT',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${chatId}`},loadMessages).subscribe();
}

async function loadChatHeader(){
    // Simple fetch to avoid relationship errors
    const {data:chat} = await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();
    if(chat){
        const otherId = (chat.user1_id === cu.id) ? chat.user2_id : chat.user1_id;
        const {data:user} = await sb.from('ngm_users').select('full_name').eq('user_id',otherId).single();
        document.getElementById('chatTitle').textContent = user?.full_name || "User";
        document.getElementById('chatAvatar').textContent = (user?.full_name || "U").charAt(0);
    }
}

async function loadMessages(){
    const {data:msgs, error} = await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});
    if(error) { console.error(error); return; }
    
    const container = document.getElementById('messagesContainer');
    container.innerHTML = msgs.map(m => {
        const isSent = m.sender_id === cu.id;
        const time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        // Emoji Logic
        const emojiCount = m.content.match(/[\p{Emoji}]/gu)?.length || 0;
        const textOnly = m.content.replace(/[\p{Emoji}\s]/gu, '').length;
        let emojiCls = '';
        if(textOnly === 0){
            if(emojiCount === 1) emojiCls = ' emoji-xl';
            else if(emojiCount === 2) emojiCls = ' emoji-lg';
            else if(emojiCount === 3) emojiCls = ' emoji-md';
        }

        return `<div class="m ${isSent?'sent':'received'}">
            <div class="mb ${emojiCls}">
                <div class="mt">${m.content}</div>
                ${emojiCls==='' ? `<div class="mti">${time}</div>` : ''}
            </div>
        </div>`;
    }).join('');
    window.scrollTo(0, document.body.scrollHeight);
}

async function sendMessage(){
    const input = document.getElementById('messageInput');
    const val = input.value.trim();
    if(!val) return;
    
    const {error} = await sb.from('ngm_messages').insert({
        chat_id: chatId,
        sender_id: cu.id,
        content: val
    });

    if(!error) {
        input.value = '';
        loadMessages();
    }
}

init();
</script>
</body>
</html>
