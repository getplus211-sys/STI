<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>LRD Quiz - Mock Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;
box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3{margin:8px 0}
button{border:none;border-radius:14px;padding:14px 20px;font-size:16px;width:100%;cursor:pointer;font-weight:600;transition:all .3s}
.primary{background:#22c55e;color:#fff}
.primary:hover{background:#16a34a}
.gray{background:#e5e7eb;color:#334155}
.gray:hover{background:#d1d5db}
.danger{background:#dc2626;color:#fff}
.danger:hover{background:#b91c1c}
.option{border:2px solid #e5e7eb;border-radius:12px;padding:14px;margin:10px 0;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .3s}
.option:hover{border-color:#22c55e;background:#f0fdf4}
.option.selected{border-color:#22c55e;background:#f0fdf4}
.hidden{display:none}
#timer{font-weight:bold;color:#dc2626;font-size:1.3rem}
.nav-btns{display:flex;gap:12px;margin-top:20px}
.q-nav{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:20px}
.q-num{padding:12px;text-align:center;background:#f1f5f9;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:all .3s}
.q-num:hover{background:#e2e8f0}
.q-num.active{background:#22c55e;color:#fff}
.q-num.answered{background:#8b5cf6;color:#fff}
.chart-container{width:100%;max-width:300px;margin:20px auto}
.badge{padding:5px 10px;border-radius:8px;font-size:13px;font-weight:bold;text-transform:uppercase}
.badge-easy{background:#dcfce7;color:#166534}
.badge-medium{background:#fef9c3;color:#854d0e}
.badge-hard{background:#fee2e2;color:#991b1b}

/* Modal Styles */
#modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000;
}
#modal-content {
  background: #fff; padding: 28px; border-radius: 20px; max-width: 360px; width: 90%;
  text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.nav-bar{background:#1e40af;color:#fff;padding:16px 24px;box-shadow:0 4px 20px rgba(0,0,0,.15);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.nav-logo{background:#fff;color:#1e40af;padding:6px 12px;border-radius:8px;font-weight:bold;margin-right:12px}
.nav-btn{background:#2563eb;color:#fff;border:none;padding:10px 20px;border-radius:25px;font-size:14px;cursor:pointer;transition:all .3s}
.nav-btn:hover{background:#1d4ed8}
</style>
</head>
<body>

<div class="nav-bar">
  <div style="display:flex;align-items:center">
    <span class="nav-logo">LRD</span>
    <span style="font-size:18px;font-weight:bold">Mock Test</span>
  </div>
  <button class="nav-btn" onclick="goHome()"><i>ğŸ </i> àª¹à«‹àª®</button>
</div>

<div id="modal-overlay">
  <div id="modal-content">
    <div id="modal-icon" style="font-size: 56px; margin-bottom: 16px;"></div>
    <h3 id="modal-title" style="margin-bottom: 12px; font-size: 20px;"></h3>
    <p id="modal-text" style="color: #64748b; margin-bottom: 24px; line-height: 1.6; font-size: 15px;"></p>
    <button id="modal-btn" class="primary" onclick="closeModal()">OK</button>
  </div>
</div>

<div id="setup-screen" class="container">
  <div class="card">
    <h2 id="setup-title">ğŸ“ Mock Test</h2>
    <p id="setup-desc" style="color: #64748b; font-size: 15px;">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</p>
    
    <div id="test-info" class="hidden">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 24px 0;">
        <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0;">
          <small style="color: #64748b; font-weight: 600;">àªªà«àª°àª¶à«àª¨à«‹</small>
          <div id="info-qcount" style="font-size: 24px; font-weight: bold; color: #1e293b; margin-top: 4px;">-</div>
        </div>
        <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0;">
          <small style="color: #64748b; font-weight: 600;">àª¸àª®àª¯</small>
          <div id="info-time" style="font-size: 24px; font-weight: bold; color: #1e293b; margin-top: 4px;">-</div>
        </div>
        <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0;">
          <small style="color: #64748b; font-weight: 600;">àª—à«àª£</small>
          <div id="info-marks" style="font-size: 24px; font-weight: bold; color: #1e293b; margin-top: 4px;">-</div>
        </div>
      </div>
    </div>

    <button id="start-btn" class="primary hidden" onclick="startTest()">âœ¨ Start Test Now</button>
  </div>
</div>

<div id="quiz-screen" class="container hidden">
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:16px 24px">
    <span id="q-progress" style="font-weight:700;color:#334155;font-size:16px">Question 1/0</span>
    <span id="timer">00:00</span>
  </div>

  <div class="card">
    <div id="question-text" style="font-size:18px;margin-bottom:24px;font-weight:600;line-height:1.6;color:#1e293b"></div>
    <div id="options-container"></div>
  </div>

  <div class="nav-btns">
    <button class="gray" onclick="prevQuestion()" style="flex:1">â† àªªàª¾àª›àª³</button>
    <button class="primary" id="next-btn" onclick="nextQuestion()" style="flex:2">àª†àª—àª³ â†’</button>
  </div>

  <div class="q-nav" id="q-nav-grid"></div>

  <button class="danger" style="margin-top:24px;background:#fee2e2;color:#dc2626;font-weight:700;border:2px solid #fecaca" onclick="confirmSubmit()">âœ“ Finish & Submit</button>
</div>

<div id="result-screen" class="container hidden">
  <div class="card" style="text-align:center">
    <h2 id="result-title" style="color:#1e293b">ğŸ‰ Test àªªà«‚àª°à«àª‚ àª¥àª¯à«àª‚!</h2>
    <div class="chart-container">
      <canvas id="resultChart"></canvas>
    </div>
    <div id="score-details" style="margin-bottom:24px"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <button class="primary" onclick="viewSolutions()">ğŸ“– Solutions</button>
      <button class="primary" style="background:#8b5cf6" onclick="viewPerformance()">ğŸ“Š Performance</button>
    </div>
    <button class="gray" style="margin-top:12px" onclick="goHome()">ğŸ  Back to Home</button>
  </div>

  <div id="solutions-container" class="hidden"></div>
  
  <div id="leaderboard-container" class="card" style="margin-top:24px">
    <h3 style="color:#1e293b">ğŸ† Leaderboard</h3>
    <div id="leaderboard-list">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</div>
  </div>
</div>

<script>
/* ========== CONFIGURATION ========== */
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(window.location.search);
const QUIZ_ID = params.get('id') || 'DEMO_QUIZ_001';
const TIMEOUT_MS = 15000;

let user = null;
let questions = [];
let currentIndex = 0;
let userAnswers = {};
let questionTimes = {};
let timeLeft = 0;
let timerInterval = null;
let startTime = null;
let questionStartTime = null;
let isSubmitting = false;
let testInfo = null;

const timeout = (ms) => new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), ms));

/* ========== INITIALIZATION ========== */
async function init() {
  const { data: { session }, error: authError } = await sb.auth.getSession();
  if (!session) {
    alertModal('ğŸ”’', 'àª²à«‹àª—àª¿àª¨ àªœàª°à«‚àª°à«€', 'àªŸà«‡àª¸à«àªŸ àª†àªªàªµàª¾ àª®àª¾àªŸà«‡ àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª²à«‹àª—àª¿àª¨ àª•àª°à«‹.');
    setTimeout(() => window.location.href = 'index.html', 2000);
    return;
  }
  user = session.user;

  try {
    // 1. Fetch Mapping First
    const { data: mapping } = await sb.from("quiz_test_mapping").select("lrd_test_id").eq("quiz_id", QUIZ_ID).maybeSingle();
    const finalTestId = mapping ? mapping.lrd_test_id : QUIZ_ID;

    // 2. Fetch Test Info
    const { data: test } = await sb.from("lrd_tests").select("*").eq("id", finalTestId).maybeSingle();
    testInfo = test || { title: 'Mock Test', total_marks: 100, target_score: 90, duration_minutes: 60 };

    // 3. Fetch Questions
    const { data, error } = await Promise.race([
      sb.from("lrd_questions").select("*").eq("quiz_id", QUIZ_ID).order('id', { ascending: true }),
      timeout(TIMEOUT_MS)
    ]);
    if (error) throw error;
    questions = data || [];

    if (questions.length === 0) {
      alertModal('âš ï¸', 'àªªà«àª°àª¶à«àª¨à«‹ àª¨àª¥à«€', 'àª† Quiz àª®àª¾àªŸà«‡ àª•à«‹àªˆ àªªà«àª°àª¶à«àª¨à«‹ àª®àª³à«àª¯àª¾ àª¨àª¥à«€.');
      return;
    }

    // 4. Check Existing Result
    const { data: existingResult } = await Promise.race([
      sb.from("lrd_test_results")
        .select("*")
        .eq("user_id", user.id)
        .eq("test_id", finalTestId)
        .maybeSingle(),
      timeout(TIMEOUT_MS)
    ]);

    if (existingResult) {
      const totalQuestions = existingResult.easy_total + existingResult.hard_total;
      const correctCount = existingResult.easy_correct + existingResult.hard_correct;
      const wrongCount = totalQuestions - correctCount - existingResult.unanswered_count;

      showResults({
        result_id: existingResult.id,
        total_score: existingResult.obtained_marks,
        correct_count: correctCount,
        wrong_count: wrongCount,
        skipped_count: existingResult.unanswered_count,
        time_taken_seconds: existingResult.total_time_taken_seconds
      });
    } else {
      document.getElementById("setup-title").innerText = testInfo.title || 'Mock Test';
      document.getElementById("setup-desc").innerText = "àª¶à«àª‚ àª¤àª®à«‡ àª¤à«ˆàª¯àª¾àª° àª›à«‹?";
      document.getElementById("info-qcount").innerText = questions.length;
      document.getElementById("info-time").innerText = (testInfo.duration_minutes || questions.length) + " àª®àª¿àª¨àª¿àªŸ";
      document.getElementById("info-marks").innerText = testInfo.total_marks || 100;
      document.getElementById("test-info").classList.remove("hidden");
      document.getElementById("start-btn").classList.remove("hidden");
    }
  } catch (err) {
    console.error('Init error:', err);
    alertModal('âŒ', 'Error', 'àª®àª¾àª¹àª¿àª¤à«€ àª²à«‹àª¡ àª•àª°àªµàª¾àª®àª¾àª‚ àª¸àª®àª¸à«àª¯àª¾ àª†àªµà«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.');
  }
}

/* ========== TEST ENGINE ========== */
function startTest() {
  document.getElementById("setup-screen").classList.add("hidden");
  document.getElementById("quiz-screen").classList.remove("hidden");
  
  const durationMinutes = testInfo.duration_minutes || questions.length;
  timeLeft = durationMinutes * 60;
  startTime = Date.now();
  questionStartTime = Date.now();
  
  renderQuestion();
  renderNav();
  timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
  if (timeLeft <= 0) { 
    alertModal('â°', 'àª¸àª®àª¯ àªªà«‚àª°à«‹', 'àª¤àª®àª¾àª°à«‹ àª¸àª®àª¯ àªªà«‚àª°à«‹ àª¥àª¯à«‹. àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª¥àªˆ àª°àª¹à«€ àª›à«‡...');
    setTimeout(submitTest, 1500);
    return; 
  }
  timeLeft--;
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;
  document.getElementById("timer").innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
}

function renderQuestion() {
  const q = questions[currentIndex];
  document.getElementById("q-progress").innerText = `Question ${currentIndex + 1}/${questions.length}`;
  
  const diffBadge = q.difficulty_level ? `<span class="badge badge-${q.difficulty_level.toLowerCase()}">${q.difficulty_level}</span> ` : '';
  document.getElementById("question-text").innerHTML = `${diffBadge}${q.question_text}`;

  const container = document.getElementById("options-container");
  container.innerHTML = "";

  const opts = [
    {key:'1', text: q.option_a, label: 'A'},
    {key:'2', text: q.option_b, label: 'B'},
    {key:'3', text: q.option_c, label: 'C'},
    {key:'4', text: q.option_d, label: 'D'}
  ];

  if (q.option_e) {
    opts.push({key:'5', text: q.option_e, label: 'E'});
  }

  opts.forEach(o => {
    const div = document.createElement("div");
    div.className = `option ${userAnswers[currentIndex] === o.key ? 'selected' : ''}`;
    div.innerHTML = `<strong style="font-size:17px">${o.label}.</strong> <span style="font-size:15px">${o.text}</span>`;
    div.onclick = () => { 
      // Save time for previous question
      if (questionStartTime) {
        const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
        questionTimes[currentIndex] = (questionTimes[currentIndex] || 0) + timeSpent;
      }
      
      userAnswers[currentIndex] = o.key; 
      renderQuestion(); 
      renderNav();
      
      // Reset question timer
      questionStartTime = Date.now();
    };
    container.appendChild(div);
  });

  document.getElementById("next-btn").innerText = (currentIndex === questions.length - 1) ? "àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹" : "àª†àª—àª³ â†’";
}

function renderNav() {
  const grid = document.getElementById("q-nav-grid");
  grid.innerHTML = "";
  questions.forEach((_, i) => {
    const d = document.createElement("div");
    d.className = `q-num ${i === currentIndex ? 'active' : ''} ${userAnswers[i] ? 'answered' : ''}`;
    d.innerText = i + 1;
    d.onclick = () => { 
      // Save time for current question before switching
      if (questionStartTime) {
        const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
        questionTimes[currentIndex] = (questionTimes[currentIndex] || 0) + timeSpent;
      }
      
      currentIndex = i; 
      renderQuestion(); 
      renderNav();
      
      // Reset timer for new question
      questionStartTime = Date.now();
    };
    grid.appendChild(d);
  });
}

function prevQuestion() { 
  if(currentIndex > 0) { 
    // Save time for current question
    if (questionStartTime) {
      const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
      questionTimes[currentIndex] = (questionTimes[currentIndex] || 0) + timeSpent;
    }
    
    currentIndex--; 
    renderQuestion(); 
    renderNav();
    
    // Reset timer
    questionStartTime = Date.now();
  } 
}

function nextQuestion() {
  if(currentIndex < questions.length - 1) { 
    // Save time for current question
    if (questionStartTime) {
      const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
      questionTimes[currentIndex] = (questionTimes[currentIndex] || 0) + timeSpent;
    }
    
    currentIndex++; 
    renderQuestion(); 
    renderNav();
    
    // Reset timer
    questionStartTime = Date.now();
  }
  else confirmSubmit();
}

function confirmSubmit() { 
  alertModal('â“', 'àª¸àª¬àª®àª¿àªŸ àª•àª°à«€àª?', 'àª¶à«àª‚ àª¤àª®à«‡ àª–àª°à«‡àª–àª° àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?', true); 
}

async function submitTest() {
  if (isSubmitting) return;
  isSubmitting = true;
  clearInterval(timerInterval);

  // Save time for last question
  if (questionStartTime) {
    const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
    questionTimes[currentIndex] = (questionTimes[currentIndex] || 0) + timeSpent;
  }

  const finalTime = Math.floor((Date.now() - startTime) / 1000);
  let correct = 0, wrong = 0, skipped = 0;
  let easy_c = 0, easy_t = 0, hard_c = 0, hard_t = 0;

  questions.forEach((q, i) => {
    const a = userAnswers[i];
    const isEasy = q.difficulty_level?.toLowerCase() === 'easy';
    if(isEasy) easy_t++; else hard_t++;

    if(!a) {
        skipped++;
    } else if(Number(a) === Number(q.correct_option)) {
        correct++;
        if(isEasy) easy_c++; else hard_c++;
    } else {
        wrong++;
    }
  });

  const score = correct - (wrong * 0.25);
  const accuracy = (correct / (correct + wrong)) * 100 || 0;
  const avgTimePerQuestion = finalTime / questions.length;

  // Calculate concentration rating (1-10)
  let concentration = 5;
  if (accuracy >= 90) concentration = 10;
  else if (accuracy >= 80) concentration = 9;
  else if (accuracy >= 70) concentration = 8;
  else if (accuracy >= 60) concentration = 7;
  else if (accuracy >= 50) concentration = 6;
  else if (accuracy >= 40) concentration = 5;
  else if (accuracy >= 30) concentration = 4;
  else concentration = 3;

  // Calculate improvement percentage (placeholder - would need previous test data)
  const targetScore = testInfo.target_score || 90;
  const improvement = Math.max(0, Math.round(((targetScore - score) / targetScore) * 100));

  try {
    const { data: mapping } = await sb.from("quiz_test_mapping").select("lrd_test_id").eq("quiz_id", QUIZ_ID).maybeSingle();
    const finalTestId = mapping ? mapping.lrd_test_id : QUIZ_ID;

    // Get subject_id from first question
    const subjectId = questions[0]?.subject_id || null;

    const { data: resData, error: resErr } = await sb.from("lrd_test_results").insert({
      user_id: user.id,
      test_id: finalTestId,
      obtained_marks: score,
      accuracy_percentage: accuracy,
      total_time_taken_seconds: finalTime,
      easy_correct: easy_c,
      easy_total: easy_t,
      hard_correct: hard_c,
      hard_total: hard_t,
      unanswered_count: skipped,
      avg_time_per_question: avgTimePerQuestion.toFixed(2),
      subject_id: subjectId,
      concentration_rating: concentration,
      improvement_percentage: improvement
    }).select().single();

    if(resErr) throw resErr;

    // Insert question responses with individual timings
    const resp = questions.map((q, i) => ({
      result_id: resData.id,
      question_id: q.id,
      user_selected_option: userAnswers[i] ? String.fromCharCode(96 + parseInt(userAnswers[i])) : null,
      is_correct: userAnswers[i] ? (Number(userAnswers[i]) === Number(q.correct_option)) : false,
      time_spent_seconds: questionTimes[i] || Math.floor(avgTimePerQuestion)
    }));
    
    const { error: respErr } = await sb.from("lrd_question_responses").insert(resp);
    if (respErr) console.error('Response insert error:', respErr);

    // Update profile stats
    const { data: profile } = await sb.from("profiles").select("total_tests_taken").eq("id", user.id).single();
    if (profile) {
      await sb.from("profiles").update({
        total_tests_taken: (profile.total_tests_taken || 0) + 1
      }).eq("id", user.id);
    }

    showResults({ 
      result_id: resData.id,
      total_score: score, 
      correct_count: correct, 
      wrong_count: wrong, 
      skipped_count: skipped, 
      time_taken_seconds: finalTime 
    });
  } catch (err) {
    console.error(err);
    alertModal('âŒ', 'Error', 'àª¸à«‡àªµ àª•àª°àªµàª¾àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.');
    isSubmitting = false;
  }
}

/* ========== RESULTS & UI HELPERS ========== */
function showResults(data) {
  document.getElementById("setup-screen").classList.add("hidden");
  document.getElementById("quiz-screen").classList.add("hidden");
  document.getElementById("result-screen").classList.remove("hidden");

  const m = Math.floor(data.time_taken_seconds / 60), s = data.time_taken_seconds % 60;

  document.getElementById("score-details").innerHTML = `
    <div style="font-size:40px;font-weight:900;color:#22c55e;margin:10px 0">${data.total_score.toFixed(2)}</div>
    <div style="color:#64748b;margin-bottom:20px;font-size:16px">àª¤àª®àª¾àª°à«‹ àª¸à«àª•à«‹àª°</div>
    <div style="display:flex;justify-content:space-around;font-weight:700;font-size:16px">
      <div style="color:#22c55e">âœ”ï¸ ${data.correct_count}</div>
      <div style="color:#dc2626">âŒ ${data.wrong_count}</div>
      <div style="color:#64748b">âšª ${data.skipped_count}</div>
      <div style="color:#0ea5e9">â±ï¸ ${m}m ${s}s</div>
    </div>
  `;

  new Chart(document.getElementById('resultChart'), {
    type: 'doughnut',
    data: {
      labels: ['àª¸àª¾àªšàª¾ àªœàªµàª¾àª¬', 'àª–à«‹àªŸàª¾ àªœàªµàª¾àª¬', 'àª¬àª¾àª•à«€ àª°àª¾àª–à«‡àª²'],
      datasets: [{
        data: [data.correct_count, data.wrong_count, data.skipped_count],
        backgroundColor: ['#22c55e', '#dc2626', '#e5e7eb'],
        borderWidth: 0
      }]
    },
    options: { 
      cutout: '75%', 
      plugins: { 
        legend: { 
          display: true,
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 13 }
          }
        } 
      } 
    }
  });

  loadLeaderboard();
}

async function viewSolutions() {
  const container = document.getElementById("solutions-container");
  container.classList.remove("hidden");
  container.innerHTML = "<h3 style='margin:24px 0 16px;color:#1e293b;font-size:22px'>ğŸ“– Solutions</h3>";
  const options = ['a','b','c','d','e'];
  
  questions.forEach((q, i) => {
    const userAns = userAnswers[i];
    const isCorrect = userAns && Number(userAns) === Number(q.correct_option);
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div style="margin-bottom:16px">
        <span style="font-weight:700;color:#1e293b;font-size:16px">Q${i+1}.</span>
        ${q.difficulty_level ? `<span class="badge badge-${q.difficulty_level.toLowerCase()}" style="margin-left:8px">${q.difficulty_level}</span>` : ''}
      </div>
      <p style="font-size:16px;line-height:1.6;color:#334155;margin-bottom:16px"><b>${q.question_text}</b></p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:14px">
        <div style="padding:12px;border-radius:10px;background:${isCorrect ? '#f0fdf4' : '#fef2f2'};border:2px solid ${isCorrect ? '#22c55e' : '#dc2626'}">
          <b style="display:block;margin-bottom:6px;color:#334155">àª¤àª®àª¾àª°à«‹ àªœàªµàª¾àª¬:</b> 
          <span style="color:${isCorrect ? '#166534' : '#991b1b'}">${userAns ? q['option_'+options[userAns-1]] : 'àª¨àª¥à«€ àª†àªªà«àª¯à«‹'}</span>
        </div>
        <div style="padding:12px;border-radius:10px;background:#f0fdf4;border:2px solid #22c55e">
          <b style="display:block;margin-bottom:6px;color:#334155">àª¸àª¾àªšà«‹ àªœàªµàª¾àª¬:</b> 
          <span style="color:#166534">${q['option_'+options[Number(q.correct_option)-1]]}</span>
        </div>
      </div>
      ${q.solution ? `
        <div style="margin-top:12px;padding:12px;background:#f1f5f9;border-radius:8px;border-left:4px solid #2563eb">
          <b style="color:#1e40af;display:block;margin-bottom:6px">ğŸ’¡ Solution:</b>
          <p style="margin:0;color:#475569;line-height:1.5">${q.solution}</p>
        </div>
      ` : ''}
    `;
    container.appendChild(div);
  });
  container.scrollIntoView({behavior:'smooth'});
}

async function loadLeaderboard() {
  try {
    const { data: mapping } = await sb.from("quiz_test_mapping").select("lrd_test_id").eq("quiz_id", QUIZ_ID).maybeSingle();
    const finalTestId = mapping ? mapping.lrd_test_id : QUIZ_ID;

    const { data: results } = await sb.from("lrd_test_results")
      .select("user_id, obtained_marks, profiles(full_name)")
      .eq("test_id", finalTestId)
      .order("obtained_marks", { ascending: false })
      .limit(10);

    if (!results || results.length === 0) {
      document.getElementById("leaderboard-list").innerHTML = '<p style="color:#64748b;text-align:center;padding:20px">àª•à«‹àªˆ àª°àª¿àªàª²à«àªŸ àª¨àª¥à«€.</p>';
      return;
    }

    document.getElementById("leaderboard-list").innerHTML = results.map((r, i) => {
      const isCurrentUser = r.user_id === user.id;
      return `
      <div style="display:flex;justify-content:space-between;padding:14px 0;border-bottom:1px solid #e5e7eb;align-items:center">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-weight:900;font-size:18px;color:${i < 3 ? '#f59e0b' : '#64748b'};min-width:30px">${i+1}.</span>
          <span style="font-weight:${isCurrentUser ? 'bold' : '600'};color:${isCurrentUser ? '#2563eb' : '#334155'}">
            ${isCurrentUser ? 'ğŸ¯ àª¤àª®à«‡' : (r.profiles?.full_name || 'Student ' + (i+1))}
          </span>
        </div>
        <b style="font-size:18px;color:#1e293b">${r.obtained_marks.toFixed(2)}</b>
      </div>
    `}).join('');
  } catch (err) { 
    console.error(err); 
    document.getElementById("leaderboard-list").innerHTML = '<p style="color:#ef4444;text-align:center;padding:20px">àª²à«€àª¡àª°àª¬à«‹àª°à«àª¡ àª²à«‹àª¡ àª•àª°àªµàª¾àª®àª¾àª‚ àª¸àª®àª¸à«àª¯àª¾.</p>';
  }
}

async function viewPerformance() {
  const { data: mapping } = await sb.from("quiz_test_mapping").select("lrd_test_id").eq("quiz_id", QUIZ_ID).maybeSingle();
  const finalTestId = mapping ? mapping.lrd_test_id : QUIZ_ID;
  const { data: res } = await sb.from("lrd_test_results").select("id").eq("user_id", user.id).eq("test_id", finalTestId).order("created_at", {ascending: false}).limit(1).maybeSingle();
  
  if(res) {
    window.location.href = `performance-dashboard.html?result_id=${res.id}`;
  } else {
    alertModal('âš ï¸', 'àª¨àª¥à«€ àª®àª³à«àª¯à«àª‚', 'àªªàª°àª«à«‹àª°à«àª®àª¨à«àª¸ àª¡à«‡àªŸàª¾ àª¨àª¥à«€ àª®àª³à«àª¯à«‹.');
  }
}

/* ========== MODAL HELPERS ========== */
function alertModal(icon, title, text, showConfirm = false) {
  document.getElementById("modal-icon").innerText = icon;
  document.getElementById("modal-title").innerText = title;
  document.getElementById("modal-text").innerText = text;
  document.getElementById("modal-btn").innerText = showConfirm ? "àª¹àª¾, àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹" : "OK";
  document.getElementById("modal-btn").onclick = showConfirm ? () => { closeModal(); submitTest(); } : closeModal;
  document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() { 
  document.getElementById("modal-overlay").style.display = "none"; 
}

function goHome() {
  window.location.href = 'index.html';
}

init();
</script>
</body>
</html>
