<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STI Mock Test - Access</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        /* ... (ркЕрк╣рлАркВркпрк╛ рккрк╣рлЗрк▓рк╛ ркЖрккрлЗрк▓рлБркВ ркЖркЦрлБркВ CSS рк╕рлНркЯрк╛ркЗрк▓рк┐ркВркЧ ркП ркЬ рк░рк╣рлЗрк╢рлЗ) ... */
        /* ркЕрк╣рлАркВркпрк╛ ркдркоркирлЗ ркЕркЧрк╛ркЙ ркЖрккрлЗрк▓рлБркВ CSS рккрлЗрк╕рлНркЯ ркХрк░рлЛ */
        :root {
            --primary-blue: #007BFF;
            --light-blue: #E9F5FF;
            --white: #FFFFFF;
            --text-dark: #333;
            --text-light: #666;
            --success-green: #28a745;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-blue);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 95%;
            max-width: 450px; 
            margin: 10px auto;
            padding: 15px;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }

        header {
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 15px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 1.2rem;
            margin: 0;
            flex-grow: 1;
        }

        .header-controls {
            display: flex;
            align-items: center;
        }

        #user-name {
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9rem;
        }

        #home-button {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: none;
            font-weight: bold;
        }

        .loading-screen {
            text-align: center;
            padding: 40px 0;
            font-size: 1.1rem;
            color: var(--text-light);
        }

        .action-card {
            text-align: center;
            padding: 30px 10px;
        }

        .action-card h2 {
            color: var(--primary-blue);
            font-size: 1.4rem;
            margin-top: 0;
        }

        .action-card p {
            margin-bottom: 25px;
            color: var(--text-light);
        }

        .mock-test-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .mock-test-list a {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            text-decoration: none;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
            text-align: left;
            border-left: 5px solid var(--primary-blue);
        }

        .mock-test-list a:hover {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        #buy-now-btn {
            background-color: var(--success-green);
            color: var(--white);
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }

        #buy-now-btn:hover {
            background-color: #1e7e34;
        }

        .purchased-status {
            color: var(--success-green);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        footer {
            margin-top: auto; 
            padding: 10px 0;
            text-align: center;
            background-color: var(--primary-blue);
        }

        #whatsapp-icon {
            font-size: 2.0rem;
            color: var(--white);
            text-decoration: none;
            display: inline-block;
        }

        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');
    </style>
</head>
<body>

    <header>
        <h1>STI Mock Test</h1>
        <div class="header-controls">
            <span id="user-name">Guest</span>
            <a id="home-button" href="https://kapilainstitute.vercel.app/">Home</a>
        </div>
    </header>

    <div class="container">
        <div class="loading-screen" id="loading-div">
            <i class="fas fa-spinner fa-spin"></i> ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ... ркПркХрлНрк╕рлЗрк╕ ркЪрлЗркХ ркеркИ рк░рк╣рлНркпрлЛ ркЫрлЗ.
        </div>

        <div class="action-card" id="content-div" style="display: none;">
            </div>
    </div>

    <footer>
        <a id="whatsapp-icon" href="https://wa.me/919925858057" target="_blank" aria-label="WhatsApp Support">
            <i class="fab fa-whatsapp"></i>
        </a>
    </footer>

    <script>
        // ----------------------------------------------------
        // JavaScript рк▓рлЙркЬрк┐ркХ (рк╕рлБрк░ркХрлНрк╖рк┐ркд ркХрлАркЭ рк╕рк╛ркерлЗ)
        // ----------------------------------------------------

        // ЁЯОп ркорк╛ркдрлНрк░ ркмрлЗ рккркмрлНрк▓рк┐ркХ URL ркирлА ркЬрк░рлВрк░ ркЫрлЗ
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const ACCESS_GRANTED_DAYS = 45;
        
        // ЁЯЪи ркЕрк╣рлАркВркпрк╛ ркдркорк╛рк░рлА ркЕрк╕рк▓рлА Anon Key ркорлВркХрлЛ (рккркмрлНрк▓рк┐ркХ рк╣рлЛрк╡рк╛ркерлА, ркдрлЗ Edge Function ркорк╛ркВ рк░рк╛ркЦрк╡рк╛ркирлА ркЬрк░рлВрк░ ркиркерлА)
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4'; 

        // ЁЯОп Edge Function URL (ркЬрлЗ Razorpay Key ID рккрк░ркд ркорлЛркХрк▓рк╢рлЗ)
        const API_ORDER_URL = `${SUPABASE_URL}/functions/v1/create-order`;

        // Supabase Client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUserId = null; 
        
        /**
         * рлз. Supabase Auth ркжрлНрк╡рк╛рк░рк╛ ркпрлБркЭрк░ркирлБркВ рк╕рлНркЯрлЗркЯрк╕ ркЪрлЗркХ ркХрк░рк╡рлБркВ
         */
        async function checkAuthAndAccess() {
            const loadingDiv = document.getElementById('loading-div');
            const contentDiv = document.getElementById('content-div');
            const userNameSpan = document.getElementById('user-name');

            try {
                // Auth ркЪрлЗркХ
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    alert('ркдркорлЗ рк▓рлЙркЧрк┐рки ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЙркЧрк┐рки ркХрк░рлЛ.');
                    window.location.href = 'https://kapilainstitute.vercel.app/login'; 
                    return;
                }

                currentUserId = user.id;
                userNameSpan.textContent = user.user_metadata?.full_name || user.email || 'User';

                // ркПркХрлНрк╕рлЗрк╕ ркЪрлЗркХ (user_access ркЯрлЗркмрк▓ркорк╛ркВркерлА)
                // RLS Policy ркжрлНрк╡рк╛рк░рк╛ ркорк╛ркдрлНрк░ ркЖ ркпрлБркЭрк░ркирлЛ ркбрлЗркЯрк╛ ркорк│рк╢рлЗ
                const { data: accessData, error: accessError } = await supabase
                    .from('user_access')
                    .select('expires_at')
                    .eq('user_id', currentUserId)
                    .eq('plan_name', 'Mock_Test_45_Days')
                    .eq('is_active', true)
                    .gt('expires_at', new Date().toISOString()) 
                    .maybeSingle(); 

                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';

                if (accessError && accessError.code !== 'PGRST116') { 
                    console.error('Access Fetch Error:', accessError);
                    contentDiv.innerHTML = '<p style="color: red;">ркПркХрлНрк╕рлЗрк╕ ркЪрлЗркХ ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА. рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.</p>';
                } else if (accessData) {
                    // тЬЕ ркПркХрлНрк╕рлЗрк╕ ркЫрлЗ
                    const expiryDate = new Date(accessData.expires_at).toLocaleDateString('gu-IN');
                    renderAccessGranted(expiryDate);
                } else {
                    // тЭМ ркПркХрлНрк╕рлЗрк╕ ркиркерлА
                    renderPaymentRequired();
                }

            } catch (error) {
                console.error('System Error:', error);
                loadingDiv.style.display = 'none';
                contentDiv.innerHTML = '<p style="color: red;">рк╕рк┐рк╕рлНркЯрко рк▓рлЛркб ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА. ркирлЗркЯрк╡рк░рлНркХ ркЪрлЗркХ ркХрк░рлЛ.</p>';
            }
        }

        // ... (renderAccessGranted ркЕркирлЗ renderPaymentRequired Functions ркП ркЬ рк░рк╣рлЗрк╢рлЗ) ...
        function renderAccessGranted(expiryDate) {
            const contentDiv = document.getElementById('content-div');
            contentDiv.innerHTML = `
                <div class="purchased-status">тЬЕ Access Purchased!</div>
                <p>ркдркорк╛рк░рлА ркПркХрлНрк╕рлЗрк╕ркирлА ркорлБркжркд: <strong>${expiryDate}</strong> рк╕рлБркзрлА ркЫрлЗ.</p>
                <hr>
                <h2>Mock Test рк▓рк┐ркВркХрлНрк╕</h2>
                <div class="mock-test-list">
                    <a href="/mock-test-1.html">Mock Test 1</a>
                    <a href="/mock-test-2.html">Mock Test 2</a>
                    <a href="/mock-test-3.html">Mock Test 3</a>
                    <a href="/mock-test-4.html">Mock Test 4</a>
                    <a href="/mock-test-5.html">Mock Test 5</a>
                </div>
            `;
        }

        function renderPaymentRequired() {
            const contentDiv = document.getElementById('content-div');
            contentDiv.innerHTML = `
                <h2>Mock Test Access</h2>
                <p>тВ╣1 ркорк╛ркВ ${ACCESS_GRANTED_DAYS} ркжрк┐рк╡рк╕ ркорк╛ркЯрлЗ Mock Test Access ркорлЗрк│рк╡рлЛ.</p>
                <p>ркЖ ркПркХ рк╡рки-ркЯрк╛ркЗрко рккрлЗркорлЗркирлНркЯ ркЫрлЗ.</p>
                <button id="buy-now-btn">ркЦрк░рлАркжрлЛ (тВ╣1)</button>
            `;
            document.getElementById('buy-now-btn').addEventListener('click', startPayment);
        }

        /**
         * рлк. Razorpay рккрлЗркорлЗркирлНркЯ рк╢рк░рлВ ркХрк░рк╡рлБркВ
         */
        async function startPayment() {
            if (!currentUserId) {
                alert('ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЙркЧрк┐рки ркХрк░рлЛ.');
                return;
            }

            const btn = document.getElementById('buy-now-btn');
            btn.disabled = true;
            btn.textContent = 'ркУрк░рлНркбрк░ ркмркирлА рк░рк╣рлНркпрлЛ ркЫрлЗ...';

            try {
                // Supabase Edge Function ркирлЗ ркХрлЙрк▓ ркХрк░рлАркирлЗ Order ID ркЕркирлЗ Key ID ркорлЗрк│рк╡рлЛ
                const response = await fetch(API_ORDER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUserId }) // ркпрлБркЭрк░ ID ркмрлЗркХркПркирлНркбркирлЗ ркорлЛркХрк▓рлЛ
                });

                const data = await response.json();

                if (data.error || !data.orderId || !data.keyId) {
                    alert('ркУрк░рлНркбрк░ ркмркирк╛рк╡рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА.');
                    console.error('Edge Function Error:', data.error);
                    btn.textContent = 'ркЦрк░рлАркжрлЛ (тВ╣1)';
                    btn.disabled = false;
                    return;
                }

                // Razorpay Options
                const options = {
                    key: data.keyId, // ЁЯФС Key ID Edge Function ркорк╛ркВркерлА рк╕рлБрк░ркХрлНрк╖рк┐ркд рк░рлАркдрлЗ ркЖрк╡рлНркпрлБркВ
                    amount: data.amount, 
                    order_id: data.orderId, 
                    currency: 'INR',
                    name: 'STI Mock Test Access',
                    description: '45 Days Mock Test Plan',
                    handler: function (response) {
                        alert('рккрлЗркорлЗркирлНркЯ рк╕рклрк│! ркдркорк╛рк░рлЛ ркПркХрлНрк╕рлЗрк╕ ркерлЛркбрлАрк╡рк╛рк░ркорк╛ркВ ркЕрккркбрлЗркЯ ркеркИ ркЬрк╢рлЗ.');
                        btn.textContent = 'ркХркирлНрклрк░рлНркорлЗрк╢рки ркмрк╛ркХрлА ркЫрлЗ...';
                        
                        // Webhook ркжрлНрк╡рк╛рк░рк╛ DB ркЕрккркбрлЗркЯ ркеркпрк╛ рккркЫрлА рк░рлАрк▓рлЛркб ркХрк░рлЛ
                        setTimeout(() => {
                            window.location.reload(); 
                        }, 5000); 
                    },
                    prefill: {
                        email: (await supabase.auth.getUser()).data.user.email,
                    },
                    modal: {
                        ondismiss: function() {
                            alert('рккрлЗркорлЗркирлНркЯ рк░ркж ркХрк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлНркпрлБркВ.');
                            btn.textContent = 'ркЦрк░рлАркжрлЛ (тВ╣1)';
                            btn.disabled = false;
                        }
                    }
                };
                
                const rzp = new Razorpay(options);
                rzp.open();

            } catch (error) {
                console.error('Payment initiation failed:', error);
                alert('рккрлЗркорлЗркирлНркЯ рк╢рк░рлВ ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА.');
                btn.textContent = 'ркЦрк░рлАркжрлЛ (тВ╣1)';
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', checkAuthAndAccess);
    </script>

</body>
</html>
