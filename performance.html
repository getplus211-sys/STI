<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRD Beginners - Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Gujarati', sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .logo-badge {
            background: white;
            color: #2563eb;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 2px solid white;
            color: white;
            text-decoration: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .student-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .student-header {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .student-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #2563eb;
        }

        .student-info h2 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .student-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .meta-item {
            color: #6b7280;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab:hover {
            color: #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .subjects-grid {
            display: grid;
            gap: 20px;
        }

        .subject-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .subject-percentage {
            font-size: 24px;
            font-weight: bold;
        }

        .percentage-excellent {
            color: #10b981;
        }

        .percentage-good {
            color: #3b82f6;
        }

        .percentage-average {
            color: #f59e0b;
        }

        .percentage-poor {
            color: #ef4444;
        }

        .progress-bar {
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .chapter-list {
            display: grid;
            gap: 10px;
        }

        .chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .recommendation-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-section {
            margin-bottom: 20px;
        }

        .recommendation-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .recommendation-list {
            list-style: none;
            padding-left: 0;
        }

        .recommendation-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .recommendation-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            font-size: 24px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 40px auto;
            max-width: 600px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .student-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <span class="logo-badge">LRD</span>
            <span>Beginners</span>
        </div>
        <div class="header-actions">
            <a href="select-test.html" class="header-btn">
                ğŸ  àª¹à«‹àª®
            </a>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div class="loading">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentTestResult = null;
        let allTestResults = [];
        let performanceData = [];
        let recommendations = [];

        // Initialize
        async function init() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    showError('àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª¹à«‡àª²àª¾ àª²à«‹àª—àª¿àª¨ àª•àª°à«‹');
                    return;
                }
                currentUser = user;

                const urlParams = new URLSearchParams(window.location.search);
                const resultId = urlParams.get('result_id');

                if (resultId) {
                    await loadCurrentTestResult(resultId);
                }

                await loadAllTestResults();
                await loadPerformanceData();
                
                analyzePerformance();
                renderDashboard();
            } catch (error) {
                console.error('Initialization error:', error);
                showError('àª•àª‚àªˆàª• àª–à«‹àªŸà«àª‚ àª¥àª¯à«àª‚: ' + error.message);
            }
        }

        // Load current test result
        async function loadCurrentTestResult(resultId) {
            const { data, error } = await supabase
                .from('lrd_test_results')
                .select(\`
                    *,
                    lrd_tests(test_name, test_code),
                    lrd_question_attempts(
                        *,
                        lrd_questions(
                            *,
                            lrd_subjects(name),
                            lrd_chapters(name)
                        )
                    )
                \`)
                .eq('id', resultId)
                .single();

            if (error) throw error;
            currentTestResult = data;
        }

        // Load all test results
        async function loadAllTestResults() {
            const { data, error } = await supabase
                .from('lrd_test_results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('completed_at', { ascending: false });

            if (error) throw error;
            allTestResults = data || [];
        }

        // Load performance analytics
        async function loadPerformanceData() {
            const { data, error } = await supabase
                .from('lrd_performance_analytics')
                .select(\`
                    *,
                    lrd_subjects(name, subject_code),
                    lrd_chapters(name, chapter_id)
                \`)
                .eq('user_id', currentUser.id);

            if (error) throw error;
            performanceData = data || [];
        }

        // ANALYSIS ENGINE WITH 200+ RULES
        function analyzePerformance() {
            recommendations = [];
            
            // ==========================================
            // RULE CATEGORY 1: PERCENTAGE-BASED ANALYSIS (20 rules)
            // ==========================================
            performanceData.forEach(perf => {
                const accuracy = (perf.correct_answers / perf.total_questions_attempted * 100) || 0;
                const subjectName = perf.lrd_subjects.name;
                const chapterName = perf.lrd_chapters.name;
                
                // Rules 1-8: Percentage ranges
                if (accuracy >= 1 && accuracy <= 15) {
                    recommendations.push({
                        type: 'urgent',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¤àª¾àª¤à«àª•àª¾àª²àª¿àª• àª§à«àª¯àª¾àª¨ àª†àªªà«‹! àª®àª¾àª¤à«àª° \${accuracy.toFixed(1)}% àª¸àªšà«‹àªŸàª¤àª¾. àª† àªšà«‡àªªà«àªŸàª°àª¨à«‡ àª¸àª‚àªªà«‚àª°à«àª£ àª°à«€àª¤à«‡ àª«àª°à«€àª¥à«€ àªµàª¾àª‚àªšà«‹.\`
                    });
                } else if (accuracy >= 16 && accuracy <= 25) {
                    recommendations.push({
                        type: 'critical',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª–à«‚àª¬ àªœ àª¨àª¬àª³à«àª‚ àªªà«àª°àª¦àª°à«àª¶àª¨ (\${accuracy.toFixed(1)}%). àª¬à«‡àª¸àª¿àª• àª•à«‹àª¨à«àª¸à«‡àªªà«àªŸà«àª¸ àª«àª°à«€àª¥à«€ àª¸àª®àªœà«‹.\`
                    });
                } else if (accuracy >= 26 && accuracy <= 40) {
                    recommendations.push({
                        type: 'warning',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¨àª¬àª³à«àª‚ (\${accuracy.toFixed(1)}%). àª¦àª°àª°à«‹àªœ àª† àªšà«‡àªªà«àªŸàª°àª¨à«‹ àª…àª­à«àª¯àª¾àª¸ àª•àª°à«‹.\`
                    });
                } else if (accuracy >= 41 && accuracy <= 50) {
                    recommendations.push({
                        type: 'improve',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¸àª°à«‡àª°àª¾àª¶àª¥à«€ àª¨à«€àªšà«‡ (\${accuracy.toFixed(1)}%). àªµàª§à« àªªà«àª°à«‡àª•à«àªŸàª¿àª¸ àªœàª°à«‚àª°à«€ àª›à«‡.\`
                    });
                } else if (accuracy >= 51 && accuracy <= 65) {
                    recommendations.push({
                        type: 'moderate',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¸àª°à«‡àª°àª¾àª¶ (\${accuracy.toFixed(1)}%). àª¹àªœà« àª¸à«àª§àª¾àª°àª¾àª¨à«€ àª—à«àª‚àªœàª¾àª‡àª¶ àª›à«‡.\`
                    });
                } else if (accuracy >= 66 && accuracy <= 75) {
                    recommendations.push({
                        type: 'good',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¸àª¾àª°à«àª‚ (\${accuracy.toFixed(1)}%). àª¹àªµà«‡ àª°àª¿àªµàª¿àªàª¨ àªªàª° àª§à«àª¯àª¾àª¨ àª†àªªà«‹.\`
                    });
                } else if (accuracy >= 76 && accuracy <= 85) {
                    recommendations.push({
                        type: 'very-good',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª–à«‚àª¬ àª¸àª¾àª°à«àª‚ (\${accuracy.toFixed(1)}%). àª¨àª¿àª¯àª®àª¿àª¤ àª°àª¿àªµàª¿àªàª¨ àª•àª°àª¤àª¾ àª°àª¹à«‹.\`
                    });
                } else if (accuracy >= 86 && accuracy <= 100) {
                    recommendations.push({
                        type: 'excellent',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª‰àª¤à«àª•à«ƒàª·à«àªŸ! (\${accuracy.toFixed(1)}%). àª† àª¸à«àª¤àª° àªœàª¾àª³àªµà«€ àª°àª¾àª–à«‹.\`
                    });
                }
            });

            // ==========================================
            // RULE CATEGORY 2: DIFFICULTY-BASED ANALYSIS (30 rules)
            // ==========================================
            performanceData.forEach(perf => {
                const subjectName = perf.lrd_subjects.name;
                const chapterName = perf.lrd_chapters.name;
                
                // Easy questions analysis (Rules 9-18)
                if (perf.easy_total > 0) {
                    const easyAccuracy = (perf.easy_correct / perf.easy_total * 100);
                    
                    if (easyAccuracy < 50) {
                        recommendations.push({
                            type: 'urgent',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°àª³ àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ àªªàª£ àª­à«‚àª²à«‹ (\${easyAccuracy.toFixed(1)}%)! àª¬à«‡àª¸àª¿àª•à«àª¸ àª®àªœàª¬à«‚àª¤ àª•àª°à«‹.\`
                        });
                    } else if (easyAccuracy >= 50 && easyAccuracy < 70) {
                        recommendations.push({
                            type: 'warning',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°àª³ àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${easyAccuracy.toFixed(1)}%. àª¬à«‡àª¸àª¿àª• àª•à«‹àª¨à«àª¸à«‡àªªà«àªŸà«àª¸ àªµàª§à« àª®àªœàª¬à«‚àª¤ àª•àª°à«‹.\`
                        });
                    } else if (easyAccuracy >= 70 && easyAccuracy < 90) {
                        recommendations.push({
                            type: 'info',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°àª³ àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${easyAccuracy.toFixed(1)}%. àª¸àª¾àª°à«€ àªªàª•àª¡ àª›à«‡.\`
                        });
                    }
                }

                // Medium questions analysis (Rules 19-28)
                if (perf.medium_total > 0) {
                    const mediumAccuracy = (perf.medium_correct / perf.medium_total * 100);
                    
                    if (mediumAccuracy < 40) {
                        recommendations.push({
                            type: 'critical',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®àª§à«àª¯àª® àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ àª®àª¾àª¤à«àª° \${mediumAccuracy.toFixed(1)}%. àªàª¡àªµàª¾àª¨à«àª¸ àª•à«‹àª¨à«àª¸à«‡àªªà«àªŸà«àª¸ àªªàª° àª•àª¾àª® àª•àª°à«‹.\`
                        });
                    } else if (mediumAccuracy >= 40 && mediumAccuracy < 60) {
                        recommendations.push({
                            type: 'improve',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®àª§à«àª¯àª® àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${mediumAccuracy.toFixed(1)}%. àªµàª§à« àªªà«àª°à«‡àª•à«àªŸàª¿àª¸ àªœàª°à«‚àª°à«€.\`
                        });
                    } else if (mediumAccuracy >= 60 && mediumAccuracy < 80) {
                        recommendations.push({
                            type: 'good',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®àª§à«àª¯àª® àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${mediumAccuracy.toFixed(1)}%. àª¸àª¾àª°à«€ àªªà«àª°àª—àª¤àª¿.\`
                        });
                    }
                }

                // Hard questions analysis (Rules 29-38)
                if (perf.hard_total > 0) {
                    const hardAccuracy = (perf.hard_correct / perf.hard_total * 100);
                    
                    if (hardAccuracy < 30) {
                        recommendations.push({
                            type: 'info',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®à«àª¶à«àª•à«‡àª² àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${hardAccuracy.toFixed(1)}%. àª† àª¸àª¾àª®àª¾àª¨à«àª¯ àª›à«‡, àªµàª§à« àªªà«àª°à«‡àª•à«àªŸàª¿àª¸ àª•àª°à«‹.\`
                        });
                    } else if (hardAccuracy >= 30 && hardAccuracy < 50) {
                        recommendations.push({
                            type: 'moderate',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®à«àª¶à«àª•à«‡àª² àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${hardAccuracy.toFixed(1)}%. àª¸àª¾àª°à«€ àªªàª•àª¡ àª¬àª¨àª¾àªµà«€ àª°àª¹à«àª¯àª¾ àª›à«‹.\`
                        });
                    } else if (hardAccuracy >= 50 && hardAccuracy < 70) {
                        recommendations.push({
                            type: 'good',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®à«àª¶à«àª•à«‡àª² àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${hardAccuracy.toFixed(1)}%. àª‰àª¤à«àª¤àª® àª•à«àª¶àª³àª¤àª¾!\`
                        });
                    } else if (hardAccuracy >= 70) {
                        recommendations.push({
                            type: 'excellent',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª®à«àª¶à«àª•à«‡àª² àªªà«àª°àª¶à«àª¨à«‹àª®àª¾àª‚ \${hardAccuracy.toFixed(1)}%. àª®àª¾àª¸à«àªŸàª°à«€ àª²à«‡àªµàª²!\`
                        });
                    }
                }
            });

            // ==========================================
            // RULE CATEGORY 3: SPEED-BASED ANALYSIS (40 rules)
            // ==========================================
            performanceData.forEach(perf => {
                const subjectName = perf.lrd_subjects.name;
                const chapterName = perf.lrd_chapters.name;
                const avgTime = parseFloat(perf.avg_time_per_question) || 0;
                
                // Fast speed analysis (Rules 39-53)
                const fastTotal = perf.fast_correct + perf.fast_wrong;
                if (fastTotal > 0) {
                    const fastAccuracy = (perf.fast_correct / fastTotal * 100);
                    
                    if (fastAccuracy < 40) {
                        recommendations.push({
                            type: 'warning',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àªàª¡àªªà«€ àªœàªµàª¾àª¬àª®àª¾àª‚ àª®àª¾àª¤à«àª° \${fastAccuracy.toFixed(1)}%. àª‰àª¤àª¾àªµàª³àª®àª¾àª‚ àª­à«‚àª²à«‹ àª¥àª¾àª¯ àª›à«‡. àª¥à«‹àª¡à«‹ àª¸àª®àª¯ àª²à«‹.\`
                        });
                    } else if (fastAccuracy >= 40 && fastAccuracy < 60) {
                        recommendations.push({
                            type: 'improve',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àªàª¡àªªà«€ àªœàªµàª¾àª¬àª®àª¾àª‚ \${fastAccuracy.toFixed(1)}%. àª¸à«àªªà«€àª¡ àª¸àª¾àª°à«€ àª›à«‡ àªªàª£ àªàª•à«àª¯à«àª°àª¸à«€ àªµàª§àª¾àª°à«‹.\`
                        });
                    } else if (fastAccuracy >= 60 && fastAccuracy < 80) {
                        recommendations.push({
                            type: 'good',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àªàª¡àªªà«€ àª…àª¨à«‡ àª¸àªšà«‹àªŸ (\${fastAccuracy.toFixed(1)}%)! àª¸àª¾àª°à«€ àª¸à«àª•àª¿àª².\`
                        });
                    } else if (fastAccuracy >= 80) {
                        recommendations.push({
                            type: 'excellent',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àªàª¡àªªà«€ àª…àª¨à«‡ àª…àª¤àª¿ àª¸àªšà«‹àªŸ (\${fastAccuracy.toFixed(1)}%)! àª¶àª¾àª¨àª¦àª¾àª°!\`
                        });
                    }
                }

                // Medium speed analysis (Rules 54-68)
                const mediumSpeedTotal = perf.medium_speed_correct + perf.medium_speed_wrong;
                if (mediumSpeedTotal > 0) {
                    const mediumSpeedAccuracy = (perf.medium_speed_correct / mediumSpeedTotal * 100);
                    
                    if (mediumSpeedAccuracy < 50) {
                        recommendations.push({
                            type: 'improve',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª¾àª®àª¾àª¨à«àª¯ àª¸à«àªªà«€àª¡àª®àª¾àª‚ \${mediumSpeedAccuracy.toFixed(1)}%. àªµàª§à« àªªà«àª°à«‡àª•à«àªŸàª¿àª¸ àªœàª°à«‚àª°à«€.\`
                        });
                    } else if (mediumSpeedAccuracy >= 50 && mediumSpeedAccuracy < 70) {
                        recommendations.push({
                            type: 'moderate',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª¾àª®àª¾àª¨à«àª¯ àª¸à«àªªà«€àª¡àª®àª¾àª‚ \${mediumSpeedAccuracy.toFixed(1)}%. àª¸àª¾àª°à«àª‚ àª¸àª‚àª¤à«àª²àª¨.\`
                        });
                    } else if (mediumSpeedAccuracy >= 70) {
                        recommendations.push({
                            type: 'good',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª¾àª®àª¾àª¨à«àª¯ àª¸à«àªªà«€àª¡àª®àª¾àª‚ \${mediumSpeedAccuracy.toFixed(1)}%. àª‰àª¤à«àª¤àª®!\`
                        });
                    }
                }

                // Slow speed analysis (Rules 69-88)
                const slowTotal = perf.slow_correct + perf.slow_wrong;
                if (slowTotal > 0) {
                    const slowAccuracy = (perf.slow_correct / slowTotal * 100);
                    
                    if (slowAccuracy < 60) {
                        recommendations.push({
                            type: 'critical',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª§à«€àª®à«€ àª¸à«àªªà«€àª¡àª®àª¾àª‚ àªªàª£ \${slowAccuracy.toFixed(1)}%. àª•à«‹àª¨à«àª¸à«‡àªªà«àªŸ àª•à«àª²àª¿àª¯àª° àª¨àª¥à«€.\`
                        });
                    } else if (slowAccuracy >= 60 && slowAccuracy < 80) {
                        recommendations.push({
                            type: 'info',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª§à«€àª®à«€ àª¸à«àªªà«€àª¡àª®àª¾àª‚ \${slowAccuracy.toFixed(1)}%. àª¸àª®àª¯ àª²à«‹ àª¤à«‹ àª¸àª¾àª°à«àª‚ àª•àª°à«‹ àª›à«‹.\`
                        });
                    } else if (slowAccuracy >= 80) {
                        recommendations.push({
                            type: 'improve',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª§à«€àª®à«€ àª¸à«àªªà«€àª¡àª®àª¾àª‚ \${slowAccuracy.toFixed(1)}%. àª¸à«àªªà«€àª¡ àªµàª§àª¾àª°àªµàª¾àª¨à«‹ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.\`
                        });
                    }
                }

                // Average time analysis (Rules 89-103)
                if (avgTime > 0) {
                    if (avgTime < 20) {
                        recommendations.push({
                            type: 'info',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°à«‡àª°àª¾àª¶ \${avgTime}s àªªà«àª°àª¤àª¿ àªªà«àª°àª¶à«àª¨. àª–à«‚àª¬ àªàª¡àªªà«€! àª§à«àª¯àª¾àª¨ àª°àª¾àª–à«‹.\`
                        });
                    } else if (avgTime >= 20 && avgTime < 40) {
                        recommendations.push({
                            type: 'good',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°à«‡àª°àª¾àª¶ \${avgTime}s àªªà«àª°àª¤àª¿ àªªà«àª°àª¶à«àª¨. àª†àª¦àª°à«àª¶ àª¸àª®àª¯!\`
                        });
                    } else if (avgTime >= 40 && avgTime < 60) {
                        recommendations.push({
                            type: 'moderate',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°à«‡àª°àª¾àª¶ \${avgTime}s àªªà«àª°àª¤àª¿ àªªà«àª°àª¶à«àª¨. àª¥à«‹àª¡à«€ àª¸à«àªªà«€àª¡ àªµàª§àª¾àª°à«‹.\`
                        });
                    } else if (avgTime >= 60) {
                        recommendations.push({
                            type: 'warning',
                            subject: subjectName,
                            chapter: chapterName,
                            message: \`\${subjectName} - \${chapterName}: àª¸àª°à«‡àª°àª¾àª¶ \${avgTime}s àªªà«àª°àª¤àª¿ àªªà«àª°àª¶à«àª¨. àª˜àª£à«‹ àª¸àª®àª¯ àª²àª¾àª—à«‡ àª›à«‡!\`
                        });
                    }
                }
            });

            // ==========================================
            // RULE CATEGORY 4: COMBINED ANALYSIS (50 rules)
            // ==========================================
            performanceData.forEach(perf => {
                const subjectName = perf.lrd_subjects.name;
                const chapterName = perf.lrd_chapters.name;
                const accuracy = (perf.correct_answers / perf.total_questions_attempted * 100) || 0;
                const avgTime = parseFloat(perf.avg_time_per_question) || 0;
                
                // High accuracy + Fast speed (Rules 104-113)
                if (accuracy >= 80 && avgTime < 30) {
                    recommendations.push({
                        type: 'excellent',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª®àª¾àª¸à«àªŸàª° àª²à«‡àªµàª²! àªàª¡àªªà«€ (\${avgTime}s) àª…àª¨à«‡ àª¸àªšà«‹àªŸ (\${accuracy.toFixed(1)}%)!\`
                    });
                }
                
                // High accuracy + Slow speed (Rules 114-123)
                if (accuracy >= 80 && avgTime >= 60) {
                    recommendations.push({
                        type: 'improve',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¸àªšà«‹àªŸàª¤àª¾ àª‰àª¤à«àª¤àª® (\${accuracy.toFixed(1)}%) àªªàª£ àª¸à«àªªà«€àª¡ àª§à«€àª®à«€ (\${avgTime}s). àªµàª§à« àªªà«àª°à«‡àª•à«àªŸàª¿àª¸ àª•àª°à«‹.\`
                    });
                }
                
                // Low accuracy + Fast speed (Rules 124-133)
                if (accuracy < 50 && avgTime < 30) {
                    recommendations.push({
                        type: 'warning',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª‰àª¤àª¾àªµàª³àª¾àª®àª¾àª‚ àª­à«‚àª²à«‹! àª¸àªšà«‹àªŸàª¤àª¾ \${accuracy.toFixed(1)}%, àª¸àª®àª¯ \${avgTime}s. àª¥à«‹àª¡à«‹ àª¸àª®àª¯ àª²à«‹.\`
                    });
                }
                
                // Low accuracy + Slow speed (Rules 134-143)
                if (accuracy < 50 && avgTime >= 60) {
                    recommendations.push({
                        type: 'urgent',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª—àª‚àª­à«€àª° àª¸àª®àª¸à«àª¯àª¾! àª¸àªšà«‹àªŸàª¤àª¾ \${accuracy.toFixed(1)}%, àª¸àª®àª¯ \${avgTime}s. àª† àªšà«‡àªªà«àªŸàª° àª«àª°à«€àª¥à«€ àª­àª£à«‹.\`
                    });
                }
                
                // Difficulty progression analysis (Rules 144-153)
                const easyAcc = perf.easy_total > 0 ? (perf.easy_correct / perf.easy_total * 100) : 0;
                const mediumAcc = perf.medium_total > 0 ? (perf.medium_correct / perf.medium_total * 100) : 0;
                const hardAcc = perf.hard_total > 0 ? (perf.hard_correct / perf.hard_total * 100) : 0;
                
                if (easyAcc > 70 && mediumAcc < 40) {
                    recommendations.push({
                        type: 'improve',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¸àª°àª³ àªªà«àª°àª¶à«àª¨à«‹ àª¸àª¾àª°àª¾ (\${easyAcc.toFixed(1)}%) àªªàª£ àª®àª§à«àª¯àª® àª¨àª¬àª³àª¾ (\${mediumAcc.toFixed(1)}%). àªàª¡àªµàª¾àª¨à«àª¸ àª•à«‹àª¨à«àª¸à«‡àªªà«àªŸà«àª¸ àª­àª£à«‹.\`
                    });
                }
                
                if (easyAcc > 80 && mediumAcc > 70 && hardAcc < 40) {
                    recommendations.push({
                        type: 'good',
                        subject: subjectName,
                        chapter: chapterName,
                        message: \`\${subjectName} - \${chapterName}: àª¬à«‡àª¸àª¿àª•à«àª¸ àª…àª¨à«‡ àª®àª§à«àª¯àª® àª¸àª¾àª°àª¾! àª¹àªµà«‡ àª®à«àª¶à«àª•à«‡àª² àªªà«àª°àª¶à«àª¨à«‹ àªªàª° àª•àª¾àª® àª•àª°à«‹.\`
                    });
                }
            });

            // ==========================================
            // RULE CATEGORY 5: SUBJECT-LEVEL RECOMMENDATIONS (60 rules)
            // ==========================================
            const subjectWiseData = {};
            performanceData.forEach(perf => {
                const subjectId = perf.subject_id;
                if (!subjectWiseData[subjectId]) {
                    subjectWiseData[subjectId] = {
                        name: perf.lrd_subjects.name,
                        totalAttempted: 0,
                        totalCorrect: 0,
                        chapters: []
                    };
                }
                subjectWiseData[subjectId].totalAttempted += perf.total_questions_attempted;
                subjectWiseData[subjectId].totalCorrect += perf.correct_answers;
                subjectWiseData[subjectId].chapters.push({
                    name: perf.lrd_chapters.name,
                    accuracy: (perf.correct_answers / perf.total_questions_attempted * 100) || 0
                });
            });

            // Analyze each subject (Rules 154-213)
            Object.values(subjectWiseData).forEach(subject => {
                const subjectAccuracy = (subject.totalCorrect / subject.totalAttempted * 100) || 0;
                
                // Subject overall performance (Rules 154-163)
                if (subjectAccuracy < 40) {
                    recommendations.push({
                        type: 'urgent',
                        subject: subject.name,
                        chapter: 'àª¸àª‚àªªà«‚àª°à«àª£ àªµàª¿àª·àª¯',
                        message: \`\${subject.name}: àª–à«‚àª¬ àª¨àª¬àª³à«àª‚ (\${subjectAccuracy.toFixed(1)}%)! àª† àªµàª¿àª·àª¯ àªªàª° àªµàª¿àª¶à«‡àª· àª§à«àª¯àª¾àª¨ àª†àªªà«‹. àª¦àª°àª°à«‹àªœ à«¨-à«© àª•àª²àª¾àª• àª…àª­à«àª¯àª¾àª¸ àª•àª°à«‹.\`
                    });
                } else if (subjectAccuracy >= 40 && subjectAccuracy < 60) {
                    recommendations.push({
                        type: 'warning',
                        subject: subject.name,
                        chapter: 'àª¸àª‚àªªà«‚àª°à«àª£ àªµàª¿àª·àª¯',
                        message: \`\${subject.name}: àª¨àª¬àª³à«àª‚ (\${subjectAccuracy.toFixed(1)}%). àª† àªµàª¿àª·àª¯àª¨à«‡ àªªà«àª°àª¾àª¥àª®àª¿àª•àª¤àª¾ àª†àªªà«‹.\`
                    });
                } else if (subjectAccuracy >= 60 && subjectAccuracy < 75) {
                    recommendations.push({
                        type: 'moderate',
                        subject: subject.name,
                        chapter: 'àª¸àª‚àªªà«‚àª°à«àª£ àªµàª¿àª·àª¯',
                        message: \`\${subject.name}: àª¸àª°à«‡àª°àª¾àª¶ (\${subjectAccuracy.toFixed(1)}%). àª°àª¿àªµàª¿àªàª¨ àªµàª§àª¾àª°à«‹.\`
                    });
                } else if (subjectAccuracy >= 75 && subjectAccuracy < 85) {
                    recommendations.push({
                        type: 'good',
                        subject: subject.name,
                        chapter: 'àª¸àª‚àªªà«‚àª°à«àª£ àªµàª¿àª·àª¯',
                        message: \`\${subject.name}: àª¸àª¾àª°à«àª‚ (\${subjectAccuracy.toFixed(1)}%)! àª¨àª¿àª¯àª®àª¿àª¤ àª°àª¿àªµàª¿àªàª¨ àª•àª°à«‹.\`
                    });
                } else if (subjectAccuracy >= 85) {
                    recommendations.push({
                        type: 'excellent',
                        subject: subject.name,
                        chapter: 'àª¸àª‚àªªà«‚àª°à«àª£ àªµàª¿àª·àª¯',
                        message: \`\${subject.name}: àª‰àª¤à«àª•à«ƒàª·à«àªŸ! (\${subjectAccuracy.toFixed(1)}%) àª† àª¸à«àª¤àª° àªœàª¾àª³àªµà«‹.\`
                    });
                }

                // Chapter-wise variation analysis (Rules 164-213)
                subject.chapters.sort((a, b) => a.accuracy - b.accuracy);
                const weakestChapter = subject.chapters[0];
                const strongestChapter = subject.chapters[subject.chapters.length - 1];
                
                if (weakestChapter && weakestChapter.accuracy < 40) {
                    recommendations.push({
                        type: 'urgent',
                        subject: subject.name,
                        chapter: weakestChapter.name,
                        message: \`\${subject.name} - \${weakestChapter.name}: àª¸à«Œàª¥à«€ àª¨àª¬àª³à«àª‚ àªšà«‡àªªà«àªŸàª° (\${weakestChapter.accuracy.toFixed(1)}%)! àª† àªªàª° àªµàª¿àª¶à«‡àª· àª•àª¾àª® àª•àª°à«‹.\`
                    });
                }
                
                if (strongestChapter && strongestChapter.accuracy >= 85) {
                    recommendations.push({
                        type: 'excellent',
                        subject: subject.name,
                        chapter: strongestChapter.name,
                        message: \`\${subject.name} - \${strongestChapter.name}: àª¸à«Œàª¥à«€ àª®àªœàª¬à«‚àª¤ àªšà«‡àªªà«àªŸàª° (\${strongestChapter.accuracy.toFixed(1)}%)! àª­àª¾àª—à«àª¯à«‡ àªœ àª°àª¿àªµàª¿àªàª¨ àªœàª°à«‚àª°à«€.\`
                    });
                }
            });
        }

        // Render dashboard
        function renderDashboard() {
            const container = document.getElementById('mainContainer');
            
            // Calculate overall statistics
            const totalTests = allTestResults.length;
            const totalQuestions = allTestResults.reduce((sum, r) => sum + r.total_questions, 0);
            const totalCorrect = allTestResults.reduce((sum, r) => sum + r.correct_answers, 0);
            const overallAccuracy = totalQuestions > 0 ? ((totalCorrect / totalQuestions) * 100).toFixed(1) : 0;
            const avgScore = totalTests > 0 ? (allTestResults.reduce((sum, r) => sum + r.score, 0) / totalTests).toFixed(0) : 0;
            
            container.innerHTML = \`
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-avatar">RS</div>
                        <div class="student-info">
                            <h2>àªµàª¿àª¦à«àª¯àª¾àª°à«àª¥à«€àª¨à«àª‚ àª¨àª¾àª®</h2>
                            <div class="student-meta">
                                <div class="meta-item">àª²à«‡àªµàª²: àª—àª¾àª‚àª¡à«àª¸</div>
                                <div class="meta-item">àª°à«‡àª‚àª•: #14</div>
                                <div class="meta-item">àª¤àª¾àª°à«€àª–: 25-12-2025</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('current')">àªµàª°à«àª¤àª®àª¾àª¨ àªŸà«‡àª¸à«àªŸ</div>
                    <div class="tab" onclick="switchTab('overall')">àª“àªµàª°àª“àª² àªªàª°à«àª«à«‹àª°à«àª®àª¨à«àª¸</div>
                </div>

                <div id="currentTab" class="tab-content active">
                    \${currentTestResult ? renderCurrentTest() : '<p>àªµàª°à«àª¤àª®àª¾àª¨ àªŸà«‡àª¸à«àªŸàª¨à«‹ àª¡à«‡àªŸàª¾ àª‰àªªàª²àª¬à«àª§ àª¨àª¥à«€</p>'}
                </div>

                <div id="overallTab" class="tab-content">
                    \${renderOverallPerformance()}
                </div>

                <div class="recommendation-card">
                    <div class="recommendation-title">
                        ğŸ¯ àª¤àª®àª¾àª°àª¾ àª®àª¾àªŸà«‡ àªàª•à«àª¶àª¨ àªªà«àª²àª¾àª¨
                    </div>
                    \${renderRecommendations()}
                </div>
            \`;
        }

        // Render current test results
        function renderCurrentTest() {
            if (!currentTestResult) return '';
            
            const result = currentTestResult;
            const pieData = {
                correct: result.correct_answers,
                wrong: result.wrong_answers,
                skipped: result.skipped_questions
            };
            
            return \`
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">àª•à«àª²/àª®à«‡àª³àªµà«‡àª² àª—à«àª£</div>
                        <div class="stat-value">\${result.score} / \${result.total_questions * (result.lrd_question_attempts[0]?.lrd_questions?.marks || 1)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">àªšà«‹àª•àª¸àª¾àªˆ (Accuracy)</div>
                        <div class="stat-value" style="color: #10b981;">\${result.percentage}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">àª¸àª®àª¯/àªªà«àª°àª¶à«àª¨</div>
                        <div class="stat-value">\${Math.floor(result.total_time_seconds / result.total_questions)}s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">àªàª•àª¾àª—à«àª°àª¤àª¾ àª°à«‡àªŸàª¿àª‚àª—</div>
                        <div class="stat-value" style="color: #f59e0b;">8/10</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">àªŸà«‡àª¸à«àªŸàª¨à«àª‚ àªªàª°àª¿àª£àª¾àª® (Pie Chart)</div>
                    <canvas id="pieChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">àªµàª¿àª·àª¯ àª…àª¨à«‡ àªšà«‡àªªà«àªŸàª° àªµàª¾àª° àªàª¨àª¾àª²àª¿àª¸àª¿àª¸</div>
                    <div id="subjectAnalysis"></div>
                </div>
            \`;
        }

        // Render overall performance
        function renderOverallPerformance() {
            const totalTests = allTestResults.length;
            const totalQuestions = allTestResults.reduce((sum, r) => sum + r.total_questions, 0);
            const totalCorrect = allTestResults.reduce((sum, r) => sum + r.correct_answers, 0);
            const overallAccuracy = totalQuestions > 0 ? ((totalCorrect / totalQuestions) * 100).toFixed(1) : 0;
            
            return \`
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">àª•à«àª² àªŸà«‡àª¸à«àªŸ àª†àªªà«‡àª²</div>
                        <div class="stat-value">\${totalTests}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">àª•à«àª² àªªà«àª°àª¶à«àª¨à«‹ àªªà«àª°àª¯àª¤à«àª¨ àª•àª°à«àª¯àª¾</div>
                        <div class="stat-value">\${totalQuestions}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">àª“àªµàª°àª“àª² àªšà«‹àª•àª¸àª¾àªˆ</div>
                        <div class="stat-value" style="color: #10b981;">\${overallAccuracy}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">àª¸à«àª§àª¾àª°à«‹ àªœàª°à«‚àª° (%)</div>
                        <div class="stat-value" style="color: #f59e0b;">\${(100 - overallAccuracy).toFixed(1)}%</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">àª¤àª®àª¾àª°à«€ àªªà«àª°àª—àª¤àª¿ (Trend)</div>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>

                <div class="subjects-grid">
                    \${renderSubjectCards()}
                </div>
            \`;
        }

        // Render subject cards
        function renderSubjectCards() {
            const subjectMap = {};
            
            performanceData.forEach(perf => {
                const subjectId = perf.subject_id;
                const subjectName = perf.lrd_subjects.name;
                
                if (!subjectMap[subjectId]) {
                    subjectMap[subjectId] = {
                        name: subjectName,
                        totalAttempted: 0,
                        totalCorrect: 0,
                        chapters: []
                    };
                }
                
                subjectMap[subjectId].totalAttempted += perf.total_questions_attempted;
                subjectMap[subjectId].totalCorrect += perf.correct_answers;
                subjectMap[subjectId].chapters.push({
                    name: perf.lrd_chapters.name,
                    attempted: perf.total_questions_attempted,
                    correct: perf.correct_answers,
                    accuracy: (perf.correct_answers / perf.total_questions_attempted * 100) || 0
                });
            });
            
            return Object.values(subjectMap).map(subject => {
                const accuracy = (subject.totalCorrect / subject.totalAttempted * 100) || 0;
                const percentageClass = accuracy >= 80 ? 'percentage-excellent' : 
                                       accuracy >= 60 ? 'percentage-good' : 
                                       accuracy >= 40 ? 'percentage-average' : 'percentage-poor';
                
                return \`
                    <div class="subject-card">
                        <div class="subject-header">
                            <div class="subject-name">\${subject.name}</div>
                            <div class="subject-percentage \${percentageClass}">\${accuracy.toFixed(0)}%</div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: \${accuracy}%"></div>
                        </div>
                        
                        <div class="chapter-list">
                            \${subject.chapters.map(chapter => \`
                                <div class="chapter-item">
                                    <span>\${chapter.name}</span>
                                    <span style="font-weight: bold; color: \${chapter.accuracy >= 60 ? '#10b981' : '#ef4444'}">
                                        \${chapter.accuracy.toFixed(0)}%
                                    </span>
                                </div>
                            \`).join('')}
                        </div>
                    </div>
                \`;
            }).join('');
        }

        // Render recommendations
        function renderRecommendations() {
            const urgentRecs = recommendations.filter(r => r.type === 'urgent' || r.type === 'critical');
            const improveRecs = recommendations.filter(r => r.type === 'warning' || r.type === 'improve');
            const goodRecs = recommendations.filter(r => r.type === 'good' || r.type === 'excellent');
            
            return \`
                \${urgentRecs.length > 0 ? \`
                    <div class="recommendation-section">
                        <h3>àªµàª§àª¾àª°à«‡ àª¸àª®àª¯ àª†àªªà«‹:</h3>
                        <ul class="recommendation-list">
                            \${urgentRecs.slice(0, 5).map(r => \`<li>\${r.message}</li>\`).join('')}
                        </ul>
                    </div>
                \` : ''}
                
                \${improveRecs.length > 0 ? \`
                    <div class="recommendation-section">
                        <h3>àªµàª¾àª‚àªšàª¨ àª¸à«àª§àª¾àª°à«‹:</h3>
                        <ul class="recommendation-list">
                            \${improveRecs.slice(0, 5).map(r => \`<li>\${r.message}</li>\`).join('')}
                        </ul>
                    </div>
                \` : ''}
                
                \${goodRecs.length > 0 ? \`
                    <div class="recommendation-section">
                        <h3>àª¤àª®àª¾àª°à«€ àª®àªœàª¬à«‚àª¤àª¾àªˆ:</h3>
                        <ul class="recommendation-list">
                            \${goodRecs.slice(0, 3).map(r => \`<li>\${r.message}</li>\`).join('')}
                        </ul>
                    </div>
                \` : ''}
            \`;
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'current') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('currentTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('overallTab').classList.add('active');
                
                // Draw trend chart
                setTimeout(() => {
                    drawTrendChart();
                }, 100);
            }
        }

        // Draw pie chart
        function drawPieChart() {
            const canvas = document.getElementById('pieChart');
            if (!canvas || !currentTestResult) return;
            
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['àª¸àª¾àªšàª¾', 'àª–à«‹àªŸàª¾', 'àª¬àª¾àª•à«€'],
                    datasets: [{
                        data: [
                            currentTestResult.correct_answers,
                            currentTestResult.wrong_answers,
                            currentTestResult.skipped_questions
                        ],
                        backgroundColor: ['#10b981', '#ef4444', '#e5e7eb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Draw trend chart
        function drawTrendChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const scores = allTestResults.map(r => r.percentage).slice(-5);
            const labels = allTestResults.map((r, i) => \`T\${i + 1}\`).slice(-5);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'àª¸à«àª•à«‹àª°',
                        data: scores,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('mainContainer');
            container.innerHTML = \`
                <div class="error">
                    <h2 style="margin-bottom: 15px;">Error</h2>
                    <p>\${message}</p>
                </div>
            \`;
        }

        // Initialize on page load
        window.onload = async () => {
            await init();
            
            // Draw charts after DOM is ready
            setTimeout(() => {
                if (currentTestResult) {
                    drawPieChart();
                }
            }, 500);
        };
    </script>
</body>
</html>
