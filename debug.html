<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Mock Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; margin:0; background: var(--bg); color: var(--text); user-select: none; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #e2e8f0; }
        .option-box { display: block; padding: 14px; border: 2px solid #f1f5f9; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .option-box:hover { border-color: #cbd5e1; }
        .option-box.selected { border-color: var(--primary); background: #f5f3ff; font-weight: 600; }
        .pal-btn { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #ddd; background: #fff; font-weight: bold; }
        .pal-done { background: #4f46e5 !important; color: white !important; }
        .pal-current { border: 2px solid #f59e0b !important; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="testUI" class="hidden">
    <div class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50">
        <div id="qCount" class="font-bold text-indigo-600">Q: 1/200</div>
        <div id="timer" class="font-mono font-bold text-red-600 text-xl">120:00</div>
        <button onclick="confirmSubmit()" class="bg-red-600 text-white px-4 py-1 rounded-lg font-bold">Submit</button>
    </div>
</div>

<div class="max-w-4xl mx-auto p-4">
    <section id="loadingSection" class="card text-center py-10">
        <p class="font-bold text-gray-500">પ્રશ્નો લોડ થઈ રહ્યા છે...</p>
    </section>

    <section id="testSection" class="hidden">
        <div class="card min-h-[300px]">
            <p id="qText" class="text-lg font-bold text-gray-800 mb-6 leading-relaxed"></p>
            <div id="optContainer"></div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mt-6">
            <button onclick="move(-1)" class="bg-white border border-gray-300 p-3 rounded-xl font-bold">Back</button>
            <button onclick="move(1)" class="bg-indigo-600 text-white p-3 rounded-xl font-bold">Next</button>
        </div>

        <div class="mt-10">
            <p class="text-xs font-bold text-gray-400 mb-3 uppercase">Question Palette</p>
            <div id="palGrid" class="grid grid-cols-6 md:grid-cols-10 gap-2"></div>
        </div>
    </section>

    <section id="resultSection" class="hidden space-y-6">
        <div class="card text-center p-10">
            <h2 class="text-2xl font-bold text-gray-500">RESULT</h2>
            <div id="scoreDisplay" class="text-6xl font-black text-indigo-600 my-6"></div>
            <div class="flex justify-center gap-10 items-center flex-wrap">
                <div class="w-48 h-48"><canvas id="resChart"></canvas></div>
                <div class="text-left space-y-2">
                    <p class="text-green-600 font-bold">સાચા જવાબ: <span id="res-c"></span></p>
                    <p class="text-red-600 font-bold">ખોટા/Skip: <span id="res-w"></span></p>
                    <p class="text-orange-600 font-bold">Option E: <span id="res-e"></span></p>
                </div>
            </div>
            <button onclick="showSolutions()" class="mt-8 bg-gray-800 text-white px-8 py-3 rounded-2xl font-bold">View Solutions</button>
        </div>
        <div id="solContainer" class="hidden space-y-4 pb-20"></div>
    </section>
</div>

<script type="module">
// --- તમારી ઓરિજિનલ કનેક્શન રીત (ESM) ---
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SB_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljcvrbucmbbrpzeaneiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const supabase = createClient(SB_URL, SB_KEY);

let questions = [], userAns = {}, currentIdx = 0, timerSec = 120 * 60, interval;

async function startExam() {
    // તમારી ઓરિજિનલ ક્વેરી
    const { data, error } = await supabase.from('questions').select('*').eq('test_id', 'mock_test_1');
    
    if (data && data.length > 0) {
        questions = data;
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('testUI').classList.remove('hidden');
        document.getElementById('testSection').classList.remove('hidden');
        renderPalette();
        showQ();
        startTimer();
    } else {
        document.getElementById('loadingSection').innerHTML = `<p class="text-red-500 font-bold">પ્રશ્નો મળ્યા નથી. કી અથવા ટેબલ ચેક કરો.</p>`;
    }
}

function showQ() {
    const q = questions[currentIdx];
    document.getElementById('qCount').innerText = `Q: ${currentIdx + 1}/${questions.length}`;
    document.getElementById('qText').innerText = q.question_text;
    
    const opts = [q.option_a, q.option_b, q.option_c, q.option_d, q.option_e || "E - Not Attempted"];
    const container = document.getElementById('optContainer');
    container.innerHTML = '';

    opts.forEach((txt, i) => {
        const div = document.createElement('div');
        div.className = `option-box ${userAns[currentIdx] === i ? 'selected' : ''}`;
        div.innerHTML = `<span>${String.fromCharCode(65+i)}.</span> <span>${txt}</span>`;
        div.onclick = () => { userAns[currentIdx] = i; showQ(); updatePal(); };
        container.appendChild(div);
    });
    updatePal();
}

function renderPalette() {
    const grid = document.getElementById('palGrid');
    questions.forEach((_, i) => {
        const b = document.createElement('button');
        b.id = `pal-${i}`; b.className = "pal-btn"; b.innerText = i + 1;
        b.onclick = () => { currentIdx = i; showQ(); };
        grid.appendChild(b);
    });
}

function updatePal() {
    questions.forEach((_, i) => {
        const b = document.getElementById(`pal-${i}`);
        b.classList.remove('pal-current', 'pal-done');
        if(i === currentIdx) b.classList.add('pal-current');
        if(userAns[i] !== undefined) b.classList.add('pal-done');
    });
}

window.move = (dir) => {
    let n = currentIdx + dir;
    if(n >= 0 && n < questions.length) { currentIdx = n; showQ(); }
};

function startTimer() {
    interval = setInterval(() => {
        timerSec--;
        let m = Math.floor(timerSec/60), s = timerSec%60;
        document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if(timerSec <= 0) autoSubmit();
    }, 1000);
}

window.confirmSubmit = () => { if(confirm("સબમિટ કરવું છે?")) autoSubmit(); };

async function autoSubmit() {
    clearInterval(interval);
    let c=0, w=0, e=0, sk=0;
    
    questions.forEach((q, i) => {
        const u = userAns[i];
        if (u === undefined) sk++;
        else if (u === 4) e++;
        else if (u === q.correct_option) c++;
        else w++;
    });

    const finalScore = (c * 1) - ((w + sk) * 0.33);

    document.getElementById('testUI').classList.add('hidden');
    document.getElementById('testSection').classList.add('hidden');
    document.getElementById('resultSection').classList.remove('hidden');
    document.getElementById('scoreDisplay').innerText = finalScore.toFixed(2);
    document.getElementById('res-c').innerText = c;
    document.getElementById('res-w').innerText = (w + sk);
    document.getElementById('res-e').innerText = e;

    new Chart(document.getElementById('resChart'), {
        type: 'doughnut',
        data: {
            labels: ['Correct', 'Wrong/Skip', 'E'],
            datasets: [{ data: [c, (w+sk), e], backgroundColor: ['#22c55e', '#ef4444', '#f97316'] }]
        },
        options: { plugins: { legend: { display: false } } }
    });
}

window.showSolutions = () => {
    const box = document.getElementById('solContainer');
    box.classList.remove('hidden');
    box.innerHTML = '<h3 class="text-xl font-bold">Detailed Solutions</h3>';
    questions.forEach((q, i) => {
        const u = userAns[i];
        const opts = [q.option_a, q.option_b, q.option_c, q.option_d, q.option_e || "E - Not Attempted"];
        const div = document.createElement('div');
        div.className = `card border-l-4 ${u === q.correct_option ? 'border-l-green-500' : 'border-l-red-500'}`;
        div.innerHTML = `
            <p class="font-bold">${i+1}. ${q.question_text}</p>
            <div class="grid grid-cols-2 gap-2 mt-3 text-sm">
                <div class="p-2 bg-gray-50 rounded">તમારો: ${u !== undefined ? opts[u] : 'સ્કીપ'}</div>
                <div class="p-2 bg-blue-50 text-blue-700 rounded">સાચો: ${opts[q.correct_option]}</div>
            </div>
            <p class="mt-3 text-xs italic text-gray-500">સમજૂતી: ${q.explanation || 'નથી'}</p>
        `;
        box.appendChild(div);
    });
    window.scrollTo({ top: box.offsetTop, behavior: 'smooth' });
};

// Start
startExam();

</script>
</body>
</html>
