<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{font-family:-apple-system,sans-serif;background:#e5ddd5;padding-bottom:120px}.c{max-width:480px;margin:0 auto;min-height:100vh}

/* --- àª¸à«àª§àª¾àª°à«‡àª²à«àª‚ àª¹à«‡àª¡àª°: 100px Height & Content at Bottom --- */
.h{
    position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;
    height:100px; 
    background:linear-gradient(135deg,var(--pc),var(--sc));
    display:flex;
    align-items:flex-end; 
    padding:0 10px 15px 10px; 
    z-index:100;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.bb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.bb svg{width:24px;height:24px;fill:#fff}.hi{flex:1;display:flex;align-items:center;gap:12px;margin-left:5px;cursor:pointer}.ha{width:50px;height:50px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;overflow:hidden;flex-shrink:0}.ha img{width:100%;height:100%;object-fit:cover}.hti{flex:1;overflow:hidden}.hn{color:#fff;font-size:20px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.hs{color:rgba(255,255,255,0.95);font-size:13px;margin-top:2px}.hm{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.hm svg{width:22px;height:22px;fill:#fff}

/* àª¹à«‡àª¡àª° àª®à«àªœàª¬ àª®à«‡àª¸à«‡àªœ àª•àª¨à«àªŸà«‡àª¨àª°àª¨à«àª‚ àªªà«‡àª¡àª¿àª‚àª— àª¸à«àª§àª¾àª°à«àª¯à«àª‚ */
.mc{padding:110px 10px 10px;min-height:100vh}

.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}.mb{max-width:75%;padding:8px 12px;border-radius:8px;position:relative;word-wrap:break-word}

/* --- àª¸à«‡àª¨à«àª¡ àª•àª°à«‡àª²àª¾ àªˆàª®à«‹àªœà«€àª¨à«€ àª¸àª¾àªˆàª 2x àª•àª°à«€ --- */
.mb.emoji-xl{background:none!important;padding:2px;font-size:160px;line-height:1;animation:bounce 0.6s} 
.mb.emoji-lg{background:none!important;padding:2px;font-size:120px;line-height:1;animation:bounce 0.5s} 
.mb.emoji-md{background:none!important;padding:2px;font-size:90px;line-height:1;animation:bounce 0.4s}  
.mb.emoji-sm{font-size:60px} 

.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}.m.received .mb{background:#fff;border-bottom-left-radius:2px}.mt{font-size:14px;color:#333}.mti{font-size:11px;color:#666;margin-top:4px;text-align:right}@keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}.ty{padding:8px 15px;font-size:13px;color:#666;font-style:italic;margin-bottom:5px}.umc{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);background:var(--pc);color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;display:none;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:98}.ua{width:24px;height:24px;border-radius:50%;background:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--pc)}.uc{font-weight:500}.da{width:24px;height:24px;border-radius:50%;background:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--pc);transform:rotate(180deg)}.ic{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f5f5f5;padding:10px 8px 8px;z-index:100;border-top:1px solid #e0e0e0;min-height:95px}.it{display:flex;gap:8px;align-items:flex-end}.ab{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;flex-shrink:0}.mitw{flex:1;position:relative;background:#fff;border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center}.mi{flex:1;padding:10px 15px;border:none;font-size:14px;resize:none;max-height:100px;overflow-y:auto;background:transparent;font-family:inherit}.mi:focus{outline:none}.sb{width:40px;height:40px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}.sb svg{width:20px;height:20px;fill:#fff}.ek{display:none;position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;padding:8px;height:280px;z-index:99;overflow-x:hidden;overflow-y:auto}.ek.show{display:block}.et{display:flex;gap:6px;margin-bottom:6px;border-bottom:1px solid #f0f0f0;padding-bottom:6px}.ett{padding:5px 12px;background:#f0f0f0;border-radius:12px;font-size:12px;cursor:pointer}.ett.active{background:var(--pc);color:#fff}.eg{display:grid;grid-template-columns:repeat(10,1fr);gap:2px}.ee{font-size:30px;padding:2px;cursor:pointer;text-align:center;border-radius:4px;transition:background 0.15s;user-select:none;line-height:1}.ee:active{background:#e0e0e0}.ctx{position:fixed;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:8px 0;z-index:1000;display:none;min-width:180px}.ctx.show{display:block}.cti{padding:12px 20px;font-size:14px;color:#333;cursor:pointer;border-bottom:1px solid #f0f0f0}.cti:last-child{border-bottom:none}.cti:active{background:#f5f5f5}.mm{position:fixed;top:0;left:0;right:0;bottom:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:center;justify-content:center}.mm.show{display:flex}.mmc{background:#fff;border-radius:12px;padding:20px;width:90%;max-width:400px}.mmt{font-size:18px;font-weight:600;margin-bottom:15px}.mmi{padding:12px 20px;margin:5px 0;cursor:pointer;border-radius:8px;background:#f5f5f5;display:flex;align-items:center;gap:10px}.mmi:active{background:#e0e0e0}.tc{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}.tcc{width:100%;padding:20px 10px;background:#f5f5f5;border-radius:8px;cursor:pointer;text-align:center;border:2px solid transparent}.tcc.active{border-color:var(--pc);background:#e8eaff}.tct{font-size:11px;margin-top:5px;color:#666}.dm{position:fixed;top:0;left:0;right:0;bottom:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,0.5);z-index:201;display:none;align-items:center;justify-content:center}.dm.show{display:flex}.dmc{background:#fff;border-radius:12px;padding:20px;width:90%;max-width:350px;text-align:center}.dmt{font-size:18px;font-weight:600;margin-bottom:15px}.dmb{display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap}.dbtn{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;flex:1;min-width:80px}.dbtn.cancel{background:#f0f0f0;color:#333}.dbtn.delete{background:#ff4444;color:#fff}.fp{position:fixed;bottom:95px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;padding:15px;z-index:99;display:none}.fp.show{display:block}.fpi{padding:15px;margin:5px 0;background:#f5f5f5;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:15px;position:relative}.fpi input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}.fpi:active{background:#e0e0e0}.empty{text-align:center;padding:40px 20px;color:#999}.loading{text-align:center;padding:20px;color:#999}
</style>
</head>
<body>
<div class="c">
<div class="h">
<button class="bb" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<div class="hi" onclick="openUserInfo()">
<div class="ha" id="chatAvatar">?</div>
<div class="hti"><div class="hn" id="chatTitle">Loading...</div><div class="hs" id="chatStatus"></div></div>
</div>
<button class="hm" onclick="showMenu()"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
</div>
<div class="mc" id="messagesContainer"><div class="loading">Loading messages...</div></div>
<div class="ty" id="typingIndicator" style="display:none">typing...</div>
<div class="umc" id="unreadMsgCounter">
<button class="ua" onclick="scrollToBottom()">â†“</button>
<span class="uc" id="unreadCount">0 new</span>
<button class="da" onclick="scrollToTop()">â†“</button>
</div>
<div class="fp" id="filePicker">
<div class="fpi">ğŸ“· Photo<input type="file" accept="image/*" onchange="uploadFile(this,'photo')"></div>
<div class="fpi">ğŸ¥ Video<input type="file" accept="video/*" onchange="uploadFile(this,'video')"></div>
<div class="fpi">ğŸ“„ Document<input type="file" accept=".pdf,.doc,.docx,.txt" onchange="uploadFile(this,'document')"></div>
<div class="fpi" onclick="shareLocation()">ğŸ“ Location</div>
</div>
<div class="ek" id="emojiKeyboard">
<div class="et">
<div class="ett active" onclick="showEmojiTab('recent')">Recent</div>
<div class="ett" onclick="showEmojiTab('all')">All</div>
</div>
<div class="eg" id="emojiGrid"></div>
</div>
<div class="ic">
<div class="it">
<button class="ab" onclick="toggleFilePicker()">ğŸ“</button>
<div class="mitw">
<textarea class="mi" id="messageInput" placeholder="Type a message..." rows="1" oninput="handleTyping()"></textarea>
</div>
<button class="ab" onclick="toggleEmoji()" id="emojiBtn">ğŸ˜Š</button>
<button class="sb" id="sendBtn" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</div>
</div>
</div>
<div class="ctx" id="contextMenu"></div>
<div class="dm" id="deleteModal">
<div class="dmc">
<div class="dmt">Delete Message?</div>
<p style="color:#666;font-size:14px;margin-bottom:15px">Choose delete option:</p>
<div class="dmb">
<button class="dbtn cancel" onclick="closeDeleteModal()">Cancel</button>
<button class="dbtn delete" onclick="deleteForMe()">For Me</button>
<button class="dbtn delete" onclick="deleteForEveryone()">Everyone</button>
</div>
</div>
</div>
<div class="mm" id="menuModal">
<div class="mmc">
<div class="mmt">Chat Options</div>
<div class="mmi" onclick="toggleMute()"><span id="muteText">ğŸ”” Mute</span></div>
<div class="mmi" onclick="showThemePicker()">ğŸ¨ Change Theme</div>
<div class="mmi" onclick="deleteChat()">ğŸ—‘ï¸ Delete Chat</div>
<div class="mmi" onclick="closeMenu()">âœ–ï¸ Close</div>
</div>
</div>
<div class="mm" id="themeModal">
<div class="mmc">
<div class="mmt">Choose Theme</div>
<div class="tc">
<div class="tcc" onclick="setTheme('purple')" data-theme="purple"><div style="width:100%;height:40px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px"></div><div class="tct">Purple</div></div>
<div class="tcc" onclick="setTheme('blue')" data-theme="blue"><div style="width:100%;height:40px;background:linear-gradient(135deg,#4facfe,#00f2fe);border-radius:8px"></div><div class="tct">Blue</div></div>
<div class="tcc" onclick="setTheme('pink')" data-theme="pink"><div style="width:100%;height:40px;background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:8px"></div><div class="tct">Pink</div></div>
<div class="tcc" onclick="setTheme('green')" data-theme="green"><div style="width:100%;height:40px;background:linear-gradient(135deg,#43e97b,#38f9d7);border-radius:8px"></div><div class="tct">Green</div></div>
<div class="tcc" onclick="setTheme('orange')" data-theme="orange"><div style="width:100%;height:40px;background:linear-gradient(135deg,#fa709a,#fee140);border-radius:8px"></div><div class="tct">Orange</div></div>
<div class="tcc" onclick="setTheme('red')" data-theme="red"><div style="width:100%;height:40px;background:linear-gradient(135deg,#ff6b6b,#ee5a6f);border-radius:8px"></div><div class="tct">Red</div></div>
<div class="tcc" onclick="setTheme('teal')" data-theme="teal"><div style="width:100%;height:40px;background:linear-gradient(135deg,#2bcbba,#45caff);border-radius:8px"></div><div class="tct">Teal</div></div>
<div class="tcc" onclick="setTheme('indigo')" data-theme="indigo"><div style="width:100%;height:40px;background:linear-gradient(135deg,#4776e6,#8e54e9);border-radius:8px"></div><div class="tct">Indigo</div></div>
</div>
<button class="dbtn cancel" onclick="closeThemePicker()" style="width:100%;margin-top:15px">Close</button>
</div>
</div>
<script>
const SUPABASE_URL='https://bhmycvrbucmbbrpzeane.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null,chatId=null,otherUser=null,chatType=null,selectedMsgId=null,unreadMsgCount=0,lastScrollHeight=0,isMuted=false,currentTab='recent',typingTimeout=null,isTyping=false;
const allEmojis=['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ¥²','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾','ğŸ‘‹','ğŸ¤š','ğŸ–','âœ‹','ğŸ––','ğŸ‘Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','è…¿','ğŸ¦¶','ğŸ‘‚','ğŸ¦»','ğŸ‘ƒ','ğŸ§ ','ğŸ¦·','ğŸ¦´','ğŸ‘€','ğŸ‘','ğŸ‘…','ğŸ‘„','ğŸ’‹','ğŸ©¸','â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶','ğŸŒ½','ğŸ¥•','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ¥¯','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ³','ãƒã‚¿ãƒ¼','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸ¦´','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ¥ª','ğŸ¥™','ğŸ§†','ğŸŒ®','ğŸŒ¯','ğŸ¥—','ğŸ¥˜','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¦ª','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥ ','ğŸ¥®','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«',' popcorn','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§‰','ğŸ¾','ğŸ§Š','ğŸ¥„','ğŸ´','ğŸ½','ğŸ¥£','ğŸ¥¡','ğŸ¥¢','ğŸ§‚','âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸',' hockey','ğŸ‘',' lacrosse','ğŸ','ğŸ¥…','â›³','å‡§','ğŸ¹','é‡£ã‚Š','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ã‚¹ã‚±ãƒœãƒ¼','ğŸ›·','ã‚¹ã‚±ãƒ¼ãƒˆ','ğŸ¥Œ','ã‚¹ã‚­ãƒ¼','â›·','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ¤¼','ğŸ¤¸','ğŸ¤º','â›¹ï¸','ğŸ¤¾','ğŸŒï¸','ğŸ‡','ğŸ§˜','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ§—','ğŸšµ','ğŸš´','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–','ğŸµ','ğŸ—','ãƒã‚±ãƒƒãƒˆ','ğŸŸ','ğŸª','ğŸ¤¹','ğŸ­','ãƒãƒ¬ã‚¨','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ãƒ‰ãƒ©ãƒ ','ğŸª˜','ã‚µãƒƒã‚¯ã‚¹','ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ','ğŸª—','ã‚®ã‚¿ãƒ¼','ãƒãƒ³ã‚¸ãƒ§ãƒ¼','ãƒã‚¤ã‚ªãƒªãƒ³','ğŸ²','ãƒã‚§ã‚¹','ğŸ¯','ãƒœã‚¦ãƒªãƒ³ã‚°','ğŸ®','ã‚¹ãƒ­ãƒƒãƒˆ','ãƒ‘ã‚ºãƒ«'];
let recentEmojis=JSON.parse(localStorage.getItem('recent_emojis')||'[]');
const themes={purple:{primary:'#667eea',secondary:'#764ba2'},blue:{primary:'#4facfe',secondary:'#00f2fe'},pink:{primary:'#f093fb',secondary:'#f5576c'},green:{primary:'#43e97b',secondary:'#38f9d7'},orange:{primary:'#fa709a',secondary:'#fee140'},red:{primary:'#ff6b6b',secondary:'#ee5a6f'},teal:{primary:'#2bcbba',secondary:'#45caff'},indigo:{primary:'#4776e6',secondary:'#8e54e9'}};

function applyTheme(){const theme=localStorage.getItem('nandigram_theme')||'purple';if(themes[theme]){document.documentElement.style.setProperty('--pc',themes[theme].primary);document.documentElement.style.setProperty('--sc',themes[theme].secondary)}document.querySelectorAll('.tcc').forEach(t=>{if(t.dataset.theme===theme)t.classList.add('active');else t.classList.remove('active')})}
applyTheme();

async function init(){await checkAuth();if(!currentUser){window.location.href='login.html';return}const params=new URLSearchParams(window.location.search);chatId=params.get('chat');if(!chatId){window.location.href='ngm-chats.html';return}await loadChat();await loadMessages();subscribeToMessages();subscribeToTyping();setInterval(()=>updatePresence(),10000);setInterval(()=>checkOnlineStatus(),3000);initEmojis();lastScrollHeight=document.getElementById('messagesContainer').scrollHeight;const muted=localStorage.getItem('muted_'+chatId);if(muted){isMuted=true;document.getElementById('muteText').innerHTML='ğŸ”• Unmute'}}
async function checkAuth(){const{data:{user}}=await sb.auth.getUser();if(user){currentUser=user}else{currentUser=null;window.location.href='login.html'}}
async function loadChat(){try{const{data:chat}=await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();if(!chat)return;chatType=chat.chat_type;if(chatType==='personal'){const otherUserId=chat.user1_id===currentUser.id?chat.user2_id:chat.user1_id;const{data:user}=await sb.from('ngm_users').select('*').eq('user_id',otherUserId).single();otherUser=user;if(user){document.getElementById('chatTitle').textContent=user.full_name||user.mobile||'Unknown';const initial=user.full_name?user.full_name.charAt(0).toUpperCase():'?';document.getElementById('chatAvatar').innerHTML=user.profile_picture_url?`<img src="${user.profile_picture_url}">`:`<span>${initial}</span>`;updateUserStatus(user)}}else if(chatType==='group'){const{data:group}=await sb.from('ngm_groups').select('*').eq('chat_id',chatId).single();if(group){document.getElementById('chatTitle').textContent=group.group_name;document.getElementById('chatAvatar').innerHTML='ğŸ‘¥';const{data:members}=await sb.from('ngm_chat_participants').select('*',{count:'exact'}).eq('chat_id',chatId).eq('is_active',true);document.getElementById('chatStatus').textContent=`${members.length||0} members`}}else if(chatType==='channel'){const{data:channel}=await sb.from('ngm_channels').select('*').eq('chat_id',chatId).single();if(channel){document.getElementById('chatTitle').textContent=channel.channel_name;document.getElementById('chatAvatar').innerHTML='ğŸ“¢';document.getElementById('chatStatus').textContent=`${channel.subscriber_count||0} subscribers`}}}catch(e){console.error(e)}}
function updateUserStatus(user){const now=Date.now();const lastSeen=user.last_seen?new Date(user.last_seen).getTime():0;const diff=now-lastSeen;if(diff<15000){document.getElementById('chatStatus').textContent='online';document.getElementById('chatStatus').style.color='rgba(255,255,255,0.95)'}else if(diff<60000){document.getElementById('chatStatus').textContent='last seen just now'}else if(diff<3600000){document.getElementById('chatStatus').textContent='last seen '+Math.floor(diff/60000)+' min ago'}else if(diff<86400000){document.getElementById('chatStatus').textContent='last seen '+Math.floor(diff/3600000)+' hr ago'}else{document.getElementById('chatStatus').textContent='last seen '+Math.floor(diff/86400000)+' days ago'}}
async function checkOnlineStatus(){if(otherUser&&chatType==='personal'){const{data:user}=await sb.from('ngm_users').select('is_online,last_seen').eq('user_id',otherUser.user_id).single();if(user){otherUser.is_online=user.is_online;otherUser.last_seen=user.last_seen;updateUserStatus(otherUser)}}}
async function loadMessages(){try{const{data:messages}=await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});renderMessages(messages||[]);await markMessagesAsRead()}catch(e){console.error(e);document.getElementById('messagesContainer').innerHTML='<div class="empty">Error loading messages</div>'}}

/* --- RenderMessages àª®àª¾àª‚ Space àªµàª¾àª³à«‹ àª¸à«àª§àª¾àª°à«‹ --- */
function renderMessages(messages){const container=document.getElementById('messagesContainer');if(messages.length===0){container.innerHTML='<div class="empty">No messages yet. Start the conversation!</div>';return}const wasAtBottom=container.scrollHeight-container.scrollTop<=container.clientHeight+100;container.innerHTML=messages.map(msg=>{const isSent=msg.sender_id===currentUser.id;const time=new Date(msg.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});const content=msg.is_deleted?'<i>Message deleted</i>':msg.content;const emojiCount=msg.content.match(/[\p{Emoji}]/gu)?.length||0;const textCount=msg.content.replace(/[\p{Emoji}\s]/gu,'').length;let emojiClass='';if(textCount===0&&emojiCount===1)emojiClass='emoji-xl';else if(textCount===0&&emojiCount===2)emojiClass='emoji-lg';else if(textCount===0&&emojiCount===3)emojiClass='emoji-md';else if(textCount===0&&emojiCount>3)emojiClass='emoji-sm';
return `<div class="m ${isSent?'sent':'received'}" data-mid="${msg.message_id}" oncontextmenu="showContextMenu(event,'${msg.message_id}',${isSent})">
<div class="mb ${emojiClass}"> <div class="mt">${content}</div>
${emojiClass===''?`<div class="mti">${time}</div>`:''}
</div>
</div>`}).join('');const newScrollHeight=container.scrollHeight;if(wasAtBottom){container.scrollTop=newScrollHeight}else if(newScrollHeight>lastScrollHeight+50){showUnreadCounter()}lastScrollHeight=newScrollHeight}

function showUnreadCounter(){unreadMsgCount++;document.getElementById('unreadCount').textContent=unreadMsgCount+' new';document.getElementById('unreadMsgCounter').style.display='flex'}
function scrollToBottom(){const container=document.getElementById('messagesContainer');container.scrollTop=container.scrollHeight;unreadMsgCount=0;document.getElementById('unreadMsgCounter').style.display='none'}
function scrollToTop(){const container=document.getElementById('messagesContainer');container.scrollTop=0}
function handleTyping(){const input=document.getElementById('messageInput');input.style.height='40px';input.style.height=Math.min(input.scrollHeight,120)+'px';if(!isTyping&&input.value.trim()){isTyping=true;sb.channel('typing_'+chatId).send({type:'broadcast',event:'typing',payload:{user_id:currentUser.id,typing:true}})}clearTimeout(typingTimeout);typingTimeout=setTimeout(()=>{isTyping=false;sb.channel('typing_'+chatId).send({type:'broadcast',event:'typing',payload:{user_id:currentUser.id,typing:false}})},2000)}
async function sendMessage(){const input=document.getElementById('messageInput');const text=input.value.trim();if(!text)return;try{const{error}=await sb.from('ngm_messages').insert({chat_id:chatId,sender_id:currentUser.id,content:text,message_type:'text',created_at:new Date().toISOString()});if(!error){await sb.from('ngm_chats').update({last_message_at:new Date().toISOString()}).eq('chat_id',chatId);input.value='';input.style.height='40px';isTyping=false;await loadMessages()}}catch(e){console.error(e)}}
async function markMessagesAsRead(){try{await sb.from('ngm_chat_participants').update({unread_count:0}).eq('chat_id',chatId).eq('user_id',currentUser.id)}catch(e){console.error(e)}}
async function updatePresence(){try{await sb.from('ngm_users').update({last_seen:new Date().toISOString(),is_online:true}).eq('user_id',currentUser.id)}catch(e){console.error(e)}}
function showContextMenu(e,msgId,isSent){e.preventDefault();selectedMsgId=msgId;const ctx=document.getElementById('contextMenu');ctx.innerHTML='<div class="cti" onclick="copyMessage()">Copy</div>'+(isSent?'<div class="cti" onclick="showDeleteModal()">Delete</div>':'');ctx.style.left=Math.min(e.pageX,window.innerWidth-200)+'px';ctx.style.top=e.pageY+'px';ctx.classList.add('show')}
function showDeleteModal(){document.getElementById('contextMenu').classList.remove('show');document.getElementById('deleteModal').classList.add('show')}
function closeDeleteModal(){document.getElementById('deleteModal').classList.remove('show')}
async function deleteForMe(){closeDeleteModal();if(selectedMsgId){const msgEl=document.querySelector(`[data-mid="${selectedMsgId}"]`);if(msgEl)msgEl.style.display='none'}}
async function deleteForEveryone(){closeDeleteModal();if(selectedMsgId){await sb.from('ngm_messages').update({is_deleted:true,deleted_at:new Date().toISOString()}).eq('message_id',selectedMsgId);await loadMessages()}}
function copyMessage(){document.getElementById('contextMenu').classList.remove('show');const msgElement=document.querySelector(`[data-mid="${selectedMsgId}"] .mt`);if(msgElement)navigator.clipboard.writeText(msgElement.textContent)}
function toggleEmoji(){const ek=document.getElementById('emojiKeyboard');const fp=document.getElementById('filePicker');fp.classList.remove('show');ek.classList.toggle('show')}
function toggleFilePicker(){const fp=document.getElementById('filePicker');const ek=document.getElementById('emojiKeyboard');ek.classList.remove('show');fp.classList.toggle('show')}
async function uploadFile(input,type){const file=input.files[0];if(file){const reader=new FileReader();reader.onload=async function(e){const base64=e.target.result;await sb.from('ngm_messages').insert({chat_id:chatId,sender_id:currentUser.id,content:`[${type.toUpperCase()}] ${file.name}`,message_type:type,created_at:new Date().toISOString()});await loadMessages()};reader.readAsDataURL(file)}document.getElementById('filePicker').classList.remove('show')}
function shareLocation(){alert('Location sharing coming soon!');document.getElementById('filePicker').classList.remove('show')}
function showEmojiTab(tab){currentTab=tab;document.querySelectorAll('.ett').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');initEmojis()}
function initEmojis(){const grid=document.getElementById('emojiGrid');const emojis=currentTab==='recent'?recentEmojis.slice(0,30):allEmojis;grid.innerHTML=emojis.map(e=>`<div class="ee" onclick="addEmoji('${e}')">${e}</div>`).join('')}
function addEmoji(emoji){const input=document.getElementById('messageInput');input.value+=emoji;input.focus();handleTyping();if(!recentEmojis.includes(emoji)){recentEmojis.unshift(emoji);if(recentEmojis.length>30)recentEmojis.pop();localStorage.setItem('recent_emojis',JSON.stringify(recentEmojis))}document.getElementById('emojiKeyboard').classList.remove('show')}
function showMenu(){document.getElementById('menuModal').classList.add('show')}
function closeMenu(){document.getElementById('menuModal').classList.remove('show')}
function toggleMute(){isMuted=!isMuted;if(isMuted){localStorage.setItem('muted_'+chatId,'true');document.getElementById('muteText').innerHTML='ğŸ”• Unmute'}else{localStorage.removeItem('muted_'+chatId);document.getElementById('muteText').innerHTML='ğŸ”” Mute'}closeMenu()}
async function deleteChat(){if(confirm('Delete this entire chat? Cannot be undone.')){try{await sb.from('ngm_messages').delete().eq('chat_id',chatId);await sb.from('ngm_chat_participants').delete().eq('chat_id',chatId);await sb.from('ngm_chats').delete().eq('chat_id',chatId);window.location.href='ngm-chats.html'}catch(e){console.error(e)}}}
function showThemePicker(){closeMenu();document.getElementById('themeModal').classList.add('show');applyTheme()}
function closeThemePicker(){document.getElementById('themeModal').classList.remove('show')}
function setTheme(theme){localStorage.setItem('nandigram_theme',theme);if(themes[theme]){document.documentElement.style.setProperty('--pc',themes[theme].primary);document.documentElement.style.setProperty('--sc',themes[theme].secondary)}document.querySelectorAll('.tcc').forEach(t=>{if(t.dataset.theme===theme)t.classList.add('active');else t.classList.remove('active')})}
function openUserInfo(){if(otherUser)window.location.href='ngm-user-info.html?user='+otherUser.user_id}
function subscribeToMessages(){sb.channel('messages_'+chatId).on('postgres_changes',{event:'INSERT',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${chatId}`},()=>loadMessages()).subscribe()}
function subscribeToTyping(){sb.channel('typing_'+chatId).on('broadcast',{event:'typing'},payload=>{if(payload.payload.user_id!==currentUser.id){if(payload.payload.typing){document.getElementById('typingIndicator').style.display='block'}else{document.getElementById('typingIndicator').style.display='none'}}}).subscribe()}
function goBack(){window.location.href='ngm-chats.html'}
const messageInput=document.getElementById('messageInput');messageInput.addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}});
document.addEventListener('click',e=>{if(!e.target.closest('.ctx'))document.getElementById('contextMenu').classList.remove('show')});
init();
</script>
</body>
</html>
