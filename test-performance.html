<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <title>ટેસ્ટ પર્ફોર્મન્સ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; color: #333; }
        .navbar { background: #1e3a8a; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #edf2f7; }
        .stat-val { font-size: 24px; font-weight: bold; color: #1e3a8a; }
        .rule-section { background: #111827; color: #fbbf24; padding: 20px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; background: #f1f5f9; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .btn { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; }
    </style>
</head>
<body>
    <div class="navbar">
        <div style="font-weight: bold; font-size: 1.2rem;">LRD Beginners</div>
        <a href="quiz-engine-updated__6_.html" class="btn">હોમ</a>
    </div>

    <div id="app" class="container">
        <div class="card" style="text-align:center;">લોડ થઈ રહ્યું છે...</div>
    </div>

    <script>
        const SB_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
        const SB_KEY = "તમારી_સાચી_ANON_KEY_અહીં_નાખો";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const resId = urlParams.get('result_id');
            if (!resId) { document.getElementById('app').innerHTML = "રિઝલ્ટ આઈડી મળ્યું નથી."; return; }

            try {
                // ૧. રિઝલ્ટ ડેટા
                const { data: res, error: e1 } = await supabaseClient.from('lrd_test_results').select('*').eq('id', resId).single();
                if (e1) throw e1;

                // ૨. રિસ્પોન્સ ડેટા (વિષય અને ચેપ્ટર સાથે)
                const { data: resp, error: e2 } = await supabaseClient.from('lrd_question_responses').select('is_correct, lrd_questions(chapter_code, lrd_chapters(name, lrd_subjects(name)))').eq('result_id', resId);
                
                // ૩. રૂલ એન્જિન (Accuracy મુજબ)
                const speedCat = res.avg_time_per_question < 45 ? 'fast' : 'slow';
                const { data: rules } = await supabaseClient.from('lrd_rule_engine').select('*').eq('speed_category', speedCat).limit(3);

                render(res, resp, rules);
            } catch (err) {
                console.error(err);
                document.getElementById('app').innerHTML = `<div class="card" style="border-color: red;">
                    <h3>કનેક્શન એરર (401)</h3>
                    <p>તમારી Anon Key અથવા Supabase RLS પોલિસી ચેક કરો.</p>
                </div>`;
            }
        }

        function render(res, resp, rules) {
            let listHTML = resp.map(r => `
                <tr>
                    <td>${r.lrd_questions?.lrd_chapters?.lrd_subjects?.name || '-'}</td>
                    <td>${r.lrd_questions?.lrd_chapters?.name || '-'}</td>
                    <td>${r.is_correct ? '✅ સાચો' : '❌ ખોટો'}</td>
                </tr>`).join('');

            document.getElementById('app').innerHTML = `
                <div class="card">
                    <h2>ટેસ્ટ સ્કોર: ${res.obtained_marks} / 100</h2>
                    <div class="grid">
                        <div class="stat-card">ચોકસાઈ<br><span class="stat-val">${res.accuracy_percentage}%</span></div>
                        <div class="stat-card">એવરેજ સમય<br><span class="stat-val">${res.avg_time_per_question}s</span></div>
                        <div class="stat-card">એકાગ્રતા<br><span class="stat-val">${res.concentration_rating}/10</span></div>
                    </div>
                </div>

                <div class="rule-section">
                    <h3>તમારા માટે વિશેષ સૂચનાઓ (Rule Engine)</h3>
                    <ul>${rules?.map(r => `<li>${r.suggestion_text}</li>`).join('') || 'સારી મહેનત ચાલુ રાખો!'}</ul>
                </div>

                <div class="card">
                    <h3>વિષયવાર વિગત</h3>
                    <table><thead><tr><th>વિષય</th><th>ચેપ્ટર</th><th>રિઝલ્ટ</th></tr></thead>
                    <tbody>${listHTML}</tbody></table>
                </div>
            `;
        }
        init();
    </script>
</body>
</html>
