<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{font-family:-apple-system,sans-serif;background:#e5ddd5;padding-bottom:120px}.c{max-width:480px;margin:0 auto;min-height:100vh}

/* --- HEADER: 100px Height --- */
.h{
    position:fixed;top:0;left:0;right:0;max-width:480px;margin:0 auto;
    height:100px; 
    background:linear-gradient(135deg,var(--pc),var(--sc));
    display:flex;
    align-items:flex-end; 
    padding:0 10px 15px 10px; 
    z-index:100;
}
.bb{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.bb svg{width:24px;height:24px;fill:#fff}.hi{flex:1;display:flex;align-items:center;gap:12px;margin-left:5px;cursor:pointer}.ha{width:50px;height:50px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--pc);font-weight:600;overflow:hidden;flex-shrink:0}.ha img{width:100%;height:100%;object-fit:cover}.hti{flex:1;overflow:hidden}.hn{color:#fff;font-size:20px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.hs{color:rgba(255,255,255,0.95);font-size:13px;margin-top:2px}.hm{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:none;border:none}.hm svg{width:22px;height:22px;fill:#fff}

.mc{padding:115px 10px 10px;min-height:100vh}

/* --- MESSAGE STYLES & TEXT SIZE (17px) --- */
.m{margin-bottom:10px;display:flex}.m.sent{justify-content:flex-end}.m.received{justify-content:flex-start}.mb{max-width:75%;padding:10px 14px;border-radius:12px;position:relative;word-wrap:break-word}.m.sent .mb{background:#dcf8c6;border-bottom-right-radius:2px}.m.received .mb{background:#fff;border-bottom-left-radius:2px}.mt{font-size:17px;color:#333;line-height:1.4}.mti{font-size:11px;color:#666;margin-top:4px;text-align:right}

/* --- EMOJI SIZE: 120px --- */
.mb.emoji-xl .mt{font-size:120px !important;line-height:1}
.mb.emoji-lg .mt{font-size:90px !important;line-height:1}
.mb.emoji-md .mt{font-size:70px !important;line-height:1}
.mb.emoji-sm .mt{font-size:45px !important;line-height:1}
.emoji-xl, .emoji-lg, .emoji-md, .emoji-sm { background:none !important; box-shadow:none !important; padding:0 !important; }

/* --- FOOTER & INPUT --- */
.ic{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:#f5f5f5;padding:10px 8px 8px;z-index:100;border-top:1px solid #e0e0e0;min-height:95px}.it{display:flex;gap:8px;align-items:flex-end}.ab{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;flex-shrink:0}.mitw{flex:1;position:relative;background:#fff;border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center}.mi{flex:1;padding:10px 15px;border:none;font-size:16px;resize:none;max-height:100px;overflow-y:auto;background:transparent;font-family:inherit}.mi:focus{outline:none}.sb{width:40px;height:40px;background:var(--pc);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}.sb svg{width:20px;height:20px;fill:#fff}
.ek{display:none;position:fixed;bottom:95px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;padding:8px;height:280px;z-index:99;overflow-y:auto}.ek.show{display:block}.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:5px}.ee{font-size:32px;text-align:center;padding:5px;cursor:pointer}.fp{position:fixed;bottom:95px;left:0;right:0;max-width:480px;margin:0 auto;background:#fff;border-top:1px solid #e0e0e0;padding:15px;z-index:99;display:none}.fp.show{display:block}.fpi{padding:15px;margin:5px 0;background:#f5f5f5;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:15px;position:relative}.fpi input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
</style>
</head>
<body>
<div class="c">
    <div class="h">
        <button class="bb" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
        <div class="hi" onclick="openUserInfo()">
            <div class="ha" id="chatAvatar">?</div>
            <div class="hti"><div class="hn" id="chatTitle">Loading...</div><div class="hs" id="chatStatus"></div></div>
        </div>
        <button class="hm"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
    </div>
    <div class="mc" id="messagesContainer"></div>
    <div class="fp" id="filePicker">
        <div class="fpi">ðŸ“· Photo<input type="file" accept="image/*" onchange="uploadFile(this,'photo')"></div>
        <div class="fpi">ðŸ“„ Document<input type="file" onchange="uploadFile(this,'document')"></div>
    </div>
    <div class="ek" id="emojiKeyboard"><div class="eg" id="emojiGrid"></div></div>
    <div class="ic">
        <div class="it">
            <button class="ab" onclick="toggleFilePicker()">ðŸ“Ž</button>
            <div class="mitw"><textarea class="mi" id="messageInput" placeholder="Type a message..." rows="1" oninput="handleTyping()"></textarea></div>
            <button class="ab" onclick="toggleEmoji()">ðŸ˜Š</button>
            <button class="sb" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL='https://bhmycvrbucmbbrpzeane.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null,chatId=null,otherUser=null;
const allEmojis=['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ˜‚','ðŸ¤£','â˜ºï¸','ðŸ˜Š','ðŸ˜‡','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','ðŸ˜š','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ¤¨','ðŸ§','ðŸ¤“','ðŸ˜Ž','ðŸ¤©','ðŸ¥³','ðŸ¤¡','ðŸ‘»','ðŸ’€','ðŸ‘½','ðŸ¤–','ðŸŽƒ','ðŸ˜º','ðŸ˜¸','ðŸ˜¹','ðŸ˜»','ðŸ¤²','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤','ðŸ‘','ðŸ‘Ž','ðŸ‘Š','âœŠ','ðŸ¤›','ðŸ¤œ','ðŸ¤ž','âœŒï¸','ðŸ¤˜','ðŸ¤Ÿ','ðŸ‘Œ','ðŸ¤','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤²','ðŸ¤','ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦¾','ðŸ¦¿','è…¿','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ','ðŸ§ ','ðŸ¦·','ðŸ¦´','ðŸ‘€','ðŸ‘','ðŸ‘…','ðŸ‘„','ðŸ’‹','ðŸ©¸','â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ–¤','ðŸ¤','ðŸ¤Ž','ðŸ’”','â£ï¸','ðŸ’•','ðŸ’ž','ðŸ’“','ðŸ’—','ðŸ’–','ðŸ’˜','ðŸ’','ðŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ðŸ•‰','â˜¸ï¸','âœ¡ï¸','ðŸ”¯','ðŸ•Ž','â˜¯ï¸','â˜¦ï¸','ðŸ›','â›Ž','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™Ž','â™','â™','â™‘','â™’','â™“'];

async function init(){
    const {data:{user}} = await sb.auth.getUser();
    if(!user) { window.location.href='login.html'; return; }
    currentUser = user;
    const params = new URLSearchParams(window.location.search);
    chatId = params.get('chat');
    
    await loadChat();
    await loadMessages();
    initEmojis();
    
    sb.channel('m').on('postgres_changes',{event:'INSERT',schema:'public',table:'ngm_messages',filter:`chat_id=eq.${chatId}`},loadMessages).subscribe();
    setInterval(()=>checkOnlineStatus(), 3000);
}

async function loadChat(){
    const {data:chat} = await sb.from('ngm_chats').select('*').eq('chat_id',chatId).single();
    if(chat){
        const otherUserId = (chat.user1_id === currentUser.id) ? chat.user2_id : chat.user1_id;
        const {data:userD} = await sb.from('ngm_users').select('*').eq('user_id',otherUserId).single();
        if(userD){
            otherUser = userD;
            document.getElementById('chatTitle').textContent = userD.full_name || userD.mobile;
            document.getElementById('chatAvatar').innerHTML = userD.profile_picture_url ? `<img src="${userD.profile_picture_url}">` : `<span>${(userD.full_name||'?').charAt(0)}</span>`;
            updateUserStatus(userD);
        }
    }
}

function updateUserStatus(user){
    const lastSeen = user.last_seen ? new Date(user.last_seen).getTime() : 0;
    const diff = Date.now() - lastSeen;
    const statusEl = document.getElementById('chatStatus');
    if(diff < 15000){ statusEl.textContent = 'online'; statusEl.style.color = 'white'; }
    else { statusEl.textContent = 'last seen recently'; statusEl.style.color = 'rgba(255,255,255,0.8)'; }
}

async function checkOnlineStatus(){
    if(otherUser){
        const {data:user} = await sb.from('ngm_users').select('last_seen').eq('user_id',otherUser.user_id).single();
        if(user) updateUserStatus(user);
    }
}

function renderMessages(messages){
    const container = document.getElementById('messagesContainer');
    container.innerHTML = messages.map(msg => {
        const isSent = msg.sender_id === currentUser.id;
        const time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const content = msg.content.trim();
        const emojiRegex = /^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\s)+$/u;
        const isOnlyEmoji = emojiRegex.test(content);
        
        let emojiClass = '';
        if(isOnlyEmoji){
            const count = (content.match(/\p{Emoji_Presentation}|\p{Emoji}\uFE0F/gu) || []).length;
            if(count === 1) emojiClass = 'emoji-xl';
            else if(count === 2) emojiClass = 'emoji-lg';
            else if(count === 3) emojiClass = 'emoji-md';
            else if(count > 3) emojiClass = 'emoji-sm';
        }
        return `<div class="m ${isSent?'sent':'received'}">
            <div class="mb ${emojiClass}"><div class="mt">${msg.content}</div>
            ${emojiClass === '' ? `<div class="mti">${time}</div>` : ''}</div>
        </div>`;
    }).join('');
    window.scrollTo(0, document.body.scrollHeight);
}

async function loadMessages(){
    const {data:msgs} = await sb.from('ngm_messages').select('*').eq('chat_id',chatId).order('created_at',{ascending:true});
    renderMessages(msgs || []);
}

async function sendMessage(){
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if(!text) return;
    const {error} = await sb.from('ngm_messages').insert({chat_id:chatId, sender_id:currentUser.id, content:text, message_type:'text', created_at:new Date().toISOString()});
    if(!error){
        input.value = '';
        input.style.height = '40px';
        loadMessages();
    }
}

function initEmojis(){
    const grid = document.getElementById('emojiGrid');
    grid.innerHTML = allEmojis.map(e => `<div class="ee" onclick="addEmoji('${e}')">${e}</div>`).join('');
}
function addEmoji(emoji){
    const input = document.getElementById('messageInput');
    input.value += emoji;
    input.focus();
}
function handleTyping(){
    const input = document.getElementById('messageInput');
    input.style.height = '40px';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
}
function toggleEmoji(){ 
    document.getElementById('filePicker').classList.remove('show');
    document.getElementById('emojiKeyboard').classList.toggle('show'); 
}
function toggleFilePicker(){ 
    document.getElementById('emojiKeyboard').classList.remove('show');
    document.getElementById('filePicker').classList.toggle('show'); 
}
function goBack(){ window.location.href='ngm-chats.html'; }
function openUserInfo(){ if(otherUser) window.location.href='ngm-user-info.html?user='+otherUser.user_id; }
init();
</script>
</body>
</html>
