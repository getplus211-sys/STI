<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Nandigram - Chats</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--pc:#667eea;--sc:#764ba2}*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{font-family:-apple-system,sans-serif;background:#f5f5f5;padding-bottom:70px}.c{max-width:480px;margin:0 auto;background:#fff;min-height:100vh}.h{position:sticky;top:0;height:90px;background:linear-gradient(135deg,var(--pc),var(--sc));display:flex;align-items:flex-end;padding:0 20px 15px;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.hc{width:100%;display:flex;justify-content:space-between;align-items:center}.h h1{color:#fff;font-size:24px;font-weight:600}.hi{display:flex;gap:15px}.ib{width:40px;height:40px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;border:none}.sb{padding:15px 20px;background:#fff;border-bottom:1px solid #e0e0e0;display:none}.sb.active{display:block}.si{width:100%;padding:10px 15px;border:1px solid #e0e0e0;border-radius:20px;font-size:14px}.ps{background:#f9f9f9}.sh{padding:10px 20px;font-size:12px;color:#666;font-weight:600;text-transform:uppercase}.cl{background:#fff}.ci{display:flex;padding:12px 20px;border-bottom:1px solid #f0f0f0;cursor:pointer}.ci:active{background:#f5f5f5}.ca{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--pc),var(--sc));display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:600;flex-shrink:0;overflow:hidden}.ca img{width:100%;height:100%;object-fit:cover}.cin{flex:1;margin-left:12px;overflow:hidden}.ch{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}.cn{font-size:16px;font-weight:600;color:#333}.ct{font-size:12px;color:#999}.cp{display:flex;justify-content:space-between;align-items:center}.cm{font-size:14px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}.ub{background:var(--pc);color:#fff;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:600;min-width:20px;text-align:center}.pin{color:var(--pc);font-size:14px;margin-right:5px}.f{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;height:70px;background:#fff;border-top:1px solid #e0e0e0;display:flex;justify-content:space-around;align-items:center;z-index:100}.fi{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;padding:10px 5px}.fi.active{color:var(--pc)}.fic{font-size:24px}.fil{font-size:11px}.fab{position:fixed;bottom:90px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,var(--pc),var(--sc));border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);z-index:99;border:none}.loading{text-align:center;padding:40px 20px;color:#999}.empty{text-align:center;padding:40px 20px;color:#999}
</style>
</head>
<body>
<div class="c">
<div class="h"><div class="hc"><h1>Nandigram</h1><div class="hi"><button class="ib" onclick="ts()">üîç</button><button class="ib" onclick="sm()">‚ãÆ</button></div></div></div>
<div class="sb" id="sb"><input type="text" class="si" placeholder="Search chats..." id="si" oninput="sc()"></div>
<div class="ps" id="ps" style="display:none"><div class="sh">üìå Pinned Chats</div><div class="cl" id="pl"></div></div>
<div class="sh">All Chats</div>
<div class="cl" id="cl"><div class="loading">Loading chats...</div></div>
</div>
<button class="fab" onclick="nc()">‚úèÔ∏è</button>
<div class="f">
<div class="fi active" onclick="nav('ngm-chats.html')"><div class="fic">üí¨</div><div class="fil">Chats</div></div>
<div class="fi" onclick="nav('ngm-channel-view.html')"><div class="fic">üì¢</div><div class="fil">Channels</div></div>
<div class="fi" onclick="nav('ngm-group-chat.html')"><div class="fic">üë•</div><div class="fil">Groups</div></div>
<div class="fi" onclick="nav('ngm-profile.html')"><div class="fic">üë§</div><div class="fil">Profile</div></div>
<div class="fi" onclick="nav('ngm-kapila.html')"><div class="fic">ü§ñ</div><div class="fil">KAPiLa</div></div>
</div>
<script>
const U='https://bhmycvrbucmbbrpzeane.supabase.co',K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4',sb=window.supabase.createClient(U,K);
let cu,allChats=[];
(()=>{const t={purple:{primary:'#667eea',secondary:'#764ba2'},blue:{primary:'#4facfe',secondary:'#00f2fe'},pink:{primary:'#f093fb',secondary:'#f5576c'},green:{primary:'#43e97b',secondary:'#38f9d7'},orange:{primary:'#fa709a',secondary:'#fee140'},red:{primary:'#ff6b6b',secondary:'#ee5a6f'},teal:{primary:'#2bcbba',secondary:'#45caff'},indigo:{primary:'#4776e6',secondary:'#8e54e9'}},th=localStorage.getItem('nandigram_theme')||'purple';if(t[th]){document.documentElement.style.setProperty('--pc',t[th].primary);document.documentElement.style.setProperty('--sc',t[th].secondary)}})();
async function init(){await ca();if(!cu){window.location.href='login.html';return}await lc();subs()}
async function ca(){const{data:{user}}=await sb.auth.getUser();if(user)cu=user;else{cu=null}}
async function lc(){try{const{data:ps}=await sb.from('ngm_chat_participants').select('*,chat:ngm_chats(*),other_user:ngm_users!ngm_chats_user2_id_fkey(*)').eq('user_id',cu.id).eq('is_active',true).order('chat.last_message_at',{ascending:false});if(!ps||ps.length===0){document.getElementById('cl').innerHTML='<div class="empty">No chats yet. Start a conversation!</div>';return}allChats=[];for(const p of ps){const c=p.chat;if(!c)continue;let ou=null,cn='Unknown';if(c.chat_type==='personal'){const oid=c.user1_id===cu.id?c.user2_id:c.user1_id;const{data:u}=await sb.from('ngm_users').select('*').eq('user_id',oid).single();ou=u;cn=u?.full_name||u?.mobile||'Unknown'}else if(c.chat_type==='group'){const{data:g}=await sb.from('ngm_groups').select('*').eq('chat_id',c.chat_id).single();cn=g?.group_name||'Group Chat'}else if(c.chat_type==='channel'){const{data:ch}=await sb.from('ngm_channels').select('*').eq('chat_id',c.chat_id).single();cn=ch?.channel_name||'Channel'}const{data:lm}=await sb.from('ngm_messages').select('*').eq('chat_id',c.chat_id).order('created_at',{ascending:false}).limit(1).single();allChats.push({chat:c,participant:p,otherUser:ou,chatName:cn,lastMessage:lm})}rc()}catch(e){console.error(e);document.getElementById('cl').innerHTML='<div class="empty">Error loading chats</div>'}}
function rc(){const pc=allChats.filter(c=>c.participant.is_pinned),rc=allChats.filter(c=>!c.participant.is_pinned);if(pc.length>0){document.getElementById('ps').style.display='block';rcs(pc,'pl',true)}else{document.getElementById('ps').style.display='none'}rcs(rc,'cl',false)}
function rcs(cs,cid,pin){const con=document.getElementById(cid);if(cs.length===0){if(!pin)con.innerHTML='<div class="empty">No chats</div>';return}con.innerHTML=cs.map(c=>{const in1=c.chatName.charAt(0).toUpperCase(),lm=c.lastMessage?.content||'No messages yet',tm=ft(c.chat.last_message_at||c.chat.created_at);return`<div class="ci" onclick="oc('${c.chat.chat_id}')"><div class="ca">${c.otherUser?.profile_picture_url?`<img src="${c.otherUser.profile_picture_url}">`:`${in1}`}</div><div class="cin"><div class="ch"><span class="cn">${pin?'<span class="pin">üìå</span>':''}${c.chatName}</span><span class="ct">${tm}</span></div><div class="cp"><span class="cm">${lm}</span>${c.participant.unread_count>0?`<span class="ub">${c.participant.unread_count}</span>`:''}</div></div></div>`}).join('')}
function ft(d){if(!d)return'';const n=new Date(),dt=new Date(d),df=n-dt;if(df<60000)return'now';if(df<3600000)return Math.floor(df/60000)+'m';if(df<86400000)return Math.floor(df/3600000)+'h';if(df<172800000)return'Yesterday';if(df<604800000)return Math.floor(df/86400000)+'d';return dt.toLocaleDateString()}
function ts(){document.getElementById('sb').classList.toggle('active');if(document.getElementById('sb').classList.contains('active'))document.getElementById('si').focus()}
function sc(){const q=document.getElementById('si').value.toLowerCase();document.querySelectorAll('.ci').forEach(i=>{const n=i.querySelector('.cn').textContent.toLowerCase();i.style.display=n.includes(q)?'flex':'none'})}
function sm(){const acts=['Settings','New Group','New Channel','Privacy','Theme'];alert(acts.join('\n'))}
function oc(cid){window.location.href=`ngm-chat-window.html?chat=${cid}`}
function nc(){window.location.href='ngm-new-chat.html'}
function nav(p){window.location.href=p}
function subs(){sb.channel('chats').on('postgres_changes',{event:'*',schema:'public',table:'ngm_messages'},()=>lc()).on('postgres_changes',{event:'*',schema:'public',table:'ngm_chats'},()=>lc()).subscribe()}
document.addEventListener('copy',e=>e.preventDefault());document.addEventListener('paste',e=>e.preventDefault());
init();
</script>
</body>
</html>
