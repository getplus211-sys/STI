<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nandigram Chats</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background: #fff;
          display: flex;
          flex-direction: column;
          height: 100vh;
          overflow: hidden;
        }

        /* HEADER */
        .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 12px 16px;
          min-height: 120px;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }

        .header-top {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .header-title {
          font-size: 24px;
          font-weight: 800;
        }

        .search-bar {
          background: rgba(255,255,255,0.2);
          border-radius: 24px;
          padding: 8px 16px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .search-bar input {
          background: transparent;
          border: none;
          color: white;
          width: 100%;
          outline: none;
        }

        .search-bar input::placeholder {
          color: rgba(255,255,255,0.6);
        }

        /* TABS */
        .tabs {
          display: flex;
          gap: 0;
          background: white;
          border-bottom: 1px solid #e5e7eb;
        }

        .tab-btn {
          background: none;
          border: none;
          padding: 12px 16px;
          font-size: 13px;
          font-weight: 600;
          color: #9ca3af;
          cursor: pointer;
          flex: 1;
          position: relative;
        }

        .tab-btn.active {
          color: #667eea;
        }

        .tab-btn.active::after {
          content: '';
          position: absolute;
          bottom: -1px;
          left: 0;
          right: 0;
          height: 3px;
          background: #667eea;
        }

        /* CONTENT */
        .content {
          flex: 1;
          overflow-y: auto;
          padding: 0;
        }

        .chats-list {
          list-style: none;
        }

        .chat-item {
          padding: 12px 16px;
          border-bottom: 1px solid #f3f4f6;
          display: flex;
          gap: 12px;
          cursor: pointer;
          align-items: center;
        }

        .chat-item:active {
          background: #f9fafb;
        }

        .chat-avatar {
          width: 56px;
          height: 56px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 18px;
          flex-shrink: 0;
        }

        .chat-info {
          flex: 1;
          min-width: 0;
        }

        .chat-name {
          font-size: 15px;
          font-weight: 600;
          color: #1f2937;
          margin-bottom: 4px;
        }

        .chat-preview {
          font-size: 13px;
          color: #9ca3af;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .chat-time {
          font-size: 12px;
          color: #d1d5db;
          flex-shrink: 0;
        }

        .empty-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          color: #d1d5db;
        }

        .empty-icon {
          font-size: 64px;
          margin-bottom: 16px;
        }

        .empty-text {
          font-size: 16px;
          color: #9ca3af;
        }

        /* FOOTER */
        .footer-tabs {
          display: flex;
          justify-content: space-around;
          align-items: center;
          padding: 8px 0;
          background: white;
          border-top: 1px solid #e5e7eb;
        }

        .footer-tab {
          background: none;
          border: none;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
          cursor: pointer;
          padding: 8px 16px;
          flex: 1;
          font-size: 11sp;
          color: #9ca3af;
        }

        .footer-tab.active {
          color: #667eea;
        }

        .footer-tab-icon {
          font-size: 20px;
        }

        /* LOADING */
        .loading {
          text-align: center;
          padding: 40px 20px;
          color: #9ca3af;
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-top">
        <div class="header-title">Nandigram</div>
        <div>üîç ‚ãÆ</div>
    </div>
    <div class="search-bar">
        <span>üîç</span>
        <input type="text" id="searchInput" placeholder="Search chats..." />
    </div>
</div>

<!-- TABS -->
<div class="tabs">
    <button class="tab-btn active" data-tab="chats">All Chats</button>
    <button class="tab-btn" data-tab="groups">Groups</button>
    <button class="tab-btn" data-tab="channels">Channels</button>
    <button class="tab-btn" data-tab="saved">Saved</button>
</div>

<!-- CONTENT -->
<div class="content" id="content">
    <div class="loading">‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡´Å‡™Ç ‡™õ‡´á...</div>
</div>

<!-- FOOTER -->
<div class="footer-tabs">
    <button class="footer-tab active">üí¨ Chats</button>
    <button class="footer-tab">üë• Groups</button>
    <button class="footer-tab">üì¢ Channels</button>
    <button class="footer-tab">‚≠ê Saved</button>
</div>

<script>
    const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadChats() {
      try {
        const { data: chats, error } = await sb
          .from('ngm_chats')
          .select('chat_id, chat_type, created_at, user1_id, user2_id')
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) throw error;

        console.log('Chats loaded:', chats?.length || 0);

        if (!chats || chats.length === 0) {
          showEmpty();
          return;
        }

        renderChats(chats);

      } catch (err) {
        console.error('Error:', err);
        showError();
      }
    }

    function renderChats(chats) {
      const contentDiv = document.getElementById('content');

      let html = '<ul class="chats-list">';

      chats.forEach(chat => {
        const chatName = chat.chat_type === 'direct'
          ? 'Chat ' + chat.user1_id.substring(0, 8)
          : 'Group';

        const time = formatTime(new Date(chat.created_at));
        const initials = chatName.charAt(0).toUpperCase();

        html += `
          <li class="chat-item">
            <div class="chat-avatar">${initials}</div>
            <div class="chat-info">
              <div class="chat-name">${chatName}</div>
              <div class="chat-preview">Tap to view messages</div>
            </div>
            <div class="chat-time">${time}</div>
          </li>
        `;
      });

      html += '</ul>';
      contentDiv.innerHTML = html;
    }

    function formatTime(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Now';
      if (diffMins < 60) return diffMins + 'm ago';
      if (diffHours < 24) return diffHours + 'h ago';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return diffDays + 'd ago';

      return date.toLocaleDateString('gu-IN', { month: 'short', day: 'numeric' });
    }

    function showEmpty() {
      const contentDiv = document.getElementById('content');
      contentDiv.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üí¨</div>
          <div class="empty-text">No chats yet</div>
        </div>
      `;
    }

    function showError() {
      const contentDiv = document.getElementById('content');
      contentDiv.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <div class="empty-text">Error loading chats</div>
        </div>
      `;
    }

    // Init
    loadChats();

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        console.log('Tab:', btn.dataset.tab);
        loadChats();
      });
    });
</script>
</body>
</html>
