<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>Overall Performance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;padding-top:105px}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
.sticky-header{position:fixed;top:0;left:0;right:0;z-index:1000;background:linear-gradient(135deg,#8b5cf6,#7c3aed);box-shadow:0 2px 10px rgba(139,92,246,0.3);min-height:95px;display:flex;align-items:flex-end;padding:0 12px 12px 12px}
.sticky-header-content{max-width:600px;color:#fff;flex:1;margin:0 auto;width:100%}
.page-title{margin:0;font-size:16px;font-weight:700;color:#fff}
.home-btn{background:rgba(255,255,255,0.2);color:#fff;border:2px solid rgba(255,255,255,0.4);border-radius:10px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;display:inline-flex;align-items:center;gap:5px}
.home-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px)}
.student-card{background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border:2px solid #bae6fd;position:relative;overflow:hidden}
.student-card::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(59,130,246,0.1) 0%,transparent 70%);animation:pulse 3s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.student-header{display:flex;align-items:center;gap:15px;margin-bottom:20px;position:relative;z-index:1}
.avatar{width:90px;height:90px;background:linear-gradient(135deg,#3b82f6 0%,#8b5cf6 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:bold;color:#fff;box-shadow:0 8px 20px rgba(59,130,246,0.4);border:4px solid #fff}
.student-meta{display:flex;gap:12px;font-size:14px;flex-wrap:wrap;margin-top:8px}
.student-name{color:#1e293b;font-size:26px;font-weight:700;margin:0 0 8px 0;text-shadow:0 2px 4px rgba(0,0,0,0.1)}
.meta-badge{background:#fff;padding:6px 12px;border-radius:20px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:inline-flex;align-items:center;gap:5px}
.level-badge{font-weight:700;padding:8px 16px;border-radius:25px;font-size:15px;box-shadow:0 4px 12px rgba(0,0,0,0.15);cursor:pointer;transition:all 0.2s}
.level-badge:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.2)}
.level-initial{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.level-starter{background:linear-gradient(135deg,#f97316,#ea580c);color:#fff}
.level-good{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
.level-better{background:linear-gradient(135deg,#eab308,#ca8a04);color:#fff}
.level-nice{background:linear-gradient(135deg,#84cc16,#65a30d);color:#fff}
.level-verygood{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
.level-verynice{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.level-excellent{background:linear-gradient(135deg,#14b8a6,#0d9488);color:#fff}
.level-excellentplus{background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff}
.level-perfect{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;animation:glow 2s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 4px 12px rgba(139,92,246,0.4)}50%{box-shadow:0 4px 20px rgba(139,92,246,0.8)}}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px}
.chart-title{font-size:16px;font-weight:600;color:#1f2937;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.info-icon{width:22px;height:22px;background:#3b82f6;color:#fff;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;font-weight:bold;flex-shrink:0}
.info-icon:hover{background:#2563eb;transform:scale(1.1)}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0}
.stat-card{background:#f8fafc;border-radius:12px;padding:15px;text-align:center;position:relative}
.stat-card.clickable{cursor:pointer;transition:all 0.2s}
.stat-card.clickable:hover{background:#e0e7ff;transform:translateY(-2px)}
.stat-label{font-size:13px;color:#6b7280;margin-bottom:5px}
.stat-value{font-size:28px;font-weight:bold;color:#1f2937}
.section-title{font-size:18px;font-weight:bold;margin:20px 0 10px;color:#1f2937}
.subjects-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}
.subject-item{background:#f8fafc;border-radius:12px;padding:15px;display:flex;flex-direction:column;gap:10px}
.subject-name{font-size:15px;font-weight:600;color:#1f2937}
.subject-bottom{display:flex;justify-content:space-between;align-items:center;gap:10px}
.subject-per{font-size:20px;font-weight:bold}
.view-btn{background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.view-btn:hover{background:#2563eb;transform:translateY(-2px)}
.per-excellent{color:#22c55e}
.per-verygood{color:#10b981}
.per-good{color:#3b82f6}
.per-average{color:#f59e0b}
.per-poor{color:#ef4444}
.progress-bar{width:100%;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;margin-top:6px}
.progress-fill{height:100%;transition:width 0.5s ease}
.rec-card{background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);color:#fff;border-radius:16px;padding:20px;margin-bottom:14px}
.rec-title{font-size:18px;font-weight:bold;margin-bottom:15px}
.rec-list{list-style:none;padding:0;margin:0}
.rec-list li{padding:5px 0 5px 22px;position:relative;font-size:14px;line-height:1.5}
.rec-list li:before{content:"тЬУ";position:absolute;left:0;color:#22c55e;font-weight:bold}
.loader{text-align:center;padding:40px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:20px;max-width:420px;width:90%;max-height:85vh;overflow-y:auto;padding:25px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease}
@keyframes modalPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.modal-icon{font-size:40px;margin-bottom:10px;text-align:center}
.modal-title{font-size:18px;font-weight:700;margin-bottom:15px;color:#1e293b;text-align:center}
.modal-body{text-align:left}
.modal-text{font-size:14px;color:#64748b;line-height:1.6;margin-bottom:15px}
.modal-btn{background:#3b82f6;color:#fff;border:none;border-radius:12px;padding:12px 24px;font-size:15px;font-weight:600;cursor:pointer;width:100%;margin-top:15px}
.chapter-item{padding:10px 0;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
.chapter-name{font-size:14px;color:#374151;flex:1}
.chapter-per{font-size:16px;font-weight:bold}
.target-good{color:#22c55e}
.target-average{color:#f59e0b}
.target-poor{color:#ef4444}
.level-info-modal{max-width:380px}
.level-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
.level-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:8px;background:#f8fafc}
.level-item .level-badge{padding:5px 10px;font-size:12px;margin:0;float:none;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.level-range{font-size:12px;color:#64748b}
@media (max-width:600px){
.charts-grid{grid-template-columns:1fr}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.subjects-grid{grid-template-columns:repeat(2,1fr)}
.student-header{flex-direction:column;text-align:center}
body{padding-top:105px}
.page-title{font-size:14px}
.home-btn{padding:6px 12px;font-size:12px}
.sticky-header{padding:8px 12px}
.avatar{width:70px;height:70px;font-size:32px}
.student-name{font-size:22px}
.student-meta{justify-content:center}
.subject-bottom{flex-direction:column}
.subject-per{font-size:16px}
.subject-name{font-size:13px}
.view-btn{font-size:11px;padding:5px 10px}
.stat-label{font-size:11px}
.stat-value{font-size:22px}
}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="card loader">
    <h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
    <p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ</p>
  </div>
</div>

<div id="modal" class="modal" onclick="if(event.target.id === 'modal') hideModal()">
  <div class="modal-content">
    <div class="modal-icon" id="modalIcon">тД╣я╕П</div>
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-body" id="modalBody">Content</div>
    <button class="modal-btn" onclick="hideModal()">ркмркВркз ркХрк░рлЛ</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let app = document.getElementById("app");
let user, allResults = [], allAttempts = [];
let userName = '', overallData = {};

function hideModal() {
  document.getElementById('modal').classList.remove('show');
  document.getElementById('modal').querySelector('.modal-content').classList.remove('level-info-modal');
}

function showChartInfo(type) {
  const messages = {
    overall: 'ркЖ chart ркдркорк╛рк░рк╛ ркмркзрк╛ tests ркирлЛ combined рккрк░рк┐ркгрк╛рко ркмркдрк╛рк╡рлЗ ркЫрлЗ - рк╕рк╛ркЪрк╛, ркЦрлЛркЯрк╛ ркЕркирлЗ ркмрк╛ркХрлА рккрлНрк░рк╢рлНркирлЛ.',
    subjects: 'ркЖ ркЪрк╛рк░рлНркЯ ркмркдрк╛рк╡рлЗ ркЫрлЗ ркХрлЗ ркдркорк╛рк░рк╛ overall performance ркорк╛ркВркерлА ркХркпрк╛ рк╡рк┐рк╖ркп ркХрлЗркЯрк▓рк╛ ркЯркХрк╛ ркЫрлЗ. ркдркоркирлЗ ркЬрлЗ ркЖрк╡ркбрлЗ ркЫрлЗ ркПркорк╛ркВркерлА ркХркпрлЛ рк╡рк┐рк╖ркп ркдркоркирлЗ рк╡ркзрк╛рк░рлЗ ркЖрк╡ркбрлЗ ркЫрлЗ.'
  };
  
  document.getElementById('modalIcon').innerText = 'тД╣я╕П';
  document.getElementById('modalTitle').innerText = type === 'overall' ? 'Overall рккрк░рк┐ркгрк╛рко' : 'рк╡рк┐рк╖ркп рк╡рк╛рк░ рк╡рк┐ркдрк░ркг';
  document.getElementById('modalBody').innerHTML = `<div class="modal-text">${messages[type]}</div>`;
  document.getElementById('modal').classList.add('show');
}

function showConcentrationInfo() {
  document.getElementById('modalIcon').innerText = 'тД╣я╕П';
  document.getElementById('modalTitle').innerText = 'ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ';
  document.getElementById('modalBody').innerHTML = '<div class="modal-text">ркЖ рк░рлЗркЯрк┐ркВркЧ ркдркорк╛рк░рлА рк╕рлНрккрлАркб ркЕркирлЗ ркЪрлЛркХрк╕рк╛ркИ ркмркВркирлЗ рккрк░ ркЖркзрк╛рк░рк┐ркд ркЫрлЗ.\n\nркЬрлЛ ркдркорлЗ ркмркзрк╛ рккрлНрк░рк╢рлНркирлЛ рк╕рк╛ркЪрк╛ ркХрк░рлЛ рккркг рк╡ркзрлБ рк╕ркоркп рк▓рлЛ ркдрлЛ, ркПркХрк╛ркЧрлНрк░ркдрк╛ ркдркорк╛рк░рлА ркУркЫрлА ркЬ ркЧркгрк╛рк╢рлЗ. ркЭркбркк ркЕркирлЗ ркЪрлЛркХрк╕рк╛ркИ ркЙрккрк░ ркПркХрк╛ркЧрлНрк░ркдрк╛ркирлБркВ ркорк╛рккрки ркерк╛ркп ркЫрлЗ.</div>';
  document.getElementById('modal').classList.add('show');
}

function showLevelInfo() {
  const levelData = [
    { name: 'Initial', range: '1-10%', class: 'level-initial' },
    { name: 'Starter', range: '11-20%', class: 'level-starter' },
    { name: 'Good', range: '21-30%', class: 'level-good' },
    { name: 'Better', range: '31-40%', class: 'level-better' },
    { name: 'Nice', range: '41-50%', class: 'level-nice' },
    { name: 'Very Good', range: '51-60%', class: 'level-verygood' },
    { name: 'Very Nice', range: '61-70%', class: 'level-verynice' },
    { name: 'Excellent', range: '71-80%', class: 'level-excellent' },
    { name: 'Excellent+', range: '81-90%', class: 'level-excellentplus' },
    { name: 'Perfect', range: '91-100%', class: 'level-perfect' }
  ];
  
  let levelHTML = '<div class="level-grid">';
  levelData.forEach(level => {
    levelHTML += `
      <div class="level-item">
        <span class="level-badge ${level.class}">${level.name}</span>
        <span class="level-range">${level.range}</span>
      </div>
    `;
  });
  levelHTML += '</div>';
  
  document.getElementById('modalIcon').innerText = 'ЁЯУК';
  document.getElementById('modalTitle').innerText = 'Performance Levels';
  document.getElementById('modalBody').innerHTML = '<div class="modal-text">ркдркорк╛рк░рк╛ рккрлНрк░ркжрк░рлНрк╢ркиркирк╛ ркЖркзрк╛рк░рлЗ levels:</div>' + levelHTML;
  document.getElementById('modal').querySelector('.modal-content').classList.add('level-info-modal');
  document.getElementById('modal').classList.add('show');
}

async function init() {
  try {
    const { data: { user: u } } = await sb.auth.getUser();
    if (!u) {
      app.innerHTML = '<div class="card"><h3>ЁЯФТ Login Required</h3><p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЛркЧрк┐рки ркХрк░рлЛ</p></div>';
      return;
    }
    user = u;

    const { data: profile } = await sb
      .from("profiles")
      .select("full_name")
      .eq("id", user.id)
      .single();
    
    userName = profile?.full_name || "Student";

    const { data: results } = await sb
      .from("kls_quiz_attempts")
      .select("*")
      .eq("user_id", user.id)
      .order("completed_at", { ascending: false });
    
    if (!results || results.length === 0) {
      app.innerHTML = '<div class="card"><h3>тЪая╕П No Tests Found</h3><p>ркдркорлЗ рк╣ркЬрлБ рк╕рлБркзрлА ркХрлЛркИ ркЯрлЗрк╕рлНркЯ ркЖрккрлА ркиркерлА</p></div>';
      return;
    }
    
    allResults = results;

    const resultIds = results.map(r => r.id);
    const { data: attempts } = await sb
      .from("kls_question_attempts")
      .select(`
        *,
        kls_questions (
          *,
          kls_subjects (id, name, subject_code),
          kls_chapters (id, name, chapter_code)
        )
      `)
      .in("quiz_attempt_id", resultIds);
    
    allAttempts = attempts || [];

    calculateOverallData();
    displayOverallPerformance();
  } catch (err) {
    console.error('Init error:', err);
    app.innerHTML = '<div class="card"><h3>тЭМ Error</h3><p>' + err.message + '</p></div>';
  }
}

function getPerformanceLevel(percentage) {
  if (percentage <= 10) return "Initial";
  if (percentage <= 20) return "Starter";
  if (percentage <= 30) return "Good";
  if (percentage <= 40) return "Better";
  if (percentage <= 50) return "Nice";
  if (percentage <= 60) return "Very Good";
  if (percentage <= 70) return "Very Nice";
  if (percentage <= 80) return "Excellent";
  if (percentage <= 90) return "Excellent+";
  return "Perfect";
}

function calculateConcentrationRating(avgTimePerQ, accuracy) {
  if (accuracy <= 0) return "1.0";
  
  let rating = 10;
  
  if (avgTimePerQ > 10) rating -= 0.5;
  if (avgTimePerQ > 15) rating -= 1;
  if (avgTimePerQ > 20) rating -= 1;
  if (avgTimePerQ > 25) rating -= 1.5;
  if (avgTimePerQ > 30) rating -= 2;
  if (avgTimePerQ > 35) rating -= 3;
  
  if (accuracy < 90) rating -= 0.5;
  if (accuracy < 80) rating -= 1;
  if (accuracy < 70) rating -= 1.5;
  if (accuracy < 60) rating -= 2;
  if (accuracy < 50) rating -= 2;
  if (accuracy < 40) rating -= 2.5;
  if (accuracy < 30) rating -= 2.5;
  if (accuracy < 20) rating -= 3;
  if (accuracy < 10) rating -= 3;
  
  return Math.max(1, Math.min(10, rating)).toFixed(1);
}

function getPercentageColor(per) {
  if (per >= 85) return 'per-excellent';
  if (per >= 70) return 'per-verygood';
  if (per >= 55) return 'per-good';
  if (per >= 40) return 'per-average';
  return 'per-poor';
}

function getSubjectCode(name) {
  const subjectMap = {
    'ркЧркгрк┐ркд': 'MATHS',
    'рк░рк┐ркЭркирк┐ркВркЧ': 'REASONING',
    'ркнрк╛рк░ркдркирлБркВ ркмркВркзрк╛рк░ркг': 'CONSTITUTION',
    'ркнрк╛рк░ркдркирлЛ ркЗркдрк┐рк╣рк╛рк╕': 'INDIAN_HISTORY',
    'ркЧрлБркЬрк░рк╛ркдркирлЛ ркЗркдрк┐рк╣рк╛рк╕': 'GUJARAT_HISTORY',
    'ркнрк╛рк░ркдркирлЛ рк╡рк╛рк░рк╕рлЛ': 'INDIAN_CULTURE',
    'ркЧрлБркЬрк░рк╛ркдркирлЛ рк╡рк╛рк░рк╕рлЛ': 'GUJARAT_CULTURE',
    'ркЧрлБркЬрк░рк╛ркдрлА рк╡рлНркпрк╛ркХрк░ркг': 'GUJARATI_GRAMMAR',
    'ркнрк╛рк░ркдркирлА ркнрлВркЧрлЛрк│': 'INDIAN_GEOGRAPHY',
    'ркЧрлБркЬрк░рк╛ркдркирлА ркнрлВркЧрлЛрк│': 'GUJARAT_GEOGRAPHY',
    'ркнрк╛рк░ркдркирлБркВ ркЕрк░рлНркеркдркВркдрлНрк░': 'INDIAN_ECONOMY',
    'рк╕рк╛ркорк╛ркирлНркп рк╡рк┐ркЬрлНркЮрк╛рки ркЕркирлЗ ркЯрлЗркХрлНркирлЛрк▓рлЛркЬрлА': 'SCIENCE_TECH',
    'ркЕркВркЧрлНрк░рлЗркЬрлА рк╡рлНркпрк╛ркХрк░ркг': 'ENGLISH_GRAMMAR'
  };
  return subjectMap[name] || 'GENERAL';
}

function calculateOverallData() {
  let totalQuestions = 0, totalCorrect = 0, totalWrong = 0, totalSkipped = 0, totalTime = 0;
  
  allResults.forEach(r => {
    totalQuestions += r.total_questions;
    totalCorrect += r.correct_answers;
    totalWrong += r.wrong_answers;
    totalSkipped += r.skipped_questions;
    totalTime += r.total_time_seconds;
  });

  const overallPercentage = totalQuestions > 0 ? ((totalCorrect / totalQuestions) * 100).toFixed(2) : 0;
  const avgTimePerQ = totalQuestions > 0 ? Math.floor(totalTime / totalQuestions) : 0;
  
  const subjectMap = {};
  
  allAttempts.forEach(att => {
    if (!att.kls_questions || !att.kls_questions.kls_subjects || !att.kls_questions.kls_chapters) return;
    
    const subjId = att.kls_questions.kls_subjects.id;
    const subjName = att.kls_questions.kls_subjects.name;
    const chapterId = att.kls_questions.kls_chapters.id;
    const chapterName = att.kls_questions.kls_chapters.name;
    
    if (!subjectMap[subjId]) {
      subjectMap[subjId] = {
        name: subjName,
        total: 0,
        correct: 0,
        chapters: {}
      };
    }
    
    subjectMap[subjId].total++;
    if (att.is_correct) subjectMap[subjId].correct++;
    
    if (!subjectMap[subjId].chapters[chapterId]) {
      subjectMap[subjId].chapters[chapterId] = {
        name: chapterName,
        total: 0,
        correct: 0
      };
    }
    
    subjectMap[subjId].chapters[chapterId].total++;
    if (att.is_correct) subjectMap[subjId].chapters[chapterId].correct++;
  });

  overallData = {
    totalQuestions,
    totalCorrect,
    totalWrong,
    totalSkipped,
    totalTime,
    overallPercentage: parseFloat(overallPercentage),
    avgTimePerQ,
    subjectMap,
    level: getPerformanceLevel(parseFloat(overallPercentage)),
    concentrationRating: calculateConcentrationRating(avgTimePerQ, parseFloat(overallPercentage))
  };
}

function displayOverallPerformance() {
  const firstLetter = userName.charAt(0).toUpperCase();
  const levelClass = overallData.level.toLowerCase().replace('+', 'plus').replace(' ', '');
  const lastTestDate = new Date(allResults[0].completed_at).toLocaleDateString('en-GB').replace(/\//g, '-');
  
  const overallRank = 1;
  
  const targetPer = 80;
  const targetClass = overallData.overallPercentage >= targetPer ? 'target-good' : 
                      overallData.overallPercentage >= targetPer - 10 ? 'target-average' : 'target-poor';

  // Subject data for pie chart
  const subjectLabels = [];
  const subjectData = [];
  const subjectColors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4', '#f97316', '#84cc16'];
  
  Object.entries(overallData.subjectMap).forEach(([subjId, subjData], idx) => {
    subjectLabels.push(subjData.name);
    subjectData.push(subjData.total);
  });

  // Generate subject HTML
  let subjectHTML = '';
  Object.entries(overallData.subjectMap).forEach(([subjId, subjData]) => {
    const subjPer = ((subjData.correct / subjData.total) * 100).toFixed(1);
    const subjPerColor = getPercentageColor(parseFloat(subjPer));
    
    subjectHTML += `
      <div class="subject-item">
        <div class="subject-name">${subjData.name}</div>
        <div class="progress-bar">
          <div class="progress-fill ${subjPerColor}" style="width:${subjPer}%;background:currentColor"></div>
        </div>
        <div class="subject-bottom">
          <span class="subject-per ${subjPerColor}">${subjPer}%</span>
          <button class="view-btn" onclick="showChapterDetails('${subjId}', '${subjData.name}')">View Full</button>
        </div>
      </div>
    `;
  });

  // Generate recommendations with study time and dynamic subject advice
  let recCards = '';
  
  // Study Time Recommendation based on overall performance
  if (overallData.overallPercentage < 85) {
    const studyHours = overallData.overallPercentage < 50 ? '12-14' : 
                       overallData.overallPercentage < 70 ? '10-12' : '8-10';
    recCards += `
    <div class="rec-card">
      <div class="rec-title">ЁЯУЪ ркжрлИркирк┐ркХ ркЕркнрлНркпрк╛рк╕ рк╕ркоркп ркнрк▓рк╛ркоркг</div>
      <ul class="rec-list">
        <li>ркжрк░рк░рлЛркЬ ркУркЫрк╛ркорк╛ркВ ркУркЫрк╛ ${studyHours} ркХрк▓рк╛ркХ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ</li>
        <li>рк╕рк╡рк╛рк░рлЗ 4-5 ркХрк▓рк╛ркХ, ркмрккрлЛрк░рлЗ 3-4 ркХрк▓рк╛ркХ ркЕркирлЗ рк╕рк╛ркВркЬрлЗ 3-4 ркХрк▓рк╛ркХ</li>
        <li>ркжрк░ 1.5-2 ркХрк▓рк╛ркХрлЗ 15 ркорк┐ркирк┐ркЯ ркирлЛ break рк▓рлЛ</li>
        <li>рк╢рк╛ркВркд рк╡рк╛ркдрк╛рк╡рк░ркгркорк╛ркВ focused study ркХрк░рлЛ</li>
      </ul>
    </div>`;
  }
  
  // Subject-wise recommendations with specific advice
  const subjectAdvice = {
    'MATHS': {
      weak: ['ркжрк░рк░рлЛркЬ 50-60 рккрлНрк░рк╢рлНркирлЛ practice ркХрк░рлЛ', 'ркмрлЗрк╕рк┐ркХ arithmetic ркЕркирлЗ tables ркоркЬркмрлВркд ркХрк░рлЛ', 'Shortcuts ркЕркирлЗ formulas ркпрк╛ркж ркХрк░рлЛ', 'Previous year ркирк╛ рккрлНрк░рк╢рлНркирлЛ рк╡рк╛рк░ркВрк╡рк╛рк░ ркЙркХрлЗрк▓рлЛ'],
      average: ['ркорлБрк╢рлНркХрлЗрк▓ рк╕рк╡рк╛рк▓рлЛ рккрк░ рк╡ркзрлБ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркХрк░рлЛ', 'Speed ркЕркирлЗ accuracy ркмркВркирлЗ рккрк░ ркХрк╛рко ркХрк░рлЛ', 'Mock tests ркирк┐ркпркорк┐ркд рк▓рлЛ', 'Time management рк╕рлБркзрк╛рк░рлЛ']
    },
    'REASONING': {
      weak: ['ркжрк░рк░рлЛркЬ рк╡рк┐рк╡рк┐ркз рккрлНрк░ркХрк╛рк░ркирк╛ рккрлНрк░рк╢рлНркирлЛ practice ркХрк░рлЛ', 'Patterns ркЕркирлЗ sequences рк╕ркоркЬрлЛ', 'Logical thinking develop ркХрк░рлЛ', 'Puzzles ркЕркирлЗ brain teasers ркЙркХрлЗрк▓рлЛ'],
      average: ['ркЬркЯрк┐рк▓ reasoning рккрк░ ркзрлНркпрк╛рки ркЖрккрлЛ', 'Different question types ркорк╛ркВ expertise ркорлЗрк│рк╡рлЛ', 'Speed рк╡ркзрк╛рк░рк╡рк╛ ркорк╛ркЯрлЗ shortcuts рк╢рлАркЦрлЛ']
    },
    'CONSTITUTION': {
      weak: ['ркорлБркЦрлНркп articles ркЕркирлЗ amendments ркпрк╛ркж ркХрк░рлЛ', 'ркжрк░рк░рлЛркЬ 5-10 articles рк╡рк╛ркВркЪрлЛ ркЕркирлЗ ркирлЛркВркзрлЛ ркмркирк╛рк╡рлЛ', 'Constitutional provisions рк╕ркоркЬрлЛ', 'Current affairs рк╕рк╛ркерлЗ link ркХрк░рлЛ'],
      average: ['Deep understanding ркорк╛ркЯрлЗ рк╡ркзрлБ рк╡рк╛ркВркЪрки ркХрк░рлЛ', 'Case studies ркЕркирлЗ examples рк╕рк╛ркерлЗ рк╢рлАркЦрлЛ', 'Mock tests ркЖрккрлЛ']
    },
    'INDIAN_HISTORY': {
      weak: ['Timeline ркЖркзрк╛рк░рк┐ркд ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ', 'ркорк╣ркдрлНрк╡ркирк╛ events ркЕркирлЗ dates ркпрк╛ркж ркХрк░рлЛ', 'ркжрк░рк░рлЛркЬ ркПркХ period ркирлЛ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ', 'Maps ркЕркирлЗ diagrams ркирлЛ ркЙрккркпрлЛркЧ ркХрк░рлЛ'],
      average: ['In-depth study ркХрк░рлЛ major events ркирлЛ', 'Connections ркмркирк╛рк╡рлЛ events рк╡ркЪрлНркЪрлЗ', 'Multiple sources рк╡рк╛ркВркЪрлЛ']
    },
    'GUJARAT_HISTORY': {
      weak: ['ркЧрлБркЬрк░рк╛ркдркирк╛ ркорлБркЦрлНркп рк╢рк╛рк╕ркХрлЛ ркЕркирлЗ events ркпрк╛ркж ркХрк░рлЛ', 'Timeline ркмркирк╛рк╡рлЛ ркЕркирлЗ daily review ркХрк░рлЛ', 'Local history рк╕рк╛ркерлЗ connect ркХрк░рлЛ'],
      average: ['Detailed study ркХрк░рлЛ important periods ркирлЛ', 'Cultural aspects рккрк░ рккркг ркзрлНркпрк╛рки ркЖрккрлЛ']
    },
    'INDIAN_CULTURE': {
      weak: ['Major festivals, traditions ркЕркирлЗ customs ркпрк╛ркж ркХрк░рлЛ', 'Art forms ркЕркирлЗ architecture рк╡рк┐рк╢рлЗ рк╡рк╛ркВркЪрлЛ', 'Visual learning ркирлЛ ркЙрккркпрлЛркЧ ркХрк░рлЛ'],
      average: ['Regional variations рк╕ркоркЬрлЛ', 'Historical context рк╕рк╛ркерлЗ рк╢рлАркЦрлЛ']
    },
    'GUJARAT_CULTURE': {
      weak: ['ркЧрлБркЬрк░рк╛ркдркирлА рккрк░ркВрккрк░рк╛ркУ ркЕркирлЗ ркдрк╣рлЗрк╡рк╛рк░рлЛ ркпрк╛ркж ркХрк░рлЛ', 'Folk arts ркЕркирлЗ crafts рк╡рк┐рк╢рлЗ ркЬрк╛ркгрлЛ', 'Local cultural events ркорк╛ркВ interest рк▓рлЛ'],
      average: ['Detailed knowledge ркорлЗрк│рк╡рлЛ various aspects ркирлЛ', 'Comparative study ркХрк░рлЛ']
    },
    'GUJARATI_GRAMMAR': {
      weak: ['ркжрк░рк░рлЛркЬ 30 ркорк┐ркирк┐ркЯ grammar practice ркХрк░рлЛ', 'Rules рк╕ркоркЬрлЛ ркЕркирлЗ examples ркмркирк╛рк╡рлЛ', 'Reading comprehension рккрк░ ркХрк╛рко ркХрк░рлЛ', 'Writing practice рк╡ркзрк╛рк░рлЛ'],
      average: ['Advanced grammar topics рккрк░ ркзрлНркпрк╛рки ркЖрккрлЛ', 'Error correction exercises ркХрк░рлЛ']
    },
    'INDIAN_GEOGRAPHY': {
      weak: ['Maps ркжрк░рк░рлЛркЬ practice ркХрк░рлЛ', 'Physical ркЕркирлЗ political features ркпрк╛ркж ркХрк░рлЛ', 'States, capitals, rivers ркпрк╛ркж ркХрк░рлЛ', 'Climate zones рк╕ркоркЬрлЛ'],
      average: ['Economic geography рккрк░ ркзрлНркпрк╛рки ркЖрккрлЛ', 'Current geographical issues рк╕рк╛ркерлЗ link ркХрк░рлЛ']
    },
    'GUJARAT_GEOGRAPHY': {
      weak: ['ркЧрлБркЬрк░рк╛ркдркирк╛ districts ркЕркирлЗ cities ркпрк╛ркж ркХрк░рлЛ', 'Rivers, mountains map рккрк░ locate ркХрк░рлЛ', 'Climate ркЕркирлЗ vegetation рк╕ркоркЬрлЛ'],
      average: ['Industrial belts ркЕркирлЗ economic zones рк╢рлАркЦрлЛ', 'Development projects рк╡рк┐рк╢рлЗ update рк░рк╣рлЛ']
    },
    'INDIAN_ECONOMY': {
      weak: ['Basic economic concepts рк╕ркоркЬрлЛ', 'Major sectors ркЕркирлЗ their contribution ркпрк╛ркж ркХрк░рлЛ', 'Budget ркЕркирлЗ policies рк╡рк╛ркВркЪрлЛ', 'Economic terminology рк╢рлАркЦрлЛ'],
      average: ['Current economic affairs рккрк░ ркиркЬрк░ рк░рк╛ркЦрлЛ', 'Economic surveys ркЕркирлЗ reports рк╡рк╛ркВркЪрлЛ']
    },
    'SCIENCE_TECH': {
      weak: ['ркжрк░рк░рлЛркЬ science facts ркЕркирлЗ concepts рк╡рк╛ркВркЪрлЛ', 'Recent discoveries ркЕркирлЗ innovations рк╢рлАркЦрлЛ', 'Basic physics, chemistry, biology revision ркХрк░рлЛ', 'Technology trends follow ркХрк░рлЛ'],
      average: ['Advanced topics explore ркХрк░рлЛ', 'Scientific reasoning develop ркХрк░рлЛ']
    },
    'ENGLISH_GRAMMAR': {
      weak: ['Daily 30 minutes grammar practice ркХрк░рлЛ', 'Tenses, parts of speech ркоркЬркмрлВркд ркХрк░рлЛ', 'Reading comprehension exercises ркХрк░рлЛ', 'Vocabulary building ркХрк░рлЛ'],
      average: ['Advanced grammar ркЕркирлЗ usage рк╢рлАркЦрлЛ', 'Error spotting practice ркХрк░рлЛ']
    }
  };
  
  Object.entries(overallData.subjectMap).forEach(([subjId, subjData]) => {
    const subjPer = ((subjData.correct / subjData.total) * 100);
    const subjectCode = getSubjectCode(subjData.name);
    const advice = subjectAdvice[subjectCode] || { weak: ['ркирк┐ркпркорк┐ркд ркЕркнрлНркпрк╛рк╕ ркЕркирлЗ practice ркХрк░рлЛ'], average: ['рк╕ркдркд рк╕рлБркзрк╛рк░рлЛ ркЪрк╛рк▓рлБ рк░рк╛ркЦрлЛ'] };
    
    if (subjPer < 60) {
      const tips = advice.weak || [];
      recCards += `
      <div class="rec-card">
        <div class="rec-title">ЁЯФ┤ ${subjData.name} - ркдрк╛ркдрлНркХрк╛рк▓рк┐ркХ ркзрлНркпрк╛рки ркЖрккрлЛ</div>
        <ul class="rec-list">
          ${tips.map(tip => `<li>${tip}</li>`).join('')}
        </ul>
      </div>`;
    } else if (subjPer >= 60 && subjPer < 80) {
      const tips = advice.average || [];
      recCards += `
      <div class="rec-card">
        <div class="rec-title">ЁЯЯб ${subjData.name} - рк╕рк╛рк░рлБркВ рккрлНрк░ркжрк░рлНрк╢рки, ркерлЛркбрлЛ рк╡ркзрлБ рккрлНрк░ркпрк╛рк╕</div>
        <ul class="rec-list">
          ${tips.map(tip => `<li>${tip}</li>`).join('')}
        </ul>
      </div>`;
    }
  });
  
  // KAPiLa Institute Ad
  recCards += `
  <div class="rec-card" style="background:linear-gradient(135deg,#059669 0%,#10b981 100%)">
    <div class="rec-title">ЁЯОУ KAPiLa Institute</div>
    <ul class="rec-list">
      <li>ркдркорк╛рк░рлА рк╕рклрк│ркдрк╛ ркЕркорк╛рк░рлЛ ркзрлНркпрлЗркп - KAPiLa Institute ркдркоркирлЗ рк╢рлНрк░рлЗрк╖рлНрка ркдрлИркпрк╛рк░рлА рккрлНрк░ркжрк╛рки ркХрк░рлЗ ркЫрлЗ</li>
      <li>ркЕркирлБркнрк╡рлА рк╢рк┐ркХрлНрк╖ркХрлЛ, comprehensive study material ркЕркирлЗ regular mock tests</li>
      <li>Individual attention ркЕркирлЗ personalized guidance ркжрк░рлЗркХ рк╡рк┐ркжрлНркпрк╛рк░рлНркерлА ркорк╛ркЯрлЗ</li>
      <li>ркЖрккркирк╛ рк╕рккркирк╛ркирлЗ рк╕рк╛ркХрк╛рк░ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркЕркорлЗ ркдрлИркпрк╛рк░ ркЫрлАркП</li>
      <li>ЁЯУЮ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ ркЕркирлЗ ркдркорк╛рк░рлА ркдрлИркпрк╛рк░рлА рк╢рк░рлВ ркХрк░рлЛ!</li>
    </ul>
  </div>`;
  

  app.innerHTML = `
  <div class="sticky-header">
    <div class="sticky-header-content">
      <div class="page-title">Overall Performance</div>
    </div>
    <a href="index-kapila.html" class="home-btn">ЁЯПа Home</a>
  </div>

  <div class="card student-card">
    <div class="student-header">
      <div class="avatar">${firstLetter}</div>
      <div style="flex:1">
        <h2 class="student-name">${userName}</h2>
        <div class="student-meta">
          <span class="meta-badge level-badge level-${levelClass}" onclick="showLevelInfo()">ЁЯУК ${overallData.level}</span>
          <span class="meta-badge" style="color:#f59e0b">ЁЯПЖ Rank: #${overallRank}</span>
          <span class="meta-badge" style="color:#6366f1">ЁЯУЕ ркЫрлЗрк▓рлНрк▓рлА: ${lastTestDate}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="card">
      <div class="chart-title">
        <span>Overall рккрк░рк┐ркгрк╛рко</span>
        <span class="info-icon" onclick="showChartInfo('overall')">i</span>
      </div>
      <canvas id="pieChart" style="max-height:220px"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">
        <span>рк╡рк┐рк╖ркп рк╡рк╛рк░ рк╡рк┐ркдрк░ркг</span>
        <span class="info-icon" onclick="showChartInfo('subjects')">i</span>
      </div>
      <canvas id="subjectPieChart" style="max-height:220px"></canvas>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">ркХрлБрк▓ рккрлНрк░рк╢рлНркирлЛ</div>
      <div class="stat-value">${overallData.totalQuestions}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркорлЗрк│рк╡рлЗрк▓ ркЧрлБркг</div>
      <div class="stat-value" style="color:#22c55e">${overallData.totalCorrect}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Overall ркЪрлЛркХрк╕рк╛ркИ</div>
      <div class="stat-value" style="color:#3b82f6">${overallData.overallPercentage}%</div>
    </div>
    <div class="stat-card clickable" onclick="showConcentrationInfo()">
      <div class="stat-label">ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ тД╣я╕П</div>
      <div class="stat-value" style="color:#f59e0b">${overallData.concentrationRating}/10</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕ркоркп/рккрлНрк░рк╢рлНрки</div>
      <div class="stat-value">${overallData.avgTimePerQ}s</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЦрлЛркЯрк╛ ркЬрк╡рк╛ркм</div>
      <div class="stat-value" style="color:#ef4444">${overallData.totalWrong}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Target Score</div>
      <div class="stat-value ${targetClass}">${targetPer}% (${overallData.overallPercentage}%)</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркмрк╛ркХрлА рккрлНрк░рк╢рлНркирлЛ</div>
      <div class="stat-value">${overallData.totalSkipped}</div>
    </div>
  </div>

  <div class="card">
    <h3>ркдркорк╛рк░рлА рккрлНрк░ркЧркдрк┐ (ркЫрлЗрк▓рлНрк▓рлА 5 ркЯрлЗрк╕рлНркЯ)</h3>
    <canvas id="trendChart" style="max-height:250px"></canvas>
  </div>

  <div class="card">
    <div class="section-title">ЁЯУК рк╡рк┐рк╖ркп рк╡рк╛рк░ Overall Analysis</div>
    <div class="subjects-grid">
      ${subjectHTML}
    </div>
  </div>

  ${recCards}
  `;

  setTimeout(() => {
    // Overall Pie Chart
    const ctx = document.getElementById('pieChart');
    if (ctx) {
      new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['рк╕рк╛ркЪрк╛', 'ркЦрлЛркЯрк╛', 'ркмрк╛ркХрлА'],
          datasets: [{
            data: [overallData.totalCorrect, overallData.totalWrong, overallData.totalSkipped],
            backgroundColor: ['#22c55e', '#ef4444', '#e5e7eb']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 10, font: { size: 12 } }
            }
          }
        }
      });
    }

    // Subject Distribution Pie Chart
    const subjCtx = document.getElementById('subjectPieChart');
    if (subjCtx) {
      new Chart(subjCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: subjectLabels,
          datasets: [{
            data: subjectData,
            backgroundColor: subjectColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 10, font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return label + ': ' + percentage + '%';
                }
              }
            }
          }
        }
      });
    }

    // Colorful Trend Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
      const last5 = allResults.slice(0, 5).reverse();
      const labels = last5.map((_, idx) => `T${idx + 1}`);
      const scores = last5.map(t => parseFloat(t.percentage));
      
      new Chart(trendCtx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'рк╕рлНркХрлЛрк░ %',
            data: scores,
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.2)',
            tension: 0.4,
            fill: true,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointBackgroundColor: '#8b5cf6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
  }, 100);
}

function showChapterDetails(subjId, subjName) {
  const subjData = overallData.subjectMap[subjId];
  
  let chaptersHTML = '<div style="margin-top:15px">';
  Object.entries(subjData.chapters).forEach(([chId, chData]) => {
    const chPer = ((chData.correct / chData.total) * 100).toFixed(1);
    const chPerColor = getPercentageColor(parseFloat(chPer));
    
    chaptersHTML += `
      <div class="chapter-item">
        <span class="chapter-name">${chData.name}</span>
        <span class="chapter-per ${chPerColor}">${chPer}%</span>
      </div>
    `;
  });
  chaptersHTML += '</div>';
  
  document.getElementById('modalIcon').innerText = 'ЁЯУЪ';
  document.getElementById('modalTitle').innerText = subjName + ' - Chapter-wise';
  document.getElementById('modalBody').innerHTML = chaptersHTML;
  document.getElementById('modal').classList.add('show');
}

init();
</script>
</body>
</html>
