<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>STI Mock Test – Full Pack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Supabase -->
  <script type="module"
    src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js">
  </script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
    }

    header {
      background: #020617;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .student-name {
      font-size: 13px;
      color: #9ca3af;
    }

    .home-btn {
      background: #1f2937;
      color: #e5e7eb;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      text-decoration: none;
      border: 1px solid #374151;
    }

    .container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .card {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .price {
      font-size: 22px;
      font-weight: 700;
      color: #22c55e;
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
    }

    .btn-disabled {
      background: #111827;
      color: #6b7280;
      cursor: default;
    }

    .tests-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 640px) {
      .tests-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .test-card {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 14px;
    }

    .test-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .test-link {
      font-size: 13px;
      color: #22c55e;
      text-decoration: none;
      font-weight: 600;
    }

    .test-link.disabled {
      color: #6b7280;
      pointer-events: none;
    }

    footer {
      padding: 16px;
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      margin-top: 40px;
    }
  </style>
</head>

<body>

  <!-- ✅ HEADER -->
  <header>
    <div>
      <div class="title">STI Mock Test</div>
      <div class="student-name" id="student-name">Loading...</div>
    </div>

    <a href="index.html" class="home-btn">Go to Home</a>
  </header>

  <div class="container">

    <!-- ✅ PAYMENT CARD -->
    <div class="card" id="payment-card">
      <div style="display:flex;justify-content:space-between;">
        <div>
          <div style="font-size:16px;font-weight:600;">Full Mock Test Pack</div>
          <div style="font-size:13px;color:#9ca3af;">Access to all 5 tests</div>
        </div>
        <div class="price">₹1</div>
      </div>

      <button id="pay-button" class="btn btn-primary">
        Buy Full Pack
      </button>

      <div id="payment-status" style="margin-top:10px;font-size:13px;color:#9ca3af;"></div>
    </div>

    <!-- ✅ TEST LIST -->
    <div class="tests-grid" id="tests-grid">
      <div class="test-card">
        <div class="test-title">Mock Test 1</div>
        <a href="mock-test-1.html" class="test-link disabled" data-test="1">Open Test</a>
      </div>

      <div class="test-card">
        <div class="test-title">Mock Test 2</div>
        <a href="mock-test-2.html" class="test-link disabled" data-test="2">Open Test</a>
      </div>

      <div class="test-card">
        <div class="test-title">Mock Test 3</div>
        <a href="mock-test-3.html" class="test-link disabled" data-test="3">Open Test</a>
      </div>

      <div class="test-card">
        <div class="test-title">Mock Test 4</div>
        <a href="mock-test-4.html" class="test-link disabled" data-test="4">Open Test</a>
      </div>

      <div class="test-card">
        <div class="test-title">Mock Test 5</div>
        <a href="mock-test-5.html" class="test-link disabled" data-test="5">Open Test</a>
      </div>
    </div>

  </div>

  <footer>
    Need help? WhatsApp: +91 63535 11804
  </footer>

  <!-- ✅ SCRIPT -->
  <script type="module">
    const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const payBtn = document.getElementById("pay-button");
    const paymentStatusEl = document.getElementById("payment-status");
    const testsGrid = document.getElementById("tests-grid");
    const studentNameEl = document.getElementById("student-name");

    const PLAN_NAME = "prelims-mock-pack";
    const ACCESS_TYPE = "mock_tests_all";
    const AMOUNT_PAISE = 100;

    const CREATE_ORDER_URL = "https://bhmycvrbucmbbrpzeane.supabase.co/functions/v1/create-order";

    let currentUser = null;
    let hasAccess = false;

    // ✅ PAGE MUST NOT OPEN WITHOUT LOGIN
    async function checkLogin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      studentNameEl.textContent = user.email;
    }

    async function checkAccess() {
      const { data } = await supabase
        .from("user_access")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("plan_name", PLAN_NAME)
        .eq("access_type", ACCESS_TYPE)
        .eq("is_active", true)
        .limit(1);

      hasAccess = data && data.length > 0;
    }

    function updateUI() {
      const links = testsGrid.querySelectorAll(".test-link");

      if (hasAccess) {
        payBtn.classList.add("btn-disabled");
        payBtn.classList.remove("btn-primary");
        payBtn.disabled = true;
        payBtn.textContent = "✅ Already Purchased — Access Granted";

        paymentStatusEl.textContent = "You can open any mock test.";

        links.forEach(link => link.classList.remove("disabled"));
      } else {
        links.forEach(link => link.classList.add("disabled"));
      }
    }

    payBtn.addEventListener("click", async () => {
      if (hasAccess) return;

      paymentStatusEl.textContent = "Creating order...";
      payBtn.disabled = true;

      const resp = await fetch(CREATE_ORDER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: currentUser.id,
          amount: AMOUNT_PAISE,
          currency: "INR",
          plan_name: PLAN_NAME,
          access_type: ACCESS_TYPE,
        }),
      });

      const data = await resp.json();

      const options = {
        key: data.key_id,
        amount: data.amount,
        currency: data.currency,
        name: "STI Mock Test",
        description: "Full mock test pack",
        order_id: data.order_id,
        handler: async function () {
          paymentStatusEl.textContent = "Processing...";
          setTimeout(async () => {
            await checkAccess();
            updateUI();
          }, 5000);
        },
        prefill: {
          email: currentUser.email,
        },
        notes: {
          user_id: currentUser.id,
          plan_name: PLAN_NAME,
          access_type: ACCESS_TYPE,
        },
        theme: { color: "#22c55e" },
      };

      new Razorpay(options).open();
    });

    // ✅ INIT
    (async () => {
      await checkLogin();
      await checkAccess();
      updateUI();
    })();
  </script>

</body>
</html>
