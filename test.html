<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSI Mock Test - Live</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p class="mt-4 font-bold text-gray-600">ડેટાબેઝ સાથે કનેક્ટ થઈ રહ્યું છે...</p>
        </div>
    </div>

    <div id="test-app" class="hidden">
        <header class="bg-white p-4 shadow-md flex justify-between items-center sticky top-0">
            <h1 class="font-bold text-blue-700">PSI PRELIMS MOCK 1</h1>
            <div class="flex items-center gap-4">
                <span id="timer" class="font-mono text-xl font-bold text-red-600">120:00</span>
                <button onclick="finishTest()" class="bg-red-600 text-white px-4 py-1 rounded-lg font-bold">Finish</button>
            </div>
        </header>

        <main class="p-4 md:p-8 max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border">
                <div id="q-label" class="text-xs font-bold text-blue-500 mb-2 uppercase">Question 1</div>
                <div id="q-text" class="text-lg font-bold text-gray-800 mb-6">Loading...</div>
                <div id="options" class="space-y-3"></div>
                <div class="flex justify-between mt-8 pt-4 border-t">
                    <button onclick="changeQ(-1)" class="px-4 py-2 text-gray-400 font-bold hover:bg-gray-100 rounded-lg">Back</button>
                    <button onclick="changeQ(1)" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md">Next</button>
                </div>
            </div>
            
            <aside class="bg-white p-4 rounded-2xl shadow-sm border h-fit">
                <h3 class="font-bold mb-4 text-gray-700 border-b pb-2 text-sm uppercase">Navigation</h3>
                <div id="palette" class="grid grid-cols-5 gap-2"></div>
            </aside>
        </main>
    </div>

    <div id="result-view" class="hidden min-h-screen p-6 bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-[30px] shadow-xl max-w-md w-full text-center">
            <h2 class="text-2xl font-black text-blue-600">TEST COMPLETED!</h2>
            <div class="my-6">
                <p class="text-5xl font-black" id="score-val">0.00</p>
                <p class="text-gray-400 font-bold text-xs mt-1 uppercase">Final Score</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 p-3 rounded-xl"><p class="font-bold text-green-600" id="c-count">0</p><p class="text-[10px]">Correct</p></div>
                <div class="bg-red-50 p-3 rounded-xl"><p class="font-bold text-red-600" id="w-count">0</p><p class="text-[10px]">Wrong</p></div>
            </div>
            <button onclick="location.reload()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Try Again</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
        // કી ને ફરીથી ડાયરેક્ટ પેસ્ટ કરી છે
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljcvrbucmbbrpzeaneiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0NjE5MTEsImV4cCI6MjA1MDAzNzkxMX0.IuE6239LofH6G_T_3pE4NqE7_D8oFh0w-26OQ9G1-60";
        
        const client = supabase.createClient(SB_URL, SB_KEY);

        let questions = [];
        let answers = {};
        let currentIdx = 0;

        async function start() {
            try {
                // Testing connection first
                const { data, error } = await client.from('questions').select('*').eq('test_id', 'mock_test_1');
                
                if (error) throw error;
                if (!data || data.length === 0) throw new Error("ટેબલમાં ડેટા મળ્યો નથી!");

                questions = data;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('test-app').classList.remove('hidden');
                
                renderPalette();
                showQ();
            } catch (e) {
                console.error("Connection Fail:", e);
                alert("સીસ્ટમ એરર: " + e.message + "\n\nકૃપા કરીને SQL માં પોલિસી રન કરો અને ANON KEY ચેક કરો.");
            }
        }

        function showQ() {
            const q = questions[currentIdx];
            document.getElementById('q-label').innerText = `Question ${currentIdx + 1}`;
            document.getElementById('q-text').innerText = q.question_text;
            
            const opts = [q.option_a, q.option_b, q.option_c, q.option_d, q.option_e];
            const div = document.getElementById('options');
            div.innerHTML = '';

            opts.forEach((text, i) => {
                const b = document.createElement('button');
                b.className = `w-full text-left p-4 rounded-xl border-2 transition ${answers[currentIdx] === i ? 'border-blue-600 bg-blue-50 font-bold' : 'border-gray-100 hover:bg-gray-50'}`;
                b.innerHTML = `<span class="mr-3 opacity-50 font-mono">${String.fromCharCode(65+i)}.</span> ${text}`;
                b.onclick = () => { answers[currentIdx] = i; showQ(); updatePal(); };
                div.appendChild(b);
            });
        }

        function renderPalette() {
            const p = document.getElementById('palette');
            questions.forEach((_, i) => {
                const b = document.createElement('button');
                b.id = `p-${i}`;
                b.className = "h-10 w-full rounded-md border bg-gray-50 text-xs font-bold text-gray-400";
                b.innerText = i + 1;
                b.onclick = () => { currentIdx = i; showQ(); };
                p.appendChild(b);
            });
        }

        function updatePal() {
            questions.forEach((_, i) => {
                const b = document.getElementById(`p-${i}`);
                if (answers[i] !== undefined) b.className = "h-10 w-full rounded-md bg-blue-600 text-white text-xs font-bold";
            });
        }

        function changeQ(dir) {
            let next = currentIdx + dir;
            if (next >= 0 && next < questions.length) {
                currentIdx = next;
                showQ();
            }
        }

        function finishTest() {
            if (!confirm("સબમિટ કરવા માંગો છો?")) return;
            
            let c = 0, w = 0;
            questions.forEach((q, i) => {
                if (answers[i] === q.correct_option) c++;
                else if (answers[i] !== undefined && answers[i] !== 4) w++;
            });

            const finalScore = (c * 1) - (w * 0.33);
            
            document.getElementById('test-app').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('score-val').innerText = finalScore.toFixed(2);
            document.getElementById('c-count').innerText = c;
            document.getElementById('w-count').innerText = w;
        }

        start();
    </script>
</body>
</html>
