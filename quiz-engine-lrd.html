<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>Mock Test - LRD Beginners</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3,h4{margin:6px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer;margin-bottom:10px}
.primary{background:#22c55e;color:#fff}
.gray{background:#e5e7eb;color:#333}
.blue{background:#3b82f6;color:#fff}
.danger{background:#dc2626;color:#fff}
.warning{background:#f59e0b;color:#fff}
.option{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0;cursor:pointer;transition:all 0.2s}
.option:hover{border-color:#22c55e}
.option.active{background:#22c55e;color:#fff;border-color:#22c55e}
.top{display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px}
.hidden{display:none}
.loader{text-align:center;padding:40px}
.qgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(45px,1fr));gap:8px;margin:15px 0}
.qbtn{padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-weight:600;font-size:14px}
.qbtn.answered{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.current{background:#3b82f6;color:#fff;border-color:#3b82f6}
.qbtn.correct{background:#22c55e;color:#fff;border-color:#22c55e}
.qbtn.wrong{background:#ef4444;color:#fff;border-color:#ef4444}
.qbtn.skipped{background:#cbd5e1;color:#333;border-color:#cbd5e1}
.badge{background:#22c55e;color:#fff;padding:5px 12px;border-radius:20px;font-size:14px;display:inline-block;margin-bottom:10px}
.badge.free{background:#3b82f6}
.badge.completed{background:#f59e0b}
.nav-buttons{display:flex;gap:10px;margin-top:10px;margin-bottom:20px}
.nav-buttons button{flex:1}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.show{display:flex}
.modal-content{background:#fff;border-radius:20px;max-width:420px;width:90%;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease;text-align:center}
@keyframes modalPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.modal-icon{font-size:60px;margin-bottom:15px}
.modal-title{font-size:22px;font-weight:700;margin-bottom:10px;color:#1e293b}
.modal-text{font-size:15px;color:#64748b;line-height:1.6;margin-bottom:20px}
.modal-brand{font-size:13px;color:#94a3b8;margin-top:20px;font-weight:600}
.modal-brand span{color:#22c55e;font-weight:700}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-buttons button{flex:1;border-radius:12px;padding:12px;font-size:15px;font-weight:600;cursor:pointer;border:none}
.modal-btn-confirm{background:#22c55e;color:#fff}
.modal-btn-cancel{background:#e2e8f0;color:#334155}
.rank-item{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:10px;margin-bottom:8px}
.rank-num{width:35px;height:35px;background:#3b82f6;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
.rank-num.top1{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.rank-num.top2{background:linear-gradient(135deg,#cbd5e1,#94a3b8)}
.rank-num.top3{background:linear-gradient(135deg,#fca5a5,#f87171)}
.rank-info{flex:1}
.rank-name{font-weight:600;font-size:14px}
.rank-score{color:#6b7280;font-size:13px}
.rank-points{font-weight:bold;color:#22c55e;font-size:18px}
.solution-item{border:1px solid #e5e7eb;border-radius:12px;padding:15px;margin-bottom:15px}
.solution-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.solution-qnum{font-weight:bold;font-size:16px}
.solution-status{padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600}
.solution-status.correct{background:#dcfce7;color:#16a34a}
.solution-status.wrong{background:#fee2e2;color:#dc2626}
.solution-status.skipped{background:#f1f5f9;color:#64748b}
.solution-question{font-size:14px;margin-bottom:10px;color:#334155}
.solution-options{margin:10px 0}
.solution-opt{padding:8px 12px;margin:5px 0;border-radius:8px;font-size:13px}
.solution-opt.selected{background:#dbeafe;border:2px solid #3b82f6}
.solution-opt.correct-ans{background:#dcfce7;border:2px solid #16a34a}
.solution-opt.wrong-ans{background:#fee2e2;border:2px solid #dc2626}
.alert-box{background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:15px;margin:15px 0}
.alert-box h3{color:#92400e;margin-bottom:8px}
.alert-box p{color:#78350f;margin:5px 0;line-height:1.6}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="card loader">
    <h3>àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</h3>
    <p>àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª°àª¾àª¹ àªœà«àª“</p>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-icon" id="modalIcon">â“</div>
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-text" id="modalText">Message</div>
    <div class="modal-buttons" id="modalButtons"></div>
    <div class="modal-brand"><span>KAPiLa Institute</span><br>Created by devendra_dd</div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const urlParams = new URLSearchParams(window.location.search);
const TEST_ID = urlParams.get('test_id');

let app = document.getElementById("app");
let user, questions = [], current = 0, answers = {}, startTime, timer, submitted = false, testResultId = null, currentTest = null;
let existingResult = null;

if (!TEST_ID) {
  app.innerHTML = '<div class="card"><h3>âš ï¸ Invalid URL</h3><p>Test ID not found</p></div>';
} else {
  init();
}

async function init() {
  try {
    const { data: { user: u } } = await sb.auth.getUser();
    if (!u) {
      app.innerHTML = '<div class="card"><h3>ğŸ”’ Login Required</h3><p>àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª¹à«‡àª²àª¾ àª²à«‹àª—àª¿àª¨ àª•àª°à«‹</p></div>';
      return;
    }
    user = u;

    const { data: test } = await sb.from("lrd_tests").select("*").eq("id", TEST_ID).single();
    if (!test) {
      app.innerHTML = '<div class="card"><h3>âŒ Test Not Found</h3></div>';
      return;
    }
    currentTest = test;

    // Check if user has already attempted this test
    const { data: previousAttempt } = await sb
      .from("lrd_test_results")
      .select("*")
      .eq("user_id", user.id)
      .eq("test_id", TEST_ID)
      .single();

    if (previousAttempt) {
      existingResult = previousAttempt;
      testResultId = previousAttempt.id;
      showAlreadyAttempted(test, previousAttempt);
      return;
    }

    const { data: qs } = await sb.from("lrd_questions").select("*").eq("test_id", TEST_ID).order("question_order");
    questions = qs || [];

    if (questions.length === 0) {
      app.innerHTML = '<div class="card"><h3>âš ï¸ No Questions</h3></div>';
      return;
    }

    showInstructions(test);
  } catch (err) {
    app.innerHTML = '<div class="card"><h3>âŒ Error</h3><p>' + err.message + '</p></div>';
  }
}

function showAlreadyAttempted(test, result) {
  const date = new Date(result.completed_at).toLocaleDateString('gu-IN');
  const time = new Date(result.completed_at).toLocaleTimeString('gu-IN', {hour: '2-digit', minute: '2-digit'});
  
  app.innerHTML = `
  <div class="card">
    <span class="badge completed">âœ“ àªªà«‚àª°à«àª£ àª¥àª¯à«‡àª²</span>
    <h2>${test.test_name}</h2>
    
    <div class="alert-box">
      <h3>âš ï¸ àª¤àª®à«‡ àª† àªŸà«‡àª¸à«àªŸ àªªàª¹à«‡àª²àª¾àª¥à«€ àªœ àª†àªªà«€ àªšà«àª•à«àª¯àª¾ àª›à«‹!</h3>
      <p><b>àª¤àª¾àª°à«€àª–:</b> ${date} ${time}</p>
      <p><b>àª¤àª®àª¾àª°à«‹ àª¸à«àª•à«‹àª°:</b> ${result.score}/${result.total_questions}</p>
      <p><b>àªšà«‹àª•àª¸àª¾àªˆ:</b> ${result.percentage}%</p>
      <p style="margin-top:10px">àª¦àª°à«‡àª• àªŸà«‡àª¸à«àªŸ àª®àª¾àª¤à«àª° àªàª• àªœ àªµàª¾àª° àª†àªªà«€ àª¶àª•àª¾àª¯ àª›à«‡. àª¤àª®à«‡ àª¤àª®àª¾àª°àª¾ àªªàª°àª¿àª£àª¾àª®à«‹ àª…àª¨à«‡ solutions àªœà«‹àªˆ àª¶àª•à«‹ àª›à«‹.</p>
    </div>

    <button class="primary" onclick="loadExistingResult()">ğŸ“Š àª¤àª®àª¾àª°àª¾ àªªàª°àª¿àª£àª¾àª®à«‹ àªœà«àª“</button>
    <button class="gray" onclick="loadExistingSolutions()">ğŸ“ Solutions àªœà«àª“</button>
    <button class="blue" onclick="viewPerformance()">ğŸ“ˆ Performance Dashboard</button>
    <br>
    <button class="warning" onclick="window.location.href='select-test.html'">â† àªªàª¾àª›àª¾ àªœàª¾àª“</button>
  </div>`;
}

async function loadExistingResult() {
  const r = existingResult;
  const m = Math.floor(r.total_time_seconds / 60);
  const sec = r.total_time_seconds % 60;

  app.innerHTML = `
  <div class="card">
    <span class="badge completed">âœ“ àªªà«‚àª°à«àª£ àª¥àª¯à«‡àª²</span>
    <h2>Your Score: ${r.score}</h2>
    <div style="margin:15px 0;line-height:1.8">
      <p><b>Correct:</b> ${r.correct_answers} | <b>Wrong:</b> ${r.wrong_answers}</p>
      <p><b>Skipped:</b> ${r.skipped_questions} | <b>E Options:</b> ${r.e_option_used}</p>
      <p><b>Time Taken:</b> ${m}m ${sec}s</p>
    </div>
    <canvas id="chart"></canvas><br><br>
    <button class="primary" onclick="loadLeaderboard()">ğŸ† View Leaderboard</button>
    <button class="gray" onclick="loadExistingSolutions()">ğŸ“ View Solutions</button>
    <button class="blue" onclick="viewPerformance()">ğŸ“Š Performance Dashboard</button>
  </div>`;

  const chart = document.getElementById("chart");
  new Chart(chart, {
    type: "pie",
    data: {
      labels: ["Correct", "Wrong", "Skipped", "E"],
      datasets: [{
        data: [r.correct_answers, r.wrong_answers, r.skipped_questions, r.e_option_used],
        backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1', '#eab308']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

async function loadExistingSolutions() {
  app.innerHTML = '<div class="card loader"><div style="font-size:40px">â³</div><h3>àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</h3><p>Solutions àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯àª¾ àª›à«‡</p></div>';
  
  // Load questions and attempts
  const { data: qs } = await sb.from("lrd_questions").select("*").eq("test_id", TEST_ID).order("question_order");
  const { data: attempts } = await sb.from("lrd_question_attempts").select("*").eq("test_result_id", testResultId);
  
  const attemptsMap = {};
  attempts.forEach(att => {
    attemptsMap[att.question_id] = att;
  });

  let html = '<div class="card"><h2>ğŸ“ Solutions</h2></div>';

  qs.forEach((q, idx) => {
    const attempt = attemptsMap[q.id];
    const userAns = attempt?.selected_answer;
    const correctAns = q.correct_answer;
    const isCorrect = attempt?.is_correct;
    
    const statusClass = userAns === 'SKIPPED' ? 'skipped' : isCorrect ? 'correct' : 'wrong';
    const statusText = userAns === 'SKIPPED' ? 'àª¬àª¾àª•à«€' : isCorrect ? 'àª¸àª¾àªšà«‹' : 'àª–à«‹àªŸà«‹';

    html += `
    <div class="solution-item">
      <div class="solution-header">
        <span class="solution-qnum">àªªà«àª°àª¶à«àª¨ ${idx + 1}</span>
        <span class="solution-status ${statusClass}">${statusText}</span>
      </div>
      <div class="solution-question">${q.question_text}</div>
      <div class="solution-options">
        <div class="solution-opt ${userAns === 'A' ? (correctAns === 'A' ? 'correct-ans' : 'wrong-ans') : (correctAns === 'A' ? 'correct-ans' : '')}">
          A) ${q.option_a} ${correctAns === 'A' ? 'âœ“' : ''}
        </div>
        <div class="solution-opt ${userAns === 'B' ? (correctAns === 'B' ? 'correct-ans' : 'wrong-ans') : (correctAns === 'B' ? 'correct-ans' : '')}">
          B) ${q.option_b} ${correctAns === 'B' ? 'âœ“' : ''}
        </div>
        <div class="solution-opt ${userAns === 'C' ? (correctAns === 'C' ? 'correct-ans' : 'wrong-ans') : (correctAns === 'C' ? 'correct-ans' : '')}">
          C) ${q.option_c} ${correctAns === 'C' ? 'âœ“' : ''}
        </div>
        <div class="solution-opt ${userAns === 'D' ? (correctAns === 'D' ? 'correct-ans' : 'wrong-ans') : (correctAns === 'D' ? 'correct-ans' : '')}">
          D) ${q.option_d} ${correctAns === 'D' ? 'âœ“' : ''}
        </div>
        ${q.has_e_option ? `<div class="solution-opt ${userAns === 'E' ? (correctAns === 'E' ? 'correct-ans' : 'wrong-ans') : (correctAns === 'E' ? 'correct-ans' : '')}">E) None ${correctAns === 'E' ? 'âœ“' : ''}</div>` : ''}
      </div>
    </div>`;
  });

  html += '<button class="blue" onclick="loadExistingResult()">â† àªªàª¾àª›àª¾ àªœàª¾àª“</button>';
  app.innerHTML = html;
}

function showInstructions(test) {
  app.innerHTML = `
  <div class="card">
    <span class="badge free">ğŸ‰ FREE TEST</span>
    <h2>${test.test_name}</h2>
    <p style="margin:10px 0">${test.description || ''}</p>
    <div style="background:#f8fafc;padding:15px;border-radius:10px;margin:15px 0">
      <p><b>àª•à«àª² àªªà«àª°àª¶à«àª¨à«‹:</b> ${test.total_questions}</p>
      <p><b>àª•à«àª² àª®àª¾àª°à«àª•à«àª¸:</b> ${test.total_marks}</p>
      <p><b>Negative Marking:</b> àª¨àª¹à«€àª‚</p>
      <p><b>àª¸àª®àª¯ àª®àª°à«àª¯àª¾àª¦àª¾:</b> àª•à«‹àªˆ àª¨àª¥à«€</p>
      <p style="color:#f59e0b;font-weight:600;margin-top:10px">âš ï¸ àª† àªŸà«‡àª¸à«àªŸ àª®àª¾àª¤à«àª° àªàª• àªœ àªµàª¾àª° àª†àªªà«€ àª¶àª•àª¾àª¯ àª›à«‡</p>
    </div>
    <button class="primary" onclick="startTest()">Start Test Now</button>
  </div>`;
}

function startTest() {
  startTime = Date.now();
  submitted = false;
  current = 0;
  answers = {};
  renderQuestion();
  startTimer();
}

function renderQuestion() {
  const q = questions[current];
  const userAns = answers[q.id];

  let gridHTML = '<div class="qgrid">';
  questions.forEach((qu, idx) => {
    const cls = answers[qu.id] ? 'qbtn answered' : 'qbtn';
    const curCls = idx === current ? ' current' : '';
    gridHTML += `<button class="${cls}${curCls}" onclick="jumpTo(${idx})">${idx + 1}</button>`;
  });
  gridHTML += '</div>';

  app.innerHTML = `
  <div class="card">
    <span class="badge free">FREE TEST</span>
    <div class="top">
      <span>Q ${current + 1}/${questions.length}</span>
      <span id="timer">â±ï¸ 0:00</span>
    </div>
    <h3>${q.question_text}</h3>
    <div class="option ${userAns === 1 ? 'active' : ''}" onclick="selectOption(1)">
      <b>A)</b> ${q.option_a}
    </div>
    <div class="option ${userAns === 2 ? 'active' : ''}" onclick="selectOption(2)">
      <b>B)</b> ${q.option_b}
    </div>
    <div class="option ${userAns === 3 ? 'active' : ''}" onclick="selectOption(3)">
      <b>C)</b> ${q.option_c}
    </div>
    <div class="option ${userAns === 4 ? 'active' : ''}" onclick="selectOption(4)">
      <b>D)</b> ${q.option_d}
    </div>
    ${q.has_e_option ? `<div class="option ${userAns === 5 ? 'active' : ''}" onclick="selectOption(5)"><b>E)</b> None</div>` : ''}
    <div class="nav-buttons">
      <button class="gray" onclick="prev()" ${current === 0 ? 'disabled' : ''}>â† àªªàª¾àª›àª³</button>
      ${current < questions.length - 1 ? 
        '<button class="primary" onclick="next()">àª†àª—àª³ â†’</button>' : 
        '<button class="danger" onclick="confirmSubmit()">Submit Test</button>'}
    </div>
    ${gridHTML}
  </div>`;
}

function selectOption(opt) {
  answers[questions[current].id] = opt;
  renderQuestion();
}

function jumpTo(idx) {
  current = idx;
  renderQuestion();
}

function next() {
  if (current < questions.length - 1) {
    current++;
    renderQuestion();
  }
}

function prev() {
  if (current > 0) {
    current--;
    renderQuestion();
  }
}

function startTimer() {
  timer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const t = document.getElementById("timer");
    if (t) {
      const m = Math.floor(elapsed / 60);
      const s = elapsed % 60;
      t.innerText = `â±ï¸ ${m}:${String(s).padStart(2, "0")}`;
    }
  }, 1000);
}

function confirmSubmit() {
  const unanswered = questions.length - Object.keys(answers).length;
  showModal(
    'â“',
    'àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹?',
    `àª¶à«àª‚ àª¤àª®à«‡ àª–àª°à«‡àª–àª° àª† àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹? àª¤àª®à«‡ àªªàª›à«€ àª•à«‹àªˆ àªœàªµàª¾àª¬ àª¬àª¦àª²à«€ àª¶àª•àª¶à«‹ àª¨àª¹à«€àª‚.${unanswered > 0 ? `\n\n${unanswered} àªªà«àª°àª¶à«àª¨à«‹ àª¬àª¾àª•à«€ àª›à«‡!` : ''}`,
    `<button class="modal-btn-cancel" onclick="hideModal()">àª°àª¦ àª•àª°à«‹</button>
     <button class="modal-btn-confirm" onclick="hideModal();submitTest()">àª¹àª¾, àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹</button>`
  );
}

async function submitTest() {
  if (submitted) return;
  submitted = true;
  clearInterval(timer);

  let correct = 0, wrong = 0, skip = 0, e = 0;

  questions.forEach(q => {
    const a = answers[q.id];
    if (!a) {
      skip++;
    } else if (a === 5) {
      e++;
      if (q.correct_answer === 'E') correct++;
      else wrong++;
    } else {
      const correctOpt = q.correct_answer === 'A' ? 1 : q.correct_answer === 'B' ? 2 : q.correct_answer === 'C' ? 3 : 4;
      if (a === correctOpt) correct++;
      else wrong++;
    }
  });

  const score = correct;
  const timeTaken = Math.floor((Date.now() - startTime) / 1000);
  const percentage = ((correct / questions.length) * 100).toFixed(2);

  const { data: result, error } = await sb.from("lrd_test_results").insert({
    user_id: user.id,
    test_id: TEST_ID,
    total_questions: questions.length,
    attempted_questions: questions.length - skip,
    correct_answers: correct,
    wrong_answers: wrong,
    skipped_questions: skip,
    e_option_used: e,
    score: score,
    percentage: percentage,
    total_time_seconds: timeTaken,
    started_at: new Date(startTime).toISOString(),
    completed_at: new Date().toISOString()
  }).select().single();

  if (error) {
    alert('Error: ' + error.message);
    submitted = false;
    return;
  }

  testResultId = result.id;
  existingResult = result;

  // Save question attempts
  for (let i = 0; i < questions.length; i++) {
    const q = questions[i];
    const userAns = answers[q.id];
    const correctOpt = q.correct_answer === 'A' ? 1 : q.correct_answer === 'B' ? 2 : q.correct_answer === 'C' ? 3 : q.correct_answer === 'D' ? 4 : 5;
    
    await sb.from("lrd_question_attempts").insert({
      test_result_id: testResultId,
      question_id: q.id,
      user_id: user.id,
      selected_answer: userAns ? (userAns === 1 ? 'A' : userAns === 2 ? 'B' : userAns === 3 ? 'C' : userAns === 4 ? 'D' : 'E') : 'SKIPPED',
      is_correct: userAns === correctOpt,
      time_taken_seconds: Math.floor(timeTaken / questions.length),
      question_order: i + 1
    });
  }

  // Show success modal with button to view results
  showModal(
    'â“',
    'àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹?',
    'àª¶à«àª‚ àª¤àª®à«‡ àª–àª°à«‡àª–àª° àª† àªŸà«‡àª¸à«àªŸ àª¸àª¬àª®àª¿àªŸ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹? àª¤àª®à«‡ àªªàª›à«€ àª•à«‹àªˆ àªœàªµàª¾àª¬ àª¬àª¦àª²à«€ àª¶àª•àª¶à«‹ àª¨àª¹à«€àª‚.',
    `<button class="modal-btn-confirm" onclick="hideModal();loadResult(${score}, ${correct}, ${wrong}, ${skip}, ${e}, ${timeTaken})">àª¹àª¾, àª¸àª¬àª®àª¿àªŸ àª•àª°à«‹</button>`
  );
}

function loadResult(score, c, w, s, e, time) {
  const m = Math.floor(time / 60);
  const sec = time % 60;

  app.innerHTML = `
  <div class="card">
    <span class="badge free">FREE TEST</span>
    <h2>Your Score: ${score}</h2>
    <div style="margin:15px 0;line-height:1.8">
      <p><b>Correct:</b> ${c} | <b>Wrong:</b> ${w}</p>
      <p><b>Skipped:</b> ${s} | <b>E Options:</b> ${e}</p>
      <p><b>Time Taken:</b> ${m}m ${sec}s</p>
    </div>
    <canvas id="chart"></canvas><br><br>
    <button class="primary" onclick="loadLeaderboard()">ğŸ† View Leaderboard</button>
    <button class="gray" onclick="loadExistingSolutions()">ğŸ“ View Answers / Solutions</button>
    <button class="blue" onclick="viewPerformance()">ğŸ“Š Current Test Performance</button>
  </div>`;

  const chart = document.getElementById("chart");
  new Chart(chart, {
    type: "pie",
    data: {
      labels: ["Correct", "Wrong", "Skipped", "E"],
      datasets: [{
        data: [c, w, s, e],
        backgroundColor: ['#22c55e', '#ef4444', '#cbd5e1', '#eab308']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

async function loadLeaderboard() {
  app.innerHTML = '<div class="card loader"><div style="font-size:40px">â³</div><h3>àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</h3><p>Leaderboard àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«‹ àª›à«‡</p></div>';
  
  const { data: results } = await sb
    .from("lrd_test_results")
    .select("*, profiles(full_name, avatar_url)")
    .eq("test_id", TEST_ID)
    .order("score", { ascending: false })
    .limit(50);

  let html = `
  <div class="card">
    <h2>ğŸ† Leaderboard</h2>
    <p style="color:#6b7280;margin:10px 0">${currentTest.test_name}</p>
  </div>`;

  if (results && results.length > 0) {
    results.forEach((r, idx) => {
      const isMe = r.user_id === user.id;
      const rankClass = idx === 0 ? 'top1' : idx === 1 ? 'top2' : idx === 2 ? 'top3' : '';
      html += `
      <div class="card">
        <div class="rank-item" style="${isMe ? 'border:2px solid #22c55e' : ''}">
          <div class="rank-num ${rankClass}">${idx + 1}</div>
          <div class="rank-info">
            <div class="rank-name">${r.profiles?.full_name || 'User'} ${isMe ? '(àª¤àª®à«‡)' : ''}</div>
            <div class="rank-score">${r.correct_answers}/${r.total_questions} correct â€¢ ${r.percentage}%</div>
          </div>
          <div class="rank-points">${r.score}</div>
        </div>
      </div>`;
    });
  } else {
    html += '<div class="card"><p>àª•à«‹àªˆ results àª¨àª¥à«€</p></div>';
  }

  html += '<button class="blue" onclick="loadExistingResult()">â† àªªàª¾àª›àª¾ àªœàª¾àª“</button>';
  app.innerHTML = html;
}

function viewPerformance() {
  window.location.href = `performance.html?result_id=${testResultId}`;
}

function showModal(icon, title, text, buttons) {
  document.getElementById('modalIcon').innerText = icon;
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalText').innerText = text;
  document.getElementById('modalButtons').innerHTML = buttons;
  document.getElementById('modal').classList.add('show');
}

function hideModal() {
  document.getElementById('modal').classList.remove('show');
}
</script>
</body>
</html>
