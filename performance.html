<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<title>Performance Dashboard - LRD Beginners</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:900px;margin:auto;padding:12px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
h2,h3,h4{margin:6px 0 12px 0}
button{border:none;border-radius:14px;padding:14px;font-size:16px;width:100%;cursor:pointer;margin-bottom:10px}
.blue{background:#3b82f6;color:#fff}
.badge{background:#3b82f6;color:#fff;padding:5px 12px;border-radius:20px;font-size:14px;display:inline-block;margin-bottom:10px}
.student-header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
.avatar{width:80px;height:80px;background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:bold;color:#2563eb}
.student-meta{display:flex;gap:15px;font-size:14px;color:#6b7280;flex-wrap:wrap}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0}
.stat-card{background:#f8fafc;border-radius:12px;padding:15px;text-align:center}
.stat-label{font-size:13px;color:#6b7280;margin-bottom:5px}
.stat-value{font-size:28px;font-weight:bold;color:#1f2937}
.section-title{font-size:16px;font-weight:bold;margin:20px 0 10px;border-left:4px solid #3b82f6;padding-left:10px;color:#1f2937}
.subject-item{background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:10px}
.subject-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.subject-name{font-size:15px;font-weight:600;color:#1f2937}
.subject-score{font-size:22px;font-weight:bold}
.score-excellent{color:#22c55e}
.score-good{color:#3b82f6}
.score-average{color:#f59e0b}
.score-poor{color:#ef4444}
.chapter-list{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px}
.chapter-item{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;color:#64748b}
.chapter-item .ch-name{flex:1}
.chapter-item .ch-score{font-weight:600;margin-left:10px}
.rec-card{background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);color:#fff;border-radius:16px;padding:20px}
.rec-title{font-size:18px;font-weight:bold;margin-bottom:15px}
.rec-section{margin-bottom:15px}
.rec-section h4{font-size:15px;margin-bottom:8px;opacity:0.95}
.rec-list{list-style:none;padding:0;margin:0}
.rec-list li{padding:5px 0 5px 22px;position:relative;font-size:14px;line-height:1.5}
.rec-list li:before{content:"тЬУ";position:absolute;left:0;color:#22c55e;font-weight:bold}
.progress-bar{height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;margin-top:5px}
.progress-fill{height:100%;background:#22c55e;transition:width 0.5s ease}
.loader{text-align:center;padding:40px}
@media (max-width:600px){
.stats-grid{grid-template-columns:1fr}
.student-header{flex-direction:column;text-align:center}
}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="card loader">
    <h3>рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</h3>
    <p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк░рк╛рк╣ ркЬрлБркУ</p>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bhmycvrbucmbbrpzeane.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const urlParams = new URLSearchParams(window.location.search);
const RESULT_ID = urlParams.get('result_id');

let app = document.getElementById("app");
let user, testResult, questionAttempts = [];

if (!RESULT_ID) {
  app.innerHTML = '<div class="card"><h3>тЪая╕П Invalid URL</h3><p>Result ID not found</p></div>';
} else {
  init();
}

async function init() {
  try {
    const { data: { user: u } } = await sb.auth.getUser();
    if (!u) {
      app.innerHTML = '<div class="card"><h3>ЁЯФТ Login Required</h3><p>ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк▓рлЛркЧрк┐рки ркХрк░рлЛ</p></div>';
      return;
    }
    user = u;

    // Load test result
    const { data: result, error: resultError } = await sb
      .from("lrd_test_results")
      .select("*")
      .eq("id", RESULT_ID)
      .single();
    
    if (resultError || !result) {
      app.innerHTML = '<div class="card"><h3>тЭМ Result Not Found</h3><p>' + (resultError?.message || 'No data') + '</p></div>';
      return;
    }
    testResult = result;

    // Load question attempts with full details
    const { data: attempts, error: attemptsError } = await sb
      .from("lrd_question_attempts")
      .select(`
        *,
        lrd_questions (
          *,
          lrd_subjects (id, name, subject_code),
          lrd_chapters (id, name, chapter_id)
        )
      `)
      .eq("test_result_id", RESULT_ID);
    
    if (attemptsError) {
      console.error('Attempts error:', attemptsError);
    }
    
    questionAttempts = attempts || [];

    if (questionAttempts.length === 0) {
      app.innerHTML = '<div class="card"><h3>тЪая╕П No Data</h3><p>рккрлНрк░рк╢рлНркирлЛркирлЛ ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА</p></div>';
      return;
    }

    displayPerformance();
  } catch (err) {
    console.error('Init error:', err);
    app.innerHTML = '<div class="card"><h3>тЭМ Error</h3><p>' + err.message + '</p></div>';
  }
}

function displayPerformance() {
  const date = new Date(testResult.completed_at).toLocaleDateString('en-GB').replace(/\//g, '-');
  const timePerQ = Math.floor(testResult.total_time_seconds / testResult.total_questions);

  // Calculate difficulty stats
  let diffStats = {
    easy: { correct: 0, total: 0 },
    medium: { correct: 0, total: 0 },
    hard: { correct: 0, total: 0 }
  };
  
  questionAttempts.forEach(att => {
    if (!att.lrd_questions) return;
    const diff = att.lrd_questions.difficulty_level;
    if (diff === 'рк╕рк░рк│') {
      diffStats.easy.total++;
      if (att.is_correct) diffStats.easy.correct++;
    } else if (diff === 'ркоркзрлНркпрко') {
      diffStats.medium.total++;
      if (att.is_correct) diffStats.medium.correct++;
    } else if (diff === 'ркорлБрк╢рлНркХрлЗрк▓') {
      diffStats.hard.total++;
      if (att.is_correct) diffStats.hard.correct++;
    }
  });

  // Calculate subject and chapter wise stats
  const subjectMap = {};
  
  questionAttempts.forEach(att => {
    if (!att.lrd_questions || !att.lrd_questions.lrd_subjects || !att.lrd_questions.lrd_chapters) return;
    
    const subjId = att.lrd_questions.lrd_subjects.id;
    const subjName = att.lrd_questions.lrd_subjects.name;
    const chapterId = att.lrd_questions.lrd_chapters.id;
    const chapterName = att.lrd_questions.lrd_chapters.name;
    
    if (!subjectMap[subjId]) {
      subjectMap[subjId] = {
        name: subjName,
        total: 0,
        correct: 0,
        chapters: {}
      };
    }
    
    subjectMap[subjId].total++;
    if (att.is_correct) subjectMap[subjId].correct++;
    
    if (!subjectMap[subjId].chapters[chapterId]) {
      subjectMap[subjId].chapters[chapterId] = {
        name: chapterName,
        total: 0,
        correct: 0
      };
    }
    
    subjectMap[subjId].chapters[chapterId].total++;
    if (att.is_correct) subjectMap[subjId].chapters[chapterId].correct++;
  });

  // Generate subject HTML with chapter breakdown
  let subjectHTML = '';
  Object.entries(subjectMap).forEach(([subjId, subjData]) => {
    const subjPer = ((subjData.correct / subjData.total) * 100).toFixed(0);
    const cls = subjPer >= 80 ? 'score-excellent' : subjPer >= 60 ? 'score-good' : subjPer >= 40 ? 'score-average' : 'score-poor';
    
    let chaptersHTML = '';
    Object.entries(subjData.chapters).forEach(([chId, chData]) => {
      const chPer = ((chData.correct / chData.total) * 100).toFixed(0);
      const chCls = chPer >= 80 ? 'score-excellent' : chPer >= 60 ? 'score-good' : chPer >= 40 ? 'score-average' : 'score-poor';
      chaptersHTML += `
        <div class="chapter-item">
          <span class="ch-name">${chData.name}</span>
          <span class="ch-score ${chCls}">${chPer}%</span>
        </div>
      `;
    });
    
    subjectHTML += `
      <div class="subject-item">
        <div class="subject-header">
          <span class="subject-name">${subjData.name}</span>
          <span class="subject-score ${cls}">${subjPer}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${subjPer}%"></div>
        </div>
        ${Object.keys(subjData.chapters).length > 0 ? `<div class="chapter-list">${chaptersHTML}</div>` : ''}
      </div>
    `;
  });

  // Generate recommendations based on performance
  const percentage = parseFloat(testResult.percentage);
  let recHTML = '';
  
  if (percentage < 40) {
    recHTML += '<div class="rec-section"><h4>ЁЯФ┤ ркдрк╛ркдрлНркХрк╛рк▓рк┐ркХ ркзрлНркпрк╛рки ркЖрккрлЛ:</h4><ul class="rec-list">';
    recHTML += '<li>ркмрлЗрк╕рк┐ркХ ркХрлЛркирлНрк╕рлЗрккрлНркЯрлНрк╕ рклрк░рлАркерлА рк╕ркоркЬрлЛ ркЕркирлЗ ркоркЬркмрлВркд ркХрк░рлЛ</li>';
    recHTML += '<li>ркжрк░рк░рлЛркЬ ркУркЫрк╛ркорк╛ркВ ркУркЫрк╛ 3-4 ркХрк▓рк╛ркХ ркЕркнрлНркпрк╛рк╕ ркХрк░рлЛ</li>';
    recHTML += '<li>ркиркмрк│рк╛ рк╡рк┐рк╖ркпрлЛ рккрк░ рк╡рк┐рк╢рлЗрк╖ ркзрлНркпрк╛рки ркЖрккрлЛ</li>';
    recHTML += '</ul></div>';
  } else if (percentage >= 40 && percentage < 60) {
    recHTML += '<div class="rec-section"><h4>ЁЯЯа рк╡рк╛ркВркЪрки рк╕рлБркзрк╛рк░рлЛ:</h4><ul class="rec-list">';
    recHTML += '<li>ркиркмрк│рк╛ рк╡рк┐рк╖ркпрлЛ рккрк░ рк╡ркзрлБ рк╕ркоркп ркЖрккрлЛ</li>';
    recHTML += '<li>ркирк┐ркпркорк┐ркд рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркЕркирлЗ рк░рк┐рк╡рк┐ркЭрки ркХрк░рлЛ</li>';
    recHTML += '<li>ркоркзрлНркпрко ркЕркирлЗ ркорлБрк╢рлНркХрлЗрк▓ рккрлНрк░рк╢рлНркирлЛ рккрк░ ркзрлНркпрк╛рки ркЖрккрлЛ</li>';
    recHTML += '</ul></div>';
  } else if (percentage >= 60 && percentage < 80) {
    recHTML += '<div class="rec-section"><h4>ЁЯЯб рк╕рк╛рк░рлБркВ - рк╡ркзрлБ рк╕рлБркзрк╛рк░рлЛ:</h4><ul class="rec-list">';
    recHTML += '<li>ркорлБрк╢рлНркХрлЗрк▓ рккрлНрк░рк╢рлНркирлЛ рккрк░ рк╡ркзрлБ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркХрк░рлЛ</li>';
    recHTML += '<li>рк╕рлНрккрлАркб ркЕркирлЗ ркПркХрлНркпрлБрк░рк╕рлА ркмркВркирлЗ рк╕рлБркзрк╛рк░рлЛ</li>';
    recHTML += '<li>ркирк┐ркпркорк┐ркд ркорлЛркХ ркЯрлЗрк╕рлНркЯ рк▓рлЛ</li>';
    recHTML += '</ul></div>';
  } else {
    recHTML += '<div class="rec-section"><h4>ЁЯЯв ркдркорк╛рк░рлА ркоркЬркмрлВркдрк╛ркИ:</h4><ul class="rec-list">';
    recHTML += '<li>ркЙркдрлНркдрко рккрлНрк░ркжрк░рлНрк╢рки! ркЖ рк╕рлНркдрк░ ркЬрк╛рк│рк╡рлЛ</li>';
    recHTML += '<li>ркирк┐ркпркорк┐ркд рк░рк┐рк╡рк┐ркЭрки ркЪрк╛рк▓рлБ рк░рк╛ркЦрлЛ</li>';
    recHTML += '<li>ркЕркирлНркп рк╡рк┐ркжрлНркпрк╛рк░рлНркерлАркУркирлЗ ркоркжркж ркХрк░рлЛ</li>';
    recHTML += '</ul></div>';
  }

  // Add weak subjects to recommendations
  Object.entries(subjectMap).forEach(([subjId, subjData]) => {
    const subjPer = ((subjData.correct / subjData.total) * 100);
    if (subjPer < 40) {
      recHTML += `<div class="rec-section"><h4>тЪая╕П ${subjData.name} - ркдрк╛ркдрлНркХрк╛рк▓рк┐ркХ ркзрлНркпрк╛рки:</h4><ul class="rec-list">`;
      Object.entries(subjData.chapters).forEach(([chId, chData]) => {
        const chPer = ((chData.correct / chData.total) * 100);
        if (chPer < 40) {
          recHTML += `<li>${chData.name}: ${chPer.toFixed(0)}% - рк╡ркзрлБ рккрлНрк░рлЗркХрлНркЯрк┐рк╕ ркЬрк░рлВрк░рлА</li>`;
        }
      });
      recHTML += '</ul></div>';
    }
  });

  const improvementNeeded = (100 - percentage).toFixed(0);

  app.innerHTML = `
  <div class="card">
    <div class="student-header">
      <div class="avatar">RS</div>
      <div>
        <h2 style="margin:0 0 8px 0">Performance Dashboard</h2>
        <div class="student-meta">
          <span>рк▓рлЗрк╡рк▓: <b>ркЧрк╛ркВркбрлНрк╕</b></span>
          <span>рк░рлЗркВркХ: <b>#14</b></span>
          <span>ркдрк╛рк░рлАркЦ: <b>${date}</b></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ркЯрлЗрк╕рлНркЯркирлБркВ рккрк░рк┐ркгрк╛рко</h3>
    <canvas id="pieChart" style="max-height:250px"></canvas>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">ркХрлБрк▓/ркорлЗрк│рк╡рлЗрк▓ ркЧрлБркг</div>
      <div class="stat-value">${testResult.total_questions}/${testResult.score}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЪрлЛркХрк╕рк╛ркИ</div>
      <div class="stat-value" style="color:#22c55e">${testResult.percentage}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕ркоркп/рккрлНрк░рк╢рлНрки</div>
      <div class="stat-value">${timePerQ}s</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркПркХрк╛ркЧрлНрк░ркдрк╛ рк░рлЗркЯрк┐ркВркЧ</div>
      <div class="stat-value" style="color:#f59e0b">8/10</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕рк░рк│ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
      <div class="stat-value">${diffStats.easy.correct}/${diffStats.easy.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркорлБрк╢рлНркХрлЗрк▓ (рк╕рк╛ркЪрк╛/ркХрлБрк▓)</div>
      <div class="stat-value">${diffStats.hard.correct}/${diffStats.hard.total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ркЯрк╛рк░рлНркЧрлЗркЯ рк╕рлНркХрлЛрк░</div>
      <div class="stat-value">60</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">рк╕рлБркзрк╛рк░рлЛ ркЬрк░рлВрк░</div>
      <div class="stat-value" style="color:#f59e0b">${improvementNeeded}%</div>
    </div>
    <div class="stat-card" style="grid-column:span 2">
      <div class="stat-label">ркмрк╛ркХрлА рккрлНрк░рк╢рлНркирлЛ</div>
      <div class="stat-value">${String(testResult.skipped_questions).padStart(2, '0')}</div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">рк╡рк┐рк╖ркп ркЕркирлЗ ркЪрлЗрккрлНркЯрк░ рк╡рк╛рк░ ркПркирк╛рк▓рк┐рк╕рк┐рк╕</div>
    ${subjectHTML}
  </div>

  <div class="rec-card">
    <div class="rec-title">ЁЯОп ркдркорк╛рк░рк╛ ркорк╛ркЯрлЗ ркПркХрлНрк╢рки рккрлНрк▓рк╛рки</div>
    ${recHTML}
  </div>

  <button class="blue" onclick="window.location.href='select-test.html'">ЁЯПа Back to Home</button>
  `;

  // Draw pie chart
  setTimeout(() => {
    const ctx = document.getElementById('pieChart');
    if (ctx) {
      new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['рк╕рк╛ркЪрк╛', 'ркЦрлЛркЯрк╛', 'ркмрк╛ркХрлА'],
          datasets: [{
            data: [testResult.correct_answers, testResult.wrong_answers, testResult.skipped_questions],
            backgroundColor: ['#22c55e', '#ef4444', '#e5e7eb']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 15, font: { size: 13 } }
            }
          }
        }
      });
    }
  }, 100);
}
</script>
</body>
</html>
