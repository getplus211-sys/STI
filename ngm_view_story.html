<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>àª¸à«àªŸà«‹àª°à«€ àªœà«àª“ - NGM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: #000;
            height: 100vh;
            user-select: none;
        }

        /* Story Container */
        .story-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
            overflow: hidden;
        }

        /* Story Content */
        .story-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .story-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .story-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            text-align: center;
            color: white;
            font-size: 32px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
            z-index: 3;
            padding: 20px;
        }

        /* Progress Bars */
        .progress-bars {
            position: absolute;
            top: 12px;
            left: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 1000;
        }

        .progress-bar {
            flex: 1;
            height: 3px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-fill.active {
            animation: progress 5s linear forwards;
        }

        .progress-fill.viewed {
            width: 100%;
        }

        @keyframes progress {
            to {
                width: 100%;
            }
        }

        /* Header */
        .story-header {
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .story-time {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }

        .header-btn:active {
            transform: scale(0.9);
        }

        /* Touch Areas for Navigation */
        .touch-area {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30%;
            z-index: 100;
            cursor: pointer;
        }

        .touch-area.left {
            left: 0;
        }

        .touch-area.right {
            right: 0;
        }

        .touch-area.center {
            left: 30%;
            right: 30%;
            width: 40%;
        }

        /* Bottom Actions */
        .story-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            z-index: 1000;
            background: linear-gradient(0deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        }

        .reply-box {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .reply-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 14px;
            outline: none;
        }

        .reply-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .action-icons {
            display: flex;
            gap: 16px;
        }

        .action-icon {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .action-icon:active {
            transform: scale(1.2);
        }

        /* Mentions Display */
        .mentions-list {
            position: absolute;
            bottom: 100px;
            left: 16px;
            right: 16px;
            z-index: 4;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .mention-tag {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 20px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mention-tag:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        /* Link Display */
        .story-link {
            position: absolute;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
        }

        .link-btn {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 24px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .link-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        /* Options Menu */
        .options-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 24px 16px 40px;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .options-menu.active {
            transform: translateY(0);
        }

        .menu-header {
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 24px;
        }

        .menu-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .menu-option:active {
            background: #f5f5f5;
        }

        .menu-icon {
            width: 44px;
            height: 44px;
            background: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .menu-text {
            flex: 1;
        }

        .menu-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .menu-desc {
            font-size: 13px;
            color: #666;
        }

        .menu-option.danger .menu-title {
            color: #ff3b30;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Reactions */
        .reactions-popup {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 30px;
            display: flex;
            gap: 16px;
            z-index: 2001;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .reactions-popup.active {
            opacity: 1;
            pointer-events: all;
        }

        .reaction-emoji {
            font-size: 32px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reaction-emoji:active {
            transform: scale(1.3);
        }

        /* Viewers List */
        .viewers-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            max-height: 70vh;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .viewers-modal.active {
            transform: translateY(0);
        }

        .viewers-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewers-title {
            font-size: 18px;
            font-weight: 600;
        }

        .viewers-count {
            font-size: 14px;
            color: #666;
        }

        .viewers-list {
            max-height: calc(70vh - 80px);
            overflow-y: auto;
            padding: 16px;
        }

        .viewer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .viewer-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .viewer-info {
            flex: 1;
        }

        .viewer-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .viewer-time {
            font-size: 13px;
            color: #666;
        }

        /* Pause Indicator */
        .pause-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .pause-indicator.active {
            opacity: 1;
        }

        /* Gradient backgrounds for demo */
        .gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    </style>
</head>
<body>
    <!-- Story Container -->
    <div class="story-container">
        <!-- Progress Bars -->
        <div class="progress-bars" id="progressBars"></div>

        <!-- Header -->
        <div class="story-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">R</div>
                <div class="user-details">
                    <div class="user-name" id="userName">àª°àª¾àªœ àªªàªŸà«‡àª²</div>
                    <div class="story-time" id="storyTime">2 àª•àª²àª¾àª• àªªàª¹à«‡àª²àª¾àª‚</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" onclick="togglePause()">â¸</button>
                <button class="header-btn" onclick="openOptions()">â‹®</button>
                <button class="header-btn" onclick="closeStory()">Ã—</button>
            </div>
        </div>

        <!-- Story Content -->
        <div class="story-content">
            <div class="story-background gradient-1" id="storyBackground">
                <img class="story-image" id="storyImage" style="display: none;" alt="">
                <div class="story-text" id="storyText"></div>
            </div>
        </div>

        <!-- Link -->
        <div class="story-link" id="storyLink" style="display: none;">
            <a class="link-btn" href="#" target="_blank">
                <span>ğŸ”—</span>
                <span>àª²àª¿àª‚àª• àªœà«àª“</span>
            </a>
        </div>

        <!-- Mentions -->
        <div class="mentions-list" id="mentionsList"></div>

        <!-- Touch Areas -->
        <div class="touch-area left" onclick="previousStory()"></div>
        <div class="touch-area center" onmousedown="pauseStory()" onmouseup="resumeStory()" 
             ontouchstart="pauseStory()" ontouchend="resumeStory()"></div>
        <div class="touch-area right" onclick="nextStory()"></div>

        <!-- Pause Indicator -->
        <div class="pause-indicator" id="pauseIndicator">â¸</div>

        <!-- Footer -->
        <div class="story-footer">
            <div class="reply-box">
                <input type="text" class="reply-input" placeholder="àª°àª¾àªœ àªªàªŸà«‡àª²àª¨à«‡ àªœàªµàª¾àª¬ àª†àªªà«‹..." id="replyInput">
                <div class="action-icons">
                    <button class="action-icon" onclick="toggleReactions()">â¤ï¸</button>
                    <button class="action-icon" onclick="shareStory()">ğŸ“¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reactions Popup -->
    <div class="reactions-popup" id="reactionsPopup">
        <span class="reaction-emoji" onclick="sendReaction('â¤ï¸')">â¤ï¸</span>
        <span class="reaction-emoji" onclick="sendReaction('ğŸ˜‚')">ğŸ˜‚</span>
        <span class="reaction-emoji" onclick="sendReaction('ğŸ˜®')">ğŸ˜®</span>
        <span class="reaction-emoji" onclick="sendReaction('ğŸ˜¢')">ğŸ˜¢</span>
        <span class="reaction-emoji" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</span>
        <span class="reaction-emoji" onclick="sendReaction('ğŸ‘')">ğŸ‘</span>
    </div>

    <!-- Options Menu -->
    <div class="overlay" id="overlay" onclick="closeOptions()"></div>
    <div class="options-menu" id="optionsMenu">
        <div class="menu-header"></div>
        
        <div class="menu-option" onclick="viewStoryInfo()">
            <div class="menu-icon">â„¹ï¸</div>
            <div class="menu-text">
                <div class="menu-title">àª¸à«àªŸà«‹àª°à«€ àªµàª¿àª—àª¤</div>
                <div class="menu-desc">àª¸à«àªŸà«‹àª°à«€ àªµàª¿àª¶à«‡ àªµàª§à« àªœàª¾àª£à«‹</div>
            </div>
        </div>

        <div class="menu-option" onclick="viewViewers()">
            <div class="menu-icon">ğŸ‘ï¸</div>
            <div class="menu-text">
                <div class="menu-title">àªœà«‹àª¨àª¾àª°àª¾àª“</div>
                <div class="menu-desc">àª•à«‹àª£à«‡ àª† àª¸à«àªŸà«‹àª°à«€ àªœà«‹àªˆ àª›à«‡</div>
            </div>
        </div>

        <div class="menu-option" onclick="muteUser()">
            <div class="menu-icon">ğŸ”‡</div>
            <div class="menu-text">
                <div class="menu-title">àª¯à«àªàª° àª®à«àª¯à«‚àªŸ àª•àª°à«‹</div>
                <div class="menu-desc">àª† àª¯à«àªàª°àª¨à«€ àª¸à«àªŸà«‹àª°à«€ àª›à«àªªàª¾àªµà«‹</div>
            </div>
        </div>

        <div class="menu-option" onclick="downloadStory()">
            <div class="menu-icon">â¬‡ï¸</div>
            <div class="menu-text">
                <div class="menu-title">àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª•àª°à«‹</div>
                <div class="menu-desc">àª† àª¸à«àªŸà«‹àª°à«€ àª¸à«‡àªµ àª•àª°à«‹</div>
            </div>
        </div>

        <div class="menu-option danger" onclick="reportStory()">
            <div class="menu-icon">âš ï¸</div>
            <div class="menu-text">
                <div class="menu-title">àª°àª¿àªªà«‹àª°à«àªŸ àª•àª°à«‹</div>
                <div class="menu-desc">àª† àª¸à«àªŸà«‹àª°à«€ àªµàª¿àª¶à«‡ àª«àª°àª¿àª¯àª¾àª¦ àª•àª°à«‹</div>
            </div>
        </div>
    </div>

    <!-- Viewers Modal -->
    <div class="viewers-modal" id="viewersModal">
        <div class="viewers-header">
            <div>
                <div class="viewers-title">àªœà«‹àª¨àª¾àª°àª¾àª“</div>
                <div class="viewers-count" id="viewersCount">24 àª²à«‹àª•à«‹àª àªœà«‹àª¯à«àª‚</div>
            </div>
            <button class="header-btn" onclick="closeViewers()" style="color: #000;">Ã—</button>
        </div>
        <div class="viewers-list" id="viewersList"></div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://bhmycvrbucmbbrpzeane.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJobXljdnJidWNtYmJycHplYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTQwOTYsImV4cCI6MjA4MDI3MDA5Nn0.qQ3bw9cADG0P8hbGwx76Oeg54l-9FbRWxc92nZdSPL4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Authentication
        let currentUser = null;

        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error || !session) {
                alert('àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª¹à«‡àª²àª¾ àª²à«‹àª—àª¿àª¨ àª•àª°à«‹');
                window.location.href = '/login.html';
                return false;
            }
            
            currentUser = session.user;
            return true;
        }

        // Load stories from database
        async function loadStoriesFromDB(userId) {
            const { data, error } = await supabase
                .from('ngm_user_posts')
                .select(`
                    *,
                    ngm_users!ngm_user_posts_user_id_fkey (
                        user_id,
                        full_name,
                        username,
                        profile_picture_url
                    ),
                    ngm_post_mentions (
                        mentioned_user_id,
                        ngm_users!ngm_post_mentions_mentioned_user_id_fkey (
                            username,
                            full_name
                        )
                    )
                `)
                .eq('user_id', userId)
                .eq('post_type', 'story')
                .gte('expires_at', new Date().toISOString())
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading stories:', error);
                return [];
            }

            return data.map(story => ({
                id: story.post_id,
                userId: story.user_id,
                userName: story.ngm_users.full_name,
                userAvatar: story.ngm_users.profile_picture_url ? '' : story.ngm_users.full_name[0],
                userAvatarUrl: story.ngm_users.profile_picture_url,
                background: 'gradient-1',
                text: story.content || '',
                image: story.media_url,
                mentions: story.ngm_post_mentions.map(m => ({
                    username: m.ngm_users.username,
                    name: m.ngm_users.full_name
                })),
                link: null,
                time: getRelativeTime(story.created_at),
                timestamp: new Date(story.created_at).getTime(),
                viewers: story.views_count || 0
            }));
        }

        // Get relative time
        function getRelativeTime(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'àª¹àª®àª£àª¾àª‚ àªœ';
            if (diffMins < 60) return `${diffMins} àª®àª¿àª¨àª¿àªŸ àªªàª¹à«‡àª²àª¾àª‚`;
            if (diffHours < 24) return `${diffHours} àª•àª²àª¾àª• àªªàª¹à«‡àª²àª¾àª‚`;
            return `${diffDays} àª¦àª¿àªµàª¸ àªªàª¹à«‡àª²àª¾àª‚`;
        }

        // Update story view count
        async function updateViewCount(storyId) {
            const { error } = await supabase
                .from('ngm_user_posts')
                .update({ 
                    views_count: supabase.sql`views_count + 1` 
                })
                .eq('post_id', storyId);
            
            if (error) console.error('View count update error:', error);
        }

        // Sample stories data (for fallback/demo)
        let storiesData = [
            {
                id: 1,
                userId: 'user1',
                userName: 'àª°àª¾àªœ àªªàªŸà«‡àª²',
                userAvatar: 'R',
                background: 'gradient-1',
                text: 'àª†àªœàª¨à«‹ àª¦àª¿àªµàª¸ àª–à«‚àª¬ àª¸àª°àª¸ àª°àª¹à«àª¯à«‹! ğŸŒŸ',
                image: null,
                mentions: [
                    { username: 'priyashah', name: 'àªªà«àª°àª¿àª¯àª¾ àª¶àª¾àª¹' },
                    { username: 'amitkumar', name: 'àª…àª®àª¿àª¤ àª•à«àª®àª¾àª°' }
                ],
                link: 'https://example.com',
                time: '2 àª•àª²àª¾àª• àªªàª¹à«‡àª²àª¾àª‚',
                timestamp: Date.now() - 7200000,
                viewers: 24
            },
            {
                id: 2,
                userId: 'user1',
                userName: 'àª°àª¾àªœ àªªàªŸà«‡àª²',
                userAvatar: 'R',
                background: 'gradient-2',
                text: 'àª¨àªµà«€ àª¶àª°à«‚àª†àª¤, àª¨àªµà«€ àª¶àª•à«àª¤àª¿! ğŸ’ª',
                image: null,
                mentions: [],
                link: null,
                time: '5 àª•àª²àª¾àª• àªªàª¹à«‡àª²àª¾àª‚',
                timestamp: Date.now() - 18000000,
                viewers: 18
            },
            {
                id: 3,
                userId: 'user1',
                userName: 'àª°àª¾àªœ àªªàªŸà«‡àª²',
                userAvatar: 'R',
                background: 'gradient-3',
                text: 'àª¸àªªàª¨àª¾àª‚ àªœà«‹àªµàª¾ àª•àª°àª¤àª¾àª‚ àª¸àªªàª¨àª¾àª‚ àª¸àª¾àª•àª¾àª° àª•àª°àªµàª¾! âœ¨',
                image: null,
                mentions: [],
                link: null,
                time: '8 àª•àª²àª¾àª• àªªàª¹à«‡àª²àª¾àª‚',
                timestamp: Date.now() - 28800000,
                viewers: 32
            }
        ];

        // Sample viewers data
        const viewersData = [
            { name: 'àªªà«àª°àª¿àª¯àª¾ àª¶àª¾àª¹', username: 'priyashah', avatar: 'P', time: '2 àª®àª¿àª¨àª¿àªŸ àªªàª¹à«‡àª²àª¾àª‚' },
            { name: 'àª…àª®àª¿àª¤ àª•à«àª®àª¾àª°', username: 'amitkumar', avatar: 'A', time: '5 àª®àª¿àª¨àª¿àªŸ àªªàª¹à«‡àª²àª¾àª‚' },
            { name: 'àª¨à«‡àª¹àª¾ àª¦à«‡àª¸àª¾àªˆ', username: 'nehadesai', avatar: 'N', time: '12 àª®àª¿àª¨àª¿àªŸ àªªàª¹à«‡àª²àª¾àª‚' },
            { name: 'àªµàª¿àª•àª¾àª¸ àª®àª¹à«‡àª¤àª¾', username: 'vikasmehta', avatar: 'V', time: '25 àª®àª¿àª¨àª¿àªŸ àªªàª¹à«‡àª²àª¾àª‚' },
            { name: 'àª…àª‚àªœàª²àª¿ àªµàª°à«àª®àª¾', username: 'anjaliverma', avatar: 'A', time: '1 àª•àª²àª¾àª• àªªàª¹à«‡àª²àª¾àª‚' }
        ];

        // State
        let currentStoryIndex = 0;
        let isPaused = false;
        let progressInterval = null;
        let currentProgress = 0;

        // Initialize
        function init() {
            renderProgressBars();
            loadStory(currentStoryIndex);
            startProgress();
        }

        // Render progress bars
        function renderProgressBars() {
            const container = document.getElementById('progressBars');
            container.innerHTML = storiesData.map((_, index) => `
                <div class="progress-bar">
                    <div class="progress-fill ${index < currentStoryIndex ? 'viewed' : ''}" 
                         id="progress-${index}"></div>
                </div>
            `).join('');
        }

        // Load story
        function loadStory(index) {
            if (index < 0 || index >= storiesData.length) {
                closeStory();
                return;
            }

            const story = storiesData[index];
            
            // Update user info
            document.getElementById('userAvatar').textContent = story.userAvatar;
            document.getElementById('userName').textContent = story.userName;
            document.getElementById('storyTime').textContent = story.time;

            // Update background
            const background = document.getElementById('storyBackground');
            background.className = `story-background ${story.background}`;

            // Update image
            const image = document.getElementById('storyImage');
            if (story.image) {
                image.src = story.image;
                image.style.display = 'block';
            } else {
                image.style.display = 'none';
            }

            // Update text
            document.getElementById('storyText').textContent = story.text;

            // Update mentions
            const mentionsList = document.getElementById('mentionsList');
            if (story.mentions && story.mentions.length > 0) {
                mentionsList.innerHTML = story.mentions.map(mention => `
                    <span class="mention-tag" onclick="viewProfile('${mention.username}')">
                        @${mention.username}
                    </span>
                `).join('');
                mentionsList.style.display = 'flex';
            } else {
                mentionsList.style.display = 'none';
            }

            // Update link
            const linkElement = document.getElementById('storyLink');
            if (story.link) {
                linkElement.querySelector('a').href = story.link;
                linkElement.style.display = 'block';
            } else {
                linkElement.style.display = 'none';
            }

            // Update reply placeholder
            document.getElementById('replyInput').placeholder = `${story.userName}àª¨à«‡ àªœàªµàª¾àª¬ àª†àªªà«‹...`;
        }

        // Progress management
        function startProgress() {
            currentProgress = 0;
            const progressElement = document.getElementById(`progress-${currentStoryIndex}`);
            progressElement.classList.add('active');
            
            progressInterval = setInterval(() => {
                if (!isPaused) {
                    currentProgress += 2;
                    progressElement.style.width = currentProgress + '%';
                    
                    if (currentProgress >= 100) {
                        nextStory();
                    }
                }
            }, 100);
        }

        function stopProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function pauseStory() {
            isPaused = true;
            document.getElementById('pauseIndicator').classList.add('active');
        }

        function resumeStory() {
            isPaused = false;
            document.getElementById('pauseIndicator').classList.remove('active');
        }

        function togglePause() {
            if (isPaused) {
                resumeStory();
            } else {
                pauseStory();
            }
        }

        // Navigation
        function previousStory() {
            if (currentStoryIndex > 0) {
                stopProgress();
                currentStoryIndex--;
                loadStory(currentStoryIndex);
                startProgress();
            }
        }

        function nextStory() {
            stopProgress();
            
            if (currentStoryIndex < storiesData.length - 1) {
                currentStoryIndex++;
                loadStory(currentStoryIndex);
                startProgress();
                
                // Track view
                updateViewCount(storiesData[currentStoryIndex].id);
            } else {
                closeStory();
            }
        }

        // Actions
        function toggleReactions() {
            const popup = document.getElementById('reactionsPopup');
            popup.classList.toggle('active');
            
            if (popup.classList.contains('active')) {
                setTimeout(() => {
                    popup.classList.remove('active');
                }, 3000);
            }
        }

        async function sendReaction(emoji) {
            const currentStory = storiesData[currentStoryIndex];
            
            try {
                // Insert or update reaction
                const { data, error } = await supabase
                    .from('ngm_message_reactions')
                    .upsert({
                        message_id: currentStory.id,
                        user_id: currentUser.id,
                        emoji: emoji
                    }, {
                        onConflict: 'message_id,user_id'
                    });

                if (error) throw error;

                console.log('Reaction sent:', emoji);
                alert(`${emoji} àª°àª¿àªàª•à«àª¶àª¨ àª®à«‹àª•àª²à«àª¯à«àª‚!`);
            } catch (error) {
                console.error('Reaction error:', error);
                alert('àª°àª¿àªàª•à«àª¶àª¨ àª®à«‹àª•àª²àª¤à«€ àªµàª–àª¤à«‡ àª­à«‚àª² àª¥àªˆ');
            }
            
            document.getElementById('reactionsPopup').classList.remove('active');
        }

        function shareStory() {
            alert('àª¸à«àªŸà«‹àª°à«€ àª¶à«‡àª° àª•àª°à«€!');
        }

        function openOptions() {
            pauseStory();
            document.getElementById('overlay').classList.add('active');
            document.getElementById('optionsMenu').classList.add('active');
        }

        function closeOptions() {
            resumeStory();
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('optionsMenu').classList.remove('active');
        }

        function viewStoryInfo() {
            const story = storiesData[currentStoryIndex];
            alert(`àª¸à«àªŸà«‹àª°à«€ ID: ${story.id}\nàª¸àª®àª¯: ${story.time}\nàªœà«‹àª¨àª¾àª°àª¾àª“: ${story.viewers}`);
            closeOptions();
        }

        async function viewViewers() {
            closeOptions();
            const modal = document.getElementById('viewersModal');
            const overlay = document.getElementById('overlay');
            const viewersList = document.getElementById('viewersList');
            
            // Show loading
            viewersList.innerHTML = '<div style="text-align: center; padding: 20px;">àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</div>';
            
            // Load viewers from database
            const currentStory = storiesData[currentStoryIndex];
            const { data, error } = await supabase
                .from('ngm_post_views')
                .select(`
                    created_at,
                    ngm_users (
                        user_id,
                        full_name,
                        username,
                        profile_picture_url
                    )
                `)
                .eq('post_id', currentStory.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading viewers:', error);
                viewersList.innerHTML = '<div style="text-align: center; padding: 20px;">àª²à«‹àª¡ àª•àª°àªµàª¾àª®àª¾àª‚ àª­à«‚àª²</div>';
            } else {
                const viewers = data || [];
                document.getElementById('viewersCount').textContent = 
                    `${viewers.length} ${viewers.length === 1 ? 'àªµà«àª¯àª•à«àª¤àª¿àª' : 'àª²à«‹àª•à«‹àª'} àªœà«‹àª¯à«àª‚`;
                
                if (viewers.length === 0) {
                    viewersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">àª¹àªœà« àª¸à«àª§à«€ àª•à«‹àªˆàª àªœà«‹àª¯à«àª‚ àª¨àª¥à«€</div>';
                } else {
                    viewersList.innerHTML = viewers.map(v => `
                        <div class="viewer-item">
                            <div class="viewer-avatar">
                                ${v.ngm_users.profile_picture_url 
                                    ? `<img src="${v.ngm_users.profile_picture_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` 
                                    : v.ngm_users.full_name[0]
                                }
                            </div>
                            <div class="viewer-info">
                                <div class="viewer-name">${v.ngm_users.full_name}</div>
                                <div class="viewer-time">${getRelativeTime(v.created_at)}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            overlay.classList.add('active');
            modal.classList.add('active');
            pauseStory();
        }

        function closeViewers() {
            document.getElementById('viewersModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            resumeStory();
        }

        function muteUser() {
            alert('àª¯à«àªàª° àª®à«àª¯à«‚àªŸ àª•àª°à«àª¯à«‹!');
            closeOptions();
        }

        function downloadStory() {
            alert('àª¸à«àªŸà«‹àª°à«€ àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª¥àªˆ àª°àª¹à«€ àª›à«‡...');
            closeOptions();
        }

        function reportStory() {
            if (confirm('àª¶à«àª‚ àª¤àª®à«‡ àª† àª¸à«àªŸà«‹àª°à«€ àª°àª¿àªªà«‹àª°à«àªŸ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?')) {
                alert('àª¸à«àªŸà«‹àª°à«€ àª°àª¿àªªà«‹àª°à«àªŸ àª•àª°à«€!');
                closeOptions();
            }
        }

        function viewProfile(username) {
            alert(`@${username} àª¨à«€ àªªà«àª°à«‹àª«àª¾àªˆàª² àªœà«àª“`);
        }

        function closeStory() {
            stopProgress();
            window.history.back();
        }

        // Reply handling
        document.getElementById('replyInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                const message = this.value.trim();
                const currentStory = storiesData[currentStoryIndex];
                
                try {
                    // Insert reply as a message
                    const { data, error } = await supabase
                        .from('ngm_messages')
                        .insert({
                            sender_id: currentUser.id,
                            chat_id: null, // Will need to create/get DM chat
                            message_type: 'story_reply',
                            content: message,
                            reply_to_message_id: null
                        });

                    if (error) throw error;

                    console.log('Reply sent:', message);
                    alert(`àªœàªµàª¾àª¬ àª®à«‹àª•àª²à«àª¯à«‹: ${message}`);
                    this.value = '';
                } catch (error) {
                    console.error('Reply error:', error);
                    alert('àªœàªµàª¾àª¬ àª®à«‹àª•àª²àª¤à«€ àªµàª–àª¤à«‡ àª­à«‚àª² àª¥àªˆ');
                }
            }
        });

        // Initialize on load
        async function initApp() {
            // Check authentication
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            // Get user ID from URL params (or use current user)
            const urlParams = new URLSearchParams(window.location.search);
            const viewUserId = urlParams.get('userId') || currentUser.id;

            // Load stories from database
            const dbStories = await loadStoriesFromDB(viewUserId);
            
            if (dbStories && dbStories.length > 0) {
                storiesData = dbStories;
            }

            // Initialize the story viewer
            init();

            // Update view count for first story
            if (storiesData.length > 0) {
                await updateViewCount(storiesData[0].id);
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
